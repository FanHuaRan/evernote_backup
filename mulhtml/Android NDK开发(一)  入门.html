<html>
<head>
  <title>Android NDK开发(一)  入门</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="531"/>
<h1>Android NDK开发(一)  入门</h1>

<div>
<span><div><h2>原文地址：<a href="https://www.jianshu.com/p/0261e6cceb3e" style="font-weight: bold; font-size: 14pt;">https://www.jianshu.com/p/0261e6cceb3e</a></h2><h2>开始之前</h2><blockquote><div>最近学习了一下NDK的开发, 就来分享一下.</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">对一个新鲜事物, 我们先解决的无非就是三件事情: 是什么?为什么?怎么做?.</span></div></blockquote><h3>NDK简介</h3><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">（英语：native development kit，简称NDK）是一种基于原生程序接口的软件开发工具。通过此工具开发的程序直接以本地语言运行，而非虚拟机。因此只有java等基于虚拟机运行的语言的程序才会有原生开发工具包。[维基百科]</span></div></blockquote><ol><li>NDK是一系列工具的集合</li></ol><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">NDK提供了一系列的工具，帮助开发者快速开发C（或C++）的动态库，并能自动将so和java应用一起打包成apk。这些工具对开发者的帮助是巨大的.</span></div></blockquote><ol start="2"><li>NDK集成了交叉编译器，并提供了相应的mk文件隔离CPU、平台、ABI等差异，开发人员只需要简单修改mk文件（指出“哪些文件需要编译”、“编译特性要求”等），就可以创建出so。</li></ol><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">NDK可以自动地将so和Java应用一起打包，极大地减轻了开发人员的打包工作。</span></div></blockquote><h3>那我们为什么要使用呢?</h3><ol><li>代码的保护。由于apk的java层代码很容易被反编译，而C/C++库反汇难度较大。</li><li>可以方便地使用现存的开源库。大部分现存的开源库都是用C/C++代码编写的。</li><li>提高程序的执行效率。将要求高性能的应用逻辑使用C开发，从而提高应用程序的执行效率。</li><li>便于移植。用C/C++写得库可以方便在其他的嵌入式平台上再次使用。</li></ol><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">上述文字致谢</span><a href="https://link.jianshu.com/?t=http://www.cnblogs.com/devinzhang/archive/2012/02/29/2373729.html" style="-en-paragraph:true;">Devin Zhang</a><span style="-en-paragraph:true;">提供理论支持</span></div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">是什么和为什么我就先介绍到这儿, 接下来就具体看看如何进行NDK的开发</span></div></blockquote><h3>开发前准备</h3><h4>开发环境</h4><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">请大家务必升级到AS 2.2以上版本, 因为这个版本升级了很多内容, 详情请见</span> <a href="https://link.jianshu.com/?t=http://www.oschina.net/news/77286/android-studio-2-2-stable?p=2" style="-en-paragraph:true;">Android Studio 2.2 正式稳定版发布</a></div></blockquote><ul><li>Android Studio 2.2.2</li><li>JDK1.7</li><li>API 24</li><li>Gradle 2.2.2</li></ul><h4>NDK和CMake 的下载和安装</h4><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">大家可以直接打开SDK进行下载和安装</span></div></blockquote><div style="max-width: 700px; max-height: 618px;"><div style="padding-bottom: 88.35%;"></div><div><img style="cursor: zoom-in;"></img></div></div><div>SDK</div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">由于NDK的工具包较大, 大家也可以选择从网站中下载:</span> <a href="https://link.jianshu.com/?t=http://wear.techbrood.com/tools/sdk/ndk/" style="-en-paragraph:true;">http://wear.techbrood.com/tools/sdk/ndk/</a><span style="-en-paragraph:true;">, 选择自己对应的版本使用迅雷等工具下载即可, 不过通过这种方法一定要修改</span><a href="https://link.jianshu.com/?t=http://local.properties" style="-en-paragraph:true;">local.properties</a><span style="-en-paragraph:true;">文件, 在里面添加:</span></div></blockquote><div>//后面改成自己下载后解压的路径名</div><div>ndk.dir=C\:\\Users\\Lulu\\AppData\\Local\\Android\\android-ndk-r13</div><div><br/></div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">关于CMake</span></div></blockquote><blockquote><ol><li>CMakeList.txt 是脚本文件, 需要指定包含哪些源代码;</li><li>可以写一些条件语句, 实现不同的代码包含</li><li>内部说明:<br/>
add_library 表示编译一个代码库, 内部包含了代码库的名称, 以及源代码有哪些</li></ol></blockquote><h4>NDK两种开发模式</h4><ol><li>ndk-build 形式; Android Studio 2.2之前的模式</li><li>CMake 形式: CLion C/C++编辑器; AS2.2之后整合了CLion代码, AS就支持了CMake形式的NDK开发</li></ol><h2>开始开发</h2><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">接下来通过几个案例来演示NDK的开发流程</span></div></blockquote><h3>创建工程</h3><ol><li><span style="-en-paragraph:true;">新建工程, 选中Include C++ Support</span><br/><br/><div style="padding-bottom: 65.89%;"></div><div><img style="cursor: zoom-in;"></img></div><br/>
Include C++ Support</li><li><span style="-en-paragraph:true;">一路Next之后, 在最后Finish页面尽量选中图示两项, 这样会给我们包裹一些特定的示例代码, 帮助我们理解和使用</span><br/><br/><div style="padding-bottom: 51.7%;"></div><div><img style="cursor: zoom-in;"></img></div><br/>
NDK</li><li><span style="-en-paragraph:true;">点击Finish, 如果出现图示错误的肯定没有好好看上面的 开发前准备</span><br/><br/><div style="padding-bottom: 22.3%;"></div><div><img style="cursor: zoom-in;"></img></div><br/>
ERROR</li></ol><h3>案例一 实现在C语言中隐藏AppKey等信息</h3><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step1: 为了使代码整洁, 咱们新建一个类 NativeHelper, 专门用于访问C语言代码的帮助类 并添加获取Appkey的方法</span></div></blockquote><div>public class NativeHelper {</div><div>static {</div><div>// 加载C代码库, 库的名称, 必须是CMakeLists.txt中指定的名称</div><div>System.loadLibrary(&quot;native-lib&quot;);</div><div>}</div><div><br/></div><div>//获取C中隐藏的AppKey</div><div>public static native String getAppKey();</div><div>}</div><div><br/></div><blockquote><div>Note: 一定要添加上面的静态代码块的内容, 否则无法加载C代码库</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">此时的getAppKey()方法标红, 不用管它, 继续....</span></div></blockquote><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step2: 在cpp目录下右击创建C/C++ Source, 选择Type, 并勾选 Create an associated hader, 为保持对应, 名字命名为: com_lulu_ndkdemo_NativeHelper, 此时会出现, 在cpp目录下会出现两个文件, 如图:</span></div></blockquote><div style="max-width: 353px; max-height: 188px;"><div style="padding-bottom: 53.26%;"></div><div><img style="cursor: zoom-in;"></img></div></div><div>cpp</div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step3: 在CMakeLists.txt中的add_library中添加依关系, 点击同步</span></div></blockquote><div>src/main/cpp/com_lulu_ndkdemo_NativeHelper.c</div><div style="max-width: 700px; max-height: 299px;"><div style="padding-bottom: 39.92%;"></div><div><img style="cursor: zoom-in;"></img></div></div><div>add_library</div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">Note:</span></div></blockquote><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">C代码库生成的名称规则</span></div></blockquote><ol><li>如果栈顶代码库名称为 &quot;nh&quot; 那么生成的文件必定是libnh.so<br/>
命名规则: lib库名.so</li><li>System.loadLibrary(库名); //此处不能包含前面的lib和后面的.so</li></ol><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step4: 在com_lulu_ndkdemo_NativeHelper.c文件中添加c语言代码</span></div></blockquote><div>#include &lt;jni.h&gt;JNIEXPORT jstring JNICALL</div><div>Java_com_lulu_ndkdemo_NativeHelper_getAppKey(JNIEnv *env, jclass type) {</div><div><br/></div><div>//测试代码, 没有任何意义</div><div>char* app_key = &quot;5465465416948&quot;;</div><div><br/></div><div>//生成 Java 中的字符串对象</div><div>//指针的指针</div><div>// env &lt;=&gt; JNINativeInterface** C语言</div><div>return (*env)-&gt;NewStringUTF(env, app_key);</div><div>}</div><div><br/></div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step5: 在MainActivity中获取AppKey, 查看结果 -&gt; 成功</span></div></blockquote><div><br/></div><div>String appKey = NativeHelper.getAppKey();</div><div>Log.d(TAG, &quot;onCreate: appKey =&gt; &quot; + appKey);</div><div><br/></div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">Note: Java 调用C/C++代码</span></div><ol><li>任何一个类的方法, 如果声明了native修饰符, 那么就可以认为是一个C代码;</li></ol></blockquote><ol start="2"><li>可以用对象, 类直接调用</li><li>创建C/C++文件; 如果一个类中有一个native的方法, 那么对应的C方法: Java_包名<span style="font-style: italic;">类名</span>方法名(JNIEnv *env, ...);</li><li>当Java类中包含了native的方法, 那么这个类必须写一个静态初初始化块: System.loadLibrary(&quot;库名&quot;)</li></ol><h3>案例二 实现在C语言中打印log</h3><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">接下来, 只简单介绍核心代码, 不再赘述</span></div></blockquote><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step1: 在com_lulu_ndkdemo_NativeHelper.c中添加:</span></div></blockquote><div>JNIEXPORT void JNICALL</div><div>Java_com_lulu_ndkdemo_NativeHelper_printLog(JNIEnv *env, jclass type, jstring str_) {</div><div>const char *str = (*env)-&gt;GetStringUTFChars(env, str_, 0);</div><div>//TODO: 显示Android 的日志</div><div>// 调用Android的代码</div><div>// 代码需要调用系统的日志库, 这个库已经在 CMakeList.txt添加了e,因此可以直接调用</div><div>const char *tag = &quot;NativeHelper&quot;;</div><div>//jstring -&gt; char*</div><div>jboolean b = JNI_FALSE;</div><div>const char* txt = (*env)-&gt;GetStringUTFChars(env, str_, b);</div><div>//打印log日志</div><div>__android_log_write(ANDROID_LOG_DEBUG, tag, txt);</div><div>//释放string</div><div>(*env)-&gt;ReleaseStringUTFChars(env, str_, str);</div><div>}</div><div><br/></div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step2: NativeHelper中添加</span></div></blockquote><div>//在C中打印logpublic static native void printLog(String str);</div><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">step3: MainActivity中调用</span></div></blockquote><div>//打印C语言中的Log</div><div>NativeHelper.printLog(&quot;测试Log&quot;);</div><h2>完整代码</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">Demo已上传到</span><a href="https://link.jianshu.com/?t=https://github.com/changer0/NDKDemo" style="-en-paragraph:true;">github</a><span style="-en-paragraph:true;">上, 欢迎大家Clone</span></div><h2>小结</h2><blockquote><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">至此, 咱们应该大致了解了一下NDK开发的简单流程, 鄙人菜鸟, 希望抛砖引玉, &quot;引&quot;出更好的文章</span></div></blockquote><div><br/></div><div><br/></div><div>作者：changer0</div><div>链接：<a href="https://www.jianshu.com/p/0261e6cceb3e">https://www.jianshu.com/p/0261e6cceb3e</a></div><div>來源：简书</div><div>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</div></div></span>
</div></body></html> 