<html>
<head>
  <title>深入研究java.lang.ThreadLocal类及其内存泄露问题</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1587"/>
<h1>深入研究java.lang.ThreadLocal类及其内存泄露问题</h1>

<div>
<span><div><div><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 24px; color: rgb(31, 73, 125); font-weight: bold;">个人理解</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(31, 73, 125); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">ThreadLocal版本变化和源码剖析</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">Java Version SE 6</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div>ThreadLocal取消使用SynchronizedMap来存各个线程的变量副本，而是在每个Thread中有一个ThreadLocalMap的变量，然后用Thread.currentThread().threadLocals.get(ThreadLocal)来引用的各线程变量副本，这样避免了去同步全局的Map。简单来说ThreadLocal对象相当于线程私有财产(数据)的经纪人，为线程的私有财产（数据)提供存储和获取的功能</div><div><span style="font-weight: bold; color: rgb(192, 0, 0);">什么好处呢：</span></div><div><span style="font-weight: bold; color: rgb(192, 0, 0);">1.可以减少同步！访问ThreadLocal不需要任何的同步机制 </span></div><div><span style="font-weight: bold; color: rgb(192, 0, 0);">2.当一个线程消亡，那么该线程所绑定的ThreadLocal局部变量也会跟着被回收，简单粗暴</span></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">注意:Thread.currentThread().threadLocals.get(ThreadLocal)没有直接使用ThreadLocal的hashcode,而是一个自定义的hashcode,每个ThreadLocal的HashCode都带有固定间隔</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">public T get() {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        Thread t = Thread.currentThread();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        ThreadLocalMap map = getMap(t);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (map != null) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            ThreadLocalMap.Entry e = map.getEntry(this);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            if (e != null) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">                @SuppressWarnings(&quot;unchecked&quot;)</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">                T result = (T)e.value;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">                return result;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        return setInitialValue();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br/></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    /**</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     * Variant of set() to establish initialValue. Used instead</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     * of set() in case user has overridden the set() method.</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     *</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     * @return the initial value</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     */</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    private T setInitialValue() {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        T value = initialValue();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        Thread t = Thread.currentThread();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        ThreadLocalMap map = getMap(t);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (map != null)</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            map.set(this, value);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        else</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            createMap(t, value);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        return value;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br/></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">Java Version SE 5</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">对ThreadLocal增加remove方法，增加泛型支持</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br/></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">J2SE Version 1.2</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">推出ThreadLocal的初步API,只包括initialValue,get,set三个方法，实现是一个ThreadLocal内部维护一个SynchronizedMap，key为当前的Thread!</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">public class ThreadLocal{</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">private Map values = Collections.synchronizedMap(new HashMap());</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">public Object get(){</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Thread curThread = Thread.currentThread();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Object o = values.get(curThread);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">if (o == null &amp;&amp; !values.containsKey(curThread)){</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">o = initialValue();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">values.put(curThread, o);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">}</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">values.put(Thread.currentThread(), newValue);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">return o ;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">}</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">public Object initialValue(){</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">return null;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">}</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">}</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在这种实现模式下，ThreadLocal实际上就是一个SynchronizedMap的包装</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br/></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px; padding: 0px;"><span style="color: rgb(31, 73, 125); font-weight: bold; font-size: 16px;">老版ThreadLocal的内存泄露问题</span></div><div style="margin: 0px; padding: 0px;"><div>每个ThreadLocal内部维护一个SynchronizedMap，key为当前的Thread，所以当Thread在其它地方的没有引用的时候，但在ThreadLocal当中也还会引用Thread，从而导致Thread对象无法回收。</div><div> </div></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(31, 73, 125); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">新版ThreadLocal的内存泄露问题</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">每个thread中都存在一个map, map的类型是ThreadLocal.ThreadLocalMap. Map中的key为一个ThreadLocal实例引用. 这个Map的确使用了弱引用,不过弱引用只是针对key. 每个key都弱引用指向ThreadLocal. 当把ThreadLocal实例置为null以后,没有任何强引用指向ThreadLocal实例,所以ThreadLocal将会被gc回收. 但是,我们的value却不能回收,因为存在一条从current thread连接过来的强引用. 只有当前thread结束以后, current thread就不会存在栈中,强引用断开, Current Thread, Map, value将全部被GC回收.如图：</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><img src="http://a3.qpic.cn/psb?/V13NpUZg0ne6zL/j4klK3BsGTa93C6.LqlibNSl4zjfAqkcfx862DSnUu4!/b/dOIAAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;t=5&amp;su=088704001&amp;tm=1520352000&amp;sce=0-12-12&amp;rf=2-9" style="margin: 0px; padding: 0px; border-width: 0px; border-style: none; vertical-align: top; width: 714px; height: 403px;"></img></div><div><br/></div><div style="margin: 0px; padding: 0px;">PS.Java为了最小化减少内存泄露的可能性和影响，在ThreadLocal的get,set的时候都会清除线程Map里所有key为null的value（expungeStaleEntries方法，但这个设计得并不完全，没有使用引用队列）。所以最怕的情况就是，threadLocal对象设null了，开始发生“内存泄露”，然后使用线程池，这个线程结束，线程放回线程池中不销毁，这个线程一直不被使用，或者分配使用了又不再调用get,set方法，那么这个期间就会发生真正的内存泄露。</div><div style="margin: 0px; padding: 0px;"><br/></div><div style="margin: 0px; padding: 0px;"><div><br/></div><div><span style="font-weight: bold; color: rgb(31, 73, 125); font-size: 24px;">修改措施</span></div></div><div style="margin: 0px; padding: 0px;"><div>1.老版本的ThreadLocal可以使用被同步装饰的WeakHashMap来解决泄漏问题。</div><div>eg:Collections.synchronizedMap(new WeakHashMap&lt;Thread, T&gt;())</div></div><div style="margin: 0px; padding: 0px;"><div><span style="border: 0px;">但是这种泄漏的修复，必须要调用get和set等方法才能去移除旧值</span></div><div>2.新版本内存泄漏并不是一直存在，会有主动的检查，但是如果所有的ThreadLocal被置为了null（一般不可能），那么这种检查措施也不会被调用。考虑过使用WeakHashMap的原理，使用引用队列来实现expungeStaleEntries方法，但这个方法还是只能在get和set中调用，也无法解决这个问题。最怕的还是TheadLoal放置为null,还使用的是线程池。</div></div></div><div><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"> 和上面的情况是类似的问题</span></div><div><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-size: 24px; color: rgb(31, 73, 125); font-weight: bold;">原文</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 18px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0); font-weight: bold;">深入研究java.lang.ThreadLocal类</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0); font-weight: bold;">一、概述</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal是什么呢？其实ThreadLocal并非是一个线程的本地实现版本，它并不是一个Thread，而是threadlocalvariable(线程局部变量)。也许把它命名为ThreadLocalVar更加合适。线程局部变量(ThreadLocal)其实的功用非常简单，就是为每一个使用该变量的线程都提供一个变量值的副本，是Java中一种较为特殊的线程绑定机制，是每一个线程都可以独立地改变自己的副本，而不会和其它线程的副本冲突。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">从线程的角度看，每个线程都保持一个对其线程局部变量副本的隐式引用，只要线程是活动的并且 ThreadLocal 实例是可访问的；在线程消失之后，其线程局部实例的所有副本都会被垃圾回收（除非存在对这些副本的其他引用）。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">通过ThreadLocal存取的数据，总是与当前线程相关，也就是说，JVM 为每个运行的线程，绑定了私有的本地实例存取空间，从而为多线程环境常出现的并发访问问题提供了一种隔离机制。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal是如何做到为每一个线程维护变量的副本的呢？其实实现的思路很简单，在ThreadLocal类中有一个Map，用于存储每一个线程的变量的副本。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">概括起来说，对于多线程资源共享的问题，同步机制采用了“以时间换空间”的方式，而ThreadLocal采用了“以空间换时间”的方式。前者仅提供一份变量，让不同的线程排队访问，而后者为每一个线程都提供了一份变量，因此可以同时访问而互不影响。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0); font-weight: bold;">二、API说明</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal()</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">          创建一个线程本地变量。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">T get()</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">          返回此线程局部变量的当前线程副本中的值，如果这是线程第一次调用该方法，则创建并初始化此副本。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">protected  T initialValue()</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">          返回此线程局部变量的当前线程的初始值。最多在每次访问线程来获得每个线程局部变量时调用此方法一次，即线程第一次使用 get() 方法访问变量的时候。如果线程先于 get 方法调用 set(T) 方法，则不会在线程中再调用 initialValue 方法。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">   若该实现只返回 null；如果程序员希望将线程局部变量初始化为 null 以外的某个值，则必须为 ThreadLocal 创建子类，并重写此方法。通常，将使用匿名内部类。initialValue 的典型实现将调用一个适当的构造方法，并返回新构造的对象。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">void remove()</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">          移除此线程局部变量的值。这可能有助于减少线程局部变量的存储需求。如果再次访问此线程局部变量，那么在默认情况下它将拥有其 initialValue。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">void set(T value)</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">          将此线程局部变量的当前线程副本中的值设置为指定值。许多应用程序不需要这项功能，它们只依赖于 initialValue() 方法来设置线程局部变量的值。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">在程序中一般都重写initialValue方法，以给定一个特定的初始值。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0); font-weight: bold;">三、典型实例</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">1、Hiberante的Session 工具类HibernateUtil</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">这个类是Hibernate官方文档中HibernateUtil类，用于session管理。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 5px; border-width: 1px; border-style: solid; border-color: rgb(170, 170, 170);"><div style="margin: 0px; padding: 0px;">public class HibernateUtil {</div><div style="margin: 0px; padding: 0px;">    private static Log log = LogFactory.getLog(HibernateUtil.class);</div><div style="margin: 0px; padding: 0px;">    private static final SessionFactory sessionFactory;     //定义SessionFactory</div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    static {</div><div>        try {</div><div>            // 通过默认配置文件hibernate.cfg.xml创建SessionFactory</div><div>            sessionFactory = new Configuration().configure().buildSessionFactory();</div><div>        } catch (Throwable ex) {</div><div>            log.error(&quot;初始化SessionFactory失败！&quot;, ex);</div><div>            throw new ExceptionInInitializerError(ex);</div><div>        }</div><div>    }</div></div><div style="margin: 0px; padding: 0px;"><div><br style="padding: 0px; margin: 0px;"/></div><div>    //创建线程局部变量session，用来保存Hibernate的Session</div><div>    public static final ThreadLocal session = new ThreadLocal();</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    /**</div><div>     * 获取当前线程中的Session</div><div>     * @return Session</div><div>     * @throws HibernateException</div><div>     */</div><div>    public static Session currentSession() throws HibernateException {</div><div>        Session s = (Session) session.get();</div><div>        // 如果Session还没有打开，则新开一个Session</div><div>        if (s == null) {</div><div>            s = sessionFactory.openSession();</div><div>            session.set(s);         //将新开的Session保存到线程局部变量中</div><div>        }</div><div>        return s;</div><div>    }</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    public static void closeSession() throws HibernateException {</div><div>        //获取线程局部变量，并强制转换为Session类型</div><div>        Session s = (Session) session.get();</div><div>        session.set(null);</div><div>        if (s != null)</div><div>            s.close();</div><div>    }</div><div>}</div></div></div></div></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">在这个类中，由于没有重写ThreadLocal的initialValue()方法，则首次创建线程局部变量session其初始值为null，第一次调用currentSession()的时候，线程局部变量的get()方法也为null。因此，对session做了判断，如果为null，则新开一个Session，并保存到线程局部变量session中，这一步非常的关键，这也是“public static final ThreadLocal session = new ThreadLocal()”所创建对象session能强制转换为Hibernate Session对象的原因。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">2、另外一个实例</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">创建一个Bean，通过不同的线程对象设置Bean属性，保证各个线程Bean对象的独立性。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 5px; border-width: 1px; border-style: solid; border-color: rgb(170, 170, 170);"><div style="margin: 0px; padding: 0px;"><div>/**</div><div> * Created by IntelliJ IDEA.</div><div> * User: leizhimin</div><div> * Date: 2007-11-23</div><div> * Time: 10:45:02</div><div> * 学生</div><div> */</div><div>public class Student {</div><div>    private int age = 0;   //年龄</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    public int getAge() {</div><div>        return this.age;</div><div>    }</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    public void setAge(int age) {</div><div>        this.age = age;</div><div>    }</div><div>}</div></div></div></div></div></div></div></div></div></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 5px; border-width: 1px; border-style: solid; border-color: rgb(170, 170, 170);"><div style="margin: 0px; padding: 0px;"><div>/**</div><div> * Created by IntelliJ IDEA.</div><div> * User: leizhimin</div><div> * Date: 2007-11-23</div><div> * Time: 10:53:33</div><div> * 多线程下测试程序</div><div> */</div><div>public class ThreadLocalDemo implements Runnable {</div><div>    //创建线程局部变量studentLocal，在后面你会发现用来保存Student对象</div><div>    private final static ThreadLocal studentLocal = new ThreadLocal();</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    public static void main(String[] agrs) {</div><div>        ThreadLocalDemo td = new ThreadLocalDemo();</div><div>        Thread t1 = new Thread(td, &quot;a&quot;);</div><div>        Thread t2 = new Thread(td, &quot;b&quot;);</div><div>        t1.start();</div><div>        t2.start();</div><div>    }</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    public void run() {</div><div>        accessStudent();</div><div>    }</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    /**</div><div>     * 示例业务方法，用来测试</div><div>     */</div><div>    public void accessStudent() {</div><div>        //获取当前线程的名字</div><div>        String currentThreadName = Thread.currentThread().getName();</div><div>        System.out.println(currentThreadName + &quot; is running!&quot;);</div></div><div style="margin: 0px; padding: 0px;"><div>        //产生一个随机数并打印</div><div>        Random random = new Random();</div><div>        int age = random.nextInt(100);</div><div>        System.out.println(&quot;thread &quot; + currentThreadName + &quot; set age to:&quot; + age);</div></div><div style="margin: 0px; padding: 0px;"><div>        //获取一个Student对象，并将随机数年龄插入到对象属性中</div><div>        Student student = getStudent();</div><div>        student.setAge(age);</div><div>        System.out.println(&quot;thread &quot; + currentThreadName + &quot; first read age is:&quot; + student.getAge());</div><div>        try {</div><div>            Thread.sleep(500);</div><div>        }</div><div>        catch (InterruptedException ex) {</div><div>            ex.printStackTrace();</div><div>        }</div><div>        System.out.println(&quot;thread &quot; + currentThreadName + &quot; second read age is:&quot; + student.getAge());</div><div>    }</div></div><div style="margin: 0px; padding: 0px;"> </div><div style="margin: 0px; padding: 0px;"><div>    protected Student getStudent() {</div><div>        //获取本地线程变量并强制转换为Student类型</div><div>        Student student = (Student) studentLocal.get();</div><div>        //线程首次执行此方法的时候，studentLocal.get()肯定为null</div><div>        if (student == null) {</div><div>            //创建一个Student对象，并保存到本地线程变量studentLocal中</div><div>            student = new Student();</div><div>            studentLocal.set(student);</div><div>        }</div><div>        return student;</div><div>    }</div><div>}</div></div></div></div></div></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">运行结果：</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 4px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); font-size: 10pt; width: 705.594px; color: rgb(0, 0, 0); word-break: break-all; font-family: verdana, 宋体;"><div>a is running! </div><div>thread a set age to:76 </div><div>b is running! </div><div>thread b set age to:27 </div><div>thread a first read age is:76 </div><div>thread b first read age is:27 </div><div>thread a second read age is:76 </div><div>thread b second read age is:27 </div></div></div></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">可以看到a、b两个线程age在不同时刻打印的值是完全相同的。这个程序通过妙用ThreadLocal，既实现多线程并发，游兼顾数据的安全性。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0); font-weight: bold;">四、总结</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal使用场合主要解决多线程中数据数据因并发产生不一致问题。ThreadLocal为每个线程的中并发访问的数据提供一个副本，通过访问副本来运行业务，这样的结果是耗费了内存，单大大减少了线程同步所带来性能消耗，也减少了线程并发控制的复杂度。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal不能使用原子类型，只能使用Object类型。ThreadLocal的使用比synchronized要简单得多。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal和Synchonized都用于解决多线程并发访问。但是ThreadLocal与synchronized有本质的区别。synchronized是利用锁的机制，使变量或代码块在某一时该只能被一个线程访问。而ThreadLocal为每一个线程都提供了变量的副本，使得每个线程在某一时间访问到的并不是同一个对象，这样就隔离了多个线程对数据的数据共享。而Synchronized却正好相反，它用于在多个线程间通信时能够获得数据共享。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">Synchronized用于线程间的数据共享，而ThreadLocal则用于线程间的数据隔离。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">当然ThreadLocal并不能替代synchronized,它们处理不同的问题域。Synchronized用于实现同步机制，比ThreadLocal更加复杂。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0); font-weight: bold;">五、ThreadLocal使用的一般步骤</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">1、在多线程的类（如ThreadDemo类）中，创建一个ThreadLocal对象threadXxx，用来保存线程间需要隔离处理的对象xxx。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">2、在ThreadDemo类中，创建一个获取要隔离访问的数据的方法getXxx()，在方法中判断，若ThreadLocal对象为null时候，应该new()一个隔离访问类型的对象，并强制转换为要应用的类型。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">3、在ThreadDemo类的run()方法中，通过getXxx()方法获取要操作的数据，这样可以保证每个线程对应一个数据对象，在任何时刻都操作的是这个对象。</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"> </span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(255, 0, 0);">参考文档：</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">JDK 官方文档</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><a href="http://www.java3z.com/cwbwebhome/article/article2a/271.html?id=319" style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(67, 67, 67);">[url]http://www.java3z.com/cwbwebhome/article/article2a/271.html?id=319[/url]</a></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);"><a href="http://www.java3z.com/cwbwebhome/article/article2/2952.html?id=1648%5B/url%5D" style="font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(67, 67, 67);">[url]http://www.java3z.com/cwbwebhome/article/article2/2952.html?id=1648[/url]</a></div><div><br style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"/></div><h2 style="margin: 20px 0px 10px; padding: 0px; font-size: 26px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-align: center; word-break: break-word; position: relative; color: rgb(85, 85, 85);"><span style="font-size: 26px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-break: break-word; position: relative; color: rgb(85, 85, 85);">Java进阶（七）正确理解Thread Local的原理与适用场景</span></h2><h1 style="margin: 20px 0px 10px; padding: 0px; font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal解决什么问题</span></h1><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">由于 ThreadLocal 支持范型，如 ThreadLocal&lt; StringBuilder &gt;，为表述方便，后文用 </span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; font-weight: bold; font-style: italic;">变量</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;"> 代表 ThreadLocal 本身，而用 </span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; font-weight: bold; font-style: italic;">实例</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;"> 代表具体类型（如 StringBuidler ）的实例。</span></div><h2 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">不恰当的理解</span></h2><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">写这篇文章的一个原因在于，网上很多博客关于 ThreadLocal 的适用场景以及解决的问题，描述的并不清楚，甚至是错的。下面是常见的对于 ThreadLocal的介绍</span></div><blockquote style="margin: 0px; padding: 0px 15px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(102, 102, 102); border-left: 4px solid rgb(221, 221, 221); font-size: 16px; text-align: justify;"><div style="margin: 0px 0px 25px; padding: 0px;"><div>ThreadLocal为解决多线程程序的并发问题提供了一种新的思路</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">ThreadLocal的目的是为了解决多线程访问资源时的共享问题</span></div></div></blockquote><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">还有很多文章在对比 ThreadLocal 与 synchronize 的异同。既然是作比较，那应该是认为这两者解决相同或类似的问题。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">上面的描述，问题在于，ThreadLocal 并不解决多线程 </span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; font-weight: bold; font-style: italic;">共享</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;"> 变量的问题。既然变量不共享，那就更谈不上同步的问题。</span></div><h2 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">合理的理解</span></h2><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">ThreadLoal 变量，它的基本原理是，同一个 ThreadLocal 所包含的对象（对ThreadLocal&lt; String &gt;而言即为 String 类型变量），在不同的 Thread 中有不同的副本（实际是不同的实例，后文会详细阐述）。这里有几点需要注意</span></div><ul style="margin: 1em 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">因为每个 Thread 内有自己的实例副本，且该副本只能由当前 Thread 使用。这是也是 ThreadLocal 命名的由来</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">既然每个 Thread 有自己的实例副本，且其它 Thread 不可访问，那就不存在多线程间共享的问题</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">既无共享，何来同步问题，又何来解决同步问题一说？</li></ul><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">那 ThreadLocal 到底解决了什么问题，又适用于什么样的场景？</span></div><blockquote style="margin: 0px; padding: 0px 15px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(102, 102, 102); border-left: 4px solid rgb(221, 221, 221); font-size: 16px; text-align: justify;"><div style="margin: 0px 0px 25px; padding: 0px;"><div>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID).</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">Each thread holds an implicit reference to its copy of a thread-local variable as long as the thread is alive and the ThreadLocal instance is accessible; after a thread goes away, all of its copies of thread-local instances are subject to garbage collection (unless other references to these copies exist).</span></div></div></blockquote><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">核心意思是</span></div><blockquote style="margin: 0px; padding: 0px 15px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(102, 102, 102); border-left: 4px solid rgb(221, 221, 221); font-size: 16px; text-align: justify;"><div style="margin: 0px 0px 25px; padding: 0px;">ThreadLocal 提供了线程本地的实例。它与普通变量的区别在于，每个使用该变量的线程都会初始化一个完全独立的实例副本。ThreadLocal 变量通常被<span style="font-size: 13px; word-wrap: break-word; color: rgb(85, 85, 85); border-radius: 3px;">private static</span>修饰。当一个线程结束时，它所使用的所有 ThreadLocal 相对的实例副本都可被回收。</div></blockquote><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">总的来说，</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; font-weight: bold;">ThreadLocal 适用于每个线程需要自己独立的实例且该实例需要在多个方法中被使用，也即变量在线程间隔离而在方法或类间共享的场景。</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">后文会通过实例详细阐述该观点。另外，该场景下，并非必须使用 ThreadLocal ，其它方式完全可以实现同样的效果，只是 ThreadLocal 使得实现更简洁。</span></div><h1 style="margin: 20px 0px 10px; padding: 0px; font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal用法</span></h1><h2 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">实例代码</span></h2><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>下面通过如下代码说明 ThreadLocal 的使用方式</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">10</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">11</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">12</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">13</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">14</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">15</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">16</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">17</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">18</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">19</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">20</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">21</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">22</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">23</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">24</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">25</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">26</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">27</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">28</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">29</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">30</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">31</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">32</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">33</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">34</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">35</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">36</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">37</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">38</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">39</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">40</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">41</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">42</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">43</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">44</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">45</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">46</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">47</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">48</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">49</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">50</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">51</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">52</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">53</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">54</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">55</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">56</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">57</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">58</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">ThreadLocalDemo</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">main</span><span style="height: 20px; color: rgb(245, 135, 31);">(String[] args)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">throws</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">InterruptedException</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">int</span><span style="height: 20px;"> </span><span style="height: 20px;">threads =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(113, 140, 0);">3</span><span style="height: 20px;">;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">CountDownLatch countDownLatch =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">CountDownLatch(threads);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">InnerClass innerClass =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">InnerClass();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">for</span><span style="height: 20px;">(</span><span style="height: 20px; color: rgb(137, 89, 168);">int</span><span style="height: 20px;"> </span><span style="height: 20px;">i =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(113, 140, 0);">1</span><span style="height: 20px;">; i &lt;= threads; i++) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">Thread(() -&gt; {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">for</span><span style="height: 20px;">(</span><span style="height: 20px; color: rgb(137, 89, 168);">int</span><span style="height: 20px;"> </span><span style="height: 20px;">j =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(113, 140, 0);">0</span><span style="height: 20px;">; j &lt;</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(113, 140, 0);">4</span><span style="height: 20px;">; j++) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">innerClass.add(String.valueOf(j));</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">innerClass.print();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">innerClass.set(</span><span style="height: 20px; color: rgb(113, 140, 0);">&quot;hello world&quot;</span><span style="height: 20px;">);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">countDownLatch.countDown();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">},</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(113, 140, 0);">&quot;thread - &quot;</span><span style="height: 20px;"> </span><span style="height: 20px;">+ i).start();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">countDownLatch.await();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">InnerClass</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">add</span><span style="height: 20px; color: rgb(245, 135, 31);">(String newStr)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">StringBuilder str = Counter.counter.get();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.set(str.append(newStr));</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">print</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">System.out.printf(</span><span style="height: 20px; color: rgb(113, 140, 0);">&quot;Thread name:%s , ThreadLocal hashcode:%s, Instance hashcode:%s, Value:%s\n&quot;</span><span style="height: 20px;">,</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread.currentThread().getName(),</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.hashCode(),</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.get().hashCode(),</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.get().toString());</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">set</span><span style="height: 20px; color: rgb(245, 135, 31);">(String words)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.set(</span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">StringBuilder(words));</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">System.out.printf(</span><span style="height: 20px; color: rgb(113, 140, 0);">&quot;Set, Thread name:%s , ThreadLocal hashcode:%s, Instance hashcode:%s, Value:%s\n&quot;</span><span style="height: 20px;">,</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread.currentThread().getName(),</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.hashCode(),</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.get().hashCode(),</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Counter.counter.get().toString());</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">Counter</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px;"> </span><span style="height: 20px;">ThreadLocal&lt;StringBuilder&gt; counter =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">ThreadLocal&lt;StringBuilder&gt;() {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">@Override</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">protected</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">StringBuilder</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">initialValue</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">StringBuilder();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">};</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><h2 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">实例分析</span></h2><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">ThreadLocal本身支持范型。该例使用了 StringBuilder 类型的 ThreadLocal 变量。可通过 ThreadLocal 的 get() 方法读取 StringBuidler 实例，也可通过 set(T t) 方法设置 StringBuilder。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>上述代码执行结果如下</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">10</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">11</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">12</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">13</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">14</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">15</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 1 , ThreadLocal hashcode:372282300, Instance hashcode:418873098, Value:0</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 3 , ThreadLocal hashcode:372282300, Instance hashcode:1609588821, Value:0</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 2 , ThreadLocal hashcode:372282300, Instance hashcode:1780437710, Value:0</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 3 , ThreadLocal hashcode:372282300, Instance hashcode:1609588821, Value:01</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 1 , ThreadLocal hashcode:372282300, Instance hashcode:418873098, Value:01</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 3 , ThreadLocal hashcode:372282300, Instance hashcode:1609588821, Value:012</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 3 , ThreadLocal hashcode:372282300, Instance hashcode:1609588821, Value:0123</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Set, Thread name:thread - 3 , ThreadLocal hashcode:372282300, Instance hashcode:1362597339, Value:hello world</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 2 , ThreadLocal hashcode:372282300, Instance hashcode:1780437710, Value:01</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 1 , ThreadLocal hashcode:372282300, Instance hashcode:418873098, Value:012</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 2 , ThreadLocal hashcode:372282300, Instance hashcode:1780437710, Value:012</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 1 , ThreadLocal hashcode:372282300, Instance hashcode:418873098, Value:0123</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread name:thread - 2 , ThreadLocal hashcode:372282300, Instance hashcode:1780437710, Value:0123</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Set, Thread name:thread - 1 , ThreadLocal hashcode:372282300, Instance hashcode:482932940, Value:hello world</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Set, Thread name:thread - 2 , ThreadLocal hashcode:372282300, Instance hashcode:1691922941, Value:hello world</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">从上面的输出可看出</span></div><ul style="margin: 1em 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">从第1-3行输出可见，每个线程通过 ThreadLocal 的 get() 方法拿到的是不同的 StringBuilder 实例</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">第1-3行输出表明，每个线程所访问到的是同一个 ThreadLocal 变量</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">从7、12、13行输出以及第30行代码可见，虽然从代码上都是对 Counter 类的静态 counter 字段进行 get() 得到 StringBuilder 实例并追加字符串，但是这并不会将所有线程追加的字符串都放进同一个 StringBuilder 中，而是每个线程将字符串追加进各自的 StringBuidler 实例内</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">对比第1行与第15行输出并结合第38行代码可知，使用 set(T t) 方法后，ThreadLocal 变量所指向的 StringBuilder 实例被替换</li></ul><h1 style="margin: 20px 0px 10px; padding: 0px; font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal原理</span></h1><h2 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal维护线程与实例的映射</span></h2><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">既然每个访问 ThreadLocal 变量的线程都有自己的一个“本地”实例副本。一个可能的方案是 ThreadLocal 维护一个 Map，键是 Thread，值是它在该 Thread 内的实例。线程通过该 ThreadLocal 的 get() 方案获取实例时，只需要以线程为键，从 Map 中找出对应的实例即可。该方案如下图所示</span></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;"><div><br/></div><div><a href="http://www.jasongj.com/img/java/threadlocal/VarMap.png"><img src="深入研究java.lang.ThreadLocal类及其内存泄露问题_files/Image.png" type="image/png" data-filename="Image.png" style="margin: 0px; padding: 3px; border-width: 1px; border-style: solid; vertical-align: top; border-color: rgb(221, 221, 221); max-width: 100%; height: auto; cursor: -webkit-zoom-in; box-sizing: border-box; display: block !important;" width="80%"/></a></div></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">该方案可满足上文提到的每个线程内一个独立备份的要求。每个新线程访问该 ThreadLocal 时，需要向 Map 中添加一个映射，而每个线程结束时，应该清除该映射。这里就有两个问题：</span></div><ul style="margin: 1em 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">增加线程与减少线程均需要写 Map，故需保证该 Map 线程安全。虽然<a href="http://www.jasongj.com/java/concurrenthashmap/" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">从ConcurrentHashMap的演进看Java多线程核心技术</a>一文介绍了几种实现线程安全 Map 的方式，但它或多或少都需要锁来保证线程的安全性</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">线程结束时，需要保证它所访问的所有 ThreadLocal 中对应的映射均删除，否则可能会引起内存泄漏。（后文会介绍避免内存泄漏的方法）</li></ul><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">其中锁的问题，是 JDK 未采用该方案的一个原因。</span></div><h2 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">Thread维护ThreadLocal与实例的映射</span></h2><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>上述方案中，出现锁的问题，原因在于多线程访问同一个 Map。如果该 Map 由 Thread 维护，从而使得每个 Thread 只访问自己的 Map，那就不存在多线程写的问题，也就不需要锁。该方案如下图所示。</div></div><div style="margin: 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;"><div><br/></div><div><a href="http://www.jasongj.com/img/java/threadlocal/ThreadMap.png"><img src="深入研究java.lang.ThreadLocal类及其内存泄露问题_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: 0px; padding: 3px; border-width: 1px; border-style: solid; vertical-align: top; border-color: rgb(221, 221, 221); max-width: 100%; height: auto; cursor: -webkit-zoom-in; box-sizing: border-box; display: block !important;" width="70%"/></a></div></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">该方案虽然没有锁的问题，但是由于每个线程访问某 ThreadLocal 变量后，都会在自己的 Map 内维护该 ThreadLocal 变量与具体实例的映射，如果不删除这些引用（映射），则这些 ThreadLocal 不能被回收，可能会造成内存泄漏。后文会介绍 JDK 如何解决该问题。</span></div><h2 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 22px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocal 在 JDK 8 中的实现</span></h2><h3 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">ThreadLocalMap与内存泄漏</span></h3><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>该方案中，Map 由 ThreadLocal 类的静态内部类 ThreadLocalMap 提供。该类的实例维护某个 ThreadLocal 与具体实例的映射。与 HashMap 不同的是，ThreadLocalMap 的每个 Entry 都是一个对 <span style="font-weight: bold; font-style: italic;">键</span> 的弱引用，这一点从<span style="font-size: 13px; word-wrap: break-word; border-radius: 3px;">super(k)</span>可看出。另外，每个 Entry 都包含了一个对 <span style="font-weight: bold; font-style: italic;">值</span> 的强引用。</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">Entry</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">extends</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">WeakReference</span><span style="height: 20px;">&lt;</span><span style="height: 20px; color: rgb(62, 153, 159);">ThreadLocal</span><span style="height: 20px;">&lt;?&gt;&gt;</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; position: relative; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 14px;">/** The value associated with this ThreadLocal. */</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Object value;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Entry(ThreadLocal&lt;?&gt; k, Object v) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">super</span><span style="height: 20px;">(k);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">value = v;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">使用弱引用的原因在于，当没有强引用指向 ThreadLocal 变量时，它可被回收，从而避免上文所述 ThreadLocal 不能被回收而造成的内存泄漏的问题。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">但是，这里又可能出现另外一种内存泄漏的问题。ThreadLocalMap 维护 ThreadLocal 变量与具体实例的映射，当 ThreadLocal 变量被回收后，该映射的键变为 null，该 Entry 无法被移除。从而使得实例被该 Entry 引用而无法被回收造成内存泄漏。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; font-weight: bold; font-style: italic;">注：</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">Entry虽然是弱引用，但它是 ThreadLocal 类型的弱引用（也即上文所述它是对 </span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; font-weight: bold; font-style: italic;">键</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;"> 的弱引用），而非具体实例的的弱引用，所以无法避免具体实例相关的内存泄漏。</span></div><h3 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">读取实例</span></h3><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>读取实例方法如下所示</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">10</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">11</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">12</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">13</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">T</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">get</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread t = Thread.currentThread();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">ThreadLocalMap map = getMap(t);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">if</span><span style="height: 20px;"> </span><span style="height: 20px;">(map !=</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">null</span><span style="height: 20px;">) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">ThreadLocalMap.Entry e = map.getEntry(</span><span style="height: 20px; color: rgb(137, 89, 168);">this</span><span style="height: 20px;">);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">if</span><span style="height: 20px;"> </span><span style="height: 20px;">(e !=</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">null</span><span style="height: 20px;">) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">@SuppressWarnings</span><span style="height: 20px;">(</span><span style="height: 20px; color: rgb(113, 140, 0);">&quot;unchecked&quot;</span><span style="height: 20px;">)</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">T result = (T)e.value;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">result;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">setInitialValue();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>读取实例时，线程首先通过<span style="font-size: 13px; word-wrap: break-word; border-radius: 3px;">getMap(t)</span>方法获取自身的 ThreadLocalMap。从如下该方法的定义可见，该 ThreadLocalMap 的实例是 Thread 类的一个字段，即由 Thread 维护 ThreadLocal 对象与具体实例的映射，这一点与上文分析一致。</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(66, 113, 174);">ThreadLocalMap</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">getMap</span><span style="height: 20px; color: rgb(245, 135, 31);">(Thread t)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">t.threadLocals;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">获取到 ThreadLocalMap 后，通过</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 13px; word-wrap: break-word; border-radius: 3px;">map.getEntry(this)</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">方法获取该 ThreadLocal 在当前线程的 ThreadLocalMap 中对应的 Entry。该方法中的 this 即当前访问的 ThreadLocal 对象。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">如果获取到的 Entry 不为 null，从 Entry 中取出值即为所需访问的本线程对应的实例。如果获取到的 Entry 为 null，则通过</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 13px; word-wrap: break-word; border-radius: 3px;">setInitialValue()</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">方法设置该 ThreadLocal 变量在该线程中对应的具体实例的初始值。</span></div><h3 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">设置初始值</span></h3><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>设置初始值方法如下</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">10</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">T</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">setInitialValue</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">T value = initialValue();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread t = Thread.currentThread();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">ThreadLocalMap map = getMap(t);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">if</span><span style="height: 20px;"> </span><span style="height: 20px;">(map !=</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">null</span><span style="height: 20px;">)</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">map.set(</span><span style="height: 20px; color: rgb(137, 89, 168);">this</span><span style="height: 20px;">, value);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">else</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">createMap(t, value);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">value;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">该方法为 private 方法，无法被重载。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">首先，通过</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 13px; word-wrap: break-word; border-radius: 3px;">initialValue()</span><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">方法获取初始值。该方法为 public 方法，且默认返回 null。所以典型用法中常常重载该方法。上例中即在内部匿名类中将其重载。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">然后拿到该线程对应的 ThreadLocalMap 对象，若该对象不为 null，则直接将该 ThreadLocal 对象与对应实例初始值的映射添加进该线程的 ThreadLocalMap中。若为 null，则先创建该 ThreadLocalMap 对象再将映射添加其中。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">这里并不需要考虑 ThreadLocalMap 的线程安全问题。因为每个线程有且只有一个 ThreadLocalMap 对象，并且只有该线程自己可以访问它，其它线程不会访问该 ThreadLocalMap，也即该对象不会在多个线程中共享，也就不存在线程安全的问题。</span></div><h3 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">设置实例</span></h3><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>除了通过<span style="font-size: 13px; word-wrap: break-word; border-radius: 3px;">initialValue()</span>方法设置实例的初始值，还可通过 set 方法设置线程内实例的值，如下所示。</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">set</span><span style="height: 20px; color: rgb(245, 135, 31);">(T value)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Thread t = Thread.currentThread();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">ThreadLocalMap map = getMap(t);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">if</span><span style="height: 20px;"> </span><span style="height: 20px;">(map !=</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">null</span><span style="height: 20px;">)</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">map.set(</span><span style="height: 20px; color: rgb(137, 89, 168);">this</span><span style="height: 20px;">, value);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">else</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">createMap(t, value);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">该方法先获取该线程的 ThreadLocalMap 对象，然后直接将 ThreadLocal 对象（即代码中的 this）与目标实例的映射添加进 ThreadLocalMap 中。当然，如果映射已经存在，就直接覆盖。另外，如果获取到的 ThreadLocalMap 为 null，则先创建该 ThreadLocalMap 对象。</span></div><h3 style="margin: 20px 0px 10px; padding: 10px 0px 0px; font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 20px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">防止内存泄漏</span></h3><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">对于已经不再被使用且已被回收的 ThreadLocal 对象，它在每个线程内对应的实例由于被线程的 ThreadLocalMap 的 Entry 强引用，无法被回收，可能会造成内存泄漏。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>针对该问题，ThreadLocalMap 的 set 方法中，通过 replaceStaleEntry 方法将所有键为 null 的 Entry 的值设置为 null，从而使得该值可被回收。另外，会在 rehash 方法中通过 expungeStaleEntry 方法将键和值为 null 的 Entry 设置为 null 从而使得该 Entry 可被回收。通过这种方式，ThreadLocal 可防止内存泄漏。</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">10</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">11</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">12</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">13</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">14</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">15</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">16</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">17</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">18</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">19</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">20</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">21</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">set</span><span style="height: 20px; color: rgb(245, 135, 31);">(ThreadLocal&lt;?&gt; key, Object value)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Entry[] tab = table;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">int</span><span style="height: 20px;"> </span><span style="height: 20px;">len = tab.length;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">int</span><span style="height: 20px;"> </span><span style="height: 20px;">i = key.threadLocalHashCode &amp; (len-</span><span style="height: 20px; color: rgb(113, 140, 0);">1</span><span style="height: 20px;">);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">for</span><span style="height: 20px;"> </span><span style="height: 20px;">(Entry e = tab[i]; e !=</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">null</span><span style="height: 20px;">; e = tab[i = nextIndex(i, len)]) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">ThreadLocal&lt;?&gt; k = e.get();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">if</span><span style="height: 20px;"> </span><span style="height: 20px;">(k == key) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">e.value = value;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;">;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">if</span><span style="height: 20px;"> </span><span style="height: 20px;">(k ==</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">null</span><span style="height: 20px;">) {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">replaceStaleEntry(key, value, i);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;">;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">tab[i] =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">Entry(key, value);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">int</span><span style="height: 20px;"> </span><span style="height: 20px;">sz = ++size;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">if</span><span style="height: 20px;"> </span><span style="height: 20px;">(!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">rehash();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><h1 style="margin: 20px 0px 10px; padding: 0px; font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">适用场景</span></h1><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">如上文所述，ThreadLocal 适用于如下两种场景</span></div><ul style="margin: 1em 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">每个线程需要有自己单独的实例</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">实例需要在多个方法中共享，但不希望被多线程共享</li></ul><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">对于第一点，每个线程拥有自己实例，实现它的方式很多。例如可以在线程内部构建一个单独的实例。ThreadLoca 可以以非常方便的形式满足该需求。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">对于第二点，可以在满足第一点（每个线程有自己的实例）的条件下，通过方法间引用传递的形式实现。ThreadLocal 使得代码耦合度更低，且实现更优雅。</span></div><h1 style="margin: 20px 0px 10px; padding: 0px; font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">案例</span></h1><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>对于 Java Web 应用而言，Session 保存了很多信息。很多时候需要通过 Session 获取信息，有些时候又需要修改 Session 的信息。一方面，需要保证每个线程有自己单独的 Session 实例。另一方面，由于很多地方都需要操作 Session，存在多方法共享 Session 的需求。如果不使用 ThreadLocal，可以在每个线程内构建一个 Session实例，并将该实例在多个方法间传递，如下所示。</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">10</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">11</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">12</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">13</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">14</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">15</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">16</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">17</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">18</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">19</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">20</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">21</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">22</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">23</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">24</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">25</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">26</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">27</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">28</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">29</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">30</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">31</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">32</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">33</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">34</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">35</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">36</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">SessionHandler</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">@Data</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">Session</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px;">String id;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px;">String user;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px;">String status;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">Session</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">createSession</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">Session();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">String</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">getUser</span><span style="height: 20px; color: rgb(245, 135, 31);">(Session session)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">session.getUser();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">String</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">getStatus</span><span style="height: 20px; color: rgb(245, 135, 31);">(Session session)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">session.getStatus();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">setStatus</span><span style="height: 20px; color: rgb(245, 135, 31);">(Session session, String status)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">session.setStatus(status);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">main</span><span style="height: 20px; color: rgb(245, 135, 31);">(String[] args)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">Thread(() -&gt; {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">SessionHandler handler =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">SessionHandler();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">Session session = handler.createSession();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.getStatus(session);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.getUser(session);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.setStatus(session,</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(113, 140, 0);">&quot;close&quot;</span><span style="height: 20px;">);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.getStatus(session);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}).start();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">该方法是可以实现需求的。但是每个需要使用 Session 的地方，都需要显式传递 Session 对象，方法间耦合度较高。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><div>这里使用 ThreadLocal 重新实现该功能如下所示。</div></div><table style="border-spacing: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); table-layout: fixed; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"></col><col style="width: 130px;"></col></colgroup><tbody style="margin: 0px; padding: 0px;"><tr style="padding: 0px;"><td style="text-align: left; vertical-align: middle; user-select: none; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">1</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">2</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">3</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">4</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">5</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">6</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">7</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">8</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">9</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">10</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">11</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">12</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">13</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">14</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">15</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">16</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">17</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">18</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">19</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">20</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">21</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">22</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">23</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">24</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">25</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">26</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">27</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">28</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">29</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">30</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">31</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">32</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">33</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">34</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">35</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">36</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">37</span></div></td><td style="text-align: left; vertical-align: middle; width: 130px; padding: 8px; border: 1px solid rgb(204, 204, 204);"><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">SessionHandler</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px;"> </span><span style="height: 20px;">ThreadLocal&lt;Session&gt; session =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">ThreadLocal&lt;Session&gt;();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">@Data</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">class</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(62, 153, 159);">Session</span><span style="height: 20px;"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px;">String id;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px;">String user;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">private</span><span style="height: 20px;"> </span><span style="height: 20px;">String status;</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">createSession</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">session.set(</span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">Session());</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">String</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">getUser</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">session.get().getUser();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(66, 113, 174);">String</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">getStatus</span><span style="height: 20px; color: rgb(245, 135, 31);">()</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">return</span><span style="height: 20px;"> </span><span style="height: 20px;">session.get().getStatus();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">setStatus</span><span style="height: 20px; color: rgb(245, 135, 31);">(String status)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">session.get().setStatus(status);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">public</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">static</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(137, 89, 168);">void</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px; color: rgb(62, 153, 159);">main</span><span style="height: 20px; color: rgb(245, 135, 31);">(String[] args)</span><span style="height: 20px; color: rgb(66, 113, 174);"> </span><span style="height: 20px;">{</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">Thread(() -&gt; {</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">SessionHandler handler =</span><span style="height: 20px;"> </span><span style="height: 20px; color: rgb(137, 89, 168);">new</span><span style="height: 20px;"> </span><span style="height: 20px;">SessionHandler();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.getStatus();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.getUser();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.setStatus(</span><span style="height: 20px; color: rgb(113, 140, 0);">&quot;close&quot;</span><span style="height: 20px;">);</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">handler.getStatus();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}).start();</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div><div style="margin: 0px; padding: 0px; height: 20px;"><span style="height: 20px;">}</span></div></td></tr></tbody></table><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">使用 ThreadLocal 改造后的代码，不再需要在各个方法间传递 Session 对象，并且也非常轻松的保证了每个线程拥有自己独立的实例。</span></div><div style="margin: 0px 0px 25px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px;">如果单看其中某一点，替代方法很多。比如可通过在线程内创建局部变量可实现每个线程有自己的实例，使用静态变量可实现变量在方法间的共享。但如果要同时满足变量在线程间的隔离与方法间的共享，ThreadLocal再合适不过。</span></div><h1 style="margin: 20px 0px 10px; padding: 0px; font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">总结</span></h1><ul style="margin: 1em 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">ThreadLocal 并不解决线程间共享数据的问题</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">ThreadLocal 通过隐式的在不同线程内创建独立实例副本避免了实例线程安全的问题</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">每个线程持有一个 Map 并维护了 ThreadLocal 对象与具体实例的映射，该 Map 由于只被持有它的线程访问，故不存在线程安全以及锁的问题</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">ThreadLocalMap 的 Entry 对 ThreadLocal 的引用为弱引用，避免了 ThreadLocal 对象无法被回收的问题</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">ThreadLocalMap 的 set 方法通过调用 replaceStaleEntry 方法回收键为 null 的 Entry 对象的值（即为具体实例）以及 Entry 对象本身从而防止内存泄漏</li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;">ThreadLocal 适用于变量在线程间隔离且在方法间共享的场景</li></ul><h1 style="margin: 20px 0px 10px; padding: 0px; font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); text-align: justify;"><span style="font-size: 24px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85);">Java进阶系列</span></h1><ul style="margin: 1em 0px; padding: 0px; font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(85, 85, 85); font-size: 16px; text-align: justify;"><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;"><a href="http://www.jasongj.com/2016/01/17/Java1_%E6%B3%A8%E8%A7%A3Annotation/" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">Java进阶（一）Annotation（注解）</a></li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;"><a href="http://www.jasongj.com/java/thread_safe" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">Java进阶（二）当我们说线程安全时，到底在说什么</a></li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;"><a href="http://www.jasongj.com/java/multi_thread" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">Java进阶（三）多线程开发关键技术</a></li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;"><a href="http://www.jasongj.com/java/thread_communication" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">Java进阶（四）线程间通信方式对比</a></li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;"><a href="http://www.jasongj.com/java/nio_reactor/" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">Java进阶（五）NIO和Reactor模式进阶</a></li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;"><a href="http://www.jasongj.com/java/concurrenthashmap/" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">Java进阶（六）从ConcurrentHashMap的演进看Java多线程核心技术</a></li><li style="margin: 0px 0px 0px 40px; padding: 0px; list-style: circle;"><a href="http://www.jasongj.com/java/threadlocal/" style="color: rgb(85, 85, 85); border-bottom: 1px solid rgb(204, 204, 204); word-wrap: break-word;">Java进阶（七）正确理解Thread Local的原理与适用场景</a></li></ul><div><br style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"/></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(31, 73, 125); font-family: punctuation, 微软雅黑, Tohoma; font-size: 24px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">学习文章</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">1.Thread类中的threadLocals 和ThreadLocal原理：</span><a href="http://www.iteye.com/topic/1141743" style="color: rgb(38, 112, 154); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">http://www.iteye.com/topic/1141743</a></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">2.ThreadLocal可能引起的内存泄露：</span><a href="https://www.cnblogs.com/onlywujun/p/3524675.html" style="color: rgb(38, 112, 154); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">https://www.cnblogs.com/onlywujun/p/3524675.html</a></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">3.深入研究java.lang.ThreadLocal类：</span><a href="http://lavasoft.blog.51cto.com/62575/51926/" style="color: rgb(38, 112, 154); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">http://lavasoft.blog.51cto.com/62575/51926/</a></div><div><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">4.Java进阶（七）正确理解Thread Local的原理与适用场景</span><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"> </span><a href="http://www.jasongj.com/java/threadlocal/" style="color: rgb(38, 112, 154); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">http://www.jasongj.com/java/threadlocal/</a></div></div></span>
</div></body></html> 