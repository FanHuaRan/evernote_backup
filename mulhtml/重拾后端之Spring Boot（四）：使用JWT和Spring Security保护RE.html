<html>
<head>
  <title>重拾后端之Spring Boot（四）：使用JWT和Spring Security保护REST API</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1211"/>
<h1>重拾后端之Spring Boot（四）：使用JWT和Spring Security保护REST API</h1>

<div>
<span><div><h1 style="box-sizing: border-box; font-size: 34px; margin: 20px 0px 0px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-break: break-word !important;"><span style="box-sizing: border-box; font-size: 34px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-break: break-word !important; color: rgb(51, 51, 51); font-family: -apple-system, &quot;SF UI Display&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 1.3;">重拾后端之Spring Boot（四）：使用JWT和Spring Security保护REST API</span></h1><div style="box-sizing: border-box; margin: 30px 0px 40px; font-size: 17px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><a href="https://www.jianshu.com/u/4f189e9f909c" style="font-size: 17px; font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" style="box-sizing: border-box; border: 1px solid rgb(221, 221, 221); vertical-align: middle; width: 48px; height: 48px; border-radius: 50%;"/></a><span style="font-size: 17px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span></div><div><a href="https://www.jianshu.com/u/4f189e9f909c" style="box-sizing: border-box; vertical-align: middle; font-size: 16px; cursor: pointer; color: rgb(51, 51, 51); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">接灰的电子产品</a><span style="box-sizing: border-box; vertical-align: middle; font-size: 17px; color: rgb(51, 51, 51); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="box-sizing: border-box; vertical-align: middle; background-color: rgb(66, 192, 46); cursor: pointer; touch-action: manipulation; background-image: none; border: 1px solid rgb(66, 192, 46); white-space: nowrap; font-size: 12px; border-radius: 40px; user-select: none; color: rgb(255, 255, 255); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: normal;">关注</span></div><div style="box-sizing: border-box; margin-top: 5px; font-size: 12px;"><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">2017.03.10 20:39*</span><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">字数 4519</span><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">阅读 50882</span><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">评论 144</span><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">喜欢 262</span><span style="box-sizing: border-box; font-size: 12px; vertical-align: middle; color: rgb(150, 150, 150); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">赞赏 2</span></div></div><div style="box-sizing: border-box;"><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><div><a href="https://www.jianshu.com/p/4e25e25b62c2" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（一）：REST API的搭建可以这样简单</a></div><div><a href="https://www.jianshu.com/p/fe3b9532b852" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（二）：MongoDb的无缝集成</a></div><div><a href="https://www.jianshu.com/p/06376b97b11e" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（三）：找回熟悉的Controller，Service</a></div><div><a href="https://www.jianshu.com/p/6307c89fe3fa" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（四）：使用 JWT 和 Spring Security 保护 REST API</a></div><div><a href="https://www.jianshu.com/p/4ef9881090ec" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（五）：跨域、自定义查询及分页</a></div><div style="margin-top: 1em; margin-bottom: 1em;"><a href="https://www.jianshu.com/p/ac4c00a63750" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);-en-paragraph:true;">重拾后端之Spring Boot（六）：热加载、容器和多项目</a></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">通常情况下，把API直接暴露出去是风险很大的，不说别的，直接被机器攻击就喝一壶的。那么一般来说，对API要划分出一定的权限级别，然后做一个用户的鉴权，依据鉴权结果给予用户开放对应的API。目前，比较主流的方案有几种:</span></div><ol style="box-sizing: border-box; margin: -5px 0px 20px 20px; word-break: break-word !important; padding: 0px;"><li style="box-sizing: border-box;"><span style="line-height: 30px;">用户名和密码鉴权，使用Session保存用户鉴权结果。</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">使用OAuth进行鉴权（其实OAuth也是一种基于Token的鉴权，只是没有规定Token的生成方式）</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">自行采用Token进行鉴权</span></li></ol><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">第一种就不介绍了，由于依赖Session来维护状态，也不太适合移动时代，新的项目就不要采用了。第二种OAuth的方案和JWT都是基于Token的，但OAuth其实对于不做开放平台的公司有些过于复杂。我们主要介绍第三种：JWT。</span></div><h2 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 24px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 24px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">什么是JWT？</span></h2><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">JWT是</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">Json Web Token</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">的缩写。它是基于</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=https://tools.ietf.org/html/rfc7519" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">RFC 7519</a><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">标准定义的一种可以安全传输的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important; font-weight: bold;">小巧</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">和</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important; font-weight: bold;">自包含</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">的JSON对象。由于数据是使用数字签名的，所以是可信任的和安全的。JWT可以使用HMAC算法对secret进行加密或者使用RSA的公钥私钥对来进行签名。</span></div><h3 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 22px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 22px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">JWT的工作流程</span></h3><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">下面是一个JWT的工作流程图。模拟一下实际的流程是这样的（假设受保护的API在</span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">/protected</span><span style="box-sizing: border-box; word-break: break-word !important;">中）</span></div><ol style="box-sizing: border-box; margin: -5px 0px 20px 20px; word-break: break-word !important; padding: 0px;"><li style="box-sizing: border-box;"><span style="line-height: 30px;">用户导航到登录页，输入用户名、密码，进行登录</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">服务器验证登录鉴权，如果改用户合法，根据用户的信息和服务器的规则生成JWT Token</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">服务器将该token以json形式返回（不一定要json形式，这里说的是一种常见的做法）</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">用户得到token，存在localStorage、cookie或其它数据存储形式中。</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">以后用户请求</span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 30px;">/protected</span><span style="line-height: 30px;">中的API时，在请求的header中加入 </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 30px;">Authorization: Bearer xxxx(token)</span><span style="line-height: 30px;">。此处注意token之前有一个7字符长度的 </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 30px;">Bearer</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">服务器端对此token进行检验，如果合法就解析其中内容，根据其拥有的权限和自己的业务逻辑给出对应的响应结果。</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">用户取得结果</span></li></ol><div style="box-sizing: border-box; padding-bottom: 25px; width: 700px; margin-left: -40px; text-align: center;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image.png" type="image/png" data-filename="Image.png" style="box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; height: auto; cursor: zoom-in; transition: all 0.25s ease-in-out;"/><span style="box-sizing: border-box; width: 700px; min-width: 20%; max-width: 80%; min-height: 22px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150); line-height: 1.7;">JWT工作流程图</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">为了更好的理解这个token是什么，我们先来看一个token生成后的样子，下面那坨乱糟糟的就是了。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><span style="box-sizing: border-box; overflow: auto; font-size: 12px; word-wrap: normal; background: rgb(246, 246, 246); border: none; border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">eyJhbGciOiJIUzUxMiJ9</span><span style="box-sizing: border-box; overflow: auto; font-size: 12px; word-wrap: normal; background: rgb(246, 246, 246); border: none; border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.eyJzdWIiOiJ3YW5nIiwiY3JlYXRlZCI6MTQ4OTA3OTk4MTM5MywiZXhwIjoxNDg5Njg0NzgxfQ</span><span style="box-sizing: border-box; overflow: auto; font-size: 12px; word-wrap: normal; background: rgb(246, 246, 246); border: none; border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.RC-BYCe_UZ2URtWddUpWXIp4NMsoeq2O6UF-8tVplqXY1-CI9u1-a-9DAAJGfNWkHE81mpnR3gXzfrBAB3WUAg</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">但仔细看到的话还是可以看到这个token分成了三部分，每部分用</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">.</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">分隔，每段都是用</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=https://en.wikipedia.org/wiki/Base64" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">Base64</a><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">编码的。如果我们用一个Base64的解码器的话 （</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=https://www.base64decode.org/" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">https://www.base64decode.org/</a><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">），可以看到第一部分</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">eyJhbGciOiJIUzUxMiJ9</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">被解析成了:</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;alg&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;HS512&quot;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">这是告诉我们HMAC采用HS512算法对JWT进行的签名。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">第二部分</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">eyJzdWIiOiJ3YW5nIiwiY3JlYXRlZCI6MTQ4OTA3OTk4MTM5MywiZXhwIjoxNDg5Njg0NzgxfQ</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">被解码之后是</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;sub&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;wang&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;created&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">1489079981393</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;exp&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">1489684781</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">这段告诉我们这个Token中含有的数据声明（Claim），这个例子里面有三个声明：</span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">sub</span><span style="box-sizing: border-box; word-break: break-word !important;">,</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">created</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">和</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">exp</span><span style="box-sizing: border-box; word-break: break-word !important;">。在我们这个例子中，分别代表着用户名、创建时间和过期时间，当然你可以把任意数据声明在这里。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">看到这里，你可能会想这是个什么鬼token，所有信息都透明啊，安全怎么保障？别急，我们看看token的第三段</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">RC-BYCe_UZ2URtWddUpWXIp4NMsoeq2O6UF-8tVplqXY1-CI9u1-a-9DAAJGfNWkHE81mpnR3gXzfrBAB3WUAg</span><span style="box-sizing: border-box; word-break: break-word !important;">。同样使用Base64解码之后，咦，这是什么东东</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">D X �DmYTeȧL�UZcPZ0</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">$gZAY</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">�_7�wY@</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">最后一段其实是签名，这个签名必须知道秘钥才能计算。这个也是JWT的安全保障。这里提一点注意事项，由于数据声明（Claim）是公开的，千万不要把密码等敏感字段放进去，否则就等于是公开给别人了。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">也就是说JWT是由三段组成的，按官方的叫法分别是header（头）、payload（负载）和signature（签名）：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><span style="box-sizing: border-box; overflow: auto; font-size: 12px; word-wrap: normal; background: rgb(246, 246, 246); border: none; border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">header</span><span style="box-sizing: border-box; overflow: auto; font-size: 12px; word-wrap: normal; background: rgb(246, 246, 246); border: none; border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.payload</span><span style="box-sizing: border-box; overflow: auto; font-size: 12px; word-wrap: normal; background: rgb(246, 246, 246); border: none; border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.signature</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">头中的数据通常包含两部分：一个是我们刚刚看到的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">alg</span><span style="box-sizing: border-box; word-break: break-word !important;">，这个词是</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">algorithm</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">的缩写，就是指明算法。另一个可以添加的字段是token的类型(按RFC 7519实现的token机制不只JWT一种)，但如果我们采用的是JWT的话，指定这个就多余了。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;alg&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;HS512&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;typ&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;JWT&quot;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">payload中可以放置三类数据：系统保留的、公共的和私有的：</span></div><ul style="box-sizing: border-box; margin: -5px 0px 20px 20px; padding: 0px; word-break: break-word !important;"><li style="box-sizing: border-box;"><span style="line-height: 30px;">系统保留的声明（Reserved claims）：这类声明不是必须的，但是是建议使用的，包括：iss (签发者), exp (过期时间),</span><br/><span style="line-height: 30px;">sub (主题), aud (目标受众)等。这里我们发现都用的缩写的三个字符，这是由于JWT的目标就是尽可能小巧。</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">公共声明：这类声明需要在 </span><a href="https://link.jianshu.com/?t=http://www.iana.org/assignments/jwt/jwt.xhtml" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208); line-height: 30px;">IANA JSON Web Token Registry</a><span style="line-height: 30px;"> 中定义或者提供一个URI，因为要避免重名等冲突。</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">私有声明：这个就是你根据业务需要自己定义的数据了。</span></li></ul><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">签名的过程是这样的：采用header中声明的算法，接受三个参数：base64编码的header、base64编码的payload和秘钥（secret）进行运算。签名这一部分如果你愿意的话，可以采用RSASHA256的方式进行公钥、私钥对的方式进行，如果安全性要求的高的话。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">HMACSHA256(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">base64UrlEncode(header) +</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;.&quot;</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">+</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">base64UrlEncode(payload),</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">secret)</span></div></div><h3 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 22px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 22px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">JWT的生成和解析</span></h3><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">为了简化我们的工作，这里引入一个比较成熟的JWT类库，叫</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">jjwt</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">(</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=https://github.com/jwtk/jjwt" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">https://github.com/jwtk/jjwt</a><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">)。这个类库可以用于Java和Android的JWT token的生成和验证。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">JWT的生成可以使用下面这样的代码完成：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">generateToken</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(Map&lt;String, Object&gt; claims)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Jwts.builder()</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.setClaims(claims)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.setExpiration(generateExpirationDate())</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.signWith(SignatureAlgorithm.HS512, secret)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">//采用什么算法是可以自己选择的，不一定非要采用HS512</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.compact();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">数据声明（Claim）其实就是一个Map，比如我们想放入用户名，可以简单的创建一个Map然后put进去就可以了。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Map&lt;String, Object&gt; claims =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">HashMap&lt;&gt;();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">claims.put(CLAIM_KEY_USERNAME, username());</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">解析也很简单，利用</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">jjwt</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">提供的parser传入秘钥，然后就可以解析token了。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Claims</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">getClaimsFromToken</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(String token)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Claims claims;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">try</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">claims = Jwts.parser()</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.setSigningKey(secret)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.parseClaimsJws(token)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.getBody();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">catch</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(Exception e) {</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">claims =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">claims;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">JWT本身没啥难度，但安全整体是一个比较复杂的事情，JWT只不过提供了一种基于token的请求验证机制。但我们的用户权限，对于API的权限划分、资源的权限划分，用户的验证等等都不是JWT负责的。也就是说，请求验证后，你是否有权限看对应的内容是由你的用户角色决定的。所以我们这里要利用Spring的一个子项目Spring Security来简化我们的工作。</span></div><h2 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 24px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 24px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">Spring Security</span></h2><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">Spring Security是一个基于Spring的通用安全框架，里面内容太多了，本文的主要目的也不是展开讲这个框架，而是如何利用Spring Security和JWT一起来完成API保护。所以关于Spring Secruity的基础内容或展开内容，请自行去官网学习（</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=http://projects.spring.io/spring-security/" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">http://projects.spring.io/spring-security/</a><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">）。</span></div><h3 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 22px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 22px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">简单的背景知识</span></h3><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">如果你的系统有用户的概念的话，一般来说，你应该有一个用户表，最简单的用户表，应该有三列：Id，Username和Password，类似下表这种</span></div><table style="box-sizing: border-box; border-spacing: 0px; background-color: transparent; word-break: normal; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 207px;"></col><col style="width: 207px;"></col><col style="width: 207px;"></col></colgroup><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; text-align: inherit; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 207px; padding: 8px;"><div><span style="font-weight: 700; line-height: 20px;">ID</span></div></td><td style="box-sizing: border-box; text-align: inherit; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 207px; padding: 8px;"><div><span style="font-weight: 700; line-height: 20px;">USERNAME</span></div></td><td style="box-sizing: border-box; text-align: inherit; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 207px; padding: 8px;"><div><span style="font-weight: 700; line-height: 20px;">PASSWORD</span></div></td></tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 207px; padding: 8px;"><div><span style="line-height: 20px;">10</span></div></td><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 207px; padding: 8px;"><div><span style="line-height: 20px;">wang</span></div></td><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 207px; padding: 8px;"><div><span style="line-height: 20px;">abcdefg</span></div></td></tr></tbody></table><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">而且不是所有用户都是一种角色，比如网站管理员、供应商、财务等等，这些角色和网站的直接用户需要的权限可能是不一样的。那么我们就需要一个角色表：</span></div><table style="box-sizing: border-box; border-spacing: 0px; background-color: transparent; word-break: normal; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 310px;"></col><col style="width: 310px;"></col></colgroup><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; text-align: inherit; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="font-weight: 700; line-height: 20px;">ID</span></div></td><td style="box-sizing: border-box; text-align: inherit; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="font-weight: 700; line-height: 20px;">ROLE</span></div></td></tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">10</span></div></td><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">USER</span></div></td></tr><tr style="box-sizing: border-box; background-color: rgba(181, 181, 181, 0.098);"><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">20</span></div></td><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">ADMIN</span></div></td></tr></tbody></table><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">当然我们还需要一个可以将用户和角色关联起来建立映射关系的表。</span></div><table style="box-sizing: border-box; border-spacing: 0px; background-color: transparent; word-break: normal; border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 310px;"></col><col style="width: 310px;"></col></colgroup><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; text-align: inherit; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="font-weight: 700; line-height: 20px;">USER_ID</span></div></td><td style="box-sizing: border-box; text-align: inherit; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="font-weight: 700; line-height: 20px;">ROLE_ID</span></div></td></tr><tr style="box-sizing: border-box;"><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">10</span></div></td><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">10</span></div></td></tr><tr style="box-sizing: border-box; background-color: rgba(181, 181, 181, 0.098);"><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">20</span></div></td><td style="box-sizing: border-box; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 310px; padding: 8px;"><div><span style="line-height: 20px;">20</span></div></td></tr></tbody></table><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">这是典型的一个关系型数据库的用户角色的设计，由于我们要使用的MongoDB是一个文档型数据库，所以让我们重新审视一下这个结构。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">这个数据结构的优点在于它避免了数据的冗余，每个表负责自己的数据，通过关联表进行关系的描述，同时也保证的数据的完整性：比如当你修改角色名称后，没有脏数据的产生。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">但是这种事情在用户权限这个领域发生的频率到底有多少呢？有多少人每天不停的改的角色名称？当然如果你的业务场景确实是需要保证数据完整性，你还是应该使用关系型数据库。但如果没有高频的对于角色表的改动，其实我们是不需要这样的一个设计的。在MongoDB中我们可以将其简化为</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">_id: &lt;id_generated&gt;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">username: 'user',</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">password: 'pass',</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">roles: ['USER', 'ADMIN']</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">基于以上考虑，我们重构一下</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">User</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">类，</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Data</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">User</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Id</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String id;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Indexed</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(unique=</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">, direction= IndexDirection.DESCENDING, dropDups=</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String username;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String password;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String email;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Date lastPasswordResetDate;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">List&lt;String&gt; roles;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">当然你可能发现这个类有点怪，只有一些field，这个简化的能力是一个叫</span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">lombok</span><span style="box-sizing: border-box; word-break: break-word !important;">类库提供的 ，这个很多开发过Android的童鞋应该熟悉，是用来简化POJO的创建的一个类库。简单说一下，采用</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">lombok</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">提供的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">@Data</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">修饰符后可以简写成，原来的一坨getter和setter以及constructor等都不需要写了。类似的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">Todo</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">可以改写成：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Data</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Todo</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Id</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String id;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String desc;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">boolean</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">completed;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">User user;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">增加这个类库只需在</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">build.gradle</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">中增加下面这行</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">dependencies</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 省略其它依赖</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">compile</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;org.projectlombok:lombok:${lombokVersion}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><h3 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 22px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 22px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">引入Spring Security</span></h3><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">要在Spring Boot中引入Spring Security非常简单，修改</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">build.gradle</span><span style="box-sizing: border-box; word-break: break-word !important;">，增加一个引用</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">org.springframework.boot:spring-boot-starter-security</span><span style="box-sizing: border-box; word-break: break-word !important;">：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">dependencies</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">compile</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;org.springframework.boot:spring-boot-starter-data-rest&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">compile</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;org.springframework.boot:spring-boot-starter-data-mongodb&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">compile</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;org.springframework.boot:spring-boot-starter-security&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">compile</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;io.jsonwebtoken:jjwt:${jjwtVersion}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">compile</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;org.projectlombok:lombok:${lombokVersion}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">testCompile(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;org.springframework.boot:spring-boot-starter-test&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">你可能发现了，我们不只增加了对Spring Security的编译依赖，还增加</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">jjwt</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">的依赖。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">Spring Security需要我们实现几个东西，第一个是UserDetails：这个接口中规定了用户的几个必须要有的方法，所以我们创建一个JwtUser类来实现这个接口。为什么不直接使用User类？因为这个UserDetails完全是为了安全服务的，它和我们的领域类可能有部分属性重叠，但很多的接口其实是安全定制的，所以最好新建一个类：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUser</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">implements</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetails</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String id;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String username;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String password;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String email;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Collection&lt;? extends GrantedAuthority&gt; authorities;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Date lastPasswordResetDate;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUser</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String id,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String username,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String password,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String email,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Collection&lt;? extends GrantedAuthority&gt; authorities,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Date lastPasswordResetDate)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.id = id;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.username = username;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.password = password;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.email = email;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.authorities = authorities;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.lastPasswordResetDate = lastPasswordResetDate;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">//返回分配给用户的角色列表</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authorities;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@JsonIgnore</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">getId</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">id;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@JsonIgnore</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">getPassword</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">password;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">getUsername</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">username;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 账户是否未过期</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@JsonIgnore</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">boolean</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">isAccountNonExpired</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 账户是否未锁定</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@JsonIgnore</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">boolean</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">isAccountNonLocked</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 密码是否未过期</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@JsonIgnore</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">boolean</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">isCredentialsNonExpired</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 账户是否激活</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@JsonIgnore</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">boolean</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">isEnabled</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 这个是自定义的，返回上次密码重置日期</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@JsonIgnore</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Date</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">getLastPasswordResetDate</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">lastPasswordResetDate;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">这个接口中规定的很多方法我们都简单粗暴的设成直接返回某个值了，这是为了简单起见，你在实际开发环境中还是要根据具体业务调整。当然由于两个类还是有一定关系的，为了写起来简单，我们写一个工厂类来由领域对象创建</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">JwtUser</span><span style="box-sizing: border-box; word-break: break-word !important;">，这个工厂就叫</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">JwtUserFactory</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">吧：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUserFactory</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUserFactory</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">static</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUser</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">create</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(User user)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUser(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">user.getId(),</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">user.getUsername(),</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">user.getPassword(),</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">user.getEmail(),</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">mapToGrantedAuthorities(user.getRoles()),</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">user.getLastPasswordResetDate()</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">static</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">List&lt;GrantedAuthority&gt;</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">mapToGrantedAuthorities</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(List&lt;String&gt; authorities)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authorities.stream()</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.map(SimpleGrantedAuthority::</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.collect(Collectors.toList());</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">第二个要实现的是</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">UserDetailsService</span><span style="box-sizing: border-box; word-break: break-word !important;">，这个接口只定义了一个方法</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">loadUserByUsername</span><span style="box-sizing: border-box; word-break: break-word !important;">，顾名思义，就是提供一种从用户名可以查到用户并返回的方法。注意，不一定是数据库哦，文本文件、xml文件等等都可能成为数据源，这也是为什么Spring提供这样一个接口的原因：保证你可以采用灵活的数据源。接下来我们建立一个</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">JwtUserDetailsServiceImpl</span><span style="box-sizing: border-box; word-break: break-word !important;">来实现这个接口。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Service</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUserDetailsServiceImpl</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">implements</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetailsService</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserRepository userRepository;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetails</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">loadUserByUsername</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(String username)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UsernameNotFoundException</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">User user = userRepository.findByUsername(username);</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">if</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(user ==</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">) {</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throw</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UsernameNotFoundException(String.format(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;No user found with username '%s'.&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">, username));</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">else</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUserFactory.create(user);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">为了让Spring可以知道我们想怎样控制安全性，我们还需要建立一个安全配置类</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">WebSecurityConfig</span><span style="box-sizing: border-box; word-break: break-word !important;">：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Configuration</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@EnableWebSecurity</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@EnableGlobalMethodSecurity</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(prePostEnabled =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">WebSecurityConfig</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">extends</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">WebSecurityConfigurerAdapter</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// Spring会自动寻找同样类型的具体类注入，这里就是JwtUserDetailsServiceImpl了</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetailsService userDetailsService;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">void</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">configureAuthentication</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(AuthenticationManagerBuilder authenticationManagerBuilder)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Exception</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authenticationManagerBuilder</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 设置UserDetailsService</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.userDetailsService(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.userDetailsService)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 使用BCrypt进行密码的hash</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.passwordEncoder(passwordEncoder());</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 装载BCrypt密码编码器</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Bean</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">PasswordEncoder</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">passwordEncoder</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">BCryptPasswordEncoder();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">protected</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">void</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">configure</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(HttpSecurity httpSecurity)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Exception</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">httpSecurity</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 由于使用的是JWT，我们这里不需要csrf</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.csrf().disable()</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 基于token，所以不需要session</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.authorizeRequests()</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">//.antMatchers(HttpMethod.OPTIONS, &quot;/**&quot;).permitAll()</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 允许对于网站静态资源的无授权访问</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.antMatchers(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">HttpMethod.GET,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/*.html&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/favicon.ico&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/**/*.html&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/**/*.css&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/**/*.js&quot;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">).permitAll()</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 对于获取token的rest api要允许匿名访问</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.antMatchers(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/auth/**&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">).permitAll()</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 除上面外的所有请求全部需要鉴权认证</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.anyRequest().authenticated();</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 禁用缓存</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">httpSecurity.headers().cacheControl();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">接下来我们要规定一下哪些资源需要什么样的角色可以访问了，在</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">UserController</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">加一个修饰符</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">@PreAuthorize(&quot;hasRole('ADMIN')&quot;)</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">表示这个资源只能被拥有</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">ADMIN</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">角色的用户访问。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">/**</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">* 在</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@PreAuthorize</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">中我们可以利用内建的 SPEL 表达式：比如 'hasRole()' 来决定哪些用户有权访问。</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">* 需注意的一点是 hasRole 表达式认为每个角色名字前都有一个前缀 'ROLE_'。所以这里的 'ADMIN' 其实在</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">* 数据库中存储的是 'ROLE_ADMIN' 。这个</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@PreAuthorize</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">可以修饰Controller也可修饰Controller中的方法。</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">**/</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RestController</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestMapping</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/users&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@PreAuthorize</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;hasRole('ADMIN')&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserController</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserRepository repository;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestMapping</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(method = RequestMethod.GET)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">List&lt;User&gt;</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">getUsers</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">repository.findAll();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 略去其它部分</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">类似的我们给</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">TodoController</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">加上</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">@PreAuthorize(&quot;hasRole('USER')&quot;)</span><span style="box-sizing: border-box; word-break: break-word !important;">，标明这个资源只能被拥有</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">USER</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">角色的用户访问：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RestController</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestMapping</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/todos&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@PreAuthorize</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;hasRole('USER')&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">TodoController</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 略去</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><h3 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 22px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 22px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">使用application.yml配置SpringBoot应用</span></h3><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">现在应该Spring Security可以工作了，但为了可以更清晰的看到工作日志，我们希望配置一下，在和</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">src</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">同级建立一个config文件夹，在这个文件夹下面新建一个</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">application.yml</span><span style="box-sizing: border-box; word-break: break-word !important;">。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;"># Server configuration</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">server:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">port: 8090</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">contextPath:</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;"># Spring configuration</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">spring:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">jackson:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">serialization:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">INDENT_OUTPUT:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">true</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">data.mongodb:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">host: localhost</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">port: 27017</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">database: springboot</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;"># Logging configuration</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">logging:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">level:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">org.springframework:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">data: DEBUG</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">security: DEBUG</span></div><div><br/></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">我们除了配置了logging的一些东东外，也顺手设置了数据库和http服务的一些配置项，现在我们的服务器会在8090端口监听，而spring data和security的日志在debug模式下会输出到console。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">现在启动服务后，访问</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important;"><a href="http://localhost:8090/" style="background-color: rgb(246, 246, 246); font-size: 12px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">http://localhost:8090</a></span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">你可以看到根目录还是正常显示的</span></div><div style="box-sizing: border-box; padding-bottom: 25px; width: 700px; margin-left: -40px; text-align: center;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image [1].png" type="image/png" data-filename="Image.png" style="box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; height: auto; cursor: zoom-in; transition: all 0.25s ease-in-out;"/><span style="box-sizing: border-box; width: 700px; min-width: 20%; max-width: 80%; min-height: 22px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150); line-height: 1.7;">根目录还是正常可以访问的</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">但我们试一下</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important;"><a href="http://localhost:8090/users" style="background-color: rgb(246, 246, 246); font-size: 12px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">http://localhost:8090/users</a></span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">，观察一下console，我们会看到如下的输出，告诉由于用户未鉴权，我们访问被拒绝了。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">2017</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">-03-10</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">15</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:51</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:53.351</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">DEBUG</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">57599</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">---</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">[nio-8090-exec-4]</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">o</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.s</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.s</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.w</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.a</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.ExceptionTranslationFilter</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Access</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">is</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">denied</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">user</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">is</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">anonymous</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">);</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">redirecting</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">to</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authentication</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">entry</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">point</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">org</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.springframework</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.security</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.access</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.AccessDeniedException</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Access</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">is</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">denied</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">at</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">org</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.springframework</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.security</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.access</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.vote</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.AffirmativeBased</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.decide</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AffirmativeBased</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.java</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:84)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">~</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">[spring-security-core-4.2.1.RELEASE.jar:4.2.1.RELEASE]</span></div></div><h2 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 24px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 24px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">集成JWT和Spring Security</span></h2><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">到现在，我们还是让JWT和Spring Security各自为战，并没有集成起来。要想要JWT在Spring中工作，我们应该新建一个filter，并把它配置在</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">WebSecurityConfig</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">中。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Component</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtAuthenticationTokenFilter</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">extends</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">OncePerRequestFilter</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetailsService userDetailsService;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtTokenUtil jwtTokenUtil;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Value</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;${jwt.header}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String tokenHeader;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Value</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;${jwt.tokenHead}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String tokenHead;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">protected</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">void</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">doFilterInternal</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">HttpServletRequest request,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">HttpServletResponse response,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">FilterChain chain)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">ServletException, IOException</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String authHeader = request.getHeader(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.tokenHeader);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">if</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(authHeader !=</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&amp;&amp; authHeader.startsWith(tokenHead)) {</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String authToken = authHeader.substring(tokenHead.length());</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// The part after &quot;Bearer &quot;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String username = jwtTokenUtil.getUsernameFromToken(authToken);</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">logger.info(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;checking authentication &quot;</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">+ username);</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">if</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(username !=</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&amp;&amp; SecurityContextHolder.getContext().getAuthentication() ==</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">) {</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetails userDetails =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.userDetailsService.loadUserByUsername(username);</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">if</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(jwtTokenUtil.validateToken(authToken, userDetails)) {</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UsernamePasswordAuthenticationToken authentication =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UsernamePasswordAuthenticationToken(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">userDetails,</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">, userDetails.getAuthorities());</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authentication.setDetails(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">WebAuthenticationDetailsSource().buildDetails(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">request));</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">logger.info(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;authenticated user &quot;</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">+ username +</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;, setting security context&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">SecurityContextHolder.getContext().setAuthentication(authentication);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">chain.doFilter(request, response);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">事实上如果我们足够相信token中的数据，也就是我们足够相信签名token的secret的机制足够好，这种情况下，我们可以不用再查询数据库，而直接采用token中的数据。本例中，我们还是通过Spring Security的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">@UserDetailsService</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">进行了数据查询，但简单验证的话，你可以采用直接验证token是否合法来避免昂贵的数据查询。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">接下来，我们会在</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">WebSecurityConfig</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">中注入这个filter，并且配置到</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">HttpSecurity</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">中：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">WebSecurityConfig</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">extends</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">WebSecurityConfigurerAdapter</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 省略其它部分</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Bean</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtAuthenticationTokenFilter</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authenticationTokenFilterBean</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">()</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Exception</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtAuthenticationTokenFilter();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">protected</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">void</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">configure</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(HttpSecurity httpSecurity)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Exception</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 省略之前写的规则部分，具体看前面的代码</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// 添加JWT filter</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">httpSecurity</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.addFilterBefore(authenticationTokenFilterBean(), UsernamePasswordAuthenticationFilter.class);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><h3 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 22px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 22px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">完成鉴权（登录）、注册和更新token的功能</span></h3><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">到现在，我们整个API其实已经在安全的保护下了，但我们遇到一个问题：所有的API都安全了，但我们还没有用户啊，所以所有API都没法访问。因此要提供一个注册、登录的API，这个API应该是可以匿名访问的。给它规划的路径呢，我们前面其实在</span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">WebSecurityConfig</span><span style="box-sizing: border-box; word-break: break-word !important;">中已经给出了，就是</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">/auth</span><span style="box-sizing: border-box; word-break: break-word !important;">。</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">首先需要一个AuthService，规定一下必选动作：</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">interface</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthService</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">User</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">register</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(User userToAdd)</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">login</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(String username, String password)</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">refresh</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(String oldToken)</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">然后，实现这些必选动作，其实非常简单：</span></div><ol style="box-sizing: border-box; margin: -5px 0px 20px 20px; word-break: break-word !important; padding: 0px;"><li style="box-sizing: border-box;"><span style="line-height: 30px;">登录时要生成token，完成Spring Security认证，然后返回token给客户端</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">注册时将用户密码用BCrypt加密，写入用户角色，由于是开放注册，所以写入角色系统控制，将其写成 </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 30px;">ROLE_USER</span></li><li style="box-sizing: border-box;"><span style="line-height: 30px;">提供一个可以刷新token的接口 refresh 用于取得新的token</span></li></ol><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Service</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthServiceImpl</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">implements</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthService</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthenticationManager authenticationManager;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetailsService userDetailsService;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtTokenUtil jwtTokenUtil;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserRepository userRepository;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Value</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;${jwt.tokenHead}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String tokenHead;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthServiceImpl</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthenticationManager authenticationManager,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetailsService userDetailsService,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtTokenUtil jwtTokenUtil,</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserRepository userRepository)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.authenticationManager = authenticationManager;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.userDetailsService = userDetailsService;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.jwtTokenUtil = jwtTokenUtil;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">this</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">.userRepository = userRepository;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">User</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">register</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(User userToAdd)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String username = userToAdd.getUsername();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">if</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(userRepository.findByUsername(username)!=</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">) {</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">BCryptPasswordEncoder encoder =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">BCryptPasswordEncoder();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String rawPassword = userToAdd.getPassword();</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">userToAdd.setPassword(encoder.encode(rawPassword));</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">userToAdd.setLastPasswordResetDate(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Date());</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">userToAdd.setRoles(asList(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;ROLE_USER&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">));</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">userRepository.insert(userToAdd);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">login</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(String username, String password)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UsernamePasswordAuthenticationToken upToken =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UsernamePasswordAuthenticationToken(username, password);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">Authentication authentication = authenticationManager.authenticate(upToken);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">SecurityContextHolder.getContext().setAuthentication(authentication);</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">UserDetails userDetails = userDetailsService.loadUserByUsername(username);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String token = jwtTokenUtil.generateToken(userDetails);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">token;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Override</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">refresh</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(String oldToken)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String token = oldToken.substring(tokenHead.length());</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String username = jwtTokenUtil.getUsernameFromToken(token);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtUser user = (JwtUser) userDetailsService.loadUserByUsername(username);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">if</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(jwtTokenUtil.canTokenBeRefreshed(token, user.getLastPasswordResetDate())){</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">jwtTokenUtil.refreshToken(token);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">然后建立AuthController就好，这个AuthController中我们在其中使用了表达式绑定，比如</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">@Value(&quot;${jwt.header}&quot;)</span><span style="box-sizing: border-box; word-break: break-word !important;">中的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">jwt.header</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">其实是定义在</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">applicaiton.yml</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">中的</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;"># JWT</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">jwt:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">header: Authorization</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">secret: mySecret</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">expiration:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">604800</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">tokenHead:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;Bearer &quot;</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">route:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authentication:</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">path: auth</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">refresh: refresh</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">register</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">:</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;auth/register&quot;</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">同样的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">@RequestMapping(value = &quot;${jwt.route.authentication.path}&quot;, method = RequestMethod.POST)</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">中的</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">jwt.route.authentication.path</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">也是定义在上面的</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RestController</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">class</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(181, 137, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthController</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Value</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;${jwt.header}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String tokenHeader;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@Autowired</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">private</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthService authService;</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestMapping</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(value =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;${jwt.route.authentication.path}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">, method = RequestMethod.POST)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">ResponseEntity&lt;?&gt; createAuthenticationToken(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestBody</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtAuthenticationRequest authenticationRequest)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthenticationException{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">final</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String token = authService.login(authenticationRequest.getUsername(), authenticationRequest.getPassword());</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(147, 161, 161); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">// Return the token</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">ResponseEntity.ok(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtAuthenticationResponse(token));</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestMapping</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(value =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;${jwt.route.authentication.refresh}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">, method = RequestMethod.GET)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">ResponseEntity&lt;?&gt; refreshAndGetAuthenticationToken(</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">HttpServletRequest request)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthenticationException{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String token = request.getHeader(tokenHeader);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String refreshedToken = authService.refresh(token);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">if</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(refreshedToken ==</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">) {</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">ResponseEntity.badRequest().body(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">null</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">else</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">ResponseEntity.ok(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">new</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">JwtAuthenticationResponse(refreshedToken));</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><br/></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestMapping</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(value =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;${jwt.route.authentication.register}&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">, method = RequestMethod.POST)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">User</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">register</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(@RequestBody User addedUser)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">throws</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">AuthenticationException</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">authService.register(addedUser);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><h2 style="box-sizing: border-box; margin: 0px 0px 15px; font-size: 24px; text-rendering: optimizeLegibility;"><span style="box-sizing: border-box; font-size: 24px; text-rendering: optimizeLegibility; color: rgb(47, 47, 47); font-weight: bold; line-height: 1.7;">验证时间</span></h2><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">接下来，我们就可以看看我们的成果了，首先注册一个用户</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">peng2</span><span style="box-sizing: border-box; word-break: break-word !important;">，很完美的注册成功了</span></div><div style="box-sizing: border-box; padding-bottom: 25px; width: 700px; margin-left: -40px; text-align: center;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image [2].png" type="image/png" data-filename="Image.png" style="box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; height: auto; cursor: zoom-in; transition: all 0.25s ease-in-out;"/><span style="box-sizing: border-box; width: 700px; min-width: 20%; max-width: 80%; min-height: 22px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150); line-height: 1.7;">注册用户</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">然后在</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">/auth</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">中取得token，也很成功</span></div><div style="box-sizing: border-box; padding-bottom: 25px; width: 700px; margin-left: -40px; text-align: center;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image [3].png" type="image/png" data-filename="Image.png" style="box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; height: auto; cursor: zoom-in; transition: all 0.25s ease-in-out;"/><span style="box-sizing: border-box; width: 700px; min-width: 20%; max-width: 80%; min-height: 22px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150); line-height: 1.7;">取得token</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">不使用token时，访问</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">/users</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">的结果，不出意料的失败，提示未授权。</span></div><div style="box-sizing: border-box; padding-bottom: 25px; width: 700px; margin-left: -40px; text-align: center;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image [4].png" type="image/png" data-filename="Image.png" style="box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; height: auto; cursor: zoom-in; transition: all 0.25s ease-in-out;"/><span style="box-sizing: border-box; width: 700px; min-width: 20%; max-width: 80%; min-height: 22px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150); line-height: 1.7;">不使用token访问users列表</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">使用token时，访问</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">/users</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">的结果，虽然仍是失败，但这次提示访问被拒绝，意思就是虽然你已经得到了授权，但由于你的会员级别还只是普卡会员，所以你的请求被拒绝。</span></div><div style="box-sizing: border-box; padding-bottom: 25px; width: 700px; margin-left: -40px; text-align: center;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image [5].png" type="image/png" data-filename="Image.png" style="box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; height: auto; cursor: zoom-in; transition: all 0.25s ease-in-out;"/><span style="box-sizing: border-box; width: 700px; min-width: 20%; max-width: 80%; min-height: 22px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150); line-height: 1.7;">image_1bas22va52vk1rj445fhm87k72a.png-156.9kB</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">接下来我们访问</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; font-size: 12px; background-color: rgb(246, 246, 246); border-radius: 4px; border: none; white-space: pre-wrap; word-break: break-word !important; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">/users/?username=peng2</span><span style="box-sizing: border-box; word-break: break-word !important;">，竟然可以访问啊</span></div><div style="box-sizing: border-box; padding-bottom: 25px; width: 700px; margin-left: -40px; text-align: center;"><img src="重拾后端之Spring Boot（四）：使用JWT和Spring Security保护RE_files/Image [6].png" type="image/png" data-filename="Image.png" style="box-sizing: border-box; border: 0px; vertical-align: middle; max-width: 100%; height: auto; cursor: zoom-in; transition: all 0.25s ease-in-out;"/><span style="box-sizing: border-box; width: 700px; min-width: 20%; max-width: 80%; min-height: 22px; border-bottom: 1px solid rgb(217, 217, 217); font-size: 14px; color: rgb(150, 150, 150); line-height: 1.7;">访问自己的信息是允许的</span></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">这是由于我们为这个方法定义的权限就是：拥有ADMIN角色或者是当前用户本身。Spring Security真是很方便，很强大。</span></div><div style="box-sizing: border-box; overflow: auto; font-size: 13px; padding: 15px; margin: 0px 0px 20px; word-wrap: normal; background: rgb(246, 246, 246); border: 1px solid rgb(204, 204, 204); border-radius: 0px; text-size-adjust: none; white-space: pre; word-break: break-word !important;"><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@PostAuthorize</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;returnObject.username == principal.username or hasRole('ROLE_ADMIN')&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">@RequestMapping</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(value =</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;/&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">,method = RequestMethod.GET)</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">public</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">User</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(38, 139, 210); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">getUserByUsername</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">(@RequestParam(value=</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(42, 161, 152); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">&quot;username&quot;</span><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">String username)</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">{</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(133, 153, 0); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">return</span> <span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">repository.findByUsername(username);</span></div><div><span style="box-sizing: border-box; font-size: 12px; border-radius: 0px; white-space: pre; border: none; color: rgb(101, 123, 131); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.42857;">}</span></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">本章代码：</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=https://github.com/wpcfan/spring-boot-tut/tree/chap04" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">https://github.com/wpcfan/spring-boot-tut/tree/chap04</a></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">慕课网 Angular 视频课上线：</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=http://coding.imooc.com/class/123.html?mc_marking=1fdb7649e8a8143e8b81e221f9621c4a&amp;mc_channel=banner" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">http://coding.imooc.com/class/123.html?mc_marking=1fdb7649e8a8143e8b81e221f9621c4a&amp;mc_channel=banner</a></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><div><a href="https://www.jianshu.com/p/4e25e25b62c2" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（一）：REST API的搭建可以这样简单</a></div><div><a href="https://www.jianshu.com/p/fe3b9532b852" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（二）：MongoDb的无缝集成</a></div><div><a href="https://www.jianshu.com/p/06376b97b11e" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（三）：找回熟悉的Controller，Service</a></div><div><a href="https://www.jianshu.com/p/6307c89fe3fa" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);">重拾后端之Spring Boot（四）：使用 JWT 和 Spring Security 保护 REST API</a></div><div style="margin-top: 1em; margin-bottom: 1em;"><a href="https://www.jianshu.com/p/4ef9881090ec" style="box-sizing: border-box; cursor: pointer; color: rgb(49, 148, 208);-en-paragraph:true;">重拾后端之Spring Boot（五）：跨域、自定义查询及分页</a></div></div><div style="box-sizing: border-box; margin: 0px 0px 25px; word-break: break-word !important;"><span style="box-sizing: border-box; word-break: break-word !important;">有问题的童鞋可以加入我的小密圈讨论：</span><span style="box-sizing: border-box; word-break: break-word !important;"> </span><a href="https://link.jianshu.com/?t=http://t.xiaomiquan.com/jayRnaQ" style="box-sizing: border-box; cursor: pointer; word-break: break-word !important; color: rgb(49, 148, 208);">http://t.xiaomiquan.com/jayRnaQ</a><span style="box-sizing: border-box; word-break: break-word !important;"> </span><span style="box-sizing: border-box; word-break: break-word !important;">(该链接7天内(5月14日前)有效)</span></div></div></div></span>
</div></body></html> 