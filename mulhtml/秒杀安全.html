<html>
<head>
  <title>秒杀安全</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="694"/>
<h1>秒杀安全</h1>

<div>
<span><div><div><font style="font-size: 12pt;"><span style="color: rgb(26, 144, 185); font-size: 12pt; font-weight: bold;">原文地址：</span><a href="http://mp.weixin.qq.com/s?__biz=MzU0OTE4MzYzMw==&amp;mid=2247484464&amp;idx=1&amp;sn=5669d142ee93d15c351ebaa6e57d0cd6&amp;chksm=fbb28dceccc504d8ae1ce1b31dd5760c48aa8e3b32f86b98aa482d2bf22d4dc53be70f1d1983&amp;scene=0#rd" style="font-size: 12pt; font-weight: bold; color: rgb(26, 144, 185);">http://mp.weixin.qq.com/s?__biz=MzU0OTE4MzYzMw<span>    </span>==&amp;mid=2247484464&amp;idx=1&amp;sn=5669d142ee93d15c351ebaa6e57d0cd6&amp;chksm=fbb28dceccc504d8ae1ce1b31dd5760c48aa8e3b32f86b98aa482d2bf22d4dc53be70f1d1983&amp;scene=0#rd</a></font></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-align: center; box-sizing: border-box !important; word-wrap: break-word !important;"><br/></div><h2 style="margin: 0px; padding: 0px; font-size: 16px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="font-size: 24px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">简介</span></h2><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">  我们通常衡量一个Web系统的吞吐率的指标是QPS（Query Per Second，每秒处理请求数），解决每秒数万次的高并发场景，这个指标非常关键。举个例子，我们假设处理一个业务请求平均响应时间为100ms，同时，系统内有20台Web服务器，配置MaxClients为500个（表示服务器的最大连接数目）。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">那么，我们的Web系统的理论峰值QPS为（理想化的计算方式）：</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">20*500/0.1 = 100000 （10万QPS）</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">在高并发的实际场景下，机器都处于高负载的状态，在这个时候平均响应时间会被大大增加。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">就Web服务器而言，他打开了越多的连接进程，CPU需要处理的上下文切换也越多，额外增加了CPU的消耗，然后就直接导致平均响应时间增加。因此上述的MaxClient数目，要根据CPU、内存等硬件因素综合考虑，绝对不是越多越好。可以通过Apache自带的ab来测试一下，取一个合适的值。然后，我们选择内存操作级别的存储的Redis，在高并发的状态下，存储的响应时间至关重要。网络带宽虽然也是一个因素，不过，这种请求数据包一般比较小，一般很少成为请求的瓶颈。负载均衡成为系统瓶颈的情况比较少，在这里不做讨论哈。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">那么问题来了，假设我们的系统，在5w/s的高并发状态下，平均响应时间从100ms变为250ms（实际情况，甚至更多）：</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">20*500/0.25 = 40000 （4万QPS）</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">于是，我们的系统剩下了4w的QPS，面对5w每秒的请求，中间相差了1w。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">举个例子，高速路口，1秒钟来5部车，每秒通过5部车，高速路口运作正常。突然，这个路口1秒钟只能通过4部车，车流量仍然依旧，结果必定出现大塞车。（5条车道忽然变成4条车道的感觉）</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">同理，某一个秒内，20*500个可用连接进程都在满负荷工作中，却仍然有1万个新来请求，没有连接进程可用，系统陷入到异常状态也是预期之内。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-caps: normal; font-variant-ligatures: normal;"><img src="秒杀安全_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: auto; padding: 0px; height: auto !important; max-width: 100%; word-wrap: break-word !important; -webkit-tap-highlight-color: transparent; border-style: none; width: auto !important; visibility: visible !important;"/></span><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">其实在正常的非高并发的业务场景中，也有类似的情况出现，某个业务请求接口出现问题，响应时间极慢，将整个Web请求响应时间拉得很长，逐渐将Web服务器的可用连接数占满，其他正常的业务请求，无连接进程可用。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">更可怕的问题是，是用户的行为特点，系统越是不可用，用户的点击越频繁，恶性循环最终导致“雪崩”（其中一台Web机器挂了，导致流量分散到其他正常工作的机器上，再导致正常的机器也挂，然后恶性循环），将整个Web系统拖垮。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h2 style="margin: 1.5em 0px; padding: 0px; font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">重启与过载保护</span></h2><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">如果系统发生“雪崩”，贸然重启服务，是无法解决问题的。最常见的现象是，启动起来后，立刻挂掉。这个时候，最好在入口层将流量拒绝，然后再将重启。如果是redis/memcache这种服务也挂了，重启的时候需要注意“预热”，并且很可能需要比较长的时间。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">秒杀和抢购的场景，流量往往是超乎我们系统的准备和想象的。这个时候，过载保护是必要的。如果检测到系统满负载状态，拒绝请求也是一种保护措施。在前端设置过滤是最简单的方式，但是，这种做法是被用户“千夫所指”的行为。更合适一点的是，将过载保护设置在CGI入口层，快速将客户的直接请求返回</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; box-sizing: border-box !important; word-wrap: break-word !important;"></div><h2 style="margin: 1.5em 0px; padding: 0px; font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">高并发下的数据安全</span></h2><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; word-wrap: break-word !important;">我们知道在多线程写入同一个文件的时候，会存现“线程安全”的问题（多个线程同时运行同一段代码，如果每次运行结果和单线程运行的结果是一样的，结果和预期相同，就是线程安全的）。如果是MySQL数据库，可以使用它自带的锁机制很好的解决问题，但是，在大规模并发的场景中，是不推荐使用MySQL的。秒杀和抢购的场景中，还有另外一个问题，就是“超发”，如果在这方面控制不慎，会产生发送过多的情况。我们也曾经听说过，某些电商搞抢购活动，买家成功拍下后，商家却不承认订单有效，拒绝发货。这里的问题，也许并不一定是商家奸诈，而是系统技术层面存在超发风险导致的。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h2 style="margin: 1.5em 0px; padding: 0px; font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">超发的原因</span></h2><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">假设某个抢购场景中，我们一共只有100个商品，在最后一刻，我们已经消耗了99个商品，仅剩最后一个。这个时候，系统发来多个并发请求，这批请求读取到的商品余量都是99个，然后都通过了这一个余量判断，最终导致超发。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-caps: normal; font-variant-ligatures: normal;"><img src="秒杀安全_files/Image [1].jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: auto; padding: 0px; height: auto !important; max-width: 100%; word-wrap: break-word !important; -webkit-tap-highlight-color: transparent; border-style: none; width: auto !important; visibility: visible !important;"/></span><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">在上面的这个图中，就导致了并发用户B也“抢购成功”，多让一个人获得了商品。这种场景，在高并发的情况下非常容易出现。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h2 style="margin: 1.5em 0px; padding: 0px; font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">优化方案1</span></h2><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h4 style="margin: 1.5em 0px; padding: 0px; font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">将库存字段number字段设为unsigned，当库存为0时，因为字段不能为负数，将会返回false</span></h4><div style="margin: 0px; padding: 2px; max-width: 100%; word-wrap: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; overflow-x: auto; background-color: rgb(63, 63, 63); border-radius: 3px; font-size: 13px;"><div style="margin: 0px; padding: 10px; max-width: 100%; word-wrap: normal; -webkit-tap-highlight-color: transparent; overflow-x: auto; border-radius: 4px;"><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&lt;?php</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//优化方案1：将库存字段number字段设为unsigned，当库存为0时，因为字段不能为负数，将会返回false</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">include</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'./mysql.php'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$username =</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'wang'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">.rand(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1000</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//生成唯一订单</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">function</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(239, 239, 143); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">build_order_no</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">()</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">return</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">date(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'ymd'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">).substr(implode(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">NULL</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">, array_map(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'ord'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">, str_split(substr(uniqid(),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">7</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">13</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">))),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">8</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//记录日志</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">function</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(239, 239, 143); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($event,$type=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,$username)</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">global</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$conn;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;insert into ih_log(event,type,usernma)</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">values('$event','$type','$username')&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">return</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">function</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(239, 239, 143); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertOrder</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($order_sn,$user_id,$goods_id,$sku_id,$price,$username,$number)</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">global</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$conn;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price,username,number)</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">values('$order_sn','$user_id','$goods_id','$sku_id','$price','$username','$number')&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">return</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//模拟下单操作</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//库存是否大于0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;select number from ih_store where goods_id='$goods_id' and sku_id='$sku_id' &quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$rs=mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$row = $rs-&gt;fetch_assoc();</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($row[</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'number'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">]&gt;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">){</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//高并发下会导致超卖</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($row[</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'number'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">]&lt;$number){</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">return</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存不够'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">3</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,$username);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$order_sn=build_order_no();</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//库存减少</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;update ih_store set number=number-{$number} where sku_id='$sku_id' and number&gt;0&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$store_rs=mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($store_rs){</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//生成订单</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertOrder($order_sn,$user_id,$goods_id,$sku_id,$price,$username,$number);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少成功'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,$username);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">else</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少失败'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">2</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,$username);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">else</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存不够'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">3</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,$username);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">?&gt;</span></div></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h2 style="margin: 1.5em 0px; padding: 0px; font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">优化方案2</span></h2><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h3 style="margin: 1.5em 0px; padding: 0px; font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">悲观锁思路</span></h3><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">解决线程安全的思路很多，可以从“悲观锁”的方向开始讨论。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">悲观锁，也就是在修改数据的时候，采用锁定状态，排斥外部请求的修改。遇到加锁的状态，就必须等待。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-caps: normal; font-variant-ligatures: normal;"><img src="秒杀安全_files/Image [2].jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: auto; padding: 0px; height: auto !important; max-width: 100%; word-wrap: break-word !important; -webkit-tap-highlight-color: transparent; border-style: none; width: auto !important; visibility: visible !important;"/></span><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">虽然上述的方案的确解决了线程安全的问题，但是，别忘记，我们的场景是“高并发”。也就是说，会很多这样的修改请求，每个请求都需要等待“锁”，某些线程可能永远都没有机会抢到这个“锁”，这种请求就会死在那里。同时，这种请求会很多，瞬间增大系统的平均响应时间，结果是可用连接数被耗尽，系统陷入异常。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h4 style="margin: 1.5em 0px; padding: 0px; font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">使用MySQL的事务，锁住操作的行</span></h4><div style="margin: 0px; padding: 2px; max-width: 100%; word-wrap: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; overflow-x: auto; background-color: rgb(63, 63, 63); border-radius: 3px; font-size: 13px;"><div style="margin: 0px; padding: 10px; max-width: 100%; word-wrap: normal; -webkit-tap-highlight-color: transparent; overflow-x: auto; border-radius: 4px;"><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&lt;?php</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//优化方案2：使用MySQL的事务，锁住操作的行</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">include</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'./mysql.php'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//生成唯一订单号</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">function</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(239, 239, 143); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">build_order_no</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">()</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">return</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">date(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'ymd'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">).substr(implode(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">NULL</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">, array_map(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'ord'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">, str_split(substr(uniqid(),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">7</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">13</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">))),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">8</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//记录日志</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">function</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(239, 239, 143); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($event,$type=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">)</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">global</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$conn;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;insert into ih_log(event,type)</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">values('$event','$type')&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//模拟下单操作</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//库存是否大于0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">mysqli_query($conn,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;BEGIN&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//开始事务</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;select number from ih_store where goods_id='$goods_id' and sku_id='$sku_id' FOR UPDATE&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//此时这条记录被锁住,其它事务必须等待此次事务提交后才能执行</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$rs=mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$row=$rs-&gt;fetch_assoc();</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($row[</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'number'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">]&gt;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">){</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//生成订单</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$order_sn=build_order_no();</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">values('$order_sn','$user_id','$goods_id','$sku_id','$price')&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$order_rs=mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//库存减少</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;update ih_store set number=number-{$number} where sku_id='$sku_id'&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$store_rs=mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($store_rs){</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少成功'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少成功'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">mysqli_query($conn,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;COMMIT&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//事务提交即解锁</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">else</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少失败'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少失败'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">else</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存不够'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存不够'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">mysqli_query($conn,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;ROLLBACK&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">?&gt;</span></div></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h3 style="margin: 1.5em 0px; padding: 0px; font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">乐观锁思路</span></h3><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">乐观锁（ Optimistic Locking ） 相对悲观锁而言，乐观锁机制采取了更加宽松的加锁机制。悲观锁大多数情况下依靠数据库的锁机制实现，以保证操作最大程度的独占性。但随之而来的就是数据库性能的大量开销，特别是对长事务而言，这样的开销往往无法承受。而乐观锁机制在一定程度上解决了这个问题。乐观锁，大多是基于数据版本（ Version ）记录机制实现。何谓数据版本？即为数据增加一个版本标识，在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 “version” 字段来实现。读取出数据时，将此版本号一同读出，之后更新时，对此版本号加一。此时，将提交数据的版本数据与数据库表对应记录的当前版本信息进行比对，如果提交的数据版本号大于数据库表当前版本号，则予以更新，否则认为是过期数据。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h4 style="margin: 1.5em 0px; padding: 0px; font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">示例</span></h4><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">如一个金融系统，当某个操作员读取用户的数据，并在读出的用户数据的基础上进行修改时（如更改用户帐户余额），如果采用悲观锁机制，也就意味着整个操作过 程中（从操作员读出数据、开始修改直至提交修改结果的全过程，甚至还包括操作 员中途去煮咖啡的时间），数据库记录始终处于加锁状态，可以想见，如果面对几百上千个并发，这样的情况将导致怎样的后果。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">乐观锁机制在一定程度上解决了这个问题。乐观锁，大多是基于数据版本 （ Version ）记录机制实现。何谓数据版本？即为数据增加一个版本标识，在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 “version” 字段来实现。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">读取出数据时，将此版本号一同读出，之后更新时，对此版本号加一。此时，将提交数据的版本数据与数据库表对应记录的当前版本信息进行比对，如果提交的数据版本号大于数据库表当前版本号，则予以更新，否则认为是过期数据。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">对于上面修改用户帐户信息的例子而言，假设数据库中帐户信息表中有一个 version 字段，当前值为 1 ；而当前帐户余额字段（ balance ）为 $100 。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">1 操作员 A 此时将其读出（ version=1 ），并从其帐户余额中扣除 $50（ $100-$50 ）。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">2 在操作员 A 操作的过程中，操作员B 也读入此用户信息（ version=1 ），并从其帐户余额中扣除 $20 （ $100-$20 ）。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">3 操作员 A 完成了修改工作，将数据版本号加一（ version=2 ），连同帐户扣除后余额（ balance=$50 ），提交至数据库更新，此时由于提交数据版本大于数据库记录当前版本，数据被更新，数据库记录 version 更新为 2 。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">4 操作员 B 完成了操作，也将版本号加一（ version=2 ）试图向数据库提交数据（ balance=$80 ），但此时比对数据库记录版本时发现，操作员 B 提交的数据版本号为 2 ，数据库记录当前版本也为 2 ，不满足 “ 提交版本必须大于记录当前版本才能执行更新 “ 的乐观锁策略，因此，操作员 B 的提交被驳回。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">这样，就避免了操作员 B 用基于 version=1 的旧数据修改的结果覆盖操作员A 的操作结果的可能。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h4 style="margin: 1.5em 0px; padding: 0px; font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">优点</span></h4><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">从上面的例子可以看出，乐观锁机制避免了长事务中的数据库加锁开销（操作员 A和操作员 B 操作过程中，都没有对数据库数据加锁），大大提升了大并发量下的系统整体性能表现。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h4 style="margin: 1.5em 0px; padding: 0px; font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">缺点</span></h4><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">需要注意的是，乐观锁机制往往基于系统中的数据存储逻辑，因此也具备一定的局限性，如在上例中，由于乐观锁机制是在我们的系统中实现，来自外部系统的用户余额更新操作不受我们系统的控制，因此可能会造成脏数据被更新到数据库中。在系统设计阶段，我们应该充分考虑到这些情况出现的可能性，并进行相应调整（如将乐观锁策略在数据库存储过程中实现，对外只开放基于此存储过程的数据更新途径，而不是将数据库表直接对外公开）。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">但是，综合来说，这是一个比较好的解决方案。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-caps: normal; font-variant-ligatures: normal;"><img src="秒杀安全_files/Image [3].jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: auto; padding: 0px; height: auto !important; max-width: 100%; word-wrap: break-word !important; -webkit-tap-highlight-color: transparent; border-style: none; width: auto !important; visibility: visible !important;"/></span><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">有很多软件和服务都“乐观锁”功能的支持，例如Redis中的watch就是其中之一。通过这个实现，我们保证了数据的安全。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h4 style="margin: 1.5em 0px; padding: 0px; font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">Redis中的watch</span></h4><div style="margin: 0px; padding: 2px; max-width: 100%; word-wrap: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; overflow-x: auto; background-color: rgb(63, 63, 63); border-radius: 3px; font-size: 13px;"><div style="margin: 0px; padding: 10px; max-width: 100%; word-wrap: normal; -webkit-tap-highlight-color: transparent; overflow-x: auto; border-radius: 4px;"><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&lt;?php</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$redis =</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">new</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">redis();</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$result = $redis-&gt;connect(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'127.0.0.1'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">6379</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$mywatchkey = $redis-&gt;get(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;mywatchkey&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><br/></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$rob_total =</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">100</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//抢购数量</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($mywatchkey&lt;=$rob_total){</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$redis-&gt;watch(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;mywatchkey&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$redis-&gt;multi();</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//在当前连接上启动一个新的事务。</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//插入抢购数据</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$redis-&gt;set(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;mywatchkey&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,$mywatchkey+</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$rob_result = $redis-&gt;exec();</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($rob_result){</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$redis-&gt;hSet(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;watchkeylist&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;user_&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">.mt_rand(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">9999</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">),$mywatchkey);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$mywatchlist = $redis-&gt;hGetAll(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;watchkeylist&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;抢购成功！&lt;br/&gt;&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;剩余数量：&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">.($rob_total-$mywatchkey</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">-1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">).</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;&lt;br/&gt;&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;用户列表：&lt;pre&gt;&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">var_dump($mywatchlist);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">else</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$redis-&gt;hSet(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;watchkeylist&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;user_&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">.mt_rand(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">9999</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">),</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'meiqiangdao'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;手气不好，再抢购！&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">exit</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">?&gt;</span></div></div></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h2 style="margin: 1.5em 0px; padding: 0px; font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">优化方案3</span></h2><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h3 style="margin: 1.5em 0px; padding: 0px; font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">FIFO队列思路</span></h3><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">那好，那么我们稍微修改一下上面的场景，我们直接将请求放入队列中的，采用FIFO（First Input First Output，先进先出），这样的话，我们就不会导致某些请求永远获取不到锁。看到这里，是不是有点强行将多线程变成单线程的感觉哈。</span></div><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-caps: normal; font-variant-ligatures: normal;"><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" style="margin: auto; padding: 0px; height: 170px !important; max-width: 100%; word-wrap: break-word !important; background-color: rgb(238, 237, 235); border: none; background-size: 22px; background-position: center center; background-repeat: no-repeat; background-image: url(&quot;data; -webkit-tap-highlight-color: transparent; width: 600px !important;"></img></span><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> 然后，我们现在解决了锁的问题，全部请求采用“先进先出”的队列方式来处理。那么新的问题来了，高并发的场景下，因为请求很多，很可能一瞬间将队列内存“撑爆”，然后系统又陷入到了异常状态。或者设计一个极大的内存队列，也是一种方案，但是，系统处理完一个队列内请求的速度根本无法和疯狂涌入队列中的数目相比。也就是说，队列内的请求会越积累越多，最终Web系统平均响应时候还是会大幅下降，系统还是陷入异常。</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h2 style="margin: 1.5em 0px; padding: 0px; font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 22px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">优化方案4</span></h2><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h3 style="margin: 1.5em 0px; padding: 0px; font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 20px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">文件锁的思路</span></h3><div style="margin: 0px 0px 16px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">对于日IP不高或者说并发数不是很大的应用，一般不用考虑这些！用一般的文件操作方法完全没有问题。但如果并发高，在我们对文件进行读写操作时，很有可能多个进程对进一文件进行操作，如果这时不对文件的访问进行相应的独占，就容易造成数据丢失</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"></div><h4 style="margin: 1.5em 0px; padding: 0px; font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important;"><span style="font-size: 18px; max-width: 100%; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(61, 70, 77); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">使用非阻塞的文件排他锁</span></h4><div style="margin: 0px; padding: 2px; max-width: 100%; word-wrap: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; -webkit-tap-highlight-color: transparent; overflow-x: auto; background-color: rgb(63, 63, 63); border-radius: 3px; font-size: 13px;"><div style="margin: 0px; padding: 10px; max-width: 100%; word-wrap: normal; -webkit-tap-highlight-color: transparent; overflow-x: auto; border-radius: 4px;"><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&lt;?php</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//优化方案4：使用非阻塞的文件排他锁</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">include</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'./mysql.php'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//生成唯一订单号</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">function</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(239, 239, 143); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">build_order_no</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">()</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">return</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">date(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'ymd'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">).substr(implode(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">NULL</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">, array_map(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'ord'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">, str_split(substr(uniqid(),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">7</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">13</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">1</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">))),</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">8</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//记录日志</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">function</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(239, 239, 143); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($event,$type=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">)</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">global</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$conn;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;insert into ih_log(event,type)</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">values('$event','$type')&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span></div><div><br/></div><div><br/></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$fp = fopen(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;lock.txt&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">,</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;w+&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">(!flock($fp,LOCK_EX | LOCK_NB)){</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;系统繁忙，请稍后再试&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">return</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//下单</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;select number from ih_store where goods_id='$goods_id' and sku_id='$sku_id'&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$rs = mysqli_query($conn,$sql);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$row = $rs-&gt;fetch_assoc();</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($row[</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'number'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">]&gt;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(140, 208, 211); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">0</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">){</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//库存是否大于0</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//模拟下单操作</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$order_sn=build_order_no();</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;insert into ih_order(order_sn,user_id,goods_id,sku_id,price)</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">values('$order_sn','$user_id','$goods_id','$sku_id','$price')&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$order_rs = mysqli_query($conn,$sql);</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//库存减少</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$sql=</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">&quot;update ih_store set number=number-{$number} where sku_id='$sku_id'&quot;</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">$store_rs = mysqli_query($conn,$sql);</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">if</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">($store_rs){</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少成功'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少成功'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">flock($fp,LOCK_UN);</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">//释放锁</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">else</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少失败'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存减少失败'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">else</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">{</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(227, 206, 171); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">echo</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存不够'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">;</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">insertLog(</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(204, 147, 147); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">'库存不够'</span><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">);</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">}</span></div><div><span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(220, 220, 220); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">fclose($fp);</span> <span style="max-width: 100%; -webkit-tap-highlight-color: transparent; word-wrap: break-word !important; color: rgb(127, 159, 127); font-size: 13px; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 1.4;">?&gt;</span></div></div></div><div><img src="秒杀安全_files/Image [4].jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: 0px; padding: 0px; height: auto !important; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; vertical-align: top; width: 558px !important; visibility: visible !important;"/></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(84, 141, 212); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 25.6px;">推荐阅读：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(51, 51, 51); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 25.6px;">技术：</span><a href="http://mp.weixin.qq.com/s?__biz=MzU0OTE4MzYzMw==&amp;mid=2247484184&amp;idx=1&amp;sn=e0aed5908e4cd83fdb883e5c6f8d04a5&amp;chksm=fbb28ae6ccc503f0c565cb95a8bcb37de85c7760cb8059828af7913e4b4bb6b0317dd8651460&amp;scene=21#wechat_redirect" style="max-width: 100%; clear: both; min-height: 1em; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important; font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 25.6px; color: rgb(96, 127, 166); text-decoration: underline;">分布式唯一ID极简教程</a></div><div style="margin: 0px; padding: 0px; max-width: 100%; clear: both; min-height: 1em; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 25.6px;">职场：</span><a href="http://mp.weixin.qq.com/s?__biz=MzU0OTE4MzYzMw==&amp;mid=2247484334&amp;idx=1&amp;sn=c001364f30ebab9e3edab66f465a756c&amp;chksm=fbb28a50ccc50346ed0ccf35899fcd54fc4bd6168cb726cb643998afc6117f7bec1d1face1b8&amp;scene=21#wechat_redirect" style="max-width: 100%; clear: both; min-height: 1em; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important; font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 25.6px; color: rgb(96, 127, 166); text-decoration: underline;">程序员职业规划</a></div><div><span style="max-width: 100%; clear: both; min-height: 1em; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 25.6px;">分享：</span><a href="http://mp.weixin.qq.com/s?__biz=MzU0OTE4MzYzMw==&amp;mid=2247483707&amp;idx=1&amp;sn=168c163e852e826d52c07b887977ff2f&amp;chksm=fbb288c5ccc501d3b0e43d8aca0cffcadfd0dd859f6840ca76fb8593d4593ef48134b22bb368&amp;scene=21#wechat_redirect" style="max-width: 100%; clear: both; min-height: 1em; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(96, 127, 166); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 25.6px; text-decoration: underline;">2T架构师学习资料干货分享</a></div></div><div><br/></div></span>
</div></body></html> 