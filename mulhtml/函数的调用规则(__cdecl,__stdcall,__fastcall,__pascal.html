<html>
<head>
  <title>函数的调用规则(__cdecl,__stdcall,__fastcall,__pascal)和extern "C" {......}</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="690"/>
<h1>函数的调用规则(__cdecl,__stdcall,__fastcall,__pascal)和extern "C" {......}</h1>

<div>
<span><div><font style="font-size: 12pt; color: rgb(26, 173, 224);"><b>原文地址：<a href="http://blog.csdn.net/jia_xiaoxin/article/details/2868216" style="color: rgb(26, 173, 224);">http://blog.csdn.net/jia_xiaoxin/article/details/2868216</a></b></font></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 11pt; line-height: 24px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">   关于函数的调用规则（调用约定），大多数时候是不需要了解的，但是如果需要跨语言的编程，比如VC写的dll要delphi调用，则需要了解。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">        microsoft的vc默认的是__cdecl方式，而windows API则是__stdcall，如果用vc开发dll给其他语言用，则应该指定__stdcall方式。堆栈由谁清除这个很重要，如果是要写汇编函数给C调用，一定要小心堆栈的清除工作，如果是__cdecl方式的函数，则函数本身（如果不用汇编写）则不需要关心保存参数的堆栈的清除，但是如果是__stdcall的规则，一定要在函数退出(ret)前恢复堆栈。</span></div><div><span style="font-weight: bold; box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(51, 102, 255);">1.__cdecl</span></div><div><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">       所谓的C调用规则。按从右至左的顺序压参数入栈，由调用者把参数弹出栈。切记：</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(255, 0, 0);">对于传送参数的内存栈是由调用者来维护的。返回值在EAX中</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(0, 0, 0);">因此，对于象printf这样变参数的函数必须用这种规则。编译器在编译的时候对这种调用规则的函数生成修饰名的饿时候</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">，仅在输出函数名前加上一个下划线前缀，格式为_functionname。</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;"> </span></div><div><span style="font-weight: bold; box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(51, 102, 255);">2.__stdcall</span><span style="font-weight: bold; box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(51, 102, 255);"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">        按从右至左的顺序压参数入栈，由被调用者把参数弹出栈。_stdcall是Pascal程序的缺省调用方式，通常用于Win32 Api中，切记：函数</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(255, 0, 0);">自己在退出时清空堆栈</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">，</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(255, 0, 0);">返回值在EAX中。</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">　　__stdcall调用约定在输出函数名前加上一个下划线前缀，后面加上一个“@”符号和其参数的字节数，格式为_functionname@number。如函数int func(int a, double b)的修饰名是</span><a href="mailto:_func@12" style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(0, 0, 255); outline: 0px; text-decoration: underline;">_func@12</a><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">。</span></div><div><span style="font-weight: bold; box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(51, 102, 255);">3.__fastcall</span></div><div><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;">       __fastcall调用的主要特点就是快，因为它是通过寄存器来传送参数的（实际上，它用ECX和EDX传送前两个双字（DWORD）或更小的参数，剩下的参数仍旧自右向左压栈传送，被调用的函数在返回前清理传送参数的内存栈）。__fastcall调用约定在输出函数名前加上一个“@”符号，后面也是一个“@”符号和其参数的字节数，格式为@functionname@number。</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(255, 0, 0);">这个和__stdcall很象，唯一差别就是头两个参数通过寄存器传送。注意通过寄存器传送的两个参数是从左向右的，即第一个参数进ECX，第2个进EDX，其他参数是从右向左的入stack。返回仍然通过EAX.</span></div><div><span style="font-weight: bold; box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(51, 102, 255);">4.__pascal</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(0, 0, 0);-en-paragraph:true;">       这种规则</span><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px;-en-paragraph:true;">从左向右传递参数，通过EAX返回，堆栈由被调用者清除</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(51, 102, 255); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">5.__thiscall</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 11pt; line-height: 22px; color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        仅仅应用于&quot;C++&quot;成员函数。this指针存放于CX寄存器，参数从右到左压。thiscall不是关键词，因此不能被程序员指定</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 11pt; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">      </span><span style="box-sizing: border-box; font-size: 11pt; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"> </span><span style="box-sizing: border-box; font-size: 11pt; line-height: 26px; color: rgb(255, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">调用约定可以通过工程设置：Setting.../C/C++ /Code Generation项进行选择，缺省状态为__cdecl。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 11pt; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">名字修饰约定：</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 11pt; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">1、修饰名(Decoration name)：&quot;C&quot;或者&quot;C++&quot;函数在内部（编译和链接）通过修饰名识别</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">2、C编译时函数名修饰约定规则：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">__stdcall调用约定在输出函数名前加上一个下划线前缀，后面加上一个&quot;@&quot;符号和其参数的字节数，格式为</span><a href="mailto:_functionname@number" style="color: rgb(0, 0, 255); outline: 0px; box-sizing: border-box; font-size: 12px; text-decoration: underline;">_functionname@number</a><span style="box-sizing: border-box; font-size: 11pt;">,例如 ：function(int a, int b)，其修饰名为：</span><a href="mailto:_function@8" style="color: rgb(0, 0, 255); outline: 0px; box-sizing: border-box; font-size: 12px; text-decoration: underline;">_function@8</a></div><div><span style="box-sizing: border-box; font-size: 11pt;">__cdecl调用约定仅在输出函数名前加上一个下划线前缀，格式为_functionname。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">__fastcall调用约定在输出函数名前加上一个&quot;@&quot;符号，后面也是一个&quot;@&quot;符号和其参数的字节数，格式为@functionname@number。</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">3、C++编译时函数名修饰约定规则：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">__stdcall调用约定：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">1)、以&quot;?&quot;标识函数名的开始，后跟函数名；</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">2)、函数名后面以&quot;@@YG&quot;标识参数表的开始，后跟参数表；</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">3)、参数表以代号表示：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">X--void ，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">D--char，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">E--unsigned char，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">F--short，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">H--int，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">I--unsigned int，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">J--long，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">K--unsigned long，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">M--float，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">N--double，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">_N--bool，</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">PA--表示指针，后面的代号表明指针类型，如果相同类型的指针连续出现，以&quot;0&quot;代替，一个&quot;0&quot;代表一次重复；</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">4)、参数表的第一项为该函数的返回值类型，其后依次为参数的数据类型,指针标识在其所指数据类型前；</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt;">5)、参数表后以&quot;@Z&quot;标识整个名字的结束，如果该函数无参数，则以&quot;Z&quot;标识结束。</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">其格式为&quot;</span><a href="mailto:?functionname@@YG*****@Z" style="color: rgb(0, 0, 255); outline: 0px; box-sizing: border-box; font-size: 12px; text-decoration: underline;">?functionname@@YG*****@Z</a><span style="box-sizing: border-box; font-size: 12px;">&quot;或&quot;</span><a href="mailto:?functionname@@YG*XZ" style="color: rgb(0, 0, 255); outline: 0px; box-sizing: border-box; font-size: 12px; text-decoration: underline;">?functionname@@YG*XZ</a><span style="box-sizing: border-box; font-size: 11pt;">&quot;，例如</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">          int Test1(char *var1,unsigned long)-----“?Test1@@YGHPADK@Z”</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">          void Test2()                      </span><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;"> </span><a href="mailto:-----%E2%80%9C?Test2@@YGXXZ" style="color: rgb(0, 0, 255); outline: 0px; box-sizing: border-box; font-size: 12px; text-decoration: underline;-en-paragraph:true;">-----“?Test2@@YGXXZ</a><span style="box-sizing: border-box; font-size: 12px;-en-paragraph:true;">”</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"> </span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">__cdecl调用约定：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">规则同上面的_stdcall调用约定，只是参数表的开始标识由上面的&quot;@@YG&quot;变为&quot;@@YA&quot;。</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">__fastcall调用约定：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">规则同上面的_stdcall调用约定，只是参数表的开始标识由上面的&quot;@@YG&quot;变为&quot;@@YI&quot;。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">VC++对函数的省缺声明是&quot;__cedcl&quot;,将只能被C/C++调用.</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br style="box-sizing: border-box;"/></div><div><span style="box-sizing: border-box; font-size: 11pt; font-weight: bold;">注意：</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">1、_beginthread需要__cdecl的线程函数地址，_beginthreadex和CreateThread需要__stdcall的线程函数地址。</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">2、一般WIN32的函数都是__stdcall。而且在Windef.h中有如下的定义：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">#define CALLBACK __stdcall</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">#define WINAPI　 __stdcall</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">3、extern &quot;C&quot; _declspec(dllexport) int __cdecl Add(int a, int b);</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">   typedef int (__cdecl*FunPointer)(int a, int b);</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">   修饰符的书写顺序如上。</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">4、extern &quot;C&quot;的作用：如果Add(int a, int b)是在c语言编译器编译，而在c++文件使用，则需要在c++文件中声明：extern &quot;C&quot; Add(int a, int b)，因为c编译器和c++编译器对函数名的解释不一样（c++编译器解释函数名的时候要考虑函数参数，这样是了方便函数重载，而在c语言中不存在函数重载的问题），使用extern &quot;C&quot;，实质就是告诉c++编译器，该函数是c库里面的函数。如果不使用extern &quot;C&quot;则会出现链接错误。</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">一般象如下使用：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">#ifdef _cplusplus</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt;">#define ETERN_C extern &quot;C&quot;</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">#else</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">#define EXTERN_C extern</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">#endif</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">#ifdef _cplusplus</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt;">extern &quot;C&quot;{</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">#endif</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt;">EXTERN_C int func(int a, int b);</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt;">#ifdef _cplusplus</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt;">}</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">#endif</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">5、MFC提供了一些宏，可以使用AFX_EXT_CLASS来代替__declspec(DLLexport)，并修饰类名，从而导出类，AFX_API_EXPORT来修饰函数，AFX_DATA_EXPORT来修饰变量</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">AFX_CLASS_IMPORT：__declspec(DLLexport)</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">AFX_API_IMPORT：__declspec(DLLexport)</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">AFX_DATA_IMPORT：__declspec(DLLexport)</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">AFX_CLASS_EXPORT：__declspec(DLLexport)</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">AFX_API_EXPORT：__declspec(DLLexport)</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">AFX_DATA_EXPORT：__declspec(DLLexport)</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">AFX_EXT_CLASS：#ifdef _AFXEXT</span><span style="box-sizing: border-box; font-size: 11pt;"> </span></div><div><span style="box-sizing: border-box; font-size: 11pt;">    AFX_CLASS_EXPORT</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">        #else</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">    AFX_CLASS_IMPORT</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 11pt; line-height: 26px; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">6、DLLMain负责初始化(Initialization)和结束(Termination)工作，每当一个新的进程或者该进程的新的线程访问DLL时，或者访问DLL的每一个进程或者线程不再使用DLL或者结束时，都会调用DLLMain。但是，使用TerminateProcess或TerminateThread结束进程或者线程，不会调用DLLMain。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; line-height: 26px; text-align: justify; color: rgb(79, 79, 79); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><span style="box-sizing: border-box; font-size: 11pt;">7、一个DLL在内存中只有一个实例</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">DLL程序和调用其输出函数的程序的关系：</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">1)、DLL与进程、线程之间的关系</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">DLL模块被映射到调用它的进程的虚拟地址空间。</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">DLL使用的内存从调用进程的虚拟地址空间分配，只能被该进程的线程所访问。</span></div><div><span style="box-sizing: border-box; font-size: 11pt;">DLL的句柄可以被调用进程使用；调用进程的句柄可以被DLL使用。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">DLLDLL可以有自己的数据段，但没有自己的堆栈，使用调用进程的栈，与调用它的应用程序相同的堆栈模式。</span></div></div><div><span style="box-sizing: border-box; font-size: 11pt;">2)、关于共享数据段</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="box-sizing: border-box; font-size: 11pt;-en-paragraph:true;">DLL定义的全局变量可以被调用进程访问；DLL可以访问调用进程的全局数据。使用同一DLL的每一个进程都有自己的DLL全局变量实例。如果多个线程并发访问同一变量，则需要使用同步机制；对一个DLL的变量，如果希望每个使用DLL的线程都有自己的值，则应该使用线程局部存储(TLS，Thread Local Strorage)。</span></div><div><br/></div></span>
</div></body></html> 