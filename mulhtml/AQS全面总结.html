<html>
<head>
  <title>AQS全面总结</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1581"/>
<h1>AQS全面总结</h1>

<div>
<span><div><span style="font-size: 18px; color: rgb(31, 73, 125); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">个人总结</span></div><div style="margin: 0px; padding: 0px;"><span style="font-size: 16px; color: rgb(31, 73, 125); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">前言</span></div><div style="margin: 0px; padding: 0px;"><font style="font-size: 12pt;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;">CAS即CompareAndSwap,是由底层提供的一个原子方法，这个方法模型中包括三个值，旧的内存值，内存值预期值，要设置的新内存值</span><span style="font-family: punctuation, 微软雅黑, Tohoma;">,当且仅当旧的内存值与内存值预期值相等时，才会成功将新的内存值写入到内存当中，写入成功返回true,写入失败返回false</span><span style="font-family: punctuation, 微软雅黑, Tohoma;"> ,在java当中由</span><a href="http://unsafe.compareandswapxxx/" style="font-family: punctuation, 微软雅黑, Tohoma;">UnSafe.compareAndSwapXXX</a><span style="font-family: punctuation, 微软雅黑, Tohoma;">方法提供CAS原语。</span></font></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">volatile关键字可以保证每次获取的字段值是内存当中的最新值(保证工作内存中该字段的值是无效的，这儿的工作内存是cpu高速缓存这些，如果是单核CPU，那就只有一个高速缓冲区，每个线程获取到的内存值都是一样，volatile就没有意义)，volatile保证了多线程中共享变量的可见性，同时也禁止指令重排序，但不保证原子性。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">注意：</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">   1.每个线程读写主内存的值时，都是要先把该值复制到工作内存，写完后，，再回写到主内存当中，什么时候写回去是不可控的，因此多个线程之间要共 享的变量必须保证可见性（监视器，juc锁，volatile,final都可以保证可见性）</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;">  2.JSR-133加强了volatile的语义，释放锁的线程在写volatile变量之前的共享变量（非volatile），在获取锁的线程读取同一个共享变量后将立即对获取锁的线程可见。</font></div><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">CAS和volatile是java concurrent包的基础！整个concurrent包很少用到内置锁，任何阻塞线程不会进入Blocked状态，而是进入wating或者timewaiting,其通过类提供的锁或者同步容器，都是通过CAS,volatile和算法实现的，AQS是其中最重要的一个核心类。</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div><div><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">concurrent包中提供的锁提供了可中断、可超时、可轮训、支持自旋的特性，比内置锁更为优秀，内置锁只能有一个等待队列，但对于concurrent包中的锁而言，一个condition就是一个条件队列，这个可以极大增加线程唤醒的正确性，降低锁资源的争夺和上下文的切换，但jvm开发小组一直在优化内置锁，提供了自旋锁、锁消除、锁粗化、轻量级锁等优秀特性且concurrent包中的锁更危险，因此只有内置锁满足不了需求时才应该使用cocurrent包中的锁</font></span></div><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">AQS即抽象队列同步(AbstractQueuedSynchronizer)，其提供了多线程的资源的获取和释放的框架，可以实现线程同步，其中包括一个实现了Condition接口的ConditionObject内部类可以代替Object.notify(Condition.signal)和Object.wait(Condition.await)！</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">抽象队列同步的原理两句话</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">(1)AQS维护了一个volatile int state（代表共享资源）和一个FIFO线程等待队列(CLH)（多线程争用资源被阻塞时会进入此队列）。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">   ConditonObject维护了一个单独的等待队列(注意这儿和CLH队列是另外一回事)：</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">  AQS的CLH队列是用来对竞争锁资源的线程进行管理的队列，ConditionObject的队列是维护调用了await方法进入等待状态的线程的队列</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">(2)当一个线程视图获取AQS的资源时，如果获取失败，会被加入CLH队列,线程会进入等待状态(等待前会自旋),等待获取资源，当一个线程释放了AQS的资源时，会唤醒CLH中的等待队列的线程，被唤醒的线程会再试图获取资源.....</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">当一个线程调用conditon.await方法时，该线程会释放其所占有的资源，然后会被加入conditon的等待队列，并且唤醒AQS的CLH队列中的第一个线程，当调用condition.signal或者sianalAll时，会把Condion等待队列中的一个或者多个线程加入到AQS的CLH队列当中，从而让他们竞争资源</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(31, 73, 125); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">详细笔记</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">AQS关于资源的三个重要方法：</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">getState()//获取当前资源的数量</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">setState()//设置当前的资源数量</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">compareAndSetState()//使用CAS设置当前资源的方法</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">AQS关于获取和释放资源的核心方法</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">acquire(int):获取资源，框架已经实现，依靠tryAcquire</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryAcquire(int)：独占方式。尝试获取资源，成功则返回true，失败则返回false。需要我们实现</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">release(int)：释放独占资源 框架已经实现，依靠tryRelease</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false。需要我们实现</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">acquireShared(int)：共享方式获取资源，框架已经实现，依靠tryAcquireShared</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">releaseShared(int)：共享方式释放资源，框架已经实现，依靠tryReleaseShared</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">AQS关于判断和设置独占线程的方法(只能在独占模式下使用，或者独占共享混合模式)</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">//当前独占资源的线程</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">private transient Thread exclusiveOwnerThread;</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">//获取当前独占资源的线程</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">protected final Thread getExclusiveOwnerThread() {</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">        return exclusiveOwnerThread;</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;"> }</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">//设置当前独占资源的线程</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;"> protected final void setExclusiveOwnerThread(Thread thread) {</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">        exclusiveOwnerThread = thread;</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;"> }</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;"> //判断当前线程是否正在独占资源。只有用到condition才需要去实现它。贴合了notify和wait只能在同步块中使用的语法特性</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;"> protected boolean isHeldExclusively() {</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">        throw new UnsupportedOperationException();</font></span></div><div style="margin: 0px; padding: 0px;"><font style="font-size: 12pt;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;">     </span><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;">//一般这样实现 return getExclusiveOwnerThread() == Thread.currentThread();</span></font></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">}</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">Condition的重要方法</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">await:释放当前线程持有的AQS资源，被加入conditon等待队列，线程进入等待状态</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">signal：将conditon等待队列的第一个线程加入到AQS的CLH队列中等待获取资源</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">signalAll:将conditond等待队列的所有线程加入到AQS的CLH队列中等待获取资源</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">AQS定义了两种资源共享方式：</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">Exclusive（独占，只有一个线程能执行，如ReentrantLock）和Share（共享，多个线程可同时执行，如Semaphore/CountDownLatch）。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;"><br/></font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">Exclusive</font></span><span style="font-size: 12pt; font-family: punctuation, 微软雅黑, Tohoma;">依靠acquire，tryAcquire，release，tryRelease：每个线程获取到资源后不会唤醒后面的线程，释放资源后只会唤醒后面的第一个线程。</span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">  比如ReentrantLock是将state初始化为0，表示未锁定状态。当state等于0时线程可以获取到资源，然后会将state+1,当线程释放资源后又会将state-1，注意这儿是可以重入的，当state被重置为0时，其它线程才有机会获取该锁。要注意，获取多少次就要释放多么次，这样才能保证state是能回到零态的。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;"><br/></font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">Share</font></span><span style="font-size: 12pt; font-family: punctuation, 微软雅黑, Tohoma;">依靠acquireShared，tryAcquireShared，releaseShared，tryReleaseShared：每个线程获取到资源后会唤醒唤醒后面的线程，释放资源后会唤醒后面的多个线程，直到资源不够。</span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">  比如CountDownLatch，任务分为N个子线程去执行，state也初始化为N（注意N要与线程个数一致）。这N个子线程是并行执行的，每个子线程执行完后countDown()一次，state会CAS减1。等到所有子线程都执行完后(即state=0)，会unpark()主调用线程，然后主调用线程就会获取到资源，从await()函数返回，继续后余动作。</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">不同的自定义同步器争用共享资源的方式不同。自定义同步器在实现时只需要实现共享资源state的获取与释放方式即可，至于具体线程等待队列的维护（如获取资源失败入队/唤醒出队等），AQS已经在顶层实现好了。自定义同步器实现时主要实现以下几种方法：</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">isHeldExclusively()：该线程是否正在独占资源。只有用到condition才需要去实现它。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryAcquire(int)：独占方式。尝试获取资源，成功则返回true，失败则返回false。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</font></span></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">一般来说，自定义同步器要么是独占方法，要么是共享方式，只需实现tryAcquire-tryRelease、tryAcquireShared-tryReleaseShared中的一种即可。但AQS也支持自定义同步器同时实现独占和共享两种方式，如ReentrantReadWriteLock。</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">同步类在实现时一般都将自定义同步器（sync）定义为内部类，供自己使用；而同步类自己（Mutex）则实现某个接口，对外服务。当然，接口的实现要直接依赖sync，它们在语义上也存在某种对应关系！！而sync只用实现资源state的获取-释放方式tryAcquire-tryRelelase，至于线程的排队、等待、唤醒等，上层的AQS都已经实现好了，我们不用关心。</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">很多同步类都有公平和不公平的方式，唯一的区别在于获取资源(tryAcquire或者tryAcquireShared)，非公平方式会直接获取资源，不管CLH队列是否为空。公平方式只有在CLH队列前没有等待线程时才会直接获取资源。非公平就可以让后来的线程有可能先获取到资源，不至于线程太饿，公平就会严格按照队列（非公平虽然获取资源是直接获取，不管队列是否为空，但是因为处于CLH的队列是挨着唤醒的，而且有检查，所以进入了CLH队列后就一定会排队了，简单来说非公平模式在第一次没获取到资源时，后面一定会按照顺序唤醒）</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">AQS还提供了有限时间等待，可中断的等待，前者不过是加了等待时间，后者只是注意了打断状态，其算法框架和思想还是和上面最基本的方式是一样的</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;"><font style="font-size: 12pt;">整个AQS实现非常精妙，很有学习价值。勉强学通，后面慢慢深入</font></span></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><font style="font-size: 12pt;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;">补充一个关于Condition的文章：</span><a href="http://m.blog.csdn.net/Truong/article/details/76473821#!/xh" style="color: rgb(38, 112, 154); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;">http://m.blog.csdn.net/Truong/article/details/76473821#!/xh</a></font></div><div style="margin: 0px; padding: 0px;"><div><font style="font-size: 12pt;"><br/></font></div></div><div style="margin: 0px; padding: 0px;"><font style="font-size: 12pt;"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;">AQS教程原文地址：</span><a href="http://www.cnblogs.com/waterystone/p/4920797.html" style="color: rgb(38, 112, 154); font-family: punctuation, 微软雅黑, Tohoma; font-variant-caps: normal; font-variant-ligatures: normal;">http://www.cnblogs.com/waterystone/p/4920797.html</a></font></div><div><br/></div><div style="margin: 0px 0px 20px; padding: 0px; word-break: break-word; color: rgb(0, 0, 0); font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><h1 style="margin: 10px 0px; padding: 0px; font-size: 28px; font-weight: bold; line-height: 1.5;"><span style="font-size: 28px; font-weight: bold; line-height: 1.5;">一、概述</span></h1><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　谈到并发，不得不谈ReentrantLock；而谈到ReentrantLock，不得不谈AbstractQueuedSynchronizer（AQS）！</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　类如其名，抽象的队列式的同步器，AQS定义了一套多线程访问共享资源的同步器框架，许多同步类实现都依赖于它，如常用的ReentrantLock/Semaphore/CountDownLatch...。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　以下是本文的目录大纲：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">概述</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">框架</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">源码详解</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">简单应用</li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　若有不正之处，请谅解和批评指正，不胜感激。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　请尊重作者劳动成果，转载请标明原文链接：</span><a href="http://www.cnblogs.com/waterystone/p/4920797.html" style="text-indent: 0px; color: black; text-decoration: underline;">http://www.cnblogs.com/waterystone/p/4920797.html</a></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; color: rgb(0, 0, 255);">　　</span><span style="text-indent: 0px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">手机版可访问：</span><a href="https://mp.weixin.qq.com/s/eyZyzk8ZzjwzZYN4a4H5YA" style="text-indent: 0px; color: black; background-color: rgb(255, 255, 255); text-decoration: underline;">https://mp.weixin.qq.com/s/eyZyzk8ZzjwzZYN4a4H5YA</a><span style="text-indent: 0px; color: rgb(0, 0, 255);">　　</span></div><h1 style="margin: 10px 0px; padding: 0px; font-size: 28px; font-weight: bold; line-height: 1.5;"><span style="font-size: 28px; font-weight: bold; line-height: 1.5;">二、框架</span></h1><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><img src="https://images2015.cnblogs.com/blog/721070/201705/721070-20170504110246211-10684485.png" style="margin: 0px; padding: 0px; border: 0px; max-width: 900px;"></img></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　它维护了一个volatile int state（代表共享资源）和一个FIFO线程等待队列（多线程争用资源被阻塞时会进入此队列）。这里volatile是核心关键词，具体volatile的语义，在此不述。state的访问方式有三种:</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">getState()</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">setState()</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">compareAndSetState()</li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　AQS定义两种资源共享方式：Exclusive（独占，只有一个线程能执行，如ReentrantLock）和Share（共享，多个线程可同时执行，如Semaphore/CountDownLatch）。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　不同的自定义同步器争用共享资源的方式也不同。</span><span style="text-indent: 0px; color: rgb(0, 0, 255); font-weight: bold;">自定义同步器在实现时只需要实现共享资源state的获取与释放方式即可</span><span style="text-indent: 0px;">，至于具体线程等待队列的维护（如获取资源失败入队/唤醒出队等），AQS已经在顶层实现好了。自定义同步器实现时主要实现以下几种方法：</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">isHeldExclusively()：该线程是否正在独占资源。只有用到condition才需要去实现它。</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">tryAcquire(int)：独占方式。尝试获取资源，成功则返回true，失败则返回false。</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false。</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;">tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false。</li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　以ReentrantLock为例，state初始化为0，表示未锁定状态。A线程lock()时，会调用tryAcquire()独占该锁并将state+1。此后，其他线程再tryAcquire()时就会失败，直到A线程unlock()到state=0（即释放锁）为止，其它线程才有机会获取该锁。当然，释放锁之前，A线程自己是可以重复获取此锁的（state会累加），这就是可重入的概念。但要注意，获取多少次就要释放多么次，这样才能保证state是能回到零态的。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　再以CountDownLatch以例，任务分为N个子线程去执行，state也初始化为N（注意N要与线程个数一致）。这N个子线程是并行执行的，每个子线程执行完后countDown()一次，state会CAS减1。等到所有子线程都执行完后(即state=0)，会unpark()主调用线程，然后主调用线程就会从await()函数返回，继续后余动作。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　一般来说，自定义同步器要么是独占方法，要么是共享方式，他们也只需实现tryAcquire-tryRelease、tryAcquireShared-tryReleaseShared中的一种即可。但AQS也支持自定义同步器同时实现独占和共享两种方式，如ReentrantReadWriteLock。</span></div><h1 style="margin: 10px 0px; padding: 0px; font-size: 28px; font-weight: bold; line-height: 1.5;"><span style="font-size: 28px; font-weight: bold; line-height: 1.5;">三、源码详解</span></h1><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　本节开始讲解AQS的源码实现。依照acquire-release、acquireShared-releaseShared的次序来。</span></div><h2 style="margin: 10px 0px; padding: 0px; font-size: 21px; font-weight: bold; line-height: 1.5;"><span style="font-size: 21px; font-weight: bold; line-height: 1.5;">3.1 acquire(int)</span></h2><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法是独占模式下线程获取共享资源的顶层入口。如果获取到资源，线程直接返回，否则进入等待队列，直到获取到资源为止，</span><span style="text-indent: 0px; color: rgb(0, 0, 255);">且整个过程忽略中断的影响</span><span style="text-indent: 0px;">。这也正是lock()的语义，当然不仅仅只限于lock()。获取到资源后，线程就可以去执行其临界区代码了。</span><span style="text-indent: 0px; line-height: 1.5;">下面是acquire()的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> acquire(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (!tryAcquire(arg) &amp;&amp;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">selfInterrupt();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> }</div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　函数流程如下：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">tryAcquire()尝试直接去获取资源，如果成功则直接返回；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">addWaiter()将该线程加入等待队列的尾部，并标记为独占模式；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">acquireQueued()使线程在等待队列中获取资源，一直获取到资源后才返回。如果在整个等待过程中被中断过，则返回true，否则返回false。</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">如果线程在等待过程中被中断过，它是不响应的。只是获取资源后才再进行自我中断selfInterrupt()，将中断补上。</li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　这时单凭这4个抽象的函数来看流程还有点朦胧，不要紧，看完接下来的分析后，你就会明白了。就像《大话西游》里唐僧说的：</span><span style="text-indent: 0px; color: rgb(255, 0, 0);">等你明白了舍生取义的道理，你自然会回来和我唱这首歌的。</span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.1.1 tryAcquire(int)</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法尝试去获取独占资源。如果获取成功，则直接返回true，否则直接返回false。这也正是tryLock()的语义，还是那句话，当然不仅仅只限于tryLock()。如下是tryAcquire()的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">protected</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> tryAcquire(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">throw</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">new</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">UnsupportedOperationException();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> }</div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　什么？直接throw异常？说好的功能呢？好吧，</span><span style="text-indent: 0px; color: rgb(0, 0, 255); font-weight: bold;">还记得概述里讲的AQS只是一个框架，具体资源的获取/释放方式交由自定义同步器去实现吗？</span><span style="text-indent: 0px;">就是这里了！！！AQS这里只定义了一个接口，具体资源的获取交由自定义同步器去实现了（通过state的get/set/CAS）！！！至于能不能重入，能不能加塞，那就看具体的自定义同步器怎么去设计了！！！当然，自定义同步器在进行资源访问时要考虑线程安全的影响。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　这里之所以没有定义成abstract，是因为独占模式下只用实现tryAcquire-tryRelease，而共享模式下只用实现tryAcquireShared-tryReleaseShared。如果都定义成abstract，那么每个模式也要去实现另一模式下的接口。说到底，Doug Lea还是站在咱们开发者的角度，尽量减少不必要的工作量。</span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.1.2 addWaiter(Node)</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法用于将当前线程加入到等待队列的队尾，并返回当前线程所在的结点。还是上源码吧：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Node addWaiter(Node mode) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">以给定模式构造结点。mode有两种：EXCLUSIVE（独占）和SHARED（共享）</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> Node node = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">new</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Node(Thread.currentThread(), mode);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">尝试快速方式直接放到队尾。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> Node pred = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">tail;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (pred != <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> node.prev = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">pred;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(compareAndSetTail(pred, node)) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> pred.next = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">node;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">node;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">上一步失败则通过enq入队。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">enq(node);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">node;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> 不用再说了，直接看注释吧。</span></div><h4 style="margin: 10px 0px; padding: 0px; font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);"><span style="font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);">3.1.2.1 enq(Node)</span></h4><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> 　　此方法用于将node加入队尾。源码如下：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> Node enq(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Node node) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">CAS&quot;自旋&quot;，直到成功加入队尾</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(;;) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> Node t = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">tail;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (t == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span>) { <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">队列为空，创建一个空的标志结点作为head结点，并将tail也指向它。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (compareAndSetHead(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">new</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Node()))</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> tail = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">head;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> } <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">else</span> {<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">正常流程，放入队尾</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> node.prev = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">t;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(compareAndSetTail(t, node)) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> t.next = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">node;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">t;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">如果你看过AtomicInteger.getAndIncrement()函数源码，那么相信你一眼便看出这段代码的精华。</span><span style="text-indent: 0px; color: rgb(0, 0, 255); background-color: rgb(255, 255, 255); font-weight: bold;">CAS自旋volatile变量</span><span style="text-indent: 0px;">，是一种很经典的用法。还不太了解的，自己去百度一下吧。</span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.1.3 acquireQueued(Node, int)</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　OK，通过tryAcquire()和addWaiter()，该线程获取资源失败，已经被放入等待队列尾部了。聪明的你立刻应该能想到该线程下一部该干什么了吧：</span><span style="text-indent: 0px; color: rgb(0, 0, 255); font-weight: bold;">进入等待状态休息，直到其他线程彻底释放资源后唤醒自己，自己再拿到资源，然后就可以去干自己想干的事了</span><span style="text-indent: 0px;">。没错，就是这样！是不是跟医院排队拿号有点相似~~acquireQueued()就是干这件事：</span><span style="text-indent: 0px; font-weight: bold; color: rgb(0, 0, 255);">在等待队列中排队拿号（中间没其它事干可以休息），直到拿到号后再返回</span><span style="text-indent: 0px;">。这个函数非常关键，还是上源码吧：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> acquireQueued(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> Node node, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> failed = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span>;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">标记是否成功拿到资源</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">try</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> interrupted = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span>;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">标记等待过程中是否被中断过</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">又是一个“自旋”！</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(;;) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> Node p = node.predecessor();<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">拿到前驱</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果前驱是head，即该结点已成老二，那么便有资格去尝试获取资源（可能是老大释放完资源唤醒自己的，当然也可能被interrupt了）。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (p == head &amp;&amp; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">tryAcquire(arg)) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> setHead(node);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">拿到资源后，将head指向该结点。所以head所指的标杆结点，就是当前获取到资源的那个结点或null。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> p.next = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span>; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">setHead中node.prev已置为null，此处再将head.next置为null，就是为了方便GC回收以前的head结点。也就意味着之前拿完资源的结点出队了！</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> failed = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> interrupted;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">返回等待过程中是否被中断过</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果自己可以休息了，就进入waiting状态，直到被unpark()</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">19</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">parkAndCheckInterrupt())</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">20</span> interrupted = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span>;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果等待过程中被中断过，哪怕只有那么一次，就将interrupted标记为true</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">21</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">22</span> } <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">finally</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">23</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(failed)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">24</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">cancelAcquire(node);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">25</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">26</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">到这里了，我们先不急着总结acquireQueued()的函数流程，先看看shouldParkAfterFailedAcquire()和parkAndCheckInterrupt()具体干些什么。</span></div><h4 style="margin: 10px 0px; padding: 0px; font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);"><span style="font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);">3.1.3.1 shouldParkAfterFailedAcquire(Node, Node)</span></h4><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法主要用于检查状态，看看自己是否真的可以去休息了（进入waiting状态，如果线程状态转换不熟，可以参考本人上一篇写的</span><a href="http://www.cnblogs.com/waterystone/p/4920007.html" style="text-indent: 0px; color: rgb(0, 0, 255); text-decoration: underline;">Thread详解</a><span style="text-indent: 0px;">），万一队列前边的线程都放弃了只是瞎站着，那也说不定，对吧！</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">shouldParkAfterFailedAcquire(Node pred, Node node) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> ws = pred.waitStatus;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">拿到前驱的状态</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (ws == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Node.SIGNAL)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果已经告诉前驱拿完号后通知自己一下，那就可以安心休息了</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (ws &gt; 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">* 如果前驱放弃了，那就一直往前找，直到找到最近一个正常等待的状态，并排在它的后边。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">* 注意：那些放弃的结点，由于被自己“加塞”到它们前边，它们相当于形成一个无引用链，稍后就会被保安大叔赶走了(GC回收)！</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">do</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> node.prev = pred = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">pred.prev;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> } <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">while</span> (pred.waitStatus &gt; 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> pred.next = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">node;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> } <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">else</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果前驱正常，那就把前驱的状态设置成SIGNAL，告诉它拿完号后通知自己一下。有可能失败，人家说不定刚刚释放完呢！</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">19</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">20</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">整个流程中，如果前驱结点的状态不是SIGNAL，那么自己就不能安心去休息，需要去找个安心的休息点，同时可以再尝试下看有没有机会轮到自己拿号。</span></div><h4 style="margin: 10px 0px; padding: 0px; font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);"><span style="font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);">3.1.3.2 parkAndCheckInterrupt()</span></h4><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　如果线程找好安全休息点后，那就可以安心去休息了。此方法就是让线程去休息，真正进入等待状态。</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">parkAndCheckInterrupt() {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> LockSupport.park(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">this</span>);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">调用park()使线程进入waiting状态</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> Thread.interrupted();<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果被唤醒，查看自己是不是被中断的。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> }</div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> 　　park()会让当前线程进入waiting状态。在此状态下，有两种途径可以唤醒该线程：1）被unpark()；2）被interrupt()。（再说一句，如果线程状态转换不熟，可以参考本人写的</span><a href="http://www.cnblogs.com/waterystone/p/4920007.html" style="text-indent: 0px; color: rgb(0, 0, 255); text-decoration: underline;">Thread详解</a><span style="text-indent: 0px;">）。需要注意的是，Thread.interrupted()会清除当前线程的中断标记位。 </span></div><h4 style="margin: 10px 0px; padding: 0px; font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);"><span style="font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);">3.1.3.3 小结</span></h4><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　OK，看了shouldParkAfterFailedAcquire()和parkAndCheckInterrupt()，现在让我们再回到acquireQueued()，总结下该函数的具体流程：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">结点进入队尾后，检查状态，找到安全休息点；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">调用park()进入waiting状态，等待unpark()或interrupt()唤醒自己；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">被唤醒后，看自己是不是有资格能拿到号。如果拿到，head指向当前结点，并返回从入队到拿到号的整个过程中是否被中断过；如果没拿到，继续流程1。</li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.1.4 小结</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　OKOK，acquireQueued()分析完之后，我们接下来再回到acquire()！再贴上它的源码吧：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> acquire(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (!tryAcquire(arg) &amp;&amp;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">selfInterrupt();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> }</div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">再来总结下它的流程吧：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">调用自定义同步器的tryAcquire()尝试直接去获取资源，如果成功则直接返回；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">没成功，则addWaiter()将该线程加入等待队列的尾部，并标记为独占模式；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">acquireQueued()使线程在等待队列中休息，有机会时（轮到自己，会被unpark()）会去尝试获取资源。获取到资源后才返回。如果在整个等待过程中被中断过，则返回true，否则返回false。</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">如果线程在等待过程中被中断过，它是不响应的。只是获取资源后才再进行自我中断selfInterrupt()，将中断补上。</li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">由于此函数是重中之重，我再用流程图总结一下：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><img src="https://images2015.cnblogs.com/blog/721070/201511/721070-20151102145743461-623794326.png" style="margin: 0px; padding: 0px; border: 0px; max-width: 900px;"></img></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">至此，acquire()的流程终于算是告一段落了。这也就是ReentrantLock.lock()的流程，不信你去看其lock()源码吧，整个函数就是一条acquire(1)！！！</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><h2 style="margin: 10px 0px; padding: 0px; font-size: 21px; font-weight: bold; line-height: 1.5;"><span style="font-size: 21px; font-weight: bold; line-height: 1.5;">3.2 release(int)</span></h2><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> 　　上一小节已经把acquire()说完了，这一小节就来讲讲它的反操作release()吧。此方法是独占模式下线程释放共享资源的顶层入口。它会释放指定量的资源，如果彻底释放了（即state=0）,它会唤醒等待队列里的其他线程来获取资源。这也正是unlock()的语义，当然不仅仅只限于unlock()。下面是release()的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> release(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(tryRelease(arg)) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> Node h = head;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">找到头结点</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (h != <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span> &amp;&amp; h.waitStatus != 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> unparkSuccessor(h);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">唤醒等待队列里的下一个线程</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　逻辑并不复杂。它调用tryRelease()来释放资源。有一点需要注意的是，</span><span style="text-indent: 0px; color: rgb(0, 0, 255); font-weight: bold;">它是根据tryRelease()的返回值来判断该线程是否已经完成释放掉资源了！所以自定义同步器在设计tryRelease()的时候要明确这一点！！</span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.2.1 tryRelease(int)</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法尝试去释放指定量的资源。下面是tryRelease()的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">protected</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> tryRelease(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">throw</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">new</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">UnsupportedOperationException();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> }</div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　跟tryAcquire()一样，这个方法是需要独占模式的自定义同步器去实现的。正常来说，tryRelease()都会成功的，因为这是独占模式，该线程来释放资源，那么它肯定已经拿到独占资源了，直接减掉相应量的资源即可(state-=arg)，也不需要考虑线程安全的问题。但要注意它的返回值，上面已经提到了，</span><span style="text-indent: 0px; font-weight: bold; color: rgb(0, 0, 255);">release()是根据tryRelease()的返回值来判断该线程是否已经完成释放掉资源了！</span><span style="text-indent: 0px;">所以自义定同步器在实现时，如果已经彻底释放资源(state=0)，要返回true，否则返回false。</span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.2.2 unparkSuccessor(Node)</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法用于唤醒等待队列中下一个线程。下面是源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">unparkSuccessor(Node node) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">这里，node一般为当前线程所在的结点。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> ws = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">node.waitStatus;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (ws &lt; 0)<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">置零当前线程所在的结点状态，允许失败。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> compareAndSetWaitStatus(node, ws, 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> Node s = node.next;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">找到下一个需要唤醒的结点s</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (s == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span> || s.waitStatus &gt; 0) {<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果为空或已取消</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> s = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> (Node t = tail; t != <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span> &amp;&amp; t != node; t = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">t.prev)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (t.waitStatus &lt;= 0)<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">从这里可以看出，&lt;=0的结点，都是还有效的结点。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> s = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">t;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (s != <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> LockSupport.unpark(s.thread);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">唤醒</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　这个函数并不复杂。一句话概括：</span><span style="text-indent: 0px; font-weight: bold; color: rgb(0, 0, 255);">用unpark()唤醒等待队列中最前边的那个未放弃线程</span><span style="text-indent: 0px;">，这里我们也用s来表示吧。此时，再和acquireQueued()联系起来，s被唤醒后，进入if (p == head &amp;&amp; tryAcquire(arg))的判断（即使p!=head也没关系，它会再进入shouldParkAfterFailedAcquire()寻找一个安全点。这里既然s已经是等待队列中最前边的那个未放弃线程了，那么通过shouldParkAfterFailedAcquire()的调整，s也必然会跑到head的next结点，下一次自旋p==head就成立啦），然后s把自己设置成head标杆结点，表示自己已经获取到资源了，acquire()也返回了！！And then, DO what you WANT!</span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.2.3 小结</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　release()是独占模式下线程释放共享资源的顶层入口。它会释放指定量的资源，如果彻底释放了（即state=0）,它会唤醒等待队列里的其他线程来获取资源。</span></div><h2 style="margin: 10px 0px; padding: 0px; font-size: 21px; font-weight: bold; line-height: 1.5;"><span style="font-size: 21px; font-weight: bold; line-height: 1.5;">3.3 acquireShared(int)</span></h2><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法是共享模式下线程获取共享资源的顶层入口。它会获取指定量的资源，获取成功则直接返回，获取失败则进入等待队列，直到获取到资源为止，整个过程忽略中断。下面是acquireShared()的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> acquireShared(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (tryAcquireShared(arg) &lt; 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">doAcquireShared(arg);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> }</div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　这里tryAcquireShared()依然需要自定义同步器去实现。但是AQS已经把其返回值的语义定义好了：负值代表获取失败；0代表获取成功，但没有剩余资源；正数表示获取成功，还有剩余资源，其他线程还可以去获取。所以这里acquireShared()的流程就是：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">tryAcquireShared()尝试获取资源，成功则直接返回；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">失败则通过doAcquireShared()进入等待队列，直到获取到资源为止才返回。</li></ol><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.3.1 doAcquireShared(int)</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法用于将当前线程加入等待队列尾部休息，直到其他线程释放资源唤醒自己，自己成功拿到相应量的资源后才返回。下面是doAcquireShared()的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> doAcquireShared(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> Node node = addWaiter(Node.SHARED);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">加入队列尾部</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> failed = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span>;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">是否成功标志</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">try</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> interrupted = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span>;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">等待过程中是否被中断过的标志</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(;;) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> Node p = node.predecessor();<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">前驱</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (p == head) {<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果到head的下一个，因为head是拿到资源的线程，此时node被唤醒，很可能是head用完资源来唤醒自己的</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> r = tryAcquireShared(arg);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">尝试获取资源</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (r &gt;= 0) {<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">成功</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> setHeadAndPropagate(node, r);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">将head指向自己，还有剩余资源可以再唤醒之后的线程</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> p.next = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span>; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">help GC</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (interrupted)<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果等待过程中被打断过，此时将中断补上。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">selfInterrupt();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> failed = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">19</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">20</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">判断状态，寻找安全点，进入waiting状态，等着被unpark()或interrupt()</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">21</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">22</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">parkAndCheckInterrupt())</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">23</span> interrupted = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">24</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">25</span> } <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">finally</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">26</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(failed)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">27</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">cancelAcquire(node);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">28</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">29</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　有木有觉得跟acquireQueued()很相似？对，其实流程并没有太大区别。只不过这里将补中断的selfInterrupt()放到doAcquireShared()里了，而独占模式是放到acquireQueued()之外，其实都一样，不知道Doug Lea是怎么想的。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　跟独占模式比，还有一点需要注意的是，这里只有线程是head.next时（“老二”），才会去尝试获取资源，有剩余的话还会唤醒之后的队友。那么问题就来了，假如老大用完后释放了5个资源，而老二需要6个，老三需要1个，老四需要2个。老大先唤醒老二，老二一看资源不够，他是把资源让给老三呢，还是不让？答案是否定的！老二会继续park()等待其他线程释放资源，也更不会去唤醒老三和老四了。独占模式，同一时刻只有一个线程去执行，这样做未尝不可；但共享模式下，多个线程是可以同时执行的，现在因为老二的资源需求量大，而把后面量小的老三和老四也都卡住了。当然，这并不是问题，只是AQS保证严格按照入队顺序唤醒罢了（保证公平，但降低了并发）。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><h4 style="margin: 10px 0px; padding: 0px; font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);"><span style="font-size: 14px; font-weight: bold; color: rgb(51, 51, 51);">3.3.1.1 setHeadAndPropagate(Node, int)</span></h4><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> setHeadAndPropagate(Node node, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">propagate) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> Node h = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">head;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> setHead(node);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">head指向自己</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">如果还有剩余量，继续唤醒下一个邻居线程</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (propagate &gt; 0 || h == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span> || h.waitStatus &lt; 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> Node s = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">node.next;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (s == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span> || <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">s.isShared())</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">doReleaseShared();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法在setHead()的基础上多了一步，就是自己苏醒的同时，如果条件符合（比如还有剩余资源），还会去唤醒后继结点，毕竟是共享模式！</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　doReleaseShared()我们留着下一小节的releaseShared()里来讲。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.3.2 小结</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　OK，至此，acquireShared()也要告一段落了。让我们再梳理一下它的流程：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">tryAcquireShared()尝试获取资源，成功则直接返回；</li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;">失败则通过doAcquireShared()进入等待队列park()，直到被unpark()/interrupt()并成功获取到资源才返回。整个等待过程也是忽略中断的。</li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　其实跟acquire()的流程大同小异，只不过多了个</span><span style="text-indent: 0px; color: rgb(0, 0, 255); font-weight: bold;">自己拿到资源后，还会去唤醒后继队友的操作（这才是共享嘛）</span><span style="text-indent: 0px;">。</span></div><h2 style="margin: 10px 0px; padding: 0px; font-size: 21px; font-weight: bold; line-height: 1.5;"><span style="font-size: 21px; font-weight: bold; line-height: 1.5;">3.4 releaseShared()</span></h2><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　上一小节已经把acquireShared()说完了，这一小节就来讲讲它的反操作releaseShared()吧。此方法是共享模式下线程释放共享资源的顶层入口。它会释放指定量的资源，如果成功释放且允许唤醒等待线程，它会唤醒等待队列里的其他线程来获取资源。下面是releaseShared()的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> releaseShared(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">arg) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (tryReleaseShared(arg)) {<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">尝试释放资源</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> doReleaseShared();<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">唤醒后继结点</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法的流程也比较简单，一句话：</span><span style="text-indent: 0px; color: rgb(0, 0, 255);">释放掉资源后，唤醒后继</span><span style="text-indent: 0px;">。跟独占模式下的release()相似，但有一点稍微需要注意：独占模式下的tryRelease()在完全释放掉资源（state=0）后，才会返回true去唤醒其他线程，这主要是基于独占下可重入的考量；而共享模式下的releaseShared()则没有这种要求，共享模式实质就是控制一定量的线程并发执行，那么拥有资源的线程在释放掉部分资源时就可以唤醒后继等待结点。例如，资源总量是13，A（5）和B（7）分别获取到资源并发运行，C（4）来时只剩1个资源就需要等待。A在运行过程中释放掉2个资源量，然后tryReleaseShared(2)返回true唤醒C，C一看只有3个仍不够继续等待；随后B又释放2个，tryReleaseShared(2)返回true唤醒C，C一看有5个够自己用了，然后C就可以跟A和B一起运行。而ReentrantReadWriteLock读锁的tryReleaseShared()只有在完全释放掉资源（state=0）才返回true，所以自定义同步器可以根据需要决定tryReleaseShared()的返回值。</span></div><h3 style="margin: 10px 0px; padding: 0px; font-size: 16px; font-weight: bold; line-height: 1.5;"><span style="font-size: 16px; font-weight: bold; line-height: 1.5;">3.4.1 doReleaseShared()</span></h3><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　此方法主要用于唤醒后继。下面是它的源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">doReleaseShared() {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(;;) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> Node h = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">head;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (h != <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span> &amp;&amp; h != <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">tail) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> ws = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">h.waitStatus;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (ws == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Node.SIGNAL) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">))</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">continue</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> unparkSuccessor(h);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">唤醒后继</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">else</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (ws == 0 &amp;&amp;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> !compareAndSetWaitStatus(h, 0<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">, Node.PROPAGATE))</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">continue</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (h == head)<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">head发生变化</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">break</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><h2 style="margin: 10px 0px; padding: 0px; font-size: 21px; font-weight: bold; line-height: 1.5;"><span style="font-size: 21px; font-weight: bold; line-height: 1.5;">3.5 小结</span></h2><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　本节我们详解了独占和共享两种模式下获取-释放资源(acquire-release、acquireShared-releaseShared)的源码，相信大家都有一定认识了。值得注意的是，acquire()和acquireSahred()两种方法下，线程在等待队列中都是忽略中断的。AQS也支持响应中断的，acquireInterruptibly()/acquireSharedInterruptibly()即是，这里相应的源码跟acquire()和acquireSahred()差不多，这里就不再详解了。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><h1 style="margin: 10px 0px; padding: 0px; font-size: 28px; font-weight: bold; line-height: 1.5;"><span style="font-size: 28px; font-weight: bold; line-height: 1.5;">四、简单应用</span></h1><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　通过前边几个章节的学习，相信大家已经基本理解AQS的原理了。这里再将“框架”一节中的一段话复制过来：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; color: rgb(0, 0, 255); text-decoration: underline;">　　不同的自定义同步器争用共享资源的方式也不同。</span><span style="text-indent: 0px; color: rgb(0, 0, 255); font-weight: bold; text-decoration: underline;">自定义同步器在实现时只需要实现共享资源state的获取与释放方式即可</span><span style="text-indent: 0px; color: rgb(0, 0, 255); text-decoration: underline;">，至于具体线程等待队列的维护（如获取资源失败入队/唤醒出队等），AQS已经在顶层实现好了。自定义同步器实现时主要实现以下几种方法：</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="color: rgb(0, 0, 255); text-decoration: underline;">isHeldExclusively()：该线程是否正在独占资源。只有用到condition才需要去实现它。</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="color: rgb(0, 0, 255); text-decoration: underline;">tryAcquire(int)：独占方式。尝试获取资源，成功则返回true，失败则返回false。</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="color: rgb(0, 0, 255); text-decoration: underline;">tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false。</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="color: rgb(0, 0, 255); text-decoration: underline;">tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="color: rgb(0, 0, 255); text-decoration: underline;">tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false。</span></li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　OK，下面我们就以AQS源码里的Mutex为例，讲一下AQS的简单应用。</span></div><h2 style="margin: 10px 0px; padding: 0px; font-size: 21px; font-weight: bold; line-height: 1.5;"><span style="font-size: 21px; font-weight: bold; line-height: 1.5;">4.1 Mutex（互斥锁）</span></h2><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　Mutex是一个不可重入的互斥锁实现。锁资源（AQS里的state）只有两种状态：0表示未锁定，1表示锁定。下边是Mutex的核心源码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">class</span> Mutex <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">implements</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Lock, java.io.Serializable {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">自定义同步器</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">class</span> Sync <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">extends</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">AbstractQueuedSynchronizer {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">判断是否锁定状态</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">protected</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">isHeldExclusively() {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> getState() == 1<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">尝试获取资源，立即返回。成功则返回true，否则false。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> tryAcquire(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">acquires) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">assert</span> acquires == 1; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">这里限定只能为1个量</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (compareAndSetState(0, 1)) {<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">state为0才设置为1，不可重入！</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> setExclusiveOwnerThread(Thread.currentThread());<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">设置为当前线程独占资源</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">false</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">19</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">尝试释放资源，立即返回。成功则为true，否则false。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">20</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">protected</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> tryRelease(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">releases) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">21</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">assert</span> releases == 1; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">限定为1个量</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">22</span> <span style="color: rgb(0, 0, 255); line-height: 1.5 !important;">if</span> (getState() == 0)<span style="color: rgb(0, 128, 0); line-height: 1.5 !important;">//</span><span style="color: rgb(0, 128, 0); line-height: 1.5 !important;">既然来释放，那肯定就是已占有状态了。只是为了保险，多层判断！</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">23</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">throw</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">new</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">IllegalMonitorStateException();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">24</span> setExclusiveOwnerThread(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">null</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">25</span> setState(0);<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">释放资源，放弃占有状态</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">26</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">true</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">27</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">28</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">29</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">30</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">真正同步类的实现都依赖继承于AQS的自定义同步器！</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">31</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">private</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">final</span> Sync sync = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">new</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">Sync();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">32</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">33</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">lock&lt;--&gt;acquire。两者语义一样：获取资源，即便等待，直到成功才返回。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">34</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">lock() {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">35</span> sync.acquire(1<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">36</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">37</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">38</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">tryLock&lt;--&gt;tryAcquire。两者语义一样：尝试获取资源，要求立即返回。成功则为true，失败则为false。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">39</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">tryLock() {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">40</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> sync.tryAcquire(1<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">41</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">42</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">43</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">unlock&lt;--&gt;release。两者语文一样：释放资源。</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">44</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">unlock() {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">45</span> sync.release(1<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">46</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">47</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">48</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">锁是否占有状态</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">49</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">public</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">boolean</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">isLocked() {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">50</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sync.isHeldExclusively();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">51</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">52</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　同步类在实现时一般都将自定义同步器（sync）定义为内部类，供自己使用；而同步类自己（Mutex）则实现某个接口，对外服务。当然，接口的实现要直接依赖sync，它们在语义上也存在某种对应关系！！而sync只用实现资源state的获取-释放方式tryAcquire-tryRelelase，至于线程的排队、等待、唤醒等，上层的AQS都已经实现好了，我们不用关心。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　除了Mutex，ReentrantLock/CountDownLatch/Semphore这些同步类的实现方式都差不多，不同的地方就在获取-释放资源的方式tryAcquire-tryRelelase。掌握了这点，AQS的核心便被攻破了！</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　OK，至此，整个AQS的讲解也要落下帷幕了。希望本文能够对学习Java并发编程的同学有所借鉴，中间写的有不对的地方，也欢迎讨论和指正~</span></div></div><div style="margin: 0px; padding: 0px;"><div style="margin: 0px; padding: 0px;">作者：<a href="http://www.cnblogs.com/waterystone/" style="color: black; text-decoration: underline;">水岩</a></div><div>　　　　</div><div style="margin: 0px; padding: 0px;">出处：<a href="http://www.cnblogs.com/waterystone/" style="color: black; text-decoration: underline;">http://www.cnblogs.com/waterystone/</a></div><div>　　　　</div><div style="margin: 0px; padding: 0px;">本博客中未标明转载的文章归作者<a href="http://www.cnblogs.com/waterystone/" style="color: black; text-decoration: underline;">水岩</a>和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。</div></div><div><br/></div></span>
</div></body></html> 