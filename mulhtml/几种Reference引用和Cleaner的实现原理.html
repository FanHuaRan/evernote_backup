<html>
<head>
  <title>几种Reference引用和Cleaner的实现原理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="905"/>
<h1>几种Reference引用和Cleaner的实现原理</h1>

<div>
<span><div><div><font style="font-size: 18pt;"><span style="color: rgb(20, 113, 145); font-size: 18pt; font-weight: bold;">Reference引用的原理</span></font></div><div>参考源码我们可以发现几种引用实际上大部分逻辑都在Reference基类当中。</div><div>看看Reference的源码：</div><div><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">abstract</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">class</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">&lt;T&gt; {</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* A Reference instance is in one of four possible internal states:</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Active: Subject to special treatment by the garbage collector.  Some</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     time after the collector detects that the reachability of the</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     referent has changed to the appropriate state, it changes the</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     instance's state to either Pending or Inactive, depending upon</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     whether or not the instance was registered with a queue when it was</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     created.  In the former case it also adds the instance to the</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     pending-Reference list.  Newly-created instances are Active.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Pending: An element of the pending-Reference list, waiting to be</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     enqueued by the Reference-handler thread.  Unregistered instances</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     are never in this state.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Enqueued: An element of the queue with which the instance was</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     registered when it was created.  When an instance is removed from</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     its ReferenceQueue, it is made Inactive.  Unregistered instances are</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     never in this state.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Inactive: Nothing more to do.  Once an instance becomes Inactive its</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     state will never change again.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * The state is encoded in the queue and next fields as follows:</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Active: queue = ReferenceQueue with which instance is registered, or</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     ReferenceQueue.NULL if it was not registered with a queue; next =</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     null.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Pending: queue = ReferenceQueue with which instance is registered;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     next = this</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Enqueued: queue = ReferenceQueue.ENQUEUED; next = Following instance</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     in queue, or this if at end of list.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     Inactive: queue = ReferenceQueue.NULL; next = this.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * With this scheme the collector need only examine the next field in order</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * to determine whether a Reference instance requires special treatment: If</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * the next field is null then the instance is active; if it is non-null,</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * then the collector should treat the instance normally.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * To ensure that a concurrent collector can discover active Reference</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * objects without interfering with application threads that may apply</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * the enqueue() method to those objects, collectors should link</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * discovered objects through the discovered field. The discovered</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * field is also used for linking Reference objects in the pending list.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">T</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">referent</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;        </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* Treated specially by GC */</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">volatile</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">ReferenceQueue&lt;?</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">super</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">T&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">queue</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* When active:   NULL</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     pending:   this</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *    Enqueued:   next reference in queue (or this if last)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *    Inactive:   this</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(100, 100, 100); font-family: Consolas;">@SuppressWarnings</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(42, 0, 255); font-family: Consolas;">&quot;rawtypes&quot;</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">Reference</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">next</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* When active:   next element in a discovered reference list maintained by GC (or this if last)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *     pending:   next element in the pending list (or null if last)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     *   otherwise:   NULL</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">transient</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">&lt;T&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">discovered</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">; </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* used by VM */</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* Object used to synchronize with the garbage collector.  The collector</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * must acquire this lock at the beginning of each collection cycle.  It is</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * therefore critical that any code holding this lock complete as quickly</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * as possible, allocate no new objects, and avoid calling user code.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">class</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Lock { }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Lock</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">lock</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">new</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Lock();</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* List of References waiting to be enqueued.  The collector adds</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * References to this list, while the Reference-handler thread removes</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * them.  This list is protected by the above lock object. The</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     * list uses the discovered field to link its elements.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">&lt;Object&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">pending</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* High-priority thread to enqueue pending References</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">class</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">ReferenceHandler</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">extends</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Thread {</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">void</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">ensureClassInitialized(Class&lt;?&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">clazz</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">try</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                Class.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">forName</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">clazz</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.getName(),</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">clazz</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.getClassLoader());</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            }</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(ClassNotFoundException</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">e</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">               </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">throw</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(Error)</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">new</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">NoClassDefFoundError(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">e</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.getMessage()).initCause(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">e</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// pre-load and initialize InterruptedException and Cleaner classes</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// so that we don't get into trouble later in the run loop if there's</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// memory shortage while loading/initializing them lazily.</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 11pt; font-size: 14pt; font-family: Consolas; font-style: italic;">ensureClassInitialized</span><span style="min-height: 11pt; font-size: 14pt; font-family: Consolas;">(InterruptedException.</span><span style="min-height: 11pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">class</span><span style="min-height: 11pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">ensureClassInitialized</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(Cleaner.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">class</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        ReferenceHandler(ThreadGroup</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">g</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">, String</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">name</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">super</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">g</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">name</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">void</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">run() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">while</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">               </span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">tryHandlePending</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * Try handle pending</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">{@link</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); color: rgb(63, 63, 191); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">}</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">if there is one.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;p&gt;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * Return {@code true} as a hint that there might be another</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">{@link</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); color: rgb(63, 63, 191); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">}</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">pending or {@code false} when there are no more pending</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">{@link</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); color: rgb(63, 63, 191); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">}</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">s at the moment and the program can do some other</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * useful work instead of looping.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 159, 191); font-family: Consolas; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">waitForNotify if {@code true} and there was no pending</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *                     </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">{@link</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); color: rgb(63, 63, 191); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">}</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">, wait until notified from VM</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *                      or interrupted; if {@code false}, return immediately</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *                      when there is no pending</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">{@link</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); color: rgb(63, 63, 191); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">}</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 159, 191); font-family: Consolas; font-weight: bold;">@return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">{@code true} if there was a</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">{@link</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); color: rgb(63, 63, 191); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 63, 191); font-family: Consolas;">}</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">pending and it</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *         was processed, or we waited for notification and either got it</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *         or thread was interrupted before being notified;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *         {@code false} otherwise.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">tryHandlePending(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">waitForNotify</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">Reference</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">&lt;Object&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        Cleaner</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">c</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">try</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">synchronized</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">lock</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">               </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">if</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">pending</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">!=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">pending</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// 'instanceof' might throw OutOfMemoryError sometimes</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// so do this before un-linking 'r' from the 'pending' chain...</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">c</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">instanceof</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Cleaner ? (Cleaner)</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">:</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// unlink 'r' from 'pending' chain</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">pending</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">discovered</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">discovered</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                }</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">else</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// The waiting on the lock may cause an OutOfMemoryError</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// because it may try to allocate exception objects.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">if</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">waitForNotify</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">lock</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.wait();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                    }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// retry if waited</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">waitForNotify</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">                }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(OutOfMemoryError</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">x</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// Give other threads CPU time so they hopefully drop some live references</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// and GC reclaims some space.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// Also prevent CPU intensive spinning in case 'r instanceof Cleaner' above</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// persistently throws OOME for some time...</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            Thread.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">yield</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// retry</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(InterruptedException</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">x</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// retry</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// Fast path for cleaners</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">if</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">c</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">!=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">c</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.clean();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        ReferenceQueue&lt;?</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">super</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Object&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">q</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">queue</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">if</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">q</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">!= ReferenceQueue.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">NULL</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">)</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">q</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.enqueue(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">r</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        ThreadGroup</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tg</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= Thread.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">currentThread</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">().getThreadGroup();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">for</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(ThreadGroup</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tgn</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tg</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tgn</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">!=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tg</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tgn</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tgn</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tg</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.getParent());</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        Thread</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">handler</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">new</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">ReferenceHandler(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">tg</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(42, 0, 255); font-family: Consolas;">&quot;Reference Handler&quot;</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* If there were a special system-only priority greater than</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">         * MAX_PRIORITY, it would be used here</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">         */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">handler</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.setPriority(Thread.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic; font-weight: bold;">MAX_PRIORITY</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">handler</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.setDaemon(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">true</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">handler</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.start();</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// provide access in SharedSecrets</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        SharedSecrets.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">setJavaLangRefAccess</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">new</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">JavaLangRefAccess() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(100, 100, 100); font-family: Consolas;">@Override</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">tryHandlePendingReference() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">               </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">tryHandlePending</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">false</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        });</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* -- Referent accessor and setters -- */</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * Returns this reference object's referent.  If this reference object has</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * been cleared, either by the program or by the garbage collector, then</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * this method returns</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">null</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;/code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 159, 191); font-family: Consolas; font-weight: bold;">@return</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">   The object to which this reference refers, or</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *          </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">null</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;/code&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">if this reference object has been cleared</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">T get() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">referent</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * Clears this reference object.  Invoking this method will not cause this</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * object to be enqueued.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;p&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">This method is invoked only by Java code; when the garbage collector</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * clears references it does so directly, without invoking this method.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">void</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">clear() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">referent</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* -- Queue operations -- */</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * Tells whether or not this reference object has been enqueued, either by</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * the program or by the garbage collector.  If this reference object was</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * not registered with a queue when it was created, then this method will</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * always return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">false</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;/code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 159, 191); font-family: Consolas; font-weight: bold;">@return</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">  </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">true</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;/code&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">if and only if this reference object has</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *           been enqueued</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">isEnqueued() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">queue</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">== ReferenceQueue.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">ENQUEUED</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * Adds this reference object to the queue with which it is registered,</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * if any.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;p&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">This method is invoked only by Java code; when the garbage collector</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     * enqueues references it does so directly, without invoking this method.</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 159, 191); font-family: Consolas; font-weight: bold;">@return</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">  </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">true</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;/code&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">if this reference object was successfully</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *           enqueued;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;code&gt;</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">false</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 127, 159); font-family: Consolas;">&lt;/code&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">if it was already enqueued or if</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     *           it was not registered with a queue when it was created</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 95, 191); font-family: Consolas;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">enqueue() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">queue</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.enqueue(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">   </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">/* -- Constructors -- */</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    Reference(T</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">referent</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">referent</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    Reference(T</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">referent</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">, ReferenceQueue&lt;?</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">super</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">T&gt;</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">queue</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">referent</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">referent</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">queue</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= (</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">queue</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">==</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) ? ReferenceQueue.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">NULL</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">:</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">queue</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">}</span></div><div><span style="font-size: 12pt;">几点讲解：</span></div><div><span style="font-size: 12pt;">1.Referent是Reference所包裹的对象引用，这儿本质上还是强引用。</span></div><div><span style="font-size: 12pt;">2.Reference类中有一个Reference类型的静态字段pending和一个私有全局lock锁。</span></div><div><span style="font-size: 12pt;">3Reference类中有一个静态</span><span style="min-height: 16pt; font-size: 12pt; font-family: Consolas;">的线程子类RefenceHandler,</span></div><div><span style="min-height: 16pt;"><span style="font-family: Consolas; font-size: 12pt;"> 该线程子类的逻辑如下：</span></span></div><div><span style="min-height: 16pt;"><span style="font-family: Consolas; font-size: 12pt;"> （1）无限循环</span></span></div><div><span style="min-height: 16pt;"><span style="font-family: Consolas; font-size: 12pt;"> （2）每次循环的逻辑如下：</span></span></div><div><span style="min-height: 16pt;"><span style="font-family: Consolas; font-size: 12pt;">      尝试获取该类的静态全局Lock，然后进入临界区，获取pending。</span></span></div><div><span style="min-height: 16pt;"><span style="font-family: Consolas; font-size: 12pt;">      获取pending以后：</span></span></div><div><span style="min-height: 16pt;"><span style="font-family: Consolas; font-size: 12pt;">         如果是该reference对象是cleaner类型，就执行它的clean方法。</span></span></div><div><span style="font-size: 12pt;">                 如果该Reference不是Cleaner类型，就将其入队，入哪个队？其自身的refencequeue。</span></div><div><span style="font-size: 12pt;"> 4.RefenceHandler是一个无限循环的线程，会伴随jvm一直运行。它所处理的pending字段从何而来？</span></div><div><span style="font-size: 12pt;">    pending来自于垃圾收集器，垃圾收集器在进行垃圾过程当中，除了进行垃圾回收对象的GC标记以外，还会进行Reference引用对象的GC标记，当一个对象只有Reference来引用它的时候，Reference内的referent引用就会被置null，同时reference对象也会被放置在pending上，然后由ReferenceHandler线程来进行处理，处理逻辑在上面。</span></div><div><span style="font-size: 12pt;">5.故Reference的魔力不仅仅是来源于API，而是垃圾收集器的GC标记处理和RefenceHandler线程的共同作用结果。</span></div><div><span style="font-size: 16px;">注意：ReferenceHandler线程与GC线程是并发的，ReferenceHandler对Reference的处理过程不会阻塞GC线程对Referent的回收（Referent的引用已经被置为null，去纠结处理时是否被回收没有意义了）</span></div><div><span style="font-size: 12pt;">终于弄明白了Reference！！！ 好累。不过还是趁热打铁来看看Cleaner</span></div><div><br/></div><div><span style="font-weight: bold; color: rgb(20, 113, 145); font-size: 18pt;">Cleaner的实现原理</span></div><div><span style="font-size: 12pt;">PhantomReference是Reference的一个子类，Cleaner是PhantomReference的一个子类。</span></div><div><span style="font-size: 12pt;">我们都知道虚引用不参与对象的引用分析当中，无法阻止对象的垃圾回收，即一个对象的所有强引用都已经没有了，只剩虚引用，那么这个对象还是会被垃圾回收。</span></div><div><span style="font-size: 12pt;">Cleaner继承自PhantomReference，它本质上仍然是一个Reference。所以它的处理逻辑与WeakReference，SoftReference十分相似，仍然是由GC标记，然后由Reference Handler线程来处理。</span></div><div><span style="font-size: 12pt;">Cleaner本身不带有清理逻辑，所有的逻辑都封装在thunk（Runnable字段对象）中，因此thunk是怎么实现的才是最关键的，Reference Handler线程会自动调用Cleaner的clean方法（看上面）。</span></div><div><span style="font-size: 16px;">总结来说：Cleaner是一个Reference子类，其自身可以携带一个Runnable对象来在被ReferenceHandler线程处理时进行回调，从而可以实现一些资源释放的操作。</span></div><div><br/></div><div><span style="font-size: 18pt; color: rgb(26, 144, 185); font-weight: bold;">原文</span></div><div>地址：<a href="https://zhuanlan.zhihu.com/p/29454205">https://zhuanlan.zhihu.com/p/29454205</a></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">在讲DirectBuffer的时候，圈里有同学问我，关于DirectBuffer如何回收的问题。我当时回答说别急，等我讲完GC再来讲这个问题。课程进行到现在，终于可以讲一下了。</span></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">其实，在讲DirectBuffer的时候，就已经贴过这一段代码了，但是当时没有做为重点去讲解。今天我们再返回来看一下DirectByteBuffer的构造函数：</span></div><div style="-webkit-box-orient: vertical; -webkit-box-direction: normal; flex-direction: column; -webkit-box-align: stretch; align-items: stretch; flex-shrink: 0; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 1em 0px; padding: 10px; overflow: auto; font-size: 14px; word-wrap: normal; background: rgb(246, 246, 246); border-radius: 4px;"><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">DirectByteBuffer</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(23, 81, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">int</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cap</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">)</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">{</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(153, 153, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-style: italic; font-variant-caps: normal; font-variant-ligatures: normal;">// package-private</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">super</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(-</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">1</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">0</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cap</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cap</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(23, 81, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">boolean</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">pa</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">VM</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">isDirectMemoryPageAligned</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">();</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(23, 81, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">int</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">ps</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">Bits</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">pageSize</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">();</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(23, 81, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">long</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">size</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">Math</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">max</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">1L</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(23, 81, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">long</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">)</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cap</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">+</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">pa</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">?</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">ps</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">:</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">0</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">));</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">Bits</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">reserveMemory</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">size</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cap</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">);</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(23, 81, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">long</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">0</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">try</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">{</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">unsafe</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">allocateMemory</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">size</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">}</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">catch</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">OutOfMemoryError</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">x</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">)</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">{</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">Bits</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">unreserveMemory</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">size</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cap</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">throw</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">x</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">unsafe</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">setMemory</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">size</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(23, 81, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">byte</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">)</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">0</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">if</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">pa</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">&amp;&amp;</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">%</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">ps</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">!=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">0</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">))</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">{</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(153, 153, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-style: italic; font-variant-caps: normal; font-variant-ligatures: normal;">// Round up to page boundary</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">address</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">+</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">ps</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">-</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">&amp;</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">ps</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">-</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">1</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">));</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">}</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">else</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">{</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">address</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(153, 153, 153); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-style: italic; font-variant-caps: normal; font-variant-ligatures: normal;">// 这个cleaner就是DirectBuffer回收的最关键部分。</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cleaner</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">Cleaner</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">.</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(0, 132, 255); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">create</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">this</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">new</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">Deallocator</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">(</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">base</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">size</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">,</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cap</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">));</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">att</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">=</span> <span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">null</span><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">}</span></div></div></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">前边的部分大家再复习一下，今天的重点是倒数第三行的那个cleaner到底是什么鬼。我们点开Cleaner的定义看一下：</span></div><div style="-webkit-box-orient: vertical; -webkit-box-direction: normal; flex-direction: column; -webkit-box-align: stretch; align-items: stretch; flex-shrink: 0; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 1em 0px; padding: 10px; overflow: auto; font-size: 14px; word-wrap: normal; background: rgb(246, 246, 246); border-radius: 4px;"><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">public class Cleaner</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">extends PhantomReference&lt;Object&gt;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">{</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// Dummy reference queue, needed because the PhantomReference constructor</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// insists that we pass a queue. Nothing will ever be placed on this queue</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// since the reference handler invokes cleaners explicitly.</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// 就像英文注释所说的，这货没啥卵用。后面我会讲到的。</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private static final ReferenceQueue&lt;Object&gt; dummyQueue = new ReferenceQueue&lt;&gt;();</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// Doubly-linked list of live cleaners, which prevents the cleaners</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// themselves from being GC'd before their referents</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// 所有的cleaner都会被加到一个双向链表中去，这样做是为了保证在referent被回收之前</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// 这些Cleaner都是存活的。</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">static private Cleaner first = null;</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private Cleaner</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">next = null,</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">prev = null;</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// 构造的时候把自己加到双向链表中去</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private static synchronized Cleaner add(Cleaner cl) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (first != null) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cl.next = first;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">first.prev = cl;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">first = cl;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return cl;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// clean方法会调用remove把当前的cleaner从链表中删除。</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private static synchronized boolean remove(Cleaner cl) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// If already removed, do nothing</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (cl.next == cl)</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return false;</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// Update list</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (first == cl) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (cl.next != null)</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">first = cl.next;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">else</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">first = cl.prev;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (cl.next != null)</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cl.next.prev = cl.prev;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (cl.prev != null)</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cl.prev.next = cl.next;</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// Indicate removal by pointing the cleaner to itself</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cl.next = cl;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">cl.prev = cl;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return true;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// 用户自定义的一个Runnable对象，</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private final Runnable thunk;</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// 私有有构造函数，保证了用户无法单独地使用new来创建Cleaner。</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private Cleaner(Object referent, Runnable thunk) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">super(referent, dummyQueue);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">this.thunk = thunk;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">/**</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">* 所有的Cleaner都必须通过create方法进行创建。</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">*/</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">public static Cleaner create(Object ob, Runnable thunk) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (thunk == null)</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return null;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return add(new Cleaner(ob, thunk));</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">/**</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">* 这个方法会被Reference Handler线程调用，来清理资源。</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">*/</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">public void clean() {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (!remove(this))</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">try {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">thunk.run();</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">} catch (final Throwable x) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">public Void run() {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (System.err != null)</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">new Error(&quot;Cleaner terminated abnormally&quot;, x)</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">.printStackTrace();</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">System.exit(1);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return null;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}});</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div></div></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">这段代码的关键注释我已经加上了。然后我再把要注意的点单独强调一下。</span></div><ol style="margin: 20px 0px; padding: 0px 0px 0px 40px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="box-sizing: inherit; list-style-type: decimal; margin-top: 10px; list-style-position: outside;"><span style="font-size: medium; color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">Cleaner继承自PhantomReference，它本质上仍然是一个Reference。所以它的处理方法与WeakReference，SoftReference十分相似。仍然是由GC标记，Reference Handler线程处理的。</span></li><li style="box-sizing: inherit; list-style-type: decimal; margin-top: 10px; list-style-position: outside;"><span style="font-size: medium; color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">Cleaner本身不带有清理逻辑，所有的逻辑都封装在thunk中，因此thunk是怎么实现的才是最关键的。</span></li><li style="box-sizing: inherit; list-style-type: decimal; margin-top: 10px; list-style-position: outside;"><span style="font-size: medium; color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">Cleaner中的next和prev是private的，一定要记住这一点，不要和Reference的成员变量next 混淆了。它们不是一回事。这个next, prev是双向链表，而Reference的next则是由JVM维护的。</span></li></ol><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">OK，关于Reference Handler的代码，请看这篇文章：</span><a href="https://zhuanlan.zhihu.com/p/28226360" style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); border-bottom: 1px solid rgba(68, 68, 68, 0.72); word-break: break-all; cursor: pointer; color: rgb(34, 85, 153); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">WeakReference</a></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">注意看啊，Reference的定义里新启的那个线程，它的run方法会专门判断从pending链表上取出来的那个对象是不是Cleaner，如果是就会调用它的clean方法。所以我们知道了，</span><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">Cleaner的clean方法是由Reference Handler线程调用的</span><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">。</span></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">好，到此为止，我们再回顾一下整个全景图：</span></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">首先，DirectBuffer buf 如果已经没有强引用了，那么JVM就会发现只有一个Cleaner还在引用着这个buf，那么就会把与此buf相关的那个cleaner放到一个名为pending的链表里。这个链表是通过Reference.discovered域连接在一起的。</span></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">接着，Reference Handler这个线程会不断地从这个pending链表上取出新的对象来。它可能是WeakReference，也可能是SoftReference，当然也可能是PhantomReference和Cleaner。</span></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">最后，如果是Cleaner，那就直接调用Cleaner的clean方法，然后就结束了。其他的情况下，要交给这个对象所关联的queue，以便于后续的处理。</span></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">关于Cleaner和PhantomReference就讲这么多了，下节课讲finalize，还会再补充一点cleaner和Finalizer的对比。如果有同学还想了解更多，就评论或者私信问我都行。当然，关于DirectBuffer，还有一点要补充，那就是Cleaner的第二个构造参数是一个Runnable类型的thunk：</span></div><div style="-webkit-box-orient: vertical; -webkit-box-direction: normal; flex-direction: column; -webkit-box-align: stretch; align-items: stretch; flex-shrink: 0; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 1em 0px; padding: 10px; overflow: auto; font-size: 14px; word-wrap: normal; background: rgb(246, 246, 246); border-radius: 4px;"><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private static class Deallocator</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">implements Runnable</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">{</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private static Unsafe unsafe = Unsafe.getUnsafe();</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private long address;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private long size;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private int capacity;</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">private Deallocator(long address, long size, int capacity) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">assert (address != 0);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">this.address = address;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">this.size = size;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">this.capacity = capacity;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><br/></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">public void run() {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">if (address == 0) {</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">// Paranoia</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">return;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">unsafe.freeMemory(address);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">address = 0;</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">Bits.unreserveMemory(size, capacity);</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div><div><span style="border-radius: 3px; background-color: rgb(246, 246, 246); font-size: 14px; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">}</span></div></div></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">嗯。在它的run方法里，真正地调用了freeMemory来释放内存。</span></div><div style="margin: 0px 0px 20px; font-size: medium; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">DirectBuffer释放的全部差不多就都在这里了。当然，说了这么多，其实DirectBuffer的释放时机还是不确定的。首先，得发生GC，其次，Reference Handler得调度到，然后处理到你的cleaner才行，还有一条，如果你自己要实现一个cleaner，千万千万不要在run方法里写一些执行时间很长，或者会阻塞线程的逻辑的。会把Reference Handler跑死的。</span></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 