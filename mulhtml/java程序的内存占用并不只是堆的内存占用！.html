<html>
<head>
  <title>java程序的内存占用并不只是堆的内存占用！</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="489"/>
<h1>java程序的内存占用并不只是堆的内存占用！</h1>

<div>
<span><div><span style="font-size: 20px; color: rgb(17, 17, 17); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif;">原文地址：<a href="http://www.oschina.net/question/100267_65544" style="font-size: 15pt; font-family: &quot;PingFang SC&quot;; color: rgb(17, 17, 17);">http://www.oschina.net/question/100267_65544</a></span></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">很多人错误的认为运行Java程序时使用-Xmx和-Xms参数指定的就是程序将会占用的内存，但是这实际上只是Java堆对象将会占用的内存。堆只是影响Java程序占用内存数量的一个因素。要更好的理解你的Java程序将会占用多大的内存需要先了解有哪些因素会影响到内存的占用。这些因素包括：</span></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><ul style="box-sizing: border-box; margin: 0px; padding: 0px 0px 0px 40px; list-style: disc; font-size: 15pt;"><li style="box-sizing: border-box;"><span style="font-size: 15pt; color: rgb(17, 17, 17); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">对象(Objects)</span></li><li style="box-sizing: border-box;"><span style="font-size: 15pt; color: rgb(17, 17, 17); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">类(Classes)</span></li><li style="box-sizing: border-box;"><span style="font-size: 15pt; color: rgb(17, 17, 17); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">线程(Theads)</span></li><li style="box-sizing: border-box;"><span style="font-size: 15pt; color: rgb(17, 17, 17); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">本地数据结构(Native data structures)</span></li><li style="box-sizing: border-box;"><span style="font-size: 15pt; color: rgb(17, 17, 17); font-family: &quot;PingFang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal;">本地代码(Native code)</span></li></ul></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"><img src="java程序的内存占用并不只是堆的内存占用！_files/Image.png" type="image/png" data-filename="Image.png" style="font-family: PingFang SC; font-size: 12pt;"/><br/>
每个因素对内存占用的影响又会随着应用程序、运行环境和系统平台的不同而变化，那怎样计算总的内存占用量？是的，想得到一个准确的数字不是那么容易，因为你很难控制本地(Native)部分。你能控制的部分只有堆大小：-Xmx，类占用的内存：-XX:MaxPermSize，还有线程栈：-Xss控制每个线程占用的内存。所以，计算公式为：</span></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">(-Xmx) + (-XX:MaxPermSize) + 线程数 * (-Xss) + 其它内存</span></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br style="box-sizing: border-box; font-family: PingFang SC; font-size: 15pt; color: rgb(17, 17, 17);"/></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">其它内存部分取决于本地代码占用的内存，如NIO、socket缓冲区、JNI等。它一般大约是jvm内存的5%左右。所以假设我们有下面的JVM参数和100个线程：</span></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">-Xmx1024m -XX:MaxPermSize=256m -Xss512k </span></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">那么jvm进程至少会占用内存数量为：1024m + 256m + 100*512k + (0.05 * 1330m) = 1396.5m</span></div><div style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><br style="box-sizing: border-box; font-family: PingFang SC; font-size: 15pt; color: rgb(17, 17, 17);"/></div><div><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">我一般使用(1.5 * 堆最大值)来作为一个近似值表示一个tomcat进程会需要的最小内存，如果你有需要增加MaxPermSize到256M以上的应用这个值可以更大些。如果你使用这个来衡量你的系统将会占用多少内存要记住你需要为系统和其它运行在系统上的程序留下足够的内存，否则会导致系统使用过多的虚拟内存，这样会降低性能。</span></div><div><span style="box-sizing: border-box; font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, &quot;Noto Sans CJK SC&quot;, Sathu, EucrosiaUPC, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"><br/></span></div><div><br/></div><div><br/></div></span>
</div></body></html> 