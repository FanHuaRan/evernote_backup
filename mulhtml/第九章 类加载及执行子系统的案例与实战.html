<html>
<head>
  <title>第九章 类加载及执行子系统的案例与实战</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1017"/>
<h1>第九章 类加载及执行子系统的案例与实战</h1>

<div>
<span><div><span style="text-indent: 0pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>概述</b></font></span><br/><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">在Class文件格式与执行引擎这部分当中，用户的程序能直接影响的内容不太多，大部分逻辑和过程已经被固化在虚拟机当中。</font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">能通过程序进行操作的主要是字节码生成与类加载器这两部分的功能。</font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">但这两部分却诞生了很多创意。</font></span></div><font style="color: rgb(26, 144, 185); font-size: 18pt;"><b><span style="text-indent: 0pt;">案例</span><span style="text-indent: 0pt;"><font>分</font></span><span style="text-indent: 0pt;">析</span></b></font><br/><b style="text-indent: 0pt;"><font style="font-size: 12pt; color: rgb(1, 1, 1);">Tomcat：正统的类加载器架构</font></b><br/><div style="margin-left: 13mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">Web应用服务器需要解决的问题：</font></span></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 51pt; margin-right: 0pt; padding-left: 18pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">同一服务器上的两个web应用程序所使用的java类库要可以相互隔离</span><br/></font></li><li style="margin-left: 51pt; margin-right: 0pt; padding-left: 18pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">同一服务器上的两个web应用程序锁使用的java类库可以共享</span><br/></font></li><li style="margin-left: 51pt; margin-right: 0pt; padding-left: 18pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">服务器需要尽可能保证自身的安全不受部署的web应用程序的影响</span><br/></font></li><li style="margin-left: 51pt; margin-right: 0pt; padding-left: 18pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">支持jsp应用的服务器，大多数需要使用Hotswap功能</span><br/></font></li></ol><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">      Tomcat的类加载架构：</font></span></div><div style="min-height: 526pt;"><font style="font-size: 12pt;"><span style="min-height: 526pt; color: rgb(1, 1, 1);">     </span> <img src="第九章 类加载及执行子系统的案例与实战_files/Image.png" type="image/png" data-filename="Image.png" width="420"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">      注意：</font></span></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 47pt; margin-right: 0pt; padding-left: 18pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">tomcat的webappclassloader重写了load方法，逻辑已经不是双亲委托，优先加载web-inf下面的lib。</span><br/></font></li><li style="margin-left: 47pt; margin-right: 0pt; padding-left: 18pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">tomcat6之后默认关闭CatalinaClassLoader与SharedClassLoader，上层只有CommonClassLoader，也只有一个lib文件夹</span><br/></font></li></ol><span style="text-indent: 0pt;"><font style="font-size: 12pt; color: rgb(1, 1, 1);"><b>OSGI：灵活的类加载器架构</b></font></span><br/><div style="margin-left: 13mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">OSGI的应用案例：eclipse、IBM Jazz平台、GlassFish服务器、jboss osgi</font></span></div><div style="margin-left: 13mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">OSGI的意义：更精确的模块划分和可见性控制、模块级的热插拔功能</font></span></div><div style="margin-left: 13mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">OSGI的缺点：</font></span><span style="font-size: 12pt; color: rgb(1, 1, 1);">1.引入了复杂性</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 15mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 15mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                    2.可能线程泄漏（多线程互相加载的情况，单线程加载可避免）</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                                3.内存泄漏</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">       OSGI的类加载器：</font></span></div><div style="min-height: 15pt;"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">              </span> <img src="第九章 类加载及执行子系统的案例与实战_files/Image [1].png" type="image/png" data-filename="Image.png" width="548"/></font></div><span style="text-indent: 0pt;"><font style="font-size: 12pt; color: rgb(1, 1, 1);"><b>字节码生成技术与动态代理的实现</b></font></span><br/><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">字节码生成技术不高速，应用场景是javac编译器、CGLIB、ASM、动态代理等</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">核心还是拼装字节码，然后编译&amp;加载</font></span></div><span style="text-indent: 0pt;"><font style="font-size: 12pt; color: rgb(1, 1, 1);"><b>Retrotranslator：跨越jdk版本</b></font></span><br/><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">Retrotranslator是“java逆向移植工具”的杰出代表，可以将java5的程序移植到java4上</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">Jdk版本变化内容：</font></span></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 36pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">语法糖，一般是javac编译时干的，可以通过工具操作字节码人工补充这些语法糖</span><br/></font></li><li style="margin-left: 36pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">API，大部分多的API可以通过独立类库进行提供</span><br/></font></li><li style="margin-left: 36pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">字节码层面的修改，无法移植</span><br/></font></li><li style="margin-left: 36pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">虚拟机模型层面的修改，无法移植</span><br/></font></li></ol><span style="text-indent: 0pt;"><b><font style="color: rgb(26, 144, 185); font-size: 18pt;"><font>实战</font></font></b></span><br/><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">自己动手实现远程执行</font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">知识点：</font></span></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 33pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">自定义类加载器需继承派生抽象类ClassLoader</span><br/></font></li><li style="margin-left: 33pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">如果想遵循双亲委托机制，重写loadclass方法，</span></font>打破双亲委托机制，重写findclass方法</li></ol><ol start="3" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 33pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">自定义类加载器加载的类需要保证不被其它类加载器重复加载，不然会出一些问题，比如classcastexception。</span><br/></font></li><li style="margin-left: 33pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">编译API</span><br/></font></li><li style="margin-left: 33pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">ASM字节码操作</span></font><br/></li></ol></div></span>
</div></body></html> 