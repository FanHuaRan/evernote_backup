<html>
<head>
  <title>方法区的垃圾回收</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1443"/>
<h1>方法区的垃圾回收</h1>

<div>
<span><div><b><font color="#147191" style="font-size: 18pt;">CMS收集器回收永久代（元空间暂无研究）</font></b></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><span style="font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;">关于sun的Hotspot JVM中的PermGen能否被GC的问题</span></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><div>首先要说明的是PermGen的作用，PermGen是在JVM启动时，类和方法的Meta信息被加载到内存，放在PermGen中。</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">一般来说，该PermGen是不会被GC掉的，但是也要视JDK的版本和GC的策略有所区别。</span></div></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><div>（1）、在JDK1.5的版本中，缺省的GC策略是不会对PermGen进行GC的，但是如果想要PermGen被GC，可以通过CMS策略来</div><div>实施，样例配置如下：</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">-server -Xms512m -Xmx512m -XX:+UseConcMarkSweepGC -XX:+CMSPermGenSweepingEnabled -XX:+CMSClassUnloadingEnabled -XX:CMSInitiatingOccupancyFraction=60 -XX:NewSize=256m  -XX:MaxNewSize=256m -XX:PermSize=40m -XX:MaxPermSize=64m -XX:+HeapDumpOnOutOfMemoryError -XX:SurvivorRatio=8</span></div></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><span style="font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;">POC如下图：</span></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><div><img src="方法区的垃圾回收_files/Image.gif" type="image/gif" data-filename="Image.gif" style="border: 0px;"/></div><div><br/></div><div>此处需要注意的是：使用CMS（ConcMarkSweep）策略时，必须有：-XX:+CMSPermGenSweepingEnabled 和-XX:+CMSClassUnloadingEnabled</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">来配合同时启用，才可以对PermGen进行GC（</span></div></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><span style="font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;">实际主要参数为：-XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled  -XX:+CMSPermGenSweepingEnabled</span></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><div>）。而且参数：-XX:+CMSPermGenSweepingEnabled在JDK1.6中是不存在的。</div><div>可以通过jconsole中的MBeans=&gt;com.sun.management.HotSpotDiagnostic来验证JVM中的参数。</div><div>（2）、在JDK1.6的版本中，缺省的GC策略是不会对PermGen进行GC的，但是如果想要PermGen被GC，可以通过CMS策略来</div><div>实施，样例配置如下：</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">-server -Xms512m -Xmx512m -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:PermSize=40m -XX:MaxPermSize=64m -XX:+HeapDumpOnOutOfMemoryError</span></div></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><span style="font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;">实际主要参数为：-XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled</span></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><span style="font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;">效果图如下：</span></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><div><img src="方法区的垃圾回收_files/Image [1].gif" type="image/gif" data-filename="Image.gif" style="border: 0px;"/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"> 总结：CMS策略可以对PermGen进行GC，但是前提是应用程序停止后能保证其所使用的类完全达到可以被GC的条件，如果某些web应用中配置了listener的话，这些web应用通过应用服务器的web控制台停掉后，其listener并不会停掉，导致该应用所加载的类不会被卸载。因为：listener中的两个方法，contextInitialized()是在Servlet容器启动时执行，而contextDestroyed()是在Servlet容器停止时执行。因此要想让PermGen在应用服务器启动状态下被GC，需要以下两个条件：</span></div></div><div style="margin: 0px; padding: 0px; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;"><span style="font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(51, 51, 51); font-family: Arial;">（1）、配置CMS策略，如：</span></div><div><span style="font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(51, 51, 51); font-family: Arial;"> -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled  -XX:+CMSPermGenSweepingEnabled，只是jdk1.6中不需要-XX:+CMSPermGenSweepingEnabled参数；</span></div></span>
</div></body></html> 