<html>
<head>
  <title>分布式事务 TCC-Transaction 源码分析 —— TCC 实现</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="584"/>
<h1>分布式事务 TCC-Transaction 源码分析 —— TCC 实现</h1>

<div>
<span><div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><b><font color="#3E3E3E">原文地址：</font><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484038&amp;idx=1&amp;sn=fb9b8f91146eed545a5464bd85675d15&amp;chksm=fa497d37cd3ef4212df9d16cd685273c01ba992f59ef50b838970004153ca4364fd163eb7c06&amp;mpshare=1&amp;scene=23&amp;srcid=02062dwHYCBGoREjfI5tmLFA#rd" style="font-weight: bold; font-family: &quot;Helvetica Neue&quot;; font-size: 12pt;"><font style="color: rgb(20, 113, 145);">http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484038&amp;idx=1&amp;sn=fb9b8f91146eed545a5464bd85675d15&amp;chksm=fa497d37cd3ef4212df9d16cd685273c01ba992f59ef50b838970004153ca4364fd163eb7c06&amp;mpshare=1&amp;scene=23&amp;srcid=02062dwHYCBGoREjfI5tmLFA#rd</font></a></b></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-weight: bold; word-wrap: break-word !important;">本文主要基于 TCC-Transaction 1.2.3.3 正式版</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">1. 概述</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">2. TCC 原理</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">3. TCC-Transaction 原理</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">4. 事务与参与者</span></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">4.1 事务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">4.2 参与者</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">5. 事务管理器</span></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">5.1 发起根事务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">5.2 传播发起分支事务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">5.3 传播获取分支事务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">5.4 提交事务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">5.5 回滚事务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">5.6 添加参与者到事务</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">6. 事务拦截器</span></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">6.1 Compensable</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">6.2 可补偿事务拦截器</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">6.3 资源协调者拦截器</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">666. 彩蛋</span></li></ul><hr style="margin: 1.5rem 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; border-style: dashed none none; border-top-color: rgb(165, 165, 165); height: 1px; background-color: rgb(255, 255, 255);"/><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">友情提示：欢迎关注公众号【芋道源码】。😈关注后，拉你进【源码圈】微信群和【芋艿】搞基嗨皮。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">友情提示：欢迎关注公众号【芋道源码】。😈关注后，拉你进【源码圈】微信群和【芋艿】】搞基嗨皮。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">友情提示：欢迎关注公众号【芋道源码】。😈关注后，拉你进【源码圈】微信群和【芋艿】】搞基嗨皮。</span></div><hr style="margin: 1.5rem 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; border-style: dashed none none; border-top-color: rgb(165, 165, 165); height: 1px; background-color: rgb(255, 255, 255);"/><h1 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">1. 概述</span></h1><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">本文分享 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">TCC 实现</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">。主要涉及如下三个 Maven 项目：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">tcc-transaction-core</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> ：tcc-transaction 底层实现。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">tcc-transaction-api</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> ：tcc-transaction 使用 API。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">tcc-transaction-spring</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> ：tcc-transaction Spring 支持。</span></li></ul><blockquote style="margin: 1em 0px; padding: 15px 15px 15px 1rem; max-width: 100%; box-sizing: border-box; word-wrap: normal; border-left: 6px solid rgb(220, 230, 240); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(129, 145, 152); font-size: 0.9em; background: rgb(242, 247, 251); overflow: auto; word-break: normal;"><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; font-size: inherit; color: inherit; line-height: inherit; word-wrap: break-word !important;"><div>你行好事会因为得到赞赏而愉悦 </div><div>同理，开源项目贡献者会因为 Star 而更加有动力 </div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">为 TCC-Transaction 点赞！传送门</span></div></div></blockquote><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">OK，开始我们的第一段 TCC 旅程吧。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">ps：笔者假设你已经阅读过《tcc-transaction 官方文档 —— 使用指南1.2.x》。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">ps2：</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">未特殊说明的情况下，本文事务指的是 TCC事务</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">。</span></div><h1 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">2. TCC 原理</span></h1><blockquote style="margin: 1em 0px; padding: 15px 15px 15px 1rem; max-width: 100%; box-sizing: border-box; word-wrap: normal; border-left: 6px solid rgb(220, 230, 240); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(129, 145, 152); font-size: 0.9em; background: rgb(242, 247, 251); overflow: auto; word-break: normal;"><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; font-size: inherit; color: inherit; line-height: inherit; word-wrap: break-word !important;"><div>FROM <a href="https://support.hwclouds.com/devg-servicestage/zh-cn_topic_0056814426.html">https://support.hwclouds.com/devg-servicestage/zh-cn_topic_0056814426.html</a></div><div><span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;">TCC事务</span> </div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">为了解决在事务运行过程中大颗粒度资源锁定的问题，业界提出一种新的事务模型，它是基于</span><span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;-en-paragraph:true;">业务层面</span><span style="-en-paragraph:true;">的事务定义。锁粒度完全由业务自己控制。它本质是一种补偿的思路。它把事务运行过程分成 Try、Confirm / Cancel 两个阶段。在每个阶段的逻辑由</span><span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;-en-paragraph:true;">业务代码控制</span><span style="-en-paragraph:true;">。这样就事务的锁粒度可以完全自由控制。业务可以在牺牲隔离性的情况下，获取更高的性能。</span></div></div></blockquote><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">Try 阶段</span></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">完成所有业务检查( 一致性 )</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">预留必须业务资源( 准隔离性 )</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">Try ：尝试执行业务</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">Confirm / Cancel 阶段：</span></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">释放 Try 阶段预留的业务资源</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">Cancel 操作满足幂等性</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">真正执行业务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">不做任务业务检查</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">Confirm 操作满足幂等性</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">Confirm ：确认执行业务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">Cancel ：取消执行业务</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">Confirm 与 Cancel 互斥</span></li></ul></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">整体流程如下图：</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><img src="分布式事务 TCC-Transaction 源码分析 —— TCC 实现_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: 0px auto; padding: 0px; height: auto !important; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; border-width: 2px; border-style: solid; border-color: rgb(238, 238, 238); border-radius: 6px; display: block; width: auto !important; visibility: visible !important;"/></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">红框部分</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">功能由 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">tcc-transaction-core</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 实现：</span></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">启动业务活动</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">登记业务操作</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">提交 / 回滚业务活动</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">黄框部分</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">功能由 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">tcc-transaction-http-sample</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 实现( 官方提供的示例项目 )：</span></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">Try 操作</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">Confirm 操作</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">Cancel 操作</span></li></ul></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">与 2PC协议 比较</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">位于业务服务层而非自愿层</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">没有单独的准备( Prepare )阶段，Try 操作兼备自愿操作与准备能力</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">Try 操作可以灵活选择业务资源的锁定粒度</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">较高开发成本</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">参考资料：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">《支付宝运营架构中柔性事务指的是什么？》</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">《分布式事务的典型处理方式:2PC、TCC、异步确保和最大努力型》</span></li></ul><h1 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">3. TCC-Transaction 原理</span></h1><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">在 TCC 里，一个业务活动可以有多个事务，每个业务操作归属于不同的事务，即一个事务可以包含多个业务操作。TCC-Transaction 将每个业务操作抽象成</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">事务参与者</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">，每个事务可以包含多个</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">参与者</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">参与者需要声明 try / confirm / cancel 三个类型的方法，和 TCC 的操作一一对应。在程序里，通过 @Compensable 注解标记在 try 方法上，并填写对应的 confirm / cancel 方法，示例代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// try</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Compensable</span>(confirmMethod = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;confirmRecord&quot;</span>, cancelMethod = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;cancelRecord&quot;</span>, transactionContextEditor = MethodTransactionContextEditor.class)</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">String</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">record</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> {}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// confirm</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">confirmRecord</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> {}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// cancel</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">cancelRecord</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext, CapitalTradeOrderDto tradeOrderDto)</span> {}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">在示例代码中，我们看到 TransactionContext，事务上下文，这个是怎么生成的呢？这里先卖一个关子。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">TCC-Transaction 有两个拦截器，通过对 @Compensable AOP 切面( 参与者 try 方法 )进行拦截，透明化对参与者 confirm / cancel 方法调用，从而实现 TCC 。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">简化</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">流程如下图：</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><img src="分布式事务 TCC-Transaction 源码分析 —— TCC 实现_files/Image [1].jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: 0px auto; padding: 0px; height: auto !important; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; border-width: 2px; border-style: solid; border-color: rgb(238, 238, 238); border-radius: 6px; display: block; width: auto !important; visibility: visible !important;"/></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">第一个拦截器，可补偿事务拦截器，实现如下功能：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">在 Try 阶段，对事务的发起、传播。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">在 Confirm / Cancel 阶段，对事务提交或回滚。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">为什么会有对事务的传播呢</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">？在远程调用服务的参与者时，会通过</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">&quot;参数&quot;</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">( 需要序列化 )的形式传递事务给远程参与者。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">第二个拦截器，资源协调者拦截器，实现如下功能：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">在 Try 阶段，添加参与者到事务中。当事务上下文不存在时，进行创建。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实际拦截器对事务的处理会比上图复杂一些，在本文「6. 事务拦截器」详细解析。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">在 TCC-Transaction 代码实现上，组件分层如下图：</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><img src="分布式事务 TCC-Transaction 源码分析 —— TCC 实现_files/Image [2].jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: 0px auto; padding: 0px; height: auto !important; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; border-width: 2px; border-style: solid; border-color: rgb(238, 238, 238); border-radius: 6px; display: block; width: auto !important; visibility: visible !important;"/></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">本文按照如下顺序分享：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">「4. 事务拦截器」</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">「5. 事务管理器」</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">「6. 事务管理器」</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">内容是</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">自下而上</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">的方式分享，每个组件可以更加整体的被认识。当然这可能对你理解时产生一脸闷逼，所以推荐两种阅读方式：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">简读 x 1 + 深读 x 1</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">倒着读，发现未分享的方法，全文检索该方法。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">事务存储器在《TCC-Transaction 源码解析 —— 事务存储于恢复》详细解析。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">事务恢复在《TCC-Transaction 源码解析 —— 事务恢复》详细解析。</span></div><h1 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">4. 事务与参与者</span></h1><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">在 TCC 里，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">一个</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">事务( </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.Transaction</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> ) 可以有</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">多个</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">参与者( </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.Participant</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> )参与业务活动。类图关系如下( 打开大图 )：</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" style="margin: 0px auto; padding: 0px; height: 257.939px !important; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background-color: rgb(238, 237, 235); border: 2px solid rgb(238, 238, 238); background-size: 22px; background-position: center center; background-repeat: no-repeat; background-image: url(&quot;data; border-radius: 6px; display: block; width: 670px !important;"></img></div><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">4.1 事务</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">Transaction 实现代码如下</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Transaction</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">implements</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Serializable</span> {</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span> serialVersionUID = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">7291423944314337931L</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务编号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> TransactionXid xid;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务状态</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> TransactionStatus status;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务类型</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> TransactionType transactionType;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 重试次数</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">volatile</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> retriedCount = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 创建时间</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Date createTime = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> Date();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 最后更新时间</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Date lastUpdateTime = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> Date();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 版本号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span> version = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">1</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 参与者集合</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> List&lt;Participant&gt; participants = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> ArrayList&lt;Participant&gt;();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 附带属性映射</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Map&lt;String, Object&gt; attachments = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> ConcurrentHashMap&lt;String, Object&gt;();</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 添加参与者</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">participant 参与者</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">enlistParticipant</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Participant participant)</span> {</div><div>participants.add(participant);</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 提交 TCC 事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">commit</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">for</span> (Participant participant : participants) {</div><div><a href="http://participant.commit/">participant.commit</a>();</div><div>}</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 回滚 TCC 事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">rollback</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">for</span> (Participant participant : participants) {</div><div>participant.rollback();</div><div>}</div><div>}</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">xid，事务编号( TransactionXid )，用于唯一标识一个事务。使用 UUID 算法生成，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">保证唯一性</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.api.TransactionXid</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 实现 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">javax.transaction.xa.Xid</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 接口，实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">TransactionXid</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">implements</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Xid</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;">,</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Serializable</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span> serialVersionUID = -<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">6817267250789142043L</span>;</div></div><br/><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* xid 格式标识符</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> formatId = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">1</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 全局事务编号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">byte</span>[] globalTransactionId;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 分支事务编号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">byte</span>[] branchQualifier;</div></div><br/>
}</li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">TODO 为什么要继承 Xid 接口？</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">status，事务状态( TransactionStatus )。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.api.TransactionStatus</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">enum</span> TransactionStatus {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 尝试中状态</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>TRYING(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">1</span>),</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 确认中状态</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>CONFIRMING(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">2</span>),</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 取消中状态</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>CANCELLING(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">3</span>);</div></div><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> id;</div></div></div><br/>
}</li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">transactionType，事务类型( TransactionType )。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);"><a href="http://org.mengyun.tcctransaction.common.transactiontype/">org.mengyun.tcctransaction.common.TransactionType</a></span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">enum</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;">TransactionType {</span></div><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 根事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>ROOT(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">1</span>),</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 分支事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>BRANCH(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">2</span>);</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> id;</div></div></div><br/>
}</li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">在「6.2 可补偿事务拦截器」有详细解析，可以看到看到这两种事务是如何发起。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">retriedCount，重试次数。在 TCC 过程中，可能参与者异常崩溃，这个时候会进行重试直到成功或超过最大次数。在《TCC-Transaction 源码解析 —— 事务恢复》详细解析。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">version，版本号，用于乐观锁更新事务。在《TCC-Transaction 源码解析 —— 事务存储器》详细解析。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">attachments，附带属性映射。在《TCC-Transaction 源码解析 —— Dubbo 支持》详细解析。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">提供 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#enlistParticipant()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，添加事务参与者。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">提供 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#commit()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，调用参与者们提交事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">提供 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#rollback()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，调用参与者回滚事务。</span></li></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">4.2 参与者</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">Participant 实现代码如下</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Participant</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">implements</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Serializable</span> {</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span> serialVersionUID = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">4127729421281425247L</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务编号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> TransactionXid xid;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 确认执行业务方法调用上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> InvocationContext confirmInvocationContext;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 取消执行业务方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> InvocationContext cancelInvocationContext;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 执行器</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Terminator terminator = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> Terminator();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务上下文编辑</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>Class&lt;? extends TransactionContextEditor&gt; transactionContextEditorClass;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 提交事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">commit</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div>terminator.invoke(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> TransactionContext(xid, TransactionStatus.CONFIRMING.getId()), confirmInvocationContext, transactionContextEditorClass);</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 回滚事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">rollback</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div>terminator.invoke(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> TransactionContext(xid, TransactionStatus.CANCELLING.getId()), cancelInvocationContext, transactionContextEditorClass);</div><div>}</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">xid，参与者事务编号。通过 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionXid.globalTransactionId</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 属性，关联上其所属的事务。当参与者进行远程调用时，远程的</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务的事务编号等于该参与者的事务编号。通过事务编号的关联，TCC Confirm / Cancel 阶段，使用参与者的事务编号和远程的</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务进行关联，从而实现事务的提交和回滚，在「5.2 传播发起分支事务」 + 「6.2 可补偿事务拦截器」可以看到具体实现。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">confirmInvocationContext，确认执行业务方法调用上下文( InvocationContext )。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.InvocationContext</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">InvocationContext</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">implements</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">Serializable</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;">{</span></div><br/><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span> serialVersionUID = -<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">7969140711432461165L</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 类</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Class targetClass;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 方法名</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> String methodName;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 参数类型数组</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Class[] parameterTypes;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 参数数组</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Object[] args;</div></div><br/>
}</li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">InvocationContext，执行方法调用上下文，记录类、方法名、参数类型数组、参数数组。通过这些属性，可以执行提交 / 回滚事务。在 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.Terminator</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 会看到具体的代码实现。</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">本质上，TCC 通过多个参与者的 try / confirm / cancel 方法，实现事务的最终一致性</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">cancelInvocationContext，取消执行业务方法调用上下文( InvocationContext )。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">terminator，执行器( Terminator )。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.Terminator</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">Terminator</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">implements</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">Serializable</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;">{</span></div><br/><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span> serialVersionUID = -<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">164958655471605778L</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">invoke</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext, InvocationContext invocationContext, Class&amp;lt;? extends TransactionContextEditor&amp;gt; transactionContextEditorClass)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (StringUtils.isNotEmpty(invocationContext.getMethodName())) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得 参与者对象</span></div><div>Object target = FactoryBuilder.factoryOf(invocationContext.getTargetClass()).getInstance();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得 方法</span></div><div>Method method = target.getClass().getMethod(invocationContext.getMethodName(), invocationContext.getParameterTypes());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 设置 事务上下文 到方法参数</span></div><div>FactoryBuilder.factoryOf(transactionContextEditorClass).getInstance().set(transactionContext, target, method, invocationContext.getArgs());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 执行方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> method.invoke(target, invocationContext.getArgs());</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (Exception e) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> SystemException(e);</div><div>}</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div>}</div></div><br/>
}</li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">FactoryBuilder，工厂 Builder，感兴趣的同学点击链接查看，已经添加完整中文代码注释。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">TransactionContextEditor，在本文「6.1 Compensable」详细解析。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">transactionContextEditorClass，事务上下文编辑，在「6.1 Compensable」详细解析。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">提交 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#commit()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，提交参与者自己的事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">提交 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#rollback()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，回滚参与者自己的事务。</span></li></ul><h1 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5. 事务管理器</span></h1><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.TransactionManager</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">，事务管理器，提供事务的获取、发起、提交、回滚，参与者的新增等等方法。</span></div><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5.1 发起根事务</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">提供 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">begin()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 方法，发起根事务。该方法在</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">调用方法类型为 MethodType.ROOT 并且 事务处于 Try 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">被调用。MethodType 在「6.2 可补偿事务拦截器」详细解析。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// TransactionManager.java</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 发起根事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Transaction</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">begin</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 创建 根事务</span></div><div>Transaction transaction = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> Transaction(TransactionType.ROOT);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 存储 事务</span></div><div>transactionRepository.create(transaction);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 注册 事务</span></div><div>registerTransaction(transaction);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> transaction;</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 Transaction 构造方法，创建</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">根事务</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// Transaction.java</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 创建指定类型的事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transactionType 事务类型</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Transaction</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionType transactionType)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.xid = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> TransactionXid();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.status = TransactionStatus.TRYING; <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 尝试中状态</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.transactionType = transactionType;</div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">目前该构造方法只有 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#begin()</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 在调用，即只创建</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">根事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#crete()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，存储事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#registerTransaction(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，注册事务到当前线程事务队列。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// TransactionManager.java</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 当前线程事务队列</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 注册事务到当前线程事务队列</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transaction 事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">registerTransaction</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Transaction transaction)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (CURRENT.get() == <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div>CURRENT.set(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> LinkedList&lt;Transaction&gt;());</div><div>}</div><div>CURRENT.get().push(transaction); <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 添加到头部</span></div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">可能有同学会比较好奇，为什么使用队列存储当前线程事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">？TCC-Transaction 支持</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">多个</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">的事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">独立存在</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">，后创建的事务先提交，类似 Spring 的</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.springframework.transaction.annotation.Propagation.REQUIRES_NEW</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 。在下文，很快我们就会看到 TCC-Transaction 自己的 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.api.Propagation</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 。</span></li></ul></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5.2 传播发起分支事务</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#propagationNewBegin(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 方法，传播发起</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">事务。该方法在</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">调用方法类型为 MethodType.PROVIDER 并且 事务处于 Try 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">被调用。MethodType 在「6.2 可补偿事务拦截器」详细解析。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 传播发起分支事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transactionContext 事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">分支事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Transaction</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">propagationNewBegin</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 创建 分支事务</span></div><div>Transaction transaction = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> Transaction(transactionContext);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 存储 事务</span></div><div>transactionRepository.create(transaction);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 注册 事务</span></div><div>registerTransaction(transaction);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> transaction;</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 Transaction 构造方法，创建</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">分支事务</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 创建分支事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transactionContext 事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Transaction</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.xid = transactionContext.getXid(); <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 事务上下文的 xid</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.status = TransactionStatus.TRYING; <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 尝试中状态</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.transactionType = TransactionType.BRANCH; <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 分支事务</span></div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务使用传播的事务上下文的事务编号。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#crete()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，存储事务。为什么要存储</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务，在「6.3 资源协调者拦截器」详细解析。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#registerTransaction(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，注册事务到当前线程事务队列。</span></li></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5.3 传播获取分支事务</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#propagationExistBegin(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 方法，传播发起</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">事务。该方法在</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">调用方法类型为 MethodType.PROVIDER 并且 事务处于 Confirm / Cancel 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">被调用。MethodType 在「6.2 可补偿事务拦截器」详细解析。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 传播获取分支事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transactionContext 事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">分支事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">NoExistedTransactionException 当事务不存在时</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Transaction</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">propagationExistBegin</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">NoExistedTransactionException</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 查询 事务</span></div><div>Transaction transaction = transactionRepository.findByXid(transactionContext.getXid());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (transaction != <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 设置 事务 状态</span></div><div>transaction.changeStatus(TransactionStatus.valueOf(transactionContext.getStatus()));</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 注册 事务</span></div><div>registerTransaction(transaction);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> transaction;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> NoExistedTransactionException();</div><div>}</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#findByXid()</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，查询事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">Transaction#changeStatus(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">设置</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务状态为 CONFIRMING 或 CANCELLING。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">#registerTransaction(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，注册事务到当前线程事务队列。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">为什么此处是</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务呢？结合 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">#propagationNewBegin(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 思考下。</span></li></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5.4 提交事务</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#commit(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 方法，提交事务。该方法在</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">事务处于 Confirm / Cancel 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">被调用。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 提交事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">commit</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获取 事务</span></div><div>Transaction transaction = getCurrentTransaction();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 设置 事务状态 为 CONFIRMING</span></div><div>transaction.changeStatus(TransactionStatus.CONFIRMING);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 更新 事务</span></div><div>transactionRepository.update(transaction);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 提交 事务</span></div><div><a href="http://transaction.commit/">transaction.commit</a>();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 删除 事务</span></div><div>transactionRepository.delete(transaction);</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (Throwable commitException) {</div><div>logger.error(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;compensable transaction confirm failed.&quot;</span>, commitException);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> ConfirmingException(commitException);</div><div>}</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#getCurrentTransaction()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法， 获取事务。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Transaction</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">getCurrentTransaction</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (isTransactionActive()) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> CURRENT.get().peek(); <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得头部元素</span></div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">boolean</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">isTransactionActive</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div>Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> transactions != <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span> &amp;&amp; !transactions.isEmpty();</div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">为什么获得队列</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">头部</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">元素呢？该元素即是上文调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">#registerTransaction(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 注册到队列头部。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">Transaction#changeStatus(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法， </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">设置</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务状态为 CONFIRMING。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#update(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法， </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">更新</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">Transaction#commit(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法， </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">提交</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#delete(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">删除</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务。</span></li></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5.5 回滚事务</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#rollback(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 方法，取消事务，和 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#commit()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 方法基本类似。该方法在</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">事务处于 Confirm / Cancel 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">被调用。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 回滚事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">rollback</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获取 事务</span></div><div>Transaction transaction = getCurrentTransaction();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 设置 事务状态 为 CANCELLING</span></div><div>transaction.changeStatus(TransactionStatus.CANCELLING);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 更新 事务</span></div><div>transactionRepository.update(transaction);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 提交 事务</span></div><div>transaction.rollback();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 删除 事务</span></div><div>transactionRepository.delete(transaction);</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (Throwable rollbackException) {</div><div>logger.error(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;compensable transaction rollback failed.&quot;</span>, rollbackException);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> CancellingException(rollbackException);</div><div>}</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">#getCurrentTransaction()</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，获取事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">Transaction#changeStatus(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法， </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">设置</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务状态为 CANCELLING。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#update(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法， </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">更新</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">Transaction#rollback(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法， </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">回滚</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#delete(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">删除</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务。</span></li></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">5.6 添加参与者到事务</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#enlistParticipant(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 方法，添加参与者到事务。该方法在</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">事务处于 Try 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">被调用，在「6.3 资源协调者拦截器」有详细解析。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 添加参与者到事务</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">participant 参与者</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">enlistParticipant</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Participant participant)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获取 事务</span></div><div>Transaction transaction = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.getCurrentTransaction();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 添加参与者</span></div><div>transaction.enlistParticipant(participant);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 更新 事务</span></div><div>transactionRepository.update(transaction);</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">#getCurrentTransaction()</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，获取事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">Transaction#enlistParticipant(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法， 添加参与者到事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">TransactionRepository#update(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法， </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">更新</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务。</span></li></ul><h1 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">6. 事务拦截器</span></h1><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">TCC-Transaction 基于 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.api.@Compensable</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> + </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.aspectj.lang.annotation.@Aspect</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">注解</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">AOP 切面</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">实现业务方法的 TCC 事务声明</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">拦截</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">，同 Spring 的 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.springframework.transaction.annotation.@Transactional</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"> 的实现。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">TCC-Transaction 有两个拦截器：</span></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);"><a href="http://org.mengyun.tcctransaction.interceptor.compensabletransactioninterceptor/">org.mengyun.tcctransaction.interceptor.CompensableTransactionInterceptor</a></span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">，可补偿事务拦截器。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.interceptor.ResourceCoordinatorInterceptor</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">，资源协调者拦截器。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">在分享拦截器的实现之前，我们先一起看看 @Compensable 注解。</span></div><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">6.1 Compensable</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">@Compensable，标记可补偿的方法注解。实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@interface</span> Compensable {</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 传播级别</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Propagation</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">propagation</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">default</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Propagation.REQUIRED</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 确认执行业务方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">String</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">confirmMethod</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">default</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">&quot;&quot;</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 取消执行业务方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">String</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">cancelMethod</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">default</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">&quot;&quot;</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务上下文编辑</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>Class&lt;? extends TransactionContextEditor&gt; transactionContextEditor() <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">default</span> DefaultTransactionContextEditor.class;</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">propagation，传播级别( Propagation )，默认 Propagation.REQUIRED。和 Spring 的 Propagation 除了缺少几个属性，基本一致。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">enum</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;">Propagation {</span></div><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 支持当前事务，如果当前没有事务，就新建一个事务。</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>REQUIRED(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>),</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 支持当前事务，如果当前没有事务，就以非事务方式执行。</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>SUPPORTS(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">1</span>),</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 支持当前事务，如果当前没有事务，就抛出异常。</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>MANDATORY(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">2</span>),</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 新建事务，如果当前存在事务，把当前事务挂起。</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>REQUIRES_NEW(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">3</span>);</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> value;</div></div></div><br/>
}</li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">confirmMethod，确认执行业务方法名。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">cancelMethod，取消执行业务方法名。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">TransactionContextEditor，事务上下文编辑器( TransactionContextEditor )，用于设置和获得事务上下文( TransactionContext )，在「6.3 资源协调者拦截器」可以看到被调用，此处只看它的代码实现。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">org.mengyun.tcctransaction.api.TransactionContextEditor</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 接口代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">interface</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">TransactionContextEditor</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;">{</span></div><br/><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 从参数中获得事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">target 对象</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">method 方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">args 参数</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">TransactionContext</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">get</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Object target, Method method, Object[] args)</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 设置事务上下文到参数中</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transactionContext 事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">target 对象</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">method 方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">args 参数</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">set</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span>;</div></div><br/>
}</li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">x</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">DefaultTransactionContextEditor，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">默认</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务上下文编辑器实现。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">DefaultTransactionContextEditor</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">implements</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">TransactionContextEditor</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;">{</span></div><br/><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Override</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">TransactionContext</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">get</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Object target, Method method, Object[] args)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (position &amp;gt;= <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> (TransactionContext) args[position];</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Override</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">set</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionContext transactionContext, Object target, Method method, Object[] args)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> position = getTransactionContextParamPosition(method.getParameterTypes());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (position &amp;gt;= <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>) {</div><div>args[position] = transactionContext; <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 设置方法参数</span></div><div>}</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 获得事务上下文在方法参数里的位置</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">parameterTypes 参数类型集合</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">位置</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">getTransactionContextParamPosition</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Class&amp;lt;?&amp;gt;[] parameterTypes)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> position = -<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">1</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">for</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> i = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>; i &amp;lt; parameterTypes.length; i++) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (parameterTypes[i].equals(org.mengyun.tcctransaction.api.TransactionContext.class)) {</div><div>position = i;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">break</span>;</div><div>}</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> position;</div><div>}</div></div><br/>
}</li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">NullableTransactionContextEditor，无事务上下文编辑器实现。实现代码如下：</span><br/><div>```Java</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">class NullableTransactionContextEditor implements TransactionContextEditor {</span></div><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Override</span></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">publi</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">c TransactionContext</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">ge</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">t(Object target, Method method, Object[] args</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">)</span></div><div>{</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">retu</span>r<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">n nu</span>l</div><div>l;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">}</span></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div></div><br/><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Overr</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">ide</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">pu</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">b</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">lic</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">v</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">oid</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">set(TransactionContext transactionContext, Object target, Method method, Object[] a</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">r</span>g</div><div>s</div><div>)</div><div>{</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div></div><br/><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; font-size: inherit; color: inherit; line-height: inherit; word-break: inherit !important; white-space: inherit !important;"/><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; font-size: inherit; color: inherit; line-height: inherit; word-break: inherit !important; white-space: inherit !important;"/><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; font-size: inherit; color: inherit; line-height: inherit; word-break: inherit !important; white-space: inherit !important;"/><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; font-size: inherit; color: inherit; line-height: inherit; word-break: inherit !important; white-space: inherit !important;"/><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; font-size: inherit; color: inherit; line-height: inherit; word-break: inherit !important; white-space: inherit !important;"/><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; font-size: inherit; color: inherit; line-height: inherit; word-break: inherit !important; white-space: inherit !important;"/><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; font-size: inherit; color: inherit; line-height: inherit; word-break: inherit !important; white-space: inherit !important;"/>
}<br/><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">```</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">DubboTransactionContextEditor，Dubbo 事务上下文编辑器实现，通过 Dubbo 隐式传参方式获得事务上下文，在《TCC-Transaction 源码解析 —— Dubbo 支持》详细解析。</span></li></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">6.2 可补偿事务拦截器</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">先一起来看下可补偿事务拦截器对应的切面 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);"><a href="http://org.mengyun.tcctransaction.interceptor.compensabletransactionaspect/">org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</a></span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">，实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Aspect</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">abstract</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">CompensableTransactionAspect</span> {</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> CompensableTransactionInterceptor compensableTransactionInterceptor;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">setCompensableTransactionInterceptor</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(CompensableTransactionInterceptor compensableTransactionInterceptor)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.compensableTransactionInterceptor = compensableTransactionInterceptor;</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Pointcut</span>(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;@annotation(<a href="http://org.mengyun.tcctransaction.api.compensable/">org.mengyun.tcctransaction.api.Compensable</a>)&quot;</span>)</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">compensableService</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Around</span>(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;compensableService()&quot;</span>)</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">interceptCompensableMethod</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Throwable</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> compensableTransactionInterceptor.interceptCompensableMethod(pjp);</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">abstract</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">getOrder</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span>;</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">通过 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.aspectj.lang.annotation.@Pointcut</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> + </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.aspectj.lang.annotation.@Around</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 注解，配置对 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">@Compensable 注解的方法</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">进行拦截，调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">CompensableTransactionInterceptor#interceptCompensableMethod(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法进行处理。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">CompensableTransactionInterceptor 实现代码如下</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">CompensableTransactionInterceptor</span> {</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> TransactionManager transactionManager;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">interceptCompensableMethod</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Throwable</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得带 @Compensable 注解的方法</span></div><div>Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">//</span></div><div>Compensable compensable = method.getAnnotation(Compensable.class);</div><div>Propagation propagation = compensable.propagation();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得 事务上下文</span></div><div>TransactionContext transactionContext = FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 当前线程是否在事务中</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">boolean</span> isTransactionActive = transactionManager.isTransactionActive();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 判断事务上下文是否合法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (!TransactionUtils.isLegalTransactionContext(isTransactionActive, propagation, transactionContext)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> SystemException(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;no active compensable transaction while propagation is mandatory for method &quot;</span> + method.getName());</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 计算方法类型</span></div><div>MethodType methodType = CompensableMethodUtils.calculateMethodType(propagation, isTransactionActive, transactionContext);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 处理</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">switch</span> (methodType) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> ROOT:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> rootMethodProceed(pjp);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> PROVIDER:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> providerMethodProceed(pjp, transactionContext);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">default</span>:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> pjp.proceed();</div><div>}</div><div>}</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">CompensableMethodUtils#getCompensableMethod(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，获得带 @Compensable 注解的方法。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// CompensableMethodUtils.java</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 获得带</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@Compensable</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">注解的方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">pjp 切面点</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Method</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">getCompensableMethod</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp)</span> {</div><div>Method method = ((MethodSignature) (pjp.getSignature())).getMethod(); <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 代理方法对象</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (method.getAnnotation(Compensable.class) == <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div>method = pjp.getTarget().getClass().getMethod(method.getName(), method.getParameterTypes()); <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 实际方法对象</span></div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (NoSuchMethodException e) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div>}</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> method;</div><div>}</div></div></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionContextEditor#get(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，从参数中获得事务上下文。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">为什么从参数中可以获得事务上下文呢</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">？在「6.3 资源协调者拦截器」揭晓答案。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#isTransactionActive()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，当前线程是否在事务中。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// TransactionManager.java</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">boolean</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">isTransactionActive</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div>Deque&lt;Transaction&gt; transactions = CURRENT.get();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> transactions != <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span> &amp;&amp; !transactions.isEmpty();</div><div>}</div></div></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionUtils#isLegalTransactionContext(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，判断事务上下文是否合法。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// TransactionUtils.java</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 判断事务上下文是否合法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 在 Propagation.MANDATORY 必须有在事务内</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">isTransactionActive 是否</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">propagation 传播级别</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transactionContext 事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">是否合法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">boolean</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">isLegalTransactionContext</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">boolean</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">isTransactionActive, Propagation propagation, TransactionContext transactionContext)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (propagation.equals(Propagation.MANDATORY) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">false</span>;</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">true</span>;</div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">当传播级别为 Propagation.MANDATORY 时，要求必须在事务中。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">CompensableMethodUtils#calculateMethodType(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，计算方法类型。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 计算方法类型</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">propagation 传播级别</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">isTransactionActive 是否事务开启</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@param</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">transactionContext 事务上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">@return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">方法类型</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">MethodType</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">calculateMethodType</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Propagation propagation,</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">boolean</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">isTransactionActive, TransactionContext transactionContext)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> ((propagation.equals(Propagation.REQUIRED) &amp;&amp; !isTransactionActive &amp;&amp; transactionContext == <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// Propagation.REQUIRED：支持当前事务，当前没有事务，就新建一个事务。</span></div><div>|| propagation.equals(Propagation.REQUIRES_NEW)) { <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// Propagation.REQUIRES_NEW：新建事务，如果当前存在事务，把当前事务挂起。</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> MethodType.ROOT;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> ((propagation.equals(Propagation.REQUIRED) <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// Propagation.REQUIRED：支持当前事务</span></div><div>|| propagation.equals(Propagation.MANDATORY)) <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// Propagation.MANDATORY：支持当前事务</span></div><div>&amp;&amp; !isTransactionActive &amp;&amp; transactionContext != <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> MethodType.PROVIDER;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> MethodType.NORMAL;</div><div>}</div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">事务传播级别为 Propagation.REQUIRED，并且当前没有事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务传播级别为 Propagation.REQUIRES_NEW，新建事务，如果当前存在事务，把当前事务挂起。</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">此时，事务管理器的当前线程事务队列可能会存在多个事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">计算方法类型( MethodType )的目的，可以根据不同方法类型，做不同的事务处理。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">方法类型为 MethodType.ROOT 时，发起</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">根事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">，判断条件如下二选一：</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><div>方法类型为 MethodType.ROOT 时，发起<span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;">分支事务</span>，判断条件如下二选一：</div><div>* 事务传播级别为 Propagation.REQUIRED，并且当前不存在事务，<span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;">并且方法参数传递了事务上下文</span>。</div><div>* 事务传播级别为 Propagation.PROVIDER，并且当前不存在事务，<span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;">并且方法参数传递了事务上下文</span>。</div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">* </span><span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;-en-paragraph:true;">当前不存在事务，方法参数传递了事务上下文是什么意思</span><span style="-en-paragraph:true;">？当跨服务</span><span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;-en-paragraph:true;">远程</span><span style="-en-paragraph:true;">调用时，被调用服务本身( </span><span style="font-weight: bold; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;-en-paragraph:true;">服务提供者</span><span style="-en-paragraph:true;"> )不在事务中，通过传递事务上下文参数，融入当前事务。</span></div></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">方法类型为 MethodType.Normal 时，不进行事务处理。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">MethodType.CONSUMER 项目已经不再使用，猜测已废弃。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当方法类型为 MethodType.ROOT 时，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#rootMethodProceed(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，发起 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">TCC 整体流程</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">rootMethodProceed</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Throwable</span> {</div><div>Object returnValue;</div><div>Transaction transaction = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 发起根事务</span></div><div>transaction = transactionManager.begin();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 执行方法原逻辑</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div>returnValue = pjp.proceed();</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (Throwable tryingException) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (isDelayCancelException(tryingException)) { <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 是否延迟回滚</span></div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> {</div><div>logger.warn(String.format(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;compensable transaction trying failed. transaction content:%s&quot;</span>, JSON.toJSONString(transaction)), tryingException);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 回滚事务</span></div><div>transactionManager.rollback();</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> tryingException;</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 提交事务</span></div><div><a href="http://transactionmanager.commit/">transactionManager.commit</a>();</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">finally</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 将事务从当前线程事务队列移除</span></div><div>transactionManager.cleanAfterCompletion(transaction);</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> returnValue;</div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important;">x</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#transactionManager()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，发起</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">根事务</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">TCC Try 阶段开始</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">ProceedingJoinPoint#proceed()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，执行方法</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">原逻辑( 即 Try 逻辑 )</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当原逻辑执行异常时，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">TCC Try 阶段失败</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#rollback(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">TCC Cancel 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">，回滚事务。此处 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#isDelayCancelException(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，判断异常是否为延迟取消回滚异常，部分异常不适合立即回滚事务，在《TCC-Transaction 源码分析 —— 事务恢复》详细解析。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当原逻辑执行成功时，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">TCC Try 阶段成功</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#commit(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">TCC Confirm 阶段</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">，提交事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#cleanAfterCompletion(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，将事务从当前线程事务队列移除，避免线程冲突。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// TransactionManager.java</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">cleanAfterCompletion</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Transaction transaction)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (isTransactionActive() &amp;&amp; transaction != <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div>Transaction currentTransaction = getCurrentTransaction();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (currentTransaction == transaction) {</div><div>CURRENT.get().pop();</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> SystemException(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;Illegal transaction when clean after completion&quot;</span>);</div><div>}</div><div>}</div><div>}</div></div></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当方法类型为 Propagation.PROVIDER 时，服务提供者参与 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">TCC 整体流程</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">providerMethodProceed</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp, TransactionContext transactionContext)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Throwable</span> {</div><div>Transaction transaction = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">switch</span> (TransactionStatus.valueOf(transactionContext.getStatus())) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> TRYING:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 传播发起分支事务</span></div><div>transaction = transactionManager.propagationNewBegin(transactionContext);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> pjp.proceed();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> CONFIRMING:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 传播获取分支事务</span></div><div>transaction = transactionManager.propagationExistBegin(transactionContext);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 提交事务</span></div><div><a href="http://transactionmanager.commit/">transactionManager.commit</a>();</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (NoExistedTransactionException excepton) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">//the transaction has been commit,ignore it.</span></div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">break</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> CANCELLING:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 传播获取分支事务</span></div><div>transaction = transactionManager.propagationExistBegin(transactionContext);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 回滚事务</span></div><div>transactionManager.rollback();</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (NoExistedTransactionException exception) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">//the transaction has been rollback,ignore it.</span></div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">break</span>;</div><div>}</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">finally</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 将事务从当前线程事务队列移除</span></div><div>transactionManager.cleanAfterCompletion(transaction);</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 返回空值</span></div><div>Method method = ((MethodSignature) (pjp.getSignature())).getMethod();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> ReflectionUtils.getNullValue(method.getReturnType());</div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">为什么要传播发起分支事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">？在</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">根事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">进行 Confirm / Cancel 时，调用</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">根事务</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">上的参与者们提交或回滚事务时，进行远程服务方法调用的参与者，可以通过自己的事务编号关联上传播的</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">事务( 两者的事务编号相等 )，进行事务的提交或回滚。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当事务处于 TransactionStatus.TRYING 时，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#propagationExistBegin(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，传播发起</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务。发起</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务完成后，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">ProceedingJoinPoint#proceed()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，执行方法</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">原逻辑( 即 Try 逻辑 )</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当事务处于 TransactionStatus.CONFIRMING 时，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#commit()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，提交事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当事务处于 TransactionStatus.CANCELLING 时，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#rollback()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，提交事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#cleanAfterCompletion(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，将事务从当前线程事务队列移除，避免线程冲突。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当事务处于 TransactionStatus.CONFIRMING / TransactionStatus.CANCELLING 时，调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">ReflectionUtils#getNullValue(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，返回空值。</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">为什么返回空值</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">？Confirm / Cancel 相关方法，是通过 AOP 切面调用，只调用，不处理返回值，但是又不能没有返回值，因此直接返回空。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">getNullValue</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Class type)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 处理基本类型</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">boolean</span>.class.equals(type)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">false</span>;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">byte</span>.class.equals(type)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">short</span>.class.equals(type)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span>.class.equals(type)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span>.class.equals(type)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">float</span>.class.equals(type)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>;</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">else</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">double</span>.class.equals(type)) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">0</span>;</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 处理对象</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div>}</div></div></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">当方法类型为 Propagation.NORMAL 时，执行方法原逻辑，</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">不进行事务处理</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">。</span></li></ul><h2 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.4em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">6.3 资源协调者拦截器</span></h2><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">先一起来看下资源协调者拦截器 对应的切面 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);"><a href="http://org.mengyun.tcctransaction.interceptor.compensabletransactionaspect/">org.mengyun.tcctransaction.interceptor.CompensableTransactionAspect</a></span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">，实现代码如下：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Aspect</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">abstract</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">ResourceCoordinatorAspect</span> {</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> ResourceCoordinatorInterceptor resourceCoordinatorInterceptor;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Pointcut</span>(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;@annotation(<a href="http://org.mengyun.tcctransaction.api.compensable/">org.mengyun.tcctransaction.api.Compensable</a>)&quot;</span>)</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">transactionContextCall</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(91, 218, 237); word-break: inherit !important; white-space: inherit !important;">@Around</span>(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;transactionContextCall()&quot;</span>)</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">interceptTransactionContextMethod</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Throwable</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> resourceCoordinatorInterceptor.interceptTransactionContextMethod(pjp);</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">setResourceCoordinatorInterceptor</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ResourceCoordinatorInterceptor resourceCoordinatorInterceptor)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.resourceCoordinatorInterceptor = resourceCoordinatorInterceptor;</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">abstract</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">int</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">getOrder</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span>;</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">通过 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.aspectj.lang.annotation.@Pointcut</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> + </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">org.aspectj.lang.annotation.@Around</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 注解，配置对 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word !important; font-weight: bold;">@Compensable 注解的方法</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">进行拦截，调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">ResourceCoordinatorInterceptor#interceptTransactionContextMethod(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法进行处理。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;">ResourceCoordinatorInterceptor 实现代码如下</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">ResourceCoordinatorInterceptor</span> {</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> TransactionManager transactionManager;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Object</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">interceptTransactionContextMethod</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Throwable</span> {</div><div>Transaction transaction = transactionManager.getCurrentTransaction();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (transaction != <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">switch</span> (transaction.getStatus()) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> TRYING:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 添加事务参与者</span></div><div>enlistParticipant(pjp);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">break</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> CONFIRMING:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">break</span>;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">case</span> CANCELLING:</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">break</span>;</div><div>}</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 执行方法原逻辑</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> pjp.proceed(pjp.getArgs());</div><div>}</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">当事务处于 TransactionStatus.TRYING 时，调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">#enlistParticipant(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，添加事务参与者。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">ProceedingJoinPoint#proceed(...)</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> 方法，执行方法原逻辑。</span></li></ul><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word; font-weight: bold; border-radius: 4px; background: rgb(248, 248, 248);">ResourceCoordinatorInterceptor#enlistParticipant()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important; font-weight: bold;"> 实现代码如下</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">：</span></div><div style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">void</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">enlistParticipant</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(ProceedingJoinPoint pjp)</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throws</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">IllegalAccessException, InstantiationException</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得 @Compensable 注解</span></div><div>Method method = CompensableMethodUtils.getCompensableMethod(pjp);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (method == <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">throw</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> RuntimeException(String.format(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(238, 220, 112); word-break: inherit !important; white-space: inherit !important;">&quot;join point not found method, point is : %s&quot;</span>, pjp.getSignature().getName()));</div><div>}</div><div>Compensable compensable = method.getAnnotation(Compensable.class);</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得 确认执行业务方法 和 取消执行业务方法</span></div><div>String confirmMethodName = compensable.confirmMethod();</div><div>String cancelMethodName = compensable.cancelMethod();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获取 当前线程事务第一个(头部)元素</span></div><div>Transaction transaction = transactionManager.getCurrentTransaction();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 创建 事务编号</span></div><div>TransactionXid xid = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> TransactionXid(transaction.getXid().getGlobalTransactionId());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// TODO</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs()) == <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div>FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().set(<span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> TransactionContext(xid, TransactionStatus.TRYING.getId()), pjp.getTarget(), ((MethodSignature) pjp.getSignature()).getMethod(), pjp.getArgs());</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 获得类</span></div><div>Class targetClass = ReflectionUtils.getDeclaringType(pjp.getTarget().getClass(), method.getName(), method.getParameterTypes());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 创建 确认执行方法调用上下文 和 取消执行方法调用上下文</span></div><div>InvocationContext confirmInvocation = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> InvocationContext(targetClass,</div><div>confirmMethodName,</div><div>method.getParameterTypes(), pjp.getArgs());</div><div>InvocationContext cancelInvocation = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> InvocationContext(targetClass,</div><div>cancelMethodName,</div><div>method.getParameterTypes(), pjp.getArgs());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 创建 事务参与者</span></div><div>Participant participant =</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> Participant(</div><div>xid,</div><div>confirmInvocation,</div><div>cancelInvocation,</div><div>compensable.transactionContextEditor());</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 添加 事务参与者 到 事务</span></div><div>transactionManager.enlistParticipant(participant);</div><div>}</div></div></div><ul style="margin: 0px; padding: 0px 0px 0px 2.2em; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">CompensableMethodUtils#getCompensableMethod(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，获得带 @Compensable 注解的方法。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">#getCurrentTransaction()</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法， 获取事务。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 TransactionXid 构造方法，创建</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important; font-weight: bold;">分支</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">事务编号。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 全局事务编号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">byte</span>[] globalTransactionId;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 分支事务编号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">byte</span>[] branchQualifier;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">TransactionXid</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">byte</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">[] globalTransactionId)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.globalTransactionId = globalTransactionId;</div><div>branchQualifier = uuidToByteArray(UUID.randomUUID()); <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">// 生成 分支事务编号</span></div><div>}</div></div></li><ul style="margin: 0px; padding: 0px 0px 0px 30px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; list-style-type: square;"><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;">分支事务编号( </span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box; word-wrap: break-word; color: rgb(233, 105, 0); border-radius: 4px; background: rgb(248, 248, 248);">branchQualifier</span><span style="max-width: 100%; clear: both; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"> ) 需要生成。</span></li></ul><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">TODO TransactionContext 和 Participant 的关系。</span></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">ReflectionUtils#getDeclaringType(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，获得声明 @Compensable 方法的实际类。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">Class</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">getDeclaringType</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Class aClass, String methodName, Class&lt;?&gt;[] parameterTypes)</span> {</div><div>Method method;</div><div>Class findClass = aClass;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">do</span> {</div><div>Class[] clazzes = findClass.getInterfaces();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">for</span> (Class clazz : clazzes) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">try</span> {</div><div>method = clazz.getDeclaredMethod(methodName, parameterTypes);</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">catch</span> (NoSuchMethodException e) {</div><div>method = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>;</div><div>}</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">if</span> (method != <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">null</span>) {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> clazz;</div><div>}</div><div>}</div><div>findClass = findClass.getSuperclass();</div><div>} <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">while</span> (!findClass.equals(Object.class));</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">return</span> aClass;</div><div>}</div></div></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 InvocationContext 构造方法，分别创建确认执行方法调用上下文和取消执行方法调用上下文。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 类</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Class targetClass;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 方法名</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> String methodName;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 参数类型数组</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Class[] parameterTypes;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 参数数组</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Object[] args;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">InvocationContext</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(Class targetClass, String methodName, Class[] parameterTypes, Object... args)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.methodName = methodName;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.parameterTypes = parameterTypes;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.targetClass = targetClass;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.args = args;</div><div>}</div></div></li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 Participant 构造方法，创建事务参与者。实现代码如下：</span><br/><div style="margin: 0px 2px; padding: 0.5em; max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;"><span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">class</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">Participant</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(248, 35, 117); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">implements</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(165, 218, 45); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; overflow-y: auto !important; white-space: inherit !important;">Serializable</span> <span style="max-width: 100%; box-sizing: border-box; font-size: 14px; color: rgb(169, 183, 198); line-height: 18px; border-radius: 0px; background: rgb(40, 43, 46); font-family: Consolas, Inconsolata, Courier, monospace; overflow-x: auto; letter-spacing: 0px; word-wrap: normal !important; word-break: normal !important; overflow-y: auto !important;">{</span></div><br/><div style="margin: 0px 2px; padding: 2px 4px; max-width: 100%; box-sizing: border-box; color: rgb(233, 105, 0); line-height: 18px; border-radius: 0px; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial; font-family: Consolas, Inconsolata, Courier, monospace; letter-spacing: 0px; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important; overflow: auto !important;"><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">static</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">final</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">long</span> serialVersionUID = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(174, 135, 250); word-break: inherit !important; white-space: inherit !important;">4127729421281425247L</span>;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务编号</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> TransactionXid xid;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 确认执行业务方法调用上下文</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> InvocationContext confirmInvocationContext;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 取消执行业务方法</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> InvocationContext cancelInvocationContext;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 执行器</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">private</span> Terminator terminator = <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">new</span> Terminator();</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">/**</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">* 事务上下文编辑</span></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(128, 128, 128); word-break: inherit !important; white-space: inherit !important;">*/</span></div><div>Class&amp;lt;? extends TransactionContextEditor&amp;gt; transactionContextEditorClass;</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Participant</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">()</span> {</div><div>}</div><div><br style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; word-break: inherit !important; white-space: inherit !important;"/></div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">public</span> <span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(165, 218, 45); word-break: inherit !important; white-space: inherit !important;">Participant</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(255, 152, 35); word-break: inherit !important; white-space: inherit !important;">(TransactionXid xid, InvocationContext confirmInvocationContext, InvocationContext cancelInvocationContext, Class&amp;lt;? extends TransactionContextEditor&amp;gt; transactionContextEditorClass)</span> {</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.xid = xid;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.confirmInvocationContext = confirmInvocationContext;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.cancelInvocationContext = cancelInvocationContext;</div><div><span style="max-width: 100%; box-sizing: border-box; word-wrap: inherit !important; color: rgb(248, 35, 117); word-break: inherit !important; white-space: inherit !important;">this</span>.transactionContextEditorClass = transactionContextEditorClass;</div><div>}</div></div><br/>
}</li><li style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;">调用 </span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(233, 105, 0); word-wrap: break-word; border-radius: 4px; background: rgb(248, 248, 248);">TransactionManager#enlistParticipant(...)</span><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; word-wrap: break-word !important;"> 方法，添加事务参与者到事务。</span></li></ul><h1 style="margin: 1.5em 0px; padding: 0px; font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-weight: bold; font-size: 1.6em; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">666. 彩蛋</span></h1><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">受限于本人的能力，蛮多处表达不够清晰或者易懂，非常抱歉。如果你对任何地方有任何疑问，欢迎添加本人微信号( wangwenbin-server )，期待与你的交流。不限于 TCC，也可以是分布式事务，也可以是微服务，以及等等。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><img src="分布式事务 TCC-Transaction 源码分析 —— TCC 实现_files/Image [3].jpg" type="image/jpeg" data-filename="Image.jpg" style="margin: 0px auto; padding: 0px; height: auto !important; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; border-width: 2px; border-style: solid; border-color: rgb(238, 238, 238); border-radius: 6px; display: block; width: auto !important; visibility: visible !important;"/></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">外送一本武林秘籍：带中文注释的 TCC-Transaction 仓库地址，目前正在慢慢完善。传送门：<a href="https://github.com/YunaiV/tcc-transaction">https://github.com/YunaiV/tcc-transaction</a>。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">再送一本葵花宝典：《TCC型分布式事务原理和实现》系列。</span></div><div style="margin: 1.5em 0px; padding: 0px; max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; clear: both; min-height: 1em; color: rgb(62, 62, 62); font-family: &quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); word-wrap: break-word !important;">胖友，分享一个朋友圈可好？</span></div><div><br/></div></div></span>
</div></body></html> 