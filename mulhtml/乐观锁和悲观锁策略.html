<html>
<head>
  <title>乐观锁和悲观锁策略</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1365"/>
<h1>乐观锁和悲观锁策略</h1>

<div>
<span><div><div><b><font style="font-size: 18pt; color: rgb(26, 144, 185);">个人理解</font></b></div><div><font style="font-size: 12pt;">(1)乐观锁和悲观锁主要用于解决并发更新记录时的丢失更新问题,换句话说乐观锁和悲观锁主要解决并发修改记录值且新值依赖于旧值的情况</font></div><div><font style="font-size: 12pt;">(2)Serializable隔离级别事务可以防止更新丢失问题的发生,其他的三个隔离级别都有可能发生更新丢失问题，但Serializable效率太低，所以一般不使用Serializable，而是采用乐观锁和悲观锁来解决丢失更新问题</font></div><div><font style="font-size: 12pt;">(3)乐观锁和悲观锁不是数据库中真正存在的锁，只是人们在解决更新丢失时的不同的解决方案，体现的是人们看待事务的态度</font></div><div><font style="font-size: 12pt;">(4)悲观锁原理之一：对每个查询出来的记录都加排它锁，直到事务释放</font></div><div><font style="font-size: 12pt;">(5)乐观锁原理之一：不使用任何锁，只是在记录中加一个版本字段，每次使用CAS方式更新数据，更新失败则需重复更新</font></div><div><font style="font-size: 12pt;">(6)对于数据库的很多锁都有两个版本的分类:</font></div><div><font style="font-size: 12pt;">   [1]行锁，页锁等分类方式只是针对范围进行分类</font></div><div><font style="font-size: 12pt;">   [2]共享和互斥是针对同步策略分类</font></div><div><font style="font-size: 12pt;">(7)原文对于悲观锁的理解是说当它修改记录才开始加锁，实际上是查询数据到就直接开始加锁，即在查询数据那一步就已经加了排它锁（通过select...forupdate的方式），如果不使用这种逻辑还是会出现更新丢失的问题</font></div><div><font style="font-size: 12pt;">(8)Mysql的for update语法只有在该sql使用到了索引时才会使用行级锁。如果没有用到索引会使用表级锁把整张表锁住，需要注意这个问题！</font></div><div><font style="font-size: 12pt;">(9)悲观锁和乐观锁的适用范围</font></div><div><font style="font-size: 12pt;">  悲观锁主要用于数据争用激烈的环境，以及发生并发冲突时使用锁保护数据的成本要低于回滚事务的成本的环境中</font></div><div><font style="font-size: 12pt;">  乐观锁适用于写比较少的情况下，即冲突真的很少发生的时候，这样可以省去了锁的开销，加大整个系统的吞吐量。</font></div><div><font style="font-size: 12pt;">(10)丢失更新、putIfAbsent等并发错误不应该通过数据库事务隔离级别来实现，要在应用程序当中去实现。</font></div><div><b><font style="color: rgb(26, 144, 185); font-size: 18pt;">原文</font></b></div><div><b>深入理解乐观锁和悲观锁：<a href="http://blog.csdn.net/qq_35246620/article/details/69948587">http://blog.csdn.net/qq_35246620/article/details/69948587</a></b></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在</span><a href="http://blog.csdn.net/qq_35246620/article/details/69569506" style="box-sizing: border-box; font-size: 16px; color: rgb(12, 137, 207); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">数据库的锁机制</a><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">中，咱们介绍过，数据库管理系统（DBMS）中的并发控制的任务是确保在多个事务同时存取数据库中同一数据时不破坏事务的隔离性和统一性以及数据库的统一性。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">乐观并发控制（乐观锁）和悲观并发控制（悲观锁）是并发控制主要采用的技术手段。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">无论是悲观锁还是乐观锁，都是人们定义出来的概念，可以认为是一种思想。其实，不仅仅是关系型数据库系统中有乐观锁和悲观锁的概念，像 MemCache、Hibernate、Tair 等都有类似的概念。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">针对于不同的业务场景，应该选用不同的并发控制方式。因此，不要把乐观并发控制和悲观并发控制狭义的理解为 DBMS 中的概念，更不要把它们和数据库中提供的锁机制（行锁、表锁、排他锁、共享锁）混为一谈。事实上，在 DBMS 中，悲观锁正是利用数据库本身提供的锁机制来实现的。</span></div><h2 style="margin: 8px 0px 16px; padding: 0px; box-sizing: border-box; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; line-height: 32px; color: rgb(79, 79, 79); text-align: start; font-size: 24px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; line-height: 32px; color: rgb(79, 79, 79); font-size: 24px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">悲观锁</span></h2><blockquote style="box-sizing: border-box; margin: 0px 0px 24px; padding: 16px; border-left: 8px solid rgb(221, 223, 228); background: rgb(238, 240, 244); border-radius: 0px 5px 5px 0px; overflow: auto; word-wrap: normal; word-break: normal; color: rgb(63, 63, 63); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; text-align: justify; word-wrap: break-word; word-break: normal;"><span style="box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; word-wrap: break-word; word-break: normal;">在关系数据库管理系统里，悲观并发控制（又名“悲观锁”，Pessimistic Concurrency Control，缩写“PCC”）是一种并发控制的方法，它可以阻止一个事务以影响其他用户的方式来修改数据。如果一个事务执行的操作在某行数据应用了锁，那只有当这个事务把锁释放，其他事务才能够执行与该锁冲突的操作。</span></div><div style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; text-align: justify; word-wrap: break-word; word-break: normal;"><span style="box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; word-wrap: break-word; word-break: normal;">悲观并发控制主要用于数据争用激烈的环境，以及发生并发冲突时使用锁保护数据的成本要低于回滚事务的成本的环境中。</span></div></blockquote><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">悲观锁，正如其名，它指的是对数据被外界（包括本系统当前的其他事务，以及来自外部系统的事务处理）修改持保守（悲观）态度。因此，在整个数据处理的过程中，都将数据处于锁定状态。 悲观锁的实现，往往依靠数据库提供的锁机制 （也只有数据库层提供的锁机制才能真正保证数据访问的排他性，否则，即使在本系统中实现了加锁机制，也无法保证外部系统不会修改数据）。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">在数据库中，悲观锁的实现流程如下：</span></div><ul style="box-sizing: border-box; margin: 0px 0px 24px; padding: 0px; color: rgb(63, 63, 63); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="box-sizing: border-box; list-style-type: disc; margin: 8px 0px 0px 32px;">在对任意记录进行修改前，先尝试为该记录加上排他锁；</li><li style="box-sizing: border-box; list-style-type: disc; margin: 8px 0px 0px 32px;">如果加锁失败，说明该记录正在被修改，那么当前查询可能要等待或者抛出异常，具体响应方式由开发者根据实际需要决定；</li><li style="box-sizing: border-box; list-style-type: disc; margin: 8px 0px 0px 32px;">如果成功加锁，那么就可以对记录做修改，事务完成后就会解锁。</li></ul><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">期间，如果有其他对该记录做修改或加排他锁的操作，都会等待解锁或直接抛出异常。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">MySQL InnoDB 中使用悲观锁：</span></div><blockquote style="box-sizing: border-box; margin: 0px 0px 24px; padding: 16px; border-left: 8px solid rgb(221, 223, 228); background: rgb(238, 240, 244); border-radius: 0px 5px 5px 0px; overflow: auto; word-wrap: normal; word-break: normal; color: rgb(63, 63, 63); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; text-align: justify; word-wrap: break-word; word-break: normal;"><span style="box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; word-wrap: break-word; word-break: normal;">要使用悲观锁，咱们必须关闭 MySQL 数据库的自动提交属性，因为 MySQL 默认使用 autocommit 模式，也就是说，当你执行一个更新操作后，MySQL 会立刻将结果进行提交，</span><span style="box-sizing: border-box; font-size: 14px; color: rgb(199, 37, 78); line-height: 22px; word-wrap: break-word; word-break: normal; font-family: Consolas, Inconsolata, Courier, monospace; background-color: rgb(249, 242, 244); white-space: nowrap; border-radius: 4px;">set autocommit=0;</span></div></blockquote><div style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin: 0px 0px 24px; font-family: Consolas, Inconsolata, Courier, monospace; padding: 8px 16px 4px 56px; font-size: 14px; line-height: 22px; word-break: break-all; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); border: none; border-radius: 0px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="padding: 0px; background: rgb(246, 248, 250); color: rgb(0, 0, 0); box-sizing: border-box; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;"><div>// 0.开始事务</div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">begin</span><span style="box-sizing: border-box;">;</span> <span style="color: rgb(136, 0, 0); box-sizing: border-box;">/* begin work; start transaction; (三者中任选一个就可以)*/</span></div><div>// 1.查询出商品信息</div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">select</span> <span style="box-sizing: border-box;">status</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">from</span> <span style="box-sizing: border-box;">t_goods</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">where</span> <span style="box-sizing: border-box;">id=</span><span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">for</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">update</span><span style="box-sizing: border-box;">;</span></div><div>// 2.根据商品信息生成订单</div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">insert</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">into</span> <span style="box-sizing: border-box;">t_orders (id,goods_id)</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">values</span> <span style="box-sizing: border-box;">(</span><span style="box-sizing: border-box; color: rgb(0, 0, 136);">null</span><span style="box-sizing: border-box;">,</span><span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span><span style="box-sizing: border-box;">);</span></div><div>// 3.修改商品 status 为 2</div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">update</span> <span style="box-sizing: border-box;">t_goods</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">set</span> <span style="box-sizing: border-box;">status=</span><span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span><span style="box-sizing: border-box;">;</span></div><div>// 4.提交事务</div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">commit</span><span style="box-sizing: border-box;">;</span> <span style="color: rgb(136, 0, 0); box-sizing: border-box;">/* commit work; */</span></div></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在上面的查询语句中，咱们使用了</span><span style="box-sizing: border-box; font-size: 14px; color: rgb(199, 37, 78); line-height: 22px; word-wrap: break-word; word-break: normal; font-family: Consolas, Inconsolata, Courier, monospace; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: nowrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); border-radius: 4px;">select…for update</span><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">的方式，这样就通过开启排他锁的方式实现了悲观锁。此时在</span><span style="box-sizing: border-box; font-size: 14px; color: rgb(199, 37, 78); line-height: 22px; word-wrap: break-word; word-break: normal; font-family: Consolas, Inconsolata, Courier, monospace; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: nowrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); border-radius: 4px;">t_goods</span><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">表中，</span><span style="box-sizing: border-box; font-size: 14px; color: rgb(199, 37, 78); line-height: 22px; word-wrap: break-word; word-break: normal; font-family: Consolas, Inconsolata, Courier, monospace; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: nowrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); border-radius: 4px;">id</span><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">为</span><span style="box-sizing: border-box; font-size: 14px; color: rgb(199, 37, 78); line-height: 22px; word-wrap: break-word; word-break: normal; font-family: Consolas, Inconsolata, Courier, monospace; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: nowrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); border-radius: 4px;">1</span><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">的那条数据就被咱们锁定了，其它的事务必须等本次事务提交之后才能执行。这样咱们就可以保证当前的数据不会被其它事务修改。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">不过，在使用</span><span style="box-sizing: border-box; font-size: 14px; color: rgb(199, 37, 78); line-height: 22px; word-wrap: break-word; word-break: normal; font-family: Consolas, Inconsolata, Courier, monospace; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: nowrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); border-radius: 4px;">select…for update</span><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">给数据加锁的时候，咱们需要注意锁的级别，MySQL InnoDB 默认行级锁。行级锁都是基于索引的，如果一条 SQL 语句用不到索引是不会使用行级锁的，而会使用表级锁把整张表锁住，这点需要咱们格外的注意。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">优点与不足</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">悲观并发控制实际上是“先取锁再访问”的保守策略，为数据处理的安全提供了保证。但是在效率方面，处理加锁的机制会让数据库产生额外的开销，还有增加产生死锁的机会；另外，在只读型事务处理中由于不会产生冲突，也没必要使用锁，这样做只能增加系统负载；还会降低并行性。一个事务如果锁定了某行数据，其他事务就必须等待该事务处理完才可以处理这行数据。</span></div><h2 style="margin: 8px 0px 16px; padding: 0px; box-sizing: border-box; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; line-height: 32px; color: rgb(79, 79, 79); text-align: start; font-size: 24px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; line-height: 32px; color: rgb(79, 79, 79); font-size: 24px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">乐观锁</span></h2><blockquote style="box-sizing: border-box; margin: 0px 0px 24px; padding: 16px; border-left: 8px solid rgb(221, 223, 228); background: rgb(238, 240, 244); border-radius: 0px 5px 5px 0px; overflow: auto; word-wrap: normal; word-break: normal; color: rgb(63, 63, 63); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; text-align: justify; word-wrap: break-word; word-break: normal;"><span style="box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; word-wrap: break-word; word-break: normal;">在关系数据库管理系统里，乐观并发控制（又名“乐观锁”，Optimistic Concurrency Control，缩写“OCC”）是一种并发控制的方法。它假设多用户并发的事务在处理时不会彼此互相影响，各事务能够在不产生锁的情况下处理各自影响的那部分数据。在提交数据更新之前，每个事务会先检查在该事务读取数据后，有没有其他事务又修改了该数据。如果其他事务有更新的话，正在提交的事务会进行回滚。乐观事务控制最早是由孔祥重（H.T.Kung）教授提出。</span></div></blockquote><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">乐观锁（ Optimistic Locking ） 是相对悲观锁而言，乐观锁假设认为数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则让返回用户错误的信息，让用户决定如何去做。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">相对于悲观锁，在对数据库进行处理的时候，乐观锁并不会使用数据库提供的锁机制。一般的，实现乐观锁的方式就是记录数据版本。</span></div><blockquote style="box-sizing: border-box; margin: 0px 0px 24px; padding: 16px; border-left: 8px solid rgb(221, 223, 228); background: rgb(238, 240, 244); border-radius: 0px 5px 5px 0px; overflow: auto; word-wrap: normal; word-break: normal; color: rgb(63, 63, 63); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="margin: 0px; padding: 0px; box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; text-align: justify; word-wrap: break-word; word-break: normal;"><span style="box-sizing: border-box; font-size: 14px; color: rgb(153, 153, 153); line-height: 22px; word-wrap: break-word; word-break: normal;">数据版本，为数据增加的一个版本标识。当读取数据时，将版本标识的值一同读出，数据每更新一次，同时对版本标识进行更新。当咱们提交更新的时候，判断数据库表对应记录的当前版本信息与第一次取出来的版本标识进行比对，如果数据库表当前版本表示与第一次取出来的版本标识值相等，则予以更新；否则，认为是过期数据。</span></div></blockquote><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">实现数据版本有两种方式，第一种是使用版本号，第二种是使用时间戳。</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">使用版本号实现乐观锁</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">使用版本号时，可以在数据初始化时指定一个版本号，每次对数据的更新操作都对版本号执行</span><span style="box-sizing: border-box; font-size: 14px; color: rgb(199, 37, 78); line-height: 22px; word-wrap: break-word; word-break: normal; font-family: Consolas, Inconsolata, Courier, monospace; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: nowrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); border-radius: 4px;">+1</span><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">操作，并判断当前版本号是不是该数据的最新的版本号。</span></div><div style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin: 0px 0px 24px; font-family: Consolas, Inconsolata, Courier, monospace; padding: 8px 16px 4px 56px; font-size: 14px; line-height: 22px; word-break: break-all; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); border: none; border-radius: 0px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="padding: 0px; background: rgb(246, 248, 250); color: rgb(0, 0, 0); box-sizing: border-box; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; white-space: pre; border-radius: 4px; line-height: 22px; overflow-x: auto; word-wrap: normal;"><div>// 1.查询出商品信息</div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">select</span> <span style="box-sizing: border-box;">(status,status,version)</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">from</span> <span style="box-sizing: border-box;">t_goods</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">where</span> <span style="box-sizing: border-box;">id=#{id}</span></div><div><span style="box-sizing: border-box;">//</span> <span style="box-sizing: border-box; color: rgb(0, 102, 102);">2.</span><span style="box-sizing: border-box;">根据商品信息生成订单</span></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">insert</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">into</span> <span style="box-sizing: border-box;">t_orders (id,goods_id)</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">values</span> <span style="box-sizing: border-box;">(</span><span style="box-sizing: border-box; color: rgb(0, 0, 136);">null</span><span style="box-sizing: border-box;">,</span><span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span><span style="box-sizing: border-box;">);</span></div><div>// 3.修改商品 status 为 2</div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">update</span> <span style="box-sizing: border-box;">t_goods</span></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">set</span> <span style="box-sizing: border-box;">status =</span> <span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span><span style="box-sizing: border-box;">,version = version +</span> <span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span><span style="box-sizing: border-box; color: rgb(0, 0, 136);">where</span> <span style="box-sizing: border-box;">id=#{id}</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">and</span> <span style="box-sizing: border-box;">version=#{version};</span></div></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold;">优点与不足</span></div><div><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; word-wrap: break-word; word-break: normal; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">乐观并发控制相信事务之间的数据竞争（data race）的概率是比较小的，因此尽可能直接做下去，直到提交的时候才去锁定，所以不会产生任何锁和死锁。但如果直接简单这么做，还是有可能会遇到不可预期的结果，例如两个事务都读取了数据库的某一行，经过修改以后写回数据库，这时就遇到了问题。</span></div><div><b><font color="#1A90B9" style="font-size: 18pt;"><br/></font></b></div><div><b><font color="#1A90B9" style="font-size: 18pt;">参考文章</font></b></div><div><font style="font-size: 12pt;">深入理解乐观锁和悲观锁：<a href="http://blog.csdn.net/qq_35246620/article/details/69948587">http://blog.csdn.net/qq_35246620/article/details/69948587</a></font></div><div><font style="font-size: 12pt;">一分钟教你知道乐观锁和悲观锁的区别：<a href="http://blog.csdn.net/hongchangfirst/article/details/26004335">http://blog.csdn.net/hongchangfirst/article/details/26004335</a></font></div><div><font style="font-size: 12pt;">事务的更新丢失：<a href="http://m.blog.csdn.net/qq_36074058/article/details/76685937">http://m.blog.csdn.net/qq_36074058/article/details/76685937</a></font></div><div><font style="font-size: 12pt;">mysql悲观锁总结和实践：<a href="http://chenzhou123520.iteye.com/blog/1860954">http://chenzhou123520.iteye.com/blog/1860954</a></font></div><div><font style="font-size: 12pt;">mysql乐观锁总结和实践：<a href="http://chenzhou123520.iteye.com/blog/1863407">http://chenzhou123520.iteye.com/blog/1863407</a></font></div><div><br/></div></div></span>
</div></body></html> 