<html>
<head>
  <title>synchronized底层原理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="947"/>
<h1>synchronized底层原理</h1>

<div>
<span><div><div><b><font style="color: rgb(26, 144, 185); font-size: 18pt;">个人理解</font></b></div><div><font style="font-size: 12pt;">1.每个对象都关联了一个monitor record，monitor record就是传说中的重量级锁，是用C++写的，文件在hotspot\src\share\vm\runtime目录下的objectMonitor.cpp文件和objectMonitor.hpp文件</font></div><div><font style="font-size: 12pt;">2.对象在使用重量级锁时，对象头会有指针指向monitor record</font></div><div><font style="font-size: 12pt;">3.objectmonitor中有数据，也有行为，很多锁优化就是在里面做的。</font></div><div><span style="font-weight: bold;"><font style="font-size: 10pt; color: rgb(26, 144, 185);"><br/></font></span></div><div><a href="synchronized底层原理_files/objectMonitor.hpp"><img src="synchronized底层原理_files/cadf58176a3d3ef3900c0499ea34d3a4.png" alt="objectMonitor.hpp"></a><a href="synchronized底层原理_files/objectMonitor.cpp"><img src="synchronized底层原理_files/a36306308812107efe5f7dca7318cabb.png" alt="objectMonitor.cpp"></a></div><div><span style="font-weight: bold;"><font style="font-size: 18pt; color: rgb(26, 144, 185);">原文</font></span></div><div><span style="font-weight: bold;">地址：<a href="http://blog.csdn.net/javazejian/article/details/72828483" style="font-weight: bold;">http://blog.csdn.net/javazejian/article/details/72828483</a></span></div><h1 style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; margin: 8px 0px 16px; padding: 0px; font-weight: bold; box-sizing: border-box; color: rgb(79, 79, 79); font-size: 28px; line-height: 36px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; box-sizing: border-box; color: rgb(190, 25, 33); font-size: 28px; line-height: 36px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">synchronized底层语义原理</span></h1><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">Java 虚拟机中的同步(Synchronization)基于进入和退出管程(Monitor)对象实现， 无论是显式同步(有明确的 monitorenter 和 monitorexit 指令,即同步代码块)还是隐式同步都是如此。在 Java 语言中，同步用的最多的地方可能是被 synchronized 修饰的同步方法。同步方法 并不是由 monitorenter 和 monitorexit 指令来实现同步的，而是由方法调用指令读取运行时常量池中方法的 ACC_SYNCHRONIZED 标志来隐式实现的，关于这点，稍后详细分析。下面先来了解一个概念Java对象头，这对深入理解synchronized实现原理非常关键。</span></div><h2 style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; margin: 8px 0px 16px; padding: 0px; font-weight: bold; box-sizing: border-box; color: rgb(79, 79, 79); font-size: 24px; line-height: 32px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; box-sizing: border-box; color: rgb(190, 25, 33); font-size: 24px; line-height: 32px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">理解Java对象头与Monitor</span></h2><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在JVM中，对象在内存中的布局分为三块区域：对象头、实例数据和对齐填充。如下：</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="synchronized底层原理_files/Image.png" type="image/png" data-filename="Image.png" style="border: 0px; outline: 0px; box-sizing: border-box; max-width: 100%; margin: 24px 0px;"/></div><div style="margin: 8px 0px 0px 32px; padding: 0px; box-sizing: border-box; list-style: disc;"><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify;"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px;">实例变量：存放类的属性数据信息，包括父类的属性信息，如果是数组的实例部分还包括数组的长度，这部分内存按4字节对齐。</span></div></div><div style="margin: 8px 0px 0px 32px; padding: 0px; box-sizing: border-box; list-style: disc;"><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify;"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px;">填充数据：由于虚拟机要求对象起始地址必须是8字节的整数倍。填充数据不是必须存在的，仅仅是为了字节对齐，这点了解即可。</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">而对于顶部，则是Java头对象，它实现synchronized的锁对象的基础，这点我们重点分析它，一般而言，synchronized使用的锁对象是存储在Java对象头里的，jvm中采用2个字来存储对象头(如果对象是数组则会分配3个字，多出来的1个字记录的是数组长度)，其主要结构是由Mark Word 和 Class Metadata Address 组成，其结构说明如下表：</span></div><table style="box-sizing: border-box; text-align: center; color: rgb(69, 69, 69); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 287px;"></col><col style="width: 287px;"></col><col style="width: 287px;"></col></colgroup><tbody style="box-sizing: border-box; border: 0px;"><tr style="box-sizing: border-box; background-color: rgb(255, 255, 255);"><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>虚拟机位数</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>头对象结构</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>说明</div></td></tr><tr style="box-sizing: border-box; background-color: rgb(255, 255, 255);"><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>32/64bit</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>Mark Word</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>存储对象的hashCode、锁信息或分代年龄或GC标志等信息</div></td></tr><tr style="box-sizing: border-box; background-color: rgb(247, 247, 247);"><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>32/64bit</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>Class Metadata Address</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 287px; padding: 8px;"><div>类型指针指向对象的类元数据，JVM通过这个指针确定该对象是哪个类的实例。</div></td></tr></tbody></table><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">其中Mark Word在默认情况下存储着对象的HashCode、分代年龄、锁标记位等以下是32位JVM的Mark Word默认存储结构</span></div><table style="box-sizing: border-box; text-align: center; color: rgb(69, 69, 69); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 172px;"></col><col style="width: 172px;"></col><col style="width: 172px;"></col><col style="width: 172px;"></col><col style="width: 172px;"></col></colgroup><tbody style="box-sizing: border-box; border: 0px;"><tr style="box-sizing: border-box; background-color: rgb(255, 255, 255);"><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>锁状态</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>25bit</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>4bit</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>1bit是否是偏向锁</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; font-weight: 700; background-color: rgb(239, 243, 245); border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>2bit 锁标志位</div></td></tr><tr style="box-sizing: border-box; background-color: rgb(255, 255, 255);"><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>无锁状态</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>对象HashCode</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>对象分代年龄</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>0</div></td><td style="box-sizing: border-box; font-size: 14px; color: rgb(79, 79, 79); line-height: 22px; text-align: left; word-wrap: break-word; word-break: normal; vertical-align: middle; border: 1px solid rgb(221, 221, 221); width: 172px; padding: 8px;"><div>01</div></td></tr></tbody></table><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">由于对象头的信息是与对象自身定义的数据没有关系的额外存储成本，因此考虑到JVM的空间效率，Mark Word 被设计成为一个非固定的数据结构，以便存储更多有效的数据，它会根据对象本身的状态复用自己的存储空间，如32位JVM下，除了上述列出的Mark Word默认存储结构外，还有如下可能变化的结构：</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="synchronized底层原理_files/Image [1].png" type="image/png" data-filename="Image.png" style="border: 0px; outline: 0px; box-sizing: border-box; max-width: 100%; margin: 24px 0px;"/></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">其中轻量级锁和偏向锁是Java 6 对 synchronized 锁进行优化后新增加的，稍后我们会简要分析。这里我们主要分析一下重量级锁也就是通常说synchronized的对象锁，锁标识位为10，其中指针指向的是monitor对象（也称为管程或监视器锁）的起始地址。每个对象都存在着一个 monitor 与之关联，对象与其 monitor 之间的关系有存在多种实现方式，如monitor可以与对象一起创建销毁或当线程试图获取对象锁时自动生成，但当一个 monitor 被某个线程持有后，它便处于锁定状态。在Java虚拟机(HotSpot)中，monitor是由ObjectMonitor实现的，其主要数据结构如下（位于HotSpot虚拟机源码ObjectMonitor.hpp文件，C++实现的）</span></div><div style="margin: 0px 0px 24px; padding: 8px 16px 4px 56px; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; border: none; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 0px; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;"><div>ObjectMonitor() {</div><div>_header = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span>;</div><div>_count = <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span>; <span style="box-sizing: border-box; color: rgb(136, 0, 0);">//记录个数</span></div><div>_waiters = <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span>,</div><div>_recursions = <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span>;</div><div>_object = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span>;</div><div>_owner = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span>;</div><div>_WaitSet = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span>; <span style="box-sizing: border-box; color: rgb(136, 0, 0);">//处于wait状态的线程，会被加入到_WaitSet</span></div><div>_WaitSetLock = <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span> ;</div><div>_Responsible = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span> ;</div><div>_succ = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span> ;</div><div>_cxq = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span> ;</div><div>FreeNext = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span> ;</div><div>_EntryList = <span style="box-sizing: border-box; color: rgb(0, 0, 136);">NULL</span> ; <span style="box-sizing: border-box; color: rgb(136, 0, 0);">//处于等待锁block状态的线程，会被加入到该列表</span></div><div>_SpinFreq = <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span> ;</div><div>_SpinClock = <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span> ;</div><div>OwnerIsThread = <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span> ;</div></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">ObjectMonitor中有两个队列，_WaitSet 和 _EntryList，用来保存ObjectWaiter对象列表( 每个等待锁的线程都会被封装成ObjectWaiter对象)，_owner指向持有ObjectMonitor对象的线程，当多个线程同时访问一段同步代码时，首先会进入 _EntryList 集合，当线程获取到对象的monitor 后进入 _Owner 区域并把monitor中的owner变量设置为当前线程同时monitor中的计数器count加1，若线程调用 wait() 方法，将释放当前持有的monitor，owner变量恢复为null，count自减1，同时该线程进入 WaitSe t集合中等待被唤醒。若当前线程执行完毕也将释放monitor(锁)并复位变量的值，以便其他线程进入获取monitor(锁)。如下图所示</span></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="synchronized底层原理_files/Image [2].png" type="image/png" data-filename="Image.png" style="border: 0px; outline: 0px; box-sizing: border-box; max-width: 100%; margin: 24px 0px;"/></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">由此看来，monitor对象存在于每个Java对象的对象头中(存储的指针的指向)，synchronized锁便是通过这种方式获取锁的，也是为什么Java中任意对象可以作为锁的原因，同时也是notify/notifyAll/wait等方法存在于顶级对象Object中的原因(关于这点稍后还会进行分析)，ok~，有了上述知识基础后，下面我们将进一步分析synchronized在字节码层面的具体语义实现。</span></div><h2 style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; margin: 8px 0px 16px; padding: 0px; font-weight: bold; box-sizing: border-box; color: rgb(79, 79, 79); font-size: 24px; line-height: 32px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; box-sizing: border-box; color: rgb(190, 25, 33); font-size: 24px; line-height: 32px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">synchronized代码块底层原理</span></h2><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">现在我们重新定义一个synchronized修饰的同步代码块，在代码块中操作共享变量i，如下</span></div><div style="margin: 0px 0px 24px; padding: 8px 16px 4px 56px; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; border: none; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 0px; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;"><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">class</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">SyncCodeBlock</span> <span style="box-sizing: border-box;">{</span></div><div><br/></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">int</span> i;</div><div><br/></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">void</span> <span style="box-sizing: border-box; color: rgb(0, 153, 0);">syncTask</span>(){</div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//同步代码库</span></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">synchronized</span> (<span style="box-sizing: border-box; color: rgb(0, 0, 136);">this</span>){</div><div>i++;</div><div>}</div><div>}</div><div>}</div></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">编译上述代码并使用javap反编译后得到字节码如下(这里我们省略一部分没有必要的信息)：</span></div><div style="margin: 0px 0px 24px; padding: 8px 16px 4px 56px; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; border: none; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 0px; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;"><div>Classfile /Users/zejian/Downloads/Java8_Action/src/main/java/com/zejian/concurrencys/SyncCodeBlock.<span style="box-sizing: border-box; color: rgb(0, 0, 136);">class</span></div><div>Last modified <span style="box-sizing: border-box; color: rgb(0, 102, 102);">2017</span>-<span style="box-sizing: border-box; color: rgb(0, 102, 102);">6</span>-<span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span>; size <span style="box-sizing: border-box; color: rgb(0, 102, 102);">426</span> bytes</div><div>MD5 checksum c80bc322c87b312de760942820b4fed5</div><div>Compiled from <span style="box-sizing: border-box; color: rgb(0, 153, 0);">&quot;SyncCodeBlock.java&quot;</span><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">class</span> com.zejian.concurrencys.SyncCodeBlock</div><div>minor version: <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span></div><div>major version: <span style="box-sizing: border-box; color: rgb(0, 102, 102);">52</span></div><div>flags: ACC_PUBLIC, ACC_SUPER</div><div>Constant pool:</div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//........省略常量池中数据</span></div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//构造函数</span></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> com.zejian.concurrencys.SyncCodeBlock();</div><div>descriptor: ()V</div><div>flags: ACC_PUBLIC</div><div>Code:</div><div><span style="box-sizing: border-box; color: rgb(79, 79, 79);">stack</span>=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span>, locals=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span>, args_size=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span>: aload_0</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span>: invokespecial <span style="box-sizing: border-box; color: rgb(0, 153, 0);">#1</span> <span style="box-sizing: border-box; color: rgb(0, 153, 0);">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">4</span>: <span style="box-sizing: border-box; color: rgb(0, 0, 136);">return</span></div><div>LineNumberTable:</div><div>line <span style="box-sizing: border-box; color: rgb(0, 102, 102);">7</span>: <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span></div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//===========主要看看syncTask方法实现================</span></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">void</span> syncTask();</div><div>descriptor: ()V</div><div>flags: ACC_PUBLIC</div><div>Code:</div><div><span style="box-sizing: border-box; color: rgb(79, 79, 79);">stack</span>=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">3</span>, locals=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">3</span>, args_size=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span>: aload_0</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span>: dup</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span>: astore_1</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">3</span>: monitorenter <span style="box-sizing: border-box; color: rgb(136, 0, 0);">//注意此处，进入同步方法</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">4</span>: aload_0</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">5</span>: dup</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">6</span>: getfield <span style="box-sizing: border-box; color: rgb(0, 153, 0);">#2</span> <span style="box-sizing: border-box; color: rgb(0, 153, 0);">// Field i:I</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">9</span>: iconst_1</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">10</span>: iadd</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">11</span>: putfield <span style="box-sizing: border-box; color: rgb(0, 153, 0);">#2</span> <span style="box-sizing: border-box; color: rgb(0, 153, 0);">// Field i:I</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">14</span>: aload_1</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">15</span>: monitorexit <span style="box-sizing: border-box; color: rgb(136, 0, 0);">//注意此处，退出同步方法</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">16</span>: <span style="box-sizing: border-box; color: rgb(0, 0, 136);">goto</span> <span style="box-sizing: border-box; color: rgb(0, 102, 102);">24</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">19</span>: astore_2</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">20</span>: aload_1</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">21</span>: monitorexit <span style="box-sizing: border-box; color: rgb(136, 0, 0);">//注意此处，退出同步方法</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">22</span>: aload_2</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">23</span>: athrow</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">24</span>: <span style="box-sizing: border-box; color: rgb(0, 0, 136);">return</span></div><div>Exception table:</div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//省略其他字节码.......</span></div><div>}</div><div>SourceFile: <span style="box-sizing: border-box; color: rgb(0, 153, 0);">&quot;SyncCodeBlock.java&quot;</span></div></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">我们主要关注字节码中的如下代码</span></div><div style="margin: 0px 0px 24px; padding: 8px 16px 4px 56px; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; border: none; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 0px; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;"><span style="box-sizing: border-box; color: rgb(0, 102, 102); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">3</span><span style="box-sizing: border-box; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">: monitorenter</span> <span style="box-sizing: border-box; color: rgb(136, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">//进入同步方法</span><span style="box-sizing: border-box; color: rgb(136, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">//..........省略其他</span> <span style="box-sizing: border-box; color: rgb(0, 102, 102); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">15</span><span style="box-sizing: border-box; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">: monitorexit</span> <span style="box-sizing: border-box; color: rgb(136, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">//退出同步方法</span><span style="box-sizing: border-box; color: rgb(0, 102, 102); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">16</span><span style="box-sizing: border-box; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">:</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">goto</span> <span style="box-sizing: border-box; color: rgb(0, 102, 102); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">24</span><span style="box-sizing: border-box; color: rgb(136, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">//省略其他.......</span><span style="box-sizing: border-box; color: rgb(0, 102, 102); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">21</span><span style="box-sizing: border-box; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">: monitorexit</span> <span style="box-sizing: border-box; color: rgb(136, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;">//退出同步方法</span></div></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">从字节码中可知同步语句块的实现使用的是monitorenter 和 monitorexit 指令，其中monitorenter指令指向同步代码块的开始位置，monitorexit指令则指明同步代码块的结束位置，当执行monitorenter指令时，当前线程将试图获取 objectref(即对象锁) 所对应的 monitor 的持有权，当 objectref 的 monitor 的进入计数器为 0，那线程可以成功取得 monitor，并将计数器值设置为 1，取锁成功。如果当前线程已经拥有 objectref 的 monitor 的持有权，那它可以重入这个 monitor (关于重入性稍后会分析)，重入时计数器的值也会加 1。倘若其他线程已经拥有 objectref 的 monitor 的所有权，那当前线程将被阻塞，直到正在执行线程执行完毕，即monitorexit指令被执行，执行线程将释放 monitor(锁)并设置计数器值为0 ，其他线程将有机会持有 monitor 。值得注意的是编译器将会确保无论方法通过何种方式完成，方法中调用过的每条 monitorenter 指令都有执行其对应 monitorexit 指令，而无论这个方法是正常结束还是异常结束。为了保证在方法异常完成时 monitorenter 和 monitorexit 指令依然可以正确配对执行，编译器会自动产生一个异常处理器，这个异常处理器声明可处理所有的异常，它的目的就是用来执行 monitorexit 指令。从字节码中也可以看出多了一个monitorexit指令，它就是异常结束时被执行的释放monitor 的指令。</span></div><h2 style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; margin: 8px 0px 16px; padding: 0px; font-weight: bold; box-sizing: border-box; color: rgb(79, 79, 79); font-size: 24px; line-height: 32px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-weight: bold; box-sizing: border-box; color: rgb(190, 25, 33); font-size: 24px; line-height: 32px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">synchronized方法底层原理</span></h2><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">方法级的同步是隐式，即无需通过字节码指令来控制的，它实现在方法调用和返回操作之中。JVM可以从方法常量池中的方法表结构(method_info Structure) 中的 ACC_SYNCHRONIZED 访问标志区分一个方法是否同步方法。当方法调用时，调用指令将会 检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先持有monitor（虚拟机规范中用的是管程一词）， 然后再执行方法，最后再方法完成(无论是正常完成还是非正常完成)时释放monitor。在方法执行期间，执行线程持有了monitor，其他任何线程都无法再获得同一个monitor。如果一个同步方法执行期间抛 出了异常，并且在方法内部无法处理此异常，那这个同步方法所持有的monitor将在异常抛到同步方法之外时自动释放。下面我们看看字节码层面如何实现：</span></div><div style="margin: 0px 0px 24px; padding: 8px 16px 4px 56px; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; border: none; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 0px; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;"><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">class</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">SyncMethod</span> <span style="box-sizing: border-box;">{</span></div><div><br/></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">int</span> i;</div><div><br/></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">synchronized</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">void</span> <span style="box-sizing: border-box; color: rgb(0, 153, 0);">syncTask</span>(){</div><div>i++;</div><div>}</div><div>}</div></div></div><div style="margin: 0px; padding: 0px 8px; box-sizing: border-box; list-style: none; color: rgb(153, 153, 153);"><br/></div><div style="margin: 0px 0px 16px; padding: 0px; box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">使用javap反编译后的字节码如下：</span></div><div style="margin: 0px 0px 24px; padding: 8px 16px 4px 56px; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; border: none; font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; color: rgb(0, 0, 0); background-color: rgb(246, 248, 250); font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><div style="box-sizing: border-box; padding: 0px; color: rgb(0, 0, 0); font-family: Consolas, Inconsolata, Courier, monospace; font-size: 14px; line-height: 22px; background-color: rgb(246, 248, 250); border-radius: 4px; overflow-x: auto; white-space: pre; word-wrap: normal;"><div>Classfile /Users/zejian/Downloads/Java8_Action/src/main/java/com/zejian/concurrencys/SyncMethod.class</div><div>Last modified <span style="box-sizing: border-box; color: rgb(0, 102, 102);">2017</span>-<span style="box-sizing: border-box; color: rgb(0, 102, 102);">6</span>-<span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span>; size <span style="box-sizing: border-box; color: rgb(0, 102, 102);">308</span> bytes</div><div>MD5 checksum f34075a8c059ea65e4cc2fa610e0cd94</div><div>Compiled from <span style="box-sizing: border-box; color: rgb(0, 153, 0);">&quot;SyncMethod.java&quot;</span><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">class</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">com</span><span style="box-sizing: border-box;">.</span><span style="box-sizing: border-box; color: rgb(79, 79, 79);">zejian</span><span style="box-sizing: border-box;">.</span><span style="box-sizing: border-box; color: rgb(79, 79, 79);">concurrencys</span><span style="box-sizing: border-box;">.</span><span style="box-sizing: border-box; color: rgb(79, 79, 79);">SyncMethod</span></div><div><span style="box-sizing: border-box; color: rgb(79, 79, 79);">minor</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">version</span><span style="box-sizing: border-box;">: 0</span></div><div><span style="box-sizing: border-box; color: rgb(79, 79, 79);">major</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">version</span><span style="box-sizing: border-box;">: 52</span></div><div><span style="box-sizing: border-box; color: rgb(79, 79, 79);">flags</span><span style="box-sizing: border-box;">:</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">ACC_PUBLIC</span><span style="box-sizing: border-box;">,</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">ACC_SUPER</span><span style="box-sizing: border-box; color: rgb(79, 79, 79);">Constant</span> <span style="box-sizing: border-box; color: rgb(79, 79, 79);">pool</span><span style="box-sizing: border-box;">;</span></div><div><br/></div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//省略没必要的字节码</span></div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//==================syncTask方法======================</span></div><div><span style="box-sizing: border-box; color: rgb(0, 0, 136);">public</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">synchronized</span> <span style="box-sizing: border-box; color: rgb(0, 0, 136);">void</span> <span style="box-sizing: border-box; color: rgb(0, 153, 0);">syncTask</span>();</div><div>descriptor: ()V</div><div><span style="box-sizing: border-box; color: rgb(136, 0, 0);">//方法标识ACC_PUBLIC代表public修饰，ACC_SYNCHRONIZED指明该方法为同步方法</span></div><div>flags: ACC_PUBLIC, ACC_SYNCHRONIZED</div><div>Code:</div><div>stack=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">3</span>, locals=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span>, args_size=<span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span>: aload_0</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">1</span>: dup</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span>: getfield #<span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span> <span style="box-sizing: border-box; color: rgb(136, 0, 0);">// Field i:I</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">5</span>: iconst_1</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">6</span>: iadd</div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">7</span>: putfield #<span style="box-sizing: border-box; color: rgb(0, 102, 102);">2</span> <span style="box-sizing: border-box; color: rgb(136, 0, 0);">// Field i:I</span></div><div><span style="box-sizing: border-box; color: rgb(0, 102, 102);">10</span>: <span style="box-sizing: border-box; color: rgb(0, 0, 136);">return</span></div><div>LineNumberTable:</div><div>line <span style="box-sizing: border-box; color: rgb(0, 102, 102);">12</span>: <span style="box-sizing: border-box; color: rgb(0, 102, 102);">0</span></div><div>line <span style="box-sizing: border-box; color: rgb(0, 102, 102);">13</span>: <span style="box-sizing: border-box; color: rgb(0, 102, 102);">10</span></div><div>}</div><div>SourceFile: <span style="box-sizing: border-box; color: rgb(0, 153, 0);">&quot;SyncMethod.java&quot;</span></div></div></div><div style="margin: 0px; padding: 0px 8px; box-sizing: border-box; list-style: none; color: rgb(153, 153, 153);"><br/></div><div><span style="box-sizing: border-box; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">从字节码中可以看出，synchronized修饰的方法并没有monitorenter指令和monitorexit指令，取得代之的确实是ACC_SYNCHRONIZED标识，该标识指明了该方法是一个同步方法，JVM通过该ACC_SYNCHRONIZED访问标志来辨别一个方法是否声明为同步方法，从而执行相应的同步调用。这便是synchronized锁在同步代码块和同步方法上实现的基本原理。同时我们还必须注意到的是在Java早期版本中，synchronized属于重量级锁，效率低下，因为监视器锁（monitor）是依赖于底层的操作系统的Mutex Lock来实现的，而操作系统实现线程之间的切换时需要从用户态转换到核心态，这个状态之间的转换需要相对比较长的时间，时间成本相对较高，这也是为什么早期的synchronized效率低的原因。庆幸的是在Java 6之后Java官方对从JVM层面对synchronized较大优化，所以现在的synchronized锁效率也优化得很不错了，Java 6之后，为了减少获得锁和释放锁所带来的性能消耗，引入了轻量级锁和偏向锁，接下来我们将简单了解一下Java官方在JVM层面对synchronized锁的优化</span></div></div></span>
</div></body></html> 