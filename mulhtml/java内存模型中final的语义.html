<html>
<head>
  <title>java内存模型中final的语义</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1068"/>
<h1>java内存模型中final的语义</h1>

<div>
<span><div><div><b>原文地址：<a href="http://www.infoq.com/cn/articles/java-memory-model-6">http://www.infoq.com/cn/articles/java-memory-model-6</a></b></div><div><br/></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">与前面介绍的锁和volatile相比较，对final域的读和写更像是普通的变量访问。对于final域，编译器和处理器要遵守两个重排序规则：</span></div><ol style="margin: 10px 0px 10px 10px; padding: 0px 0px 0px 20px; border: 0px; width: 549px; list-style-type: decimal; clear: left; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">在构造函数内对一个final域的写入，与随后把这个被构造对象的引用赋值给一个引用变量，这两个操作之间不能重排序。</li><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">初次读一个包含final域的对象的引用，与随后初次读这个final域，这两个操作之间不能重排序。</li></ol><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">下面，我们通过一些示例性的代码来分别说明这两个规则：</span></div><div style="margin: 10px 0px; padding: 10px 10px 10px 5px; border: 1px solid rgb(232, 232, 232); font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; background-color: rgb(245, 242, 240); color: rgb(49, 78, 100); line-height: 21px; width: 597.797px; overflow: auto; text-align: left; clear: none; font-size: 14px; background-position: -29px 0px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none !important;"><div>public class FinalExample {</div><div>int i; //普通变量</div><div>final int j; //final变量</div><div>static FinalExample obj;</div><div><br/></div><div>public void FinalExample () { //构造函数</div><div>i = 1; //写普通域</div><div>j = 2; //写final域</div><div>}</div><div><br/></div><div>public static void writer () { //写线程A执行</div><div>obj = new FinalExample ();</div><div>}</div><div><br/></div><div>public static void reader () { //读线程B执行</div><div>FinalExample object = obj; //读对象引用</div><div>int a = object.i; //读普通域</div><div>int b = object.j; //读final域</div><div>}</div><div>}</div></div><div style="margin: 0px; padding: 0px; border: 0px; height: 0px; clear: both; font-size: 0px; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"></div><div style="margin: 20px 0px 20px 20px; padding: 0px; border: 1px solid rgb(223, 223, 223); max-width: 100%; float: right; text-align: left; width: 315px; overflow: hidden; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div style="margin: 0px; padding: 0px; border-width: 0px 1px 0px 0px; border-right-style: dotted; border-right-color: rgb(223, 223, 223); float: left; text-align: left; width: 315px; background: none center top repeat-y rgb(247, 247, 247);"><div style="margin: 0px; padding: 10px 0px 0px 10px; border: 0px; float: left; text-align: left; width: 315px; min-height: 150px;"><div style="margin: 0px 0px 8px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: both; width: 315px; font-weight: bold;"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: both; width: 315px; font-weight: bold;">相关厂商内容</span></div><div style="margin: 0px; padding: 5px 0px 0px; border: 0px; float: left; text-align: left; width: 311.844px; min-height: 100px;"><div style="margin: 0px; padding: 0px; border: 0px;"><h3 style="margin: 0px 0px 10px; padding: 0px 0px 2px 25px; font-size: 12px; border: 0px; float: left; text-align: left; clear: both; width: 258.828px; color: rgb(34, 34, 34); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat;"><a href="http://www.infoq.com/cn/vendorcontent/show.action?vcr=4587&amp;utm_source=infoq&amp;utm_medium=VCR&amp;utm_campaign=vcr_articles_click&amp;utm_content=embedded" style="font-size: 12px; font-weight: bold; border: 0px; clear: both; width: 258.828px; color: rgb(23, 0, 0); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat; outline: none !important;">一堂课教你看懂技术创新与商业模式</a></h3></div><h3 style="margin: 0px 0px 10px; padding: 0px 0px 2px 25px; font-size: 12px; border: 0px; float: left; text-align: left; clear: both; width: 258.828px; color: rgb(34, 34, 34); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat;"><a href="http://www.infoq.com/infoq/url.action?i=17188&amp;t=f" style="font-size: 12px; font-weight: bold; border: 0px; clear: both; width: 258.828px; color: rgb(23, 0, 0); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat; outline: none !important;">从C#看开放对编程语言发展的影响</a></h3><h3 style="margin: 0px 0px 10px; padding: 0px 0px 2px 25px; font-size: 12px; border: 0px; float: left; text-align: left; clear: both; width: 258.828px; color: rgb(34, 34, 34); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat;"><a href="http://www.infoq.com/infoq/url.action?i=17189&amp;t=f" style="font-size: 12px; font-weight: bold; border: 0px; clear: both; width: 258.828px; color: rgb(23, 0, 0); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat; outline: none !important;">Netflix的工程文化：是什么在激励着我们？</a></h3><h3 style="margin: 0px 0px 10px; padding: 0px 0px 2px 25px; font-size: 12px; border: 0px; float: left; text-align: left; clear: both; width: 258.828px; color: rgb(34, 34, 34); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat;"><a href="http://www.infoq.com/infoq/url.action?i=17190&amp;t=f" style="font-size: 12px; font-weight: bold; border: 0px; clear: both; width: 258.828px; color: rgb(23, 0, 0); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat; outline: none !important;">百度贴吧之父：产品经理的发现和成长</a></h3><h3 style="margin: 0px 0px 10px; padding: 0px 0px 2px 25px; font-size: 12px; border: 0px; float: left; text-align: left; clear: both; width: 258.828px; color: rgb(34, 34, 34); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat;"><a href="http://www.infoq.com/infoq/url.action?i=17191&amp;t=f" style="font-size: 12px; font-weight: bold; border: 0px; clear: both; width: 258.828px; color: rgb(23, 0, 0); line-height: 1.2; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; background: url(&quot;i/pdf.png&quot;) 0px 0px no-repeat; outline: none !important;">Apache Kafka的过去，现在，和未来</a></h3><div style="margin: 0px; padding: 0px; border: 0px; height: 0px; clear: both; font-size: 0px;"></div></div></div></div><div style="margin: 0px; padding: 10px 0px 0px; border: 0px; float: left; text-align: left; width: 315px; clear: left;"><div style="margin: 0px 0px 8px; padding: 0px 0px 0px 10px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: both; width: 315px; font-weight: bold;"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: both; width: 315px; font-weight: bold;">相关赞助商</span></div><div><a href="http://www.infoq.com/infoq/url.action?i=17192&amp;t=f"><img src="java内存模型中final的语义_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" style="border: 0px; margin: 0px 0px 5px 5px; padding: 0px; float: right;"/></a></div><div style="margin: 0px; padding: 0px 10px; border: 0px;"></div></div><div style="margin: 0px; padding: 0px; border: 0px; height: 0px; clear: both; font-size: 0px;"></div></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">这里假设一个线程A执行writer ()方法，随后另一个线程B执行reader ()方法。下面我们通过这两个线程的交互来说明这两个规则。</span></div><h2 style="margin: 0px 0px 10px; padding: 0px; font-size: 20px; border: 0px; float: none; text-align: left; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 20px; border: 0px; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">写final域的重排序规则</span></h2><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">写final域的重排序规则禁止把final域的写重排序到构造函数之外。这个规则的实现包含下面2个方面：</span></div><ul style="margin: 0px 0px 15px 10px; padding: 0px; list-style: disc; border: 0px; clear: left; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px 0px 0px 15px; padding: 0px; border: 0px; float: none; clear: none;">JMM禁止编译器把final域的写重排序到构造函数之外。</li><li style="margin: 0px 0px 0px 15px; padding: 0px; border: 0px; float: none; clear: none;">编译器会在final域的写之后，构造函数return之前，插入一个StoreStore屏障。这个屏障禁止处理器把final域的写重排序到构造函数之外。</li></ul><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">现在让我们分析writer ()方法。writer ()方法只包含一行代码：finalExample = new FinalExample ()。这行代码包含两个步骤：</span></div><ol style="margin: 10px 0px 10px 10px; padding: 0px 0px 0px 20px; border: 0px; width: 549px; list-style-type: decimal; clear: left; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">构造一个FinalExample类型的对象；</li><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">把这个对象的引用赋值给引用变量obj。</li></ol><div style="margin: 0px; padding: 0px; border: 0px; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">假设线程B读对象引用与读对象的成员域之间没有重排序（马上会说明为什么需要这个假设），下图是一种可能的执行时序：</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="java内存模型中final的语义_files/Image [1].jpg" type="image/jpeg" data-filename="Image.jpg" style="border: 0px; margin: 0px 10px 10px 0px; padding: 0px;"/></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在上图中，写普通域的操作被编译器重排序到了构造函数之外，读线程B错误的读取了普通变量i初始化之前的值。而写final域的操作，被写final域的重排序规则“限定”在了构造函数之内，读线程B正确的读取了final变量初始化之后的值。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">写final域的重排序规则可以确保：在对象引用为任意线程可见之前，对象的final域已经被正确初始化过了，而普通域不具有这个保障。以上图为例，在读线程B“看到”对象引用obj时，很可能obj对象还没有构造完成（对普通域i的写操作被重排序到构造函数外，此时初始值2还没有写入普通域i）。</span></div><h2 style="margin: 0px 0px 10px; padding: 0px; font-size: 20px; border: 0px; float: none; text-align: left; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 20px; border: 0px; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">读final域的重排序规则</span></h2><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">读final域的重排序规则如下：</span></div><ul style="margin: 0px 0px 15px 10px; padding: 0px; list-style: disc; border: 0px; clear: left; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 0px 0px 0px 15px; padding: 0px; border: 0px; float: none; clear: none;">在一个线程中，初次读对象引用与初次读该对象包含的final域，JMM禁止处理器重排序这两个操作（注意，这个规则仅仅针对处理器）。编译器会在读final域操作的前面插入一个LoadLoad屏障。</li></ul><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">初次读对象引用与初次读该对象包含的final域，这两个操作之间存在间接依赖关系。由于编译器遵守间接依赖关系，因此编译器不会重排序这两个操作。大多数处理器也会遵守间接依赖，大多数处理器也不会重排序这两个操作。但有少数处理器允许对存在间接依赖关系的操作做重排序（比如alpha处理器），这个规则就是专门用来针对这种处理器。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">reader()方法包含三个操作：</span></div><ol style="margin: 10px 0px 10px 10px; padding: 0px 0px 0px 20px; border: 0px; width: 549px; list-style-type: decimal; clear: left; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">初次读引用变量obj;</li><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">初次读引用变量obj指向对象的普通域j。</li><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">初次读引用变量obj指向对象的final域i。</li></ol><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">现在我们假设写线程A没有发生任何重排序，同时程序在不遵守间接依赖的处理器上执行，下面是一种可能的执行时序：</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="java内存模型中final的语义_files/Image.png" type="image/png" data-filename="Image.png" style="border: 0px; margin: 0px 10px 10px 0px; padding: 0px;"/></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在上图中，读对象的普通域的操作被处理器重排序到读对象引用之前。读普通域时，该域还没有被写线程A写入，这是一个错误的读取操作。而读final域的重排序规则会把读对象final域的操作“限定”在读对象引用之后，此时该final域已经被A线程初始化过了，这是一个正确的读取操作。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">读final域的重排序规则可以确保：在读一个对象的final域之前，一定会先读包含这个final域的对象的引用。在这个示例程序中，如果该引用不为null，那么引用对象的final域一定已经被A线程初始化过了。</span></div><h2 style="margin: 0px 0px 10px; padding: 0px; font-size: 20px; border: 0px; float: none; text-align: left; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 20px; border: 0px; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">如果final域是引用类型</span></h2><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">上面我们看到的final域是基础数据类型，下面让我们看看如果final域是引用类型，将会有什么效果？</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">请看下列示例代码：</span></div><div style="margin: 10px 0px; padding: 10px 10px 10px 5px; border: 1px solid rgb(232, 232, 232); font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; background-color: rgb(245, 242, 240); color: rgb(49, 78, 100); line-height: 21px; width: 597.797px; overflow: auto; text-align: left; clear: none; font-size: 14px; background-position: -29px 0px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none !important;"><div>public class FinalReferenceExample {</div><div>final int[] intArray; //final是引用类型</div><div>static FinalReferenceExample obj;</div><div><br/></div><div>public FinalReferenceExample () { //构造函数</div><div>intArray = new int[1]; //1</div><div>intArray[0] = 1; //2</div><div>}</div><div><br/></div><div>public static void writerOne () { //写线程A执行</div><div>obj = new FinalReferenceExample (); //3</div><div>}</div><div><br/></div><div>public static void writerTwo () { //写线程B执行</div><div>obj.intArray[0] = 2; //4</div><div>}</div><div><br/></div><div>public static void reader () { //读线程C执行</div><div>if (obj != null) { //5</div><div>int temp1 = obj.intArray[0]; //6</div><div>}</div><div>}</div><div>}</div></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">这里final域为一个引用类型，它引用一个int型的数组对象。对于引用类型，写final域的重排序规则对编译器和处理器增加了如下约束：</span></div><ol style="margin: 10px 0px 10px 10px; padding: 0px 0px 0px 20px; border: 0px; width: 549px; list-style-type: decimal; clear: left; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;">在构造函数内对一个final引用的对象的成员域的写入，与随后在构造函数外把这个被构造对象的引用赋值给一个引用变量，这两个操作之间不能重排序。</li></ol><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">对上面的示例程序，我们假设首先线程A执行writerOne()方法，执行完后线程B执行writerTwo()方法，执行完后线程C执行reader ()方法。下面是一种可能的线程执行时序：</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="java内存模型中final的语义_files/Image [1].png" type="image/png" data-filename="Image.png" style="border: 0px; margin: 0px 10px 10px 0px; padding: 0px;"/></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在上图中，1是对final域的写入，2是对这个final域引用的对象的成员域的写入，3是把被构造的对象的引用赋值给某个引用变量。这里除了前面提到的1不能和3重排序外，2和3也不能重排序。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">JMM可以确保读线程C至少能看到写线程A在构造函数中对final引用对象的成员域的写入。即C至少能看到数组下标0的值为1。而写线程B对数组元素的写入，读线程C可能看的到，也可能看不到。JMM不保证线程B的写入对读线程C可见，因为写线程B和读线程C之间存在数据竞争，此时的执行结果不可预知。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">如果想要确保读线程C看到写线程B对数组元素的写入，写线程B和读线程C之间需要使用同步原语（lock或volatile）来确保内存可见性。</span></div><h2 style="margin: 0px 0px 10px; padding: 0px; font-size: 20px; border: 0px; float: none; text-align: left; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 20px; border: 0px; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">为什么final引用不能从构造函数内“逸出”</span></h2><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">前面我们提到过，写final域的重排序规则可以确保：在引用变量为任意线程可见之前，该引用变量指向的对象的final域已经在构造函数中被正确初始化过了。其实要得到这个效果，还需要一个保证：在构造函数内部，不能让这个被构造对象的引用为其他线程可见，也就是对象引用不能在构造函数中“逸出”。为了说明问题，让我们来看下面示例代码：</span></div><div style="margin: 10px 0px; padding: 10px 10px 10px 5px; border: 1px solid rgb(232, 232, 232); font-family: Consolas, Monaco, &quot;Andale Mono&quot;, monospace; background-color: rgb(245, 242, 240); color: rgb(49, 78, 100); line-height: 21px; width: 597.797px; overflow: auto; text-align: left; clear: none; font-size: 14px; background-position: -29px 0px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none !important;"><div>public class FinalReferenceEscapeExample {</div><div>final int i;</div><div>static FinalReferenceEscapeExample obj;</div><div><br/></div><div>public FinalReferenceEscapeExample () {</div><div>i = 1; //1写final域</div><div>obj = this; //2 this引用在此“逸出”</div><div>}</div><div><br/></div><div>public static void writer() {</div><div>new FinalReferenceEscapeExample ();</div><div>}</div><div><br/></div><div>public static void reader {</div><div>if (obj != null) { //3</div><div>int temp = obj.i; //4</div><div>}</div><div>}</div><div>}</div></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">假设一个线程A执行writer()方法，另一个线程B执行reader()方法。这里的操作2使得对象还未完成构造前就为线程B可见。即使这里的操作2是构造函数的最后一步，且即使在程序中操作2排在操作1后面，执行read()方法的线程仍然可能无法看到final域被初始化后的值，因为这里的操作1和操作2之间可能被重排序。实际的执行时序可能如下图所示：</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><img src="java内存模型中final的语义_files/Image [2].png" type="image/png" data-filename="Image.png" style="border: 0px; margin: 0px 10px 10px 0px; padding: 0px;"/></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">从上图我们可以看出：在构造函数返回前，被构造对象的引用不能为其他线程可见，因为此时的final域可能还没有被初始化。在构造函数返回后，任意线程都将保证能看到final域正确初始化之后的值。</span></div><h2 style="margin: 0px 0px 10px; padding: 0px; font-size: 20px; border: 0px; float: none; text-align: left; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 20px; border: 0px; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">final语义在处理器中的实现</span></h2><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">现在我们以x86处理器为例，说明final语义在处理器中的具体实现。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">上面我们提到，写final域的重排序规则会要求译编器在final域的写之后，构造函数return之前，插入一个StoreStore障屏。读final域的重排序规则要求编译器在读final域的操作前面插入一个LoadLoad屏障。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">由于x86处理器不会对写-写操作做重排序，所以在x86处理器中，写final域需要的StoreStore障屏会被省略掉。同样，由于x86处理器不会对存在间接依赖关系的操作做重排序，所以在x86处理器中，读final域需要的LoadLoad屏障也会被省略掉。也就是说在x86处理器中，final域的读/写不会插入任何内存屏障！</span></div><h2 style="margin: 0px 0px 10px; padding: 0px; font-size: 20px; border: 0px; float: none; text-align: left; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 20px; border: 0px; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">JSR-133为什么要增强final的语义</span></h2><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">在旧的Java内存模型中 ，最严重的一个缺陷就是线程可能看到final域的值会改变。比如，一个线程当前看到一个整形final域的值为0（还未初始化之前的默认值），过一段时间之后这个线程再去读这个final域的值时，却发现值变为了1（被某个线程初始化之后的值）。最常见的例子就是在旧的Java内存模型中，String的值可能会改变（参考文献2中有一个具体的例子，感兴趣的读者可以自行参考，这里就不赘述了）。</span></div><div style="margin: 0px 0px 15px; padding: 0px; border: 0px; float: none; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(0, 0, 0); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">为了修补这个漏洞，JSR-133专家组增强了final的语义。通过为final域增加写和读重排序规则，可以为java程序员提供初始化安全保证：只要对象是正确构造的（被构造对象的引用在构造函数中没有“逸出”），那么不需要使用同步（指lock和volatile的使用），就可以保证任意线程都能看到这个final域在构造函数中被初始化之后的值。</span></div><h2 style="margin: 0px 0px 10px; padding: 0px; font-size: 20px; border: 0px; float: none; text-align: left; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="font-size: 20px; border: 0px; clear: none; width: 610px; color: rgb(34, 34, 34); line-height: 24px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">参考文献</span></h2><ol style="margin: 10px 0px 10px 10px; padding: 0px 0px 0px 20px; border: 0px; width: 549px; list-style-type: decimal; clear: left; color: rgb(0, 0, 0); font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;"><a href="http://www.amazon.com/Java-Concurrency-Practice-Brian-Goetz/dp/0321349601/ref=pd_sim_b_1" style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(40, 106, 178); clear: none; width: 539px; outline: none !important;"> Java Concurrency in Practice</a></li><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;"><a href="http://www.cs.umd.edu/users/pugh/java/memoryModel/jsr-133-faq.html" style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(40, 106, 178); clear: none; width: 539px; outline: none !important;"> JSR 133 (Java Memory Model) FAQ</a></li><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;"><a href="http://www.amazon.com/Java-Concurrency-Practice-Brian-Goetz/dp/0321349601/ref=pd_sim_b_1" style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(40, 106, 178); clear: none; width: 539px; outline: none !important;"> Java Concurrency in Practice</a></li><li style="margin: 4px 0px; padding: 0px 0px 0px 10px; border: none; float: none; clear: none; text-align: left;"><a href="http://gee.cs.oswego.edu/dl/jmm/cookbook.html" style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(40, 106, 178); clear: none; width: 539px; outline: none !important;"> The JSR-133 Cookbook for Compiler Writers</a></li></ol><div><a href="http://download.intel.com/products/processor/manual/253668.pdf" style="border: 0px; font-size: 14px; line-height: 1.8; color: rgb(40, 106, 178); clear: none; width: 610px; font-family: Helvetica, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, STHeiti, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; outline: none !important;">Intel® 64 and IA-32 ArchitecturesvSoftware Developer’s Manual Volume 3A: System Programming Guide, Part 1</a></div></div></span>
</div></body></html> 