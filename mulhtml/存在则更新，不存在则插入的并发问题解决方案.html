<html>
<head>
  <title>存在则更新，不存在则插入的并发问题解决方案</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1489"/>
<h1>存在则更新，不存在则插入的并发问题解决方案</h1>

<div>
<span><div><div><font style="font-size: 18pt;"><span style="color: rgb(26, 144, 185); font-size: 18pt; font-weight: bold;">问题分析</span></font></div><div><span style="font-size: 16px;">存在则更新，不存在则插入的并发问题在于不使用一定的策略，当多个线程同时查询到数据不存在，然后插入数据就会造成数据重复。因为是插入数据，所以无法使用行锁，故前三个隔离级别的事务都无法解决问题。</span></div><div><span style="font-size: 16px;">这个的问题的解决可以在设计层面、应用层面、数据库层面进行解决，总结出以下几种解决方案</span></div><div><font style="font-size: 18pt;"><span style="color: rgb(26, 144, 185); font-size: 18pt; font-weight: bold;">解决方案</span></font></div><div><span style="font-size: 16px;">一.设计层面</span></div><div><span style="font-size: 16px;">  1.<span style="font-size: 12pt;"> 不使用自增或者UUID作为主键，显示指定主键<span style="font-size: 12pt; font-family: &quot;Pingfang SC&quot;;">，如果一个字段不行，那就两个字段建立主键。</span></span></span></div><div><span style="font-size: 16px;"><span style="font-size: 12pt;"><span style="font-size: 12pt; font-family: &quot;Pingfang SC&quot;;">      这样就可以直接利用主键约束，重复插入直接失败，然后就可以更新。强烈推荐！</span></span></span></div><div><br/></div><div><span style="font-size: 16px;">二.数据库层面</span></div><div><span style="font-size: 16px;">  1.串行化隔离级别</span></div><div><span style="font-size: 16px;">     在数据库层面直接串行化各个事务，串行化事务是表锁，会严重损害并行性，因此不推荐使用。</span></div><div><span style="font-size: 16px;">  2.与设计层面的那个解决方案是一样的，当应用可以指定主键时，使用如下几种语法（MySQL）</span></div><div><span style="font-size: 16px;">   </span> <span style="font-size: 12pt;"> </span><span style="font-size: 12pt;"> </span><span style="font-size: 12pt; background-color: rgb(249, 242, 244); letter-spacing: -0.003rem; color: rgb(199, 37, 78); font-family: &quot;Roboto Mono&quot;; font-weight: bold;">INSERT ... ON DUPLICATE KEY UPDATE</span> <span style="font-size: 12pt; background-color: rgb(249, 242, 244); letter-spacing: -0.003rem; font-family: &quot;Roboto Mono&quot;; font-weight: bold;">: 插入时如果检测到主键重复则更新，直接一条sql搞定，强烈推荐</span></div><div><font style="font-size: 12pt;"><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); font-size: 12pt; color: rgb(199, 37, 78); font-family: &quot;Roboto Mono&quot;; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">      INSERT ... INTO ... WHERE NOT EXISTS (...)</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); font-size: 12pt; font-family: &quot;Roboto Mono&quot;; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">：</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); font-size: 12pt; font-family: &quot;Roboto Mono&quot;; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">插入时再判短一次重复</span></font></div><div><font style="font-size: 12pt;"><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); font-size: 12pt; color: rgb(199, 37, 78); font-family: &quot;Roboto Mono&quot;; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">      INSERT IGNORE</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); font-size: 12pt; font-family: &quot;Roboto Mono&quot;; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">：</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); font-size: 12pt; font-family: &quot;Roboto Mono&quot;; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">插入时如果检测到主键重复则忽略</span></font></div><div><span style="font-size: 12pt; background-color: rgb(249, 242, 244); letter-spacing: -0.003rem; color: rgb(199, 37, 78); font-family: &quot;Roboto Mono&quot;; font-weight: bold;">      REPLACE</span><span style="font-size: 12pt; background-color: rgb(249, 242, 244); letter-spacing: -0.003rem; font-family: &quot;Roboto Mono&quot;; font-weight: bold;">：<span style="font-size: 12pt; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(249, 242, 244); font-family: &quot;Roboto Mono&quot;; font-weight: bold; font-variant-caps: normal; font-variant-ligatures: normal;">插入时如果检测到主键重复则替换，这个可能还是有问题，因为可能丢失更新，看怎么处理哇</span></span></div><div><span style="font-size: 16px;">  3.存储过程</span></div><div><span style="font-size: 16px;">     将整个存在则更新，不存在则插入逻辑依靠存储过程实现（中间加锁），简单方便。</span></div><div><br/></div><div><span style="font-size: 16px;">三.应用层面</span></div><div><span style="font-size: 12pt;">   1.使用分布式锁</span></div><div><span style="font-size: 12pt;">      分布式锁包括可以依赖于数据库实现、中心缓存实现和分布式锁框架实现（zookeeper）</span></div><div><span style="font-size: 12pt;">   3.消息队列</span></div><div><span style="font-size: 12pt;">     实时要求不高的可以直接将处理请求加入消息队列，后续串行处理。</span></div><div><span style="font-size: 12pt;">   4.临时缓存</span></div><div><span style="font-size: 12pt;">     在应用当中先本地处理（或者缓存处理），这个处理过程当中保证安全，过段时间后进行数据库更新，不适合分布式应用。</span></div><div><font color="#1A90B9" style="font-size: 18pt;"><span style="color: rgb(26, 144, 185); font-size: 18pt; font-weight: bold;">参考文章</span></font></div><div><span style="color: rgb(70, 70, 70); font-size: 12pt;">1.</span> <span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(70, 70, 70); font-size: 12pt; font-family: &quot;Pingfang SC&quot;, STHeiti, &quot;Lantinghei SC&quot;, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">查询记录是否存在，不存在即插入，存在即更新：<a href="https://my.oschina.net/xuguangwu/blog/839611" style="font-size: 12pt; font-family: &quot;Pingfang SC&quot;; font-variant-caps: normal; font-variant-ligatures: normal; color: rgb(70, 70, 70);">https://my.oschina.net/xuguangwu/blog/839611</a></span></div><div><span style="color: rgb(70, 70, 70); font-size: 12pt;">2.</span><a href="http://lobert.iteye.com/blog/1604122" style="font-size: 12pt; color: rgb(70, 70, 70); font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 1.5em;">ON DUPLICATE KEY UPDATE重复插入时更新</a><span style="font-size: 12pt; color: rgb(70, 70, 70); font-family: Helvetica, Tahoma, Arial, sans-serif;">：</span><a href="http://lobert.iteye.com/blog/1604122" style="font-size: 12pt; color: rgb(70, 70, 70); font-family: Helvetica;">http://lobert.iteye.com/blog/1604122</a></div><div><span style="color: rgb(70, 70, 70); font-size: 12pt;">3.</span><span style="letter-spacing: -1px; text-align: right; color: rgb(70, 70, 70); font-size: 12pt; font-family: &quot;Roboto Slab&quot;, &quot;Times New Roman&quot;, Times, serif;">How to INSERT If Row Does Not Exist (UPSERT) in MySQL：<a href="https://chartio.com/resources/tutorials/how-to-insert-if-row-does-not-exist-upsert-in-mysql/" style="font-size: 12pt; font-family: &quot;Roboto Slab&quot;; color: rgb(70, 70, 70);">https://chartio.com/resources/tutorials/how-to-insert-if-row-does-not-exist-upsert-in-mysql/</a></span></div><h6 style="box-sizing: border-box; margin: 1rem 0px 0px; font-size: 0.8em; padding: 0px; text-transform: uppercase; letter-spacing: normal; orphans: 2; text-align: right; text-indent: 0px; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></h6><div><br/></div></div><div><br/></div></span>
</div></body></html> 