<html>
<head>
  <title>spring之AOP原理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1764"/>
<h1>spring之AOP原理</h1>

<div>
<span><div><font style="font-size: 18pt;"><span style="color: rgb(20, 113, 145); font-size: 18pt; font-weight: bold;">老生常谈的东西</span></font></div><div><span style="font-size: 12pt;">spring的aop有两种实现(都是动态代理，没有静态代理):</span></div><div><span style="font-size: 12pt;">一种是基于jdk动态代理：在被代理对象所属的类实现了接口的情况下使用，高优先级，代理对象是一个实现了接口的对象，和被代理对象是组合关系。</span></div><div><span style="font-size: 16px;">一种是基于CGLIG的代理：在被代理对象所属的类没有实现接口的情况下使用，低优先级，代理对象是被代理对象的子类。</span></div><div><font style="font-size: 18pt;"><span style="color: rgb(20, 113, 145); font-size: 18pt; font-weight: bold;">原文</span></font></div><div><span style="font-size: 12pt;">地址：</span></div><div><span style="font-size: 12pt;">【Spring源码分析】AOP源码解析（上篇）</span><span style="font-size: 12pt;"> </span><a href="http://www.cnblogs.com/xrq730/p/6753160.html" style="font-size: 12pt;">http://www.cnblogs.com/xrq730/p/6753160.html</a></div><div><span style="font-size: 12pt;">【Spring源码分析】AOP源码解析（下篇）：</span><span style="font-size: 12pt;">  </span><a href="http://www.cnblogs.com/xrq730/p/6757608.html" style="font-size: 12pt;">http://www.cnblogs.com/xrq730/p/6757608.html</a></div><div><br/></div><div><h1 style="margin: 0px; padding: 0px 0px 0px 5px; font-size: 18.2px; border-bottom: 1px solid rgb(153, 153, 153); float: left; width: 1263px; clear: both; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a href="http://www.cnblogs.com/xrq730/p/6753160.html" style="font-size: 18.2px; border-bottom: 1px solid rgb(153, 153, 153); width: 1263px; clear: both; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-family: Verdana, Arial, Helvetica, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 2em; color: rgb(51, 153, 0);">【Spring源码分析】AOP源码解析（上篇）</a></h1></div><div style="margin: 0px; padding: 0px; clear: both; color: rgb(0, 0, 0); font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"></div><div style="margin: 0px 0px 20px; padding: 0px; word-break: break-word;"><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">前言</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">前面写了六篇文章详细地分析了Spring Bean加载流程，这部分完了之后就要进入一个比较困难的部分了，就是AOP的实现原理分析。为了探究AOP实现原理，首先定义几个类，一个Dao接口：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">interface</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Dao {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">select();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">insert();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">Dao接口的实现类DaoImpl：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">DaoImpl</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">implements</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Dao {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">@Override</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">select() {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">System.out.println(&quot;Enter DaoImpl.select()&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">@Override</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">insert() {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">System.out.println(&quot;Enter DaoImpl.insert()&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">定义一个TimeHandler，用于方法调用前后打印时间，在AOP中，这扮演的是横切关注点的角色：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">TimeHandler {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">printTime() {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">System.out.println(&quot;CurrentTime:&quot; +</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">System.currentTimeMillis());</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; line-height: 15.6px;">定义一个XML文件aop.xml：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;?</span><span style="font-size: 12px !important; color: rgb(255, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">?&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beans</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">xmlns</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">=&quot;</span><a href="http://www.springframework.org/schema/beans" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.springframework.org/schema/beans</a><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">xmlns:xsi</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">=&quot;</span><a href="http://www.w3.org/2001/XMLSchema-instance" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.w3.org/2001/XMLSchema-instance</a><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">xmlns:aop</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">=&quot;</span><a href="http://www.springframework.org/schema/aop" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.springframework.org/schema/aop</a><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">xmlns:tx</span><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">=&quot;</span><a href="http://www.springframework.org/schema/tx" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.springframework.org/schema/tx</a><span style="color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">xsi:schemaLocation</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;<a href="http://www.springframework.org/schema/beans" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.springframework.org/schema/beans</a></span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important;"><a href="http://www.springframework.org/schema/beans/spring-beans-3.0.xsd" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</a></span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important;"><a href="http://www.springframework.org/schema/aop" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.springframework.org/schema/aop</a></span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;"><a href="http://www.springframework.org/schema/aop/spring-aop-3.0.xsd" style="font-family: &quot;Courier New&quot;; font-size: 12px; line-height: 1.5;">http://www.springframework.org/schema/aop/spring-aop-3.0.xsd</a>&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">id</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;daoImpl&quot;</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;org.xrq.action.aop.DaoImpl&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">/&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">id</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;timeHandler&quot;</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;org.xrq.action.aop.TimeHandler&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">/&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aop:config</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">proxy-target-class</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;true&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aop:aspect</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">id</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;time&quot;</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">ref</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;timeHandler&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aop:pointcut</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">id</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;addAllMethod&quot;</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">expression</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;execution(* org.xrq.action.aop.Dao.*(..))&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">/&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aop:before</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">method</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;printTime&quot;</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pointcut-ref</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;addAllMethod&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">/&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aop:after</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">method</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;printTime&quot;</span> <span style="font-size: 12px !important; color: rgb(255, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pointcut-ref</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">=&quot;addAllMethod&quot;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">/&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;/</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aop:aspect</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&gt;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;/</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aop:config</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&gt;</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&lt;/</span><span style="font-size: 12px !important; color: rgb(128, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beans</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">&gt;</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; line-height: 1.5;">写一段测试代码TestAop.java：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">TestAop {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">@Test</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">testAop() {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">ApplicationContext ac =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">ClassPathXmlApplicationContext(&quot;spring/aop.xml&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Dao dao = (Dao)ac.getBean(&quot;daoImpl&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">dao.select();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">代码运行结果就不看了，有了以上的内容，我们就可以根据这些跟一下代码，看看Spring到底是如何实现AOP的。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">AOP实现原理----找到Spring处理AOP的源头</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">有很多朋友不愿意去看AOP源码的一个很大原因是因为找不到AOP源码实现的入口在哪里，这个确实是。不过我们可以看一下上面的测试代码，就普通Bean也好、AOP也好，最终都是通过getBean方法获取到Bean并调用方法的，getBean之后的对象已经前后都打印了TimeHandler类printTime()方法里面的内容，可以想见它们已经是被Spring容器处理过了。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">既然如此，那无非就两个地方处理：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">加载Bean定义的时候应该有过特殊的处理</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">getBean的时候应该有过特殊的处理</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">因此，本文围绕【</span><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">1.加载Bean定义的时候应该有过特殊的处理</span><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">】展开，先找一下到底是哪里Spring对AOP做了特殊的处理。代码直接定位到DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(delegate.isDefaultNamespace(root)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">NodeList nl =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">root.getChildNodes();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">int</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">i = 0; i &lt; nl.getLength(); i++</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Node node =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">nl.item(i);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(node</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Element) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Element ele =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Element) node;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(delegate.isDefaultNamespace(ele)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parseDefaultElement(ele, delegate);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">delegate.parseCustomElement(ele);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">delegate.parseCustomElement(root);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">正常来说，遇到&lt;bean id=&quot;daoImpl&quot;...&gt;、&lt;bean id=&quot;timeHandler&quot;...&gt;这两个标签的时候，都会执行第9行的代码，因为&lt;bean&gt;标签是默认的Namespace。但是在遇到后面的&lt;aop:config&gt;标签的时候就不一样了，&lt;aop:config&gt;并不是默认的Namespace，因此会执行第12行的代码，看一下：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">BeanDefinition parseCustomElement(Element ele, BeanDefinition containingBd) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String namespaceUri =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">getNamespaceURI(ele);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">NamespaceHandler handler =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(handler ==</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">error(&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot; + namespaceUri + &quot;]&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">, ele);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">handler.parse(ele,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">ParserContext(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">.readerContext,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">, containingBd));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">因为之前把整个XML解析为了org.w3c.dom.Document，org.w3c.dom.Document以树的形式表示整个XML，具体到每一个节点就是一个Node。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">首先第2行从&lt;aop:config&gt;这个Node（参数Element是Node接口的子接口）中拿到Namespace=&quot;</span><span style="text-indent: 0px; font-size: 13px;"><a href="http://www.springframework.org/schema/aop" style="font-size: 13px; font-weight: bold;">http://www.springframework.org/schema/aop</a></span><span style="text-indent: 0px; font-size: 13px;">&quot;，第3行的代码根据这个Namespace获取对应的NamespaceHandler即Namespace处理器，具体到aop这个Namespace的NamespaceHandler是</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-weight: bold;">org.springframework.aop.config.AopNamespaceHandler</span><span style="text-indent: 0px; font-size: 13px;">类，也就是第3行代码获取到的结果。具体到AopNamespaceHandler里面，有几个Parser，是用于具体标签转换的，分别为：</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px;">config--&gt;ConfigBeanDefinitionParser</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px;">aspectj-autoproxy--&gt;AspectJAutoProxyBeanDefinitionParser</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px;">scoped-proxy--&gt;ScopedProxyBeanDefinitionDecorator</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px;">spring-configured--&gt;SpringConfiguredBeanDefinitionParser</span></li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">接着，就是第8行的代码，利用AopNamespaceHandler的parse方法，解析&lt;aop:config&gt;下的内容了。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">AOP Bean定义加载----根据织入方式将&lt;aop:before&gt;、&lt;aop:after&gt;转换成名为adviceDef的RootBeanDefinition</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">上面经过分析，已经找到了Spring是通过AopNamespaceHandler处理的AOP，那么接着进入AopNamespaceHandler的parse方法源代码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">BeanDefinition parse(Element element, ParserContext parserContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">findParserForElement(element, parserContext).parse(element, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">首先获取具体的Parser，因为当前节点是&lt;aop:config&gt;，上一部分最后有列，config是通过ConfigBeanDefinitionParser来处理的，因此findParserForElement(element, parserContext)这一部分代码获取到的是ConfigBeanDefinitionParser，接着看ConfigBeanDefinitionParser的parse方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">BeanDefinition parse(Element element, ParserContext parserContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">CompositeComponentDefinition compositeDef =</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.pushContainingComponent(compositeDef);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">configureAutoProxyCreator(parserContext, element);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Element&gt; childElts =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">DomUtils.getChildElements(element);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Element elt: childElts) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String localName =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getDelegate().getLocalName(elt);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(POINTCUT.equals(localName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parsePointcut(elt, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(ADVISOR.equals(localName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parseAdvisor(elt, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(ASPECT.equals(localName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parseAspect(elt, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.popAndRegisterContainingComponent();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">重点先提一下第6行的代码，该行代码的具体实现不跟了但它非常重要，configureAutoProxyCreator方法的作用我用几句话说一下：</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">向Spring容器注册了一个BeanName为</span><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">org.springframework.aop.config.internalAutoProxyCreator</span><span style="font-size: 13px; font-family: 宋体;">的Bean定义，可以自定义也可以使用Spring提供的（根据优先级来）</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">Spring默认提供的是</span><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator</span><span style="font-size: 13px; font-family: 宋体;">，这个类是AOP的核心类，留在下篇讲解</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">在这个方法里面也会根据配置proxy-target-class和expose-proxy，设置是否使用CGLIB进行代理以及是否暴露最终的代理。</span></li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">&lt;aop:config&gt;下的节点为&lt;aop:aspect&gt;，想见必然是执行第18行的代码parseAspect，跟进去：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">private</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parseAspect(Element aspectElement, ParserContext parserContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String aspectId =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aspectElement.getAttribute(ID);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String aspectName =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aspectElement.getAttribute(REF);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">try</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">.parseState.push(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AspectEntry(aspectId, aspectName));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;BeanDefinition&gt; beanDefinitions =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">ArrayList&lt;BeanDefinition&gt;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;BeanReference&gt; beanReferences =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">ArrayList&lt;BeanReference&gt;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Element&gt; declareParents =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">DomUtils.getChildElementsByTagName(aspectElement, DECLARE_PARENTS);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">int</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">i = METHOD_INDEX; i &lt; declareParents.size(); i++</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Element declareParentsElement =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">declareParents.get(i);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanDefinitions.add(parseDeclareParents(declareParentsElement, parserContext));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">We have to parse &quot;advice&quot; and all the advice kinds in one loop, to get the</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">ordering semantics right.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">NodeList nodeList =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aspectElement.getChildNodes();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">adviceFoundAlready =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">false</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">int</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">i = 0; i &lt; nodeList.getLength(); i++</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Node node =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">nodeList.item(i);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(isAdviceNode(node, parserContext)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceFoundAlready) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">adviceFoundAlready =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">StringUtils.hasText(aspectName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">26</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getReaderContext().error(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">27</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">&quot;&lt;aspect&gt; tag needs aspect bean reference via 'ref' attribute when declaring advices.&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">,</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">28</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">aspectElement,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.parseState.snapshot());</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">29</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">30</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">31</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">beanReferences.add(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">RuntimeBeanReference(aspectName));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">32</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">33</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AbstractBeanDefinition advisorDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parseAdvice(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">34</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aspectName, i, aspectElement, (Element) node, parserContext, beanDefinitions, beanReferences);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">35</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanDefinitions.add(advisorDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">36</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">37</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">38</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">39</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AspectComponentDefinition aspectComponentDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">createAspectComponentDefinition(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">40</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aspectElement, aspectId, beanDefinitions, beanReferences, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">41</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.pushContainingComponent(aspectComponentDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">42</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">43</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Element&gt; pointcuts =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">DomUtils.getChildElementsByTagName(aspectElement, POINTCUT);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">44</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Element pointcutElement : pointcuts) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">45</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parsePointcut(pointcutElement, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">46</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">47</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">48</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.popAndRegisterContainingComponent();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">49</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">50</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">finally</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">51</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.parseState.pop();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">52</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">53</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">从第20行~第37行的循环开始关注这个方法。这个for循环有一个关键的判断就是第22行的ifAdviceNode判断，看下ifAdviceNode方法做了什么：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">private</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">isAdviceNode(Node aNode, ParserContext parserContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!(aNode</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Element)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">false</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String name =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getDelegate().getLocalName(aNode);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(BEFORE.equals(name) || AFTER.equals(name) || AFTER_RETURNING_ELEMENT.equals(name) ||</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AFTER_THROWING_ELEMENT.equals(name) ||</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AROUND.equals(name));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold; line-height: 1.5;">即这个for循环只用来处理&lt;aop:aspect&gt;标签下的</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-weight: bold;">&lt;aop:before&gt;、&lt;aop:after&gt;、&lt;aop:after-returning&gt;、&lt;aop:after-throwing method=&quot;&quot;&gt;、&lt;aop:around method=&quot;&quot;&gt;这五个标签的。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">接着，如果是上述五种标签之一，那么进入第33行~第34行的parseAdvice方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">private</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AbstractBeanDefinition parseAdvice(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String aspectName,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">int</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">order, Element aspectElement, Element adviceElement, ParserContext parserContext,</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanReferences) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">try</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">.parseState.push(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AdviceEntry(parserContext.getDelegate().getLocalName(adviceElement)));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">create the method factory bean</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition methodDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition(MethodLocatingFactoryBean.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">methodDefinition.getPropertyValues().add(&quot;targetBeanName&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">, aspectName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">methodDefinition.getPropertyValues().add(&quot;methodName&quot;, adviceElement.getAttribute(&quot;method&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">methodDefinition.setSynthetic(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">create instance factory definition</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition aspectFactoryDef =</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition(SimpleBeanFactoryAwareAspectInstanceFactory.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">aspectFactoryDef.getPropertyValues().add(&quot;aspectBeanName&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">, aspectName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">aspectFactoryDef.setSynthetic(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">register the pointcut</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AbstractBeanDefinition adviceDef =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">createAdviceDefinition(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceElement, parserContext, aspectName, order, methodDefinition, aspectFactoryDef,</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanDefinitions, beanReferences);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">configure the advisor</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">26</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition advisorDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition(AspectJPointcutAdvisor.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">27</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">advisorDefinition.setSource(parserContext.extractSource(adviceElement));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">28</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">advisorDefinition.getConstructorArgumentValues().addGenericArgumentValue(adviceDef);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">29</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(aspectElement.hasAttribute(ORDER_PROPERTY)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">30</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">advisorDefinition.getPropertyValues().add(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">31</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">ORDER_PROPERTY, aspectElement.getAttribute(ORDER_PROPERTY));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">32</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">33</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">34</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">register the final advisor</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">35</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getReaderContext().registerWithGeneratedName(advisorDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">36</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">37</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">advisorDefinition;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">38</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">39</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">finally</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">40</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.parseState.pop();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">41</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">42</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">方法主要做了三件事：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px;">根据织入方式（before、after这些）创建RootBeanDefinition，名为adviceDef即advice定义</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px;">将上一步创建的RootBeanDefinition写入一个新的RootBeanDefinition，构造一个新的对象，名为advisorDefinition，即advisor定义</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px;">将advisorDefinition注册到DefaultListableBeanFactory中</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">下面来看做的第一件事createAdviceDefinition方法定义：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">private</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AbstractBeanDefinition createAdviceDefinition(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Element adviceElement, ParserContext parserContext, String aspectName,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">int</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">order,</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">RootBeanDefinition methodDef, RootBeanDefinition aspectFactoryDef,</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanReferences) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition adviceDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">RootBeanDefinition(getAdviceClass(adviceElement, parserContext));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition.setSource(parserContext.extractSource(adviceElement));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition.getPropertyValues().add(ASPECT_NAME_PROPERTY, aspectName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition.getPropertyValues().add(DECLARATION_ORDER_PROPERTY, order);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(adviceElement.hasAttribute(RETURNING)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition.getPropertyValues().add(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">RETURNING_PROPERTY, adviceElement.getAttribute(RETURNING));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(adviceElement.hasAttribute(THROWING)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition.getPropertyValues().add(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">THROWING_PROPERTY, adviceElement.getAttribute(THROWING));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(adviceElement.hasAttribute(ARG_NAMES)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition.getPropertyValues().add(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">ARG_NAMES_PROPERTY, adviceElement.getAttribute(ARG_NAMES));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">ConstructorArgumentValues cav =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition.getConstructorArgumentValues();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">cav.addIndexedArgumentValue(METHOD_INDEX, methodDef);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">26</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">27</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object pointcut =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parsePointcutProperty(adviceElement, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">28</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(pointcut</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">BeanDefinition) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">29</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcut);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">30</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanDefinitions.add((BeanDefinition) pointcut);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">31</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">32</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(pointcut</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">String) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">33</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RuntimeBeanReference pointcutRef =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">RuntimeBeanReference((String) pointcut);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">34</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcutRef);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">35</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanReferences.add(pointcutRef);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">36</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">37</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">38</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">cav.addIndexedArgumentValue(ASPECT_INSTANCE_FACTORY_INDEX, aspectFactoryDef);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">39</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">40</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">adviceDefinition;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">41</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体; line-height: 15.6px;">首先可以看到，创建的AbstractBeanDefinition实例是RootBeanDefinition，这和普通Bean创建的实例为GenericBeanDefinition不同。然后进入第6行的getAdviceClass方法看一下：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">private</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Class getAdviceClass(Element adviceElement, ParserContext parserContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String elementName =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getDelegate().getLocalName(adviceElement);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(BEFORE.equals(elementName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AspectJMethodBeforeAdvice.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(AFTER.equals(elementName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AspectJAfterAdvice.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(AFTER_RETURNING_ELEMENT.equals(elementName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AspectJAfterReturningAdvice.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(AFTER_THROWING_ELEMENT.equals(elementName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AspectJAfterThrowingAdvice.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(AROUND.equals(elementName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AspectJAroundAdvice.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throw</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">IllegalArgumentException(&quot;Unknown advice kind [&quot; + elementName + &quot;].&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">既然创建Bean定义，必然该Bean定义中要对应一个具体的Class，不同的切入方式对应不同的Class：</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">before对应AspectJMethodBeforeAdvice</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">After对应AspectJAfterAdvice</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">after-returning对应AspectJAfterReturningAdvice</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">after-throwing对应AspectJAfterThrowingAdvice</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">around对应AspectJAroundAdvice</span></li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">createAdviceDefinition方法剩余逻辑没什么，就是判断一下标签里面的属性并设置一下相应的值而已，至此&lt;aop:before&gt;、&lt;aop:after&gt;两个标签对应的AbstractBeanDefinition就创建出来了。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">AOP Bean定义加载</span><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">----将名为adviceDef的RootBeanDefinition转换成名为advisorDefinition的RootBeanDefinition</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">下面我们看一下第二步的操作，将名为adviceDef的RootBeanD转换成名为advisorDefinition的RootBeanDefinition，跟一下上面一部分ConfigBeanDefinitionParser类parseAdvice方法的第26行~32行的代码：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition advisorDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition(AspectJPointcutAdvisor.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">a</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">dvisorDefinition.setSource(parserContext.extractSource(adviceElement));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">advisorDefinition.getConstructorArgumentValues().addGenericArgumentValue(adviceDef);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(aspectElement.hasAttribute(ORDER_PROPERTY)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">advisorDefinition.getPropertyValues().add(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">ORDER_PROPERTY, aspectElement.getAttribute(ORDER_PROPERTY));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">这里相当于将上一步生成的RootBeanDefinition包装了一下，new一个新的RootBeanDefinition出来，Class类型是org.springframework.aop.aspectj.AspectJPointcutAdvisor。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">第4行~第7行的代码是用于判断&lt;aop:aspect&gt;标签中有没有&quot;order&quot;属性的，有就设置一下，&quot;order&quot;属性是用来控制切入方法优先级的。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">AOP Bean定义加载</span><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">----将BeanDefinition注册到DefaultListableBeanFactory中</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">最后一步就是将BeanDefinition注册到DefaultListableBeanFactory中了，代码就是前面ConfigBeanDefinitionParser的parseAdvice方法的最后一部分了：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">...</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">register the final advisor</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getReaderContext().registerWithGeneratedName(advisorDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">...</span></div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">跟一下registerWithGeneratedName方法的实现：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">String registerWithGeneratedName(BeanDefinition beanDefinition) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String generatedName =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">generateBeanName(beanDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">getRegistry().registerBeanDefinition(generatedName, beanDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">generatedName;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第2行获取注册的名字BeanName，和&lt;bean&gt;的注册差不多，使用的是</span><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">Class全路径+&quot;#&quot;+全局计数器</span><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">的方式，其中的Class全路径为org.springframework.aop.aspectj.AspectJPointcutAdvisor，依次类推，每一个BeanName应当为org.springframework.aop.aspectj.AspectJPointcutAdvisor#0、org.springframework.aop.aspectj.AspectJPointcutAdvisor#1、org.springframework.aop.aspectj.AspectJPointcutAdvisor#2这样下去。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第3行向DefaultListableBeanFactory中注册，BeanName已经有了，剩下的就是Bean定义，Bean定义的解析流程之前已经看过了，就不说了。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">AOP Bean定义加载</span><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">----AopNamespaceHandler处理&lt;aop:pointcut&gt;流程</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">回到ConfigBeanDefinitionParser的parseAspect方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">private</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">void</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parseAspect(Element aspectElement, ParserContext parserContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">...</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AspectComponentDefinition aspectComponentDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">createAspectComponentDefinition(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">aspectElement, aspectId, beanDefinitions, beanReferences, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.pushContainingComponent(aspectComponentDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Element&gt; pointcuts =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">DomUtils.getChildElementsByTagName(aspectElement, POINTCUT);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Element pointcutElement : pointcuts) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parsePointcut(pointcutElement, parserContext);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.popAndRegisterContainingComponent();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">finally</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.parseState.pop();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; line-height: 1.5;">省略号部分表示是解析的是&lt;aop:before&gt;、&lt;aop:after&gt;这种标签，上部分已经说过了，就不说了，下面看一下解析&lt;aop:pointcut&gt;部分的源码。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体; line-height: 1.5;">第5行~第7行的代码构建了一个Aspect标签组件定义，并将Apsect标签组件定义推到ParseContext即解析工具上下文中，这部分代码不是关键。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体; line-height: 1.5;">第9行的代码拿到所有&lt;aop:aspect&gt;下的pointcut标签，进行遍历，由parsePointcut方法进行处理：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">private</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AbstractBeanDefinition parsePointcut(Element pointcutElement, ParserContext parserContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String id =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pointcutElement.getAttribute(ID);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String expression =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pointcutElement.getAttribute(EXPRESSION);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AbstractBeanDefinition pointcutDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">try</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">.parseState.push(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">PointcutEntry(id));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">pointcutDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">createPointcutDefinition(expression);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pointcutDefinition.setSource(parserContext.extractSource(pointcutElement));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String pointcutBeanName =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">id;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(StringUtils.hasText(pointcutBeanName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getRegistry().registerBeanDefinition(pointcutBeanName, pointcutDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">pointcutBeanName =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.getReaderContext().registerWithGeneratedName(pointcutDefinition);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">parserContext.registerComponent(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">PointcutComponentDefinition(pointcutBeanName, pointcutDefinition, expression));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">finally</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.parseState.pop();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">26</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">27</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pointcutDefinition;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">28</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第2行~第3行的代码获取&lt;aop:pointcut&gt;标签下的&quot;id&quot;属性与&quot;expression&quot;属性。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第8行的代码推送一个PointcutEntry，表示当前Spring上下文正在解析Pointcut标签。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第9行的代码创建Pointcut的Bean定义，之后再看，先把其他方法都看一下。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第10行的代码不管它，最终从NullSourceExtractor的extractSource方法获取Source，就是个null。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第12行~第18行的代码用于注册获取到的Bean定义，默认pointcutBeanName为&lt;aop:pointcut&gt;标签中定义的id属性：</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">如果&lt;aop:pointcut&gt;标签中配置了id属性就执行的是第13行~第15行的代码，pointcutBeanName=id</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">如果&lt;aop:pointcut&gt;标签中没有配置id属性就执行的是第16行~第18行的代码，和Bean不配置id属性一样的规则，pointcutBeanName=</span><span style="font-size: 13px; color: rgb(0, 0, 255); font-family: 宋体; font-weight: bold;">org.springframework.aop.aspectj.AspectJExpressionPointcut#序号（从0开始累加）</span></li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 0); font-family: 宋体;">第20行~第21行的代码向解析工具上下文中注册一个Pointcut组件定义</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 0); font-family: 宋体;">第23行~第25行的代码，finally块在&lt;aop:pointcut&gt;标签解析完毕后，让之前推送至栈顶的PointcutEntry出栈，表示此次&lt;aop:pointcut&gt;标签解析完毕。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 0); font-family: 宋体;">最后回头来一下第9行代码createPointcutDefinition的实现，比较简单：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AbstractBeanDefinition createPointcutDefinition(String expression) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition beanDefinition =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">RootBeanDefinition(AspectJExpressionPointcut.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanDefinition.setScope(BeanDefinition.SCOPE_PROTOTYPE);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">beanDefinition.setSynthetic(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanDefinition.getPropertyValues().add(EXPRESSION, expression);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanDefinition;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">关键就是注意一下两点：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">&lt;aop:pointcut&gt;标签对应解析出来的BeanDefinition是RootBeanDefinition，且RootBenaDefinitoin中的Class是</span><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">org.springframework.aop.aspectj.AspectJExpressionPointcut</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">&lt;aop:pointcut&gt;标签对应的Bean是prototype即原型的</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">这样一个流程下来，就解析了&lt;aop:pointcut&gt;标签中的内容并将之转换为RootBeanDefintion存储在Spring容器中。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div></div><div style="margin: 0px; padding: 0px;"><div><span style="font-weight: bold;">==================================================================================</span><span style="font-weight: bold;"> </span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">我不能保证写的每个地方都是对的，但是至少能保证不复制、不黏贴，保证每一句话、每一行代码都经过了认真的推敲、仔细的斟酌。每一篇文章的背后，希望都能看到自己对于技术、对于生活的态度。</span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">我相信乔布斯说的，只有那些疯狂到认为自己可以改变世界的人才能真正地改变世界。面对压力，我可以挑灯夜战、不眠不休；面对困难，我愿意迎难而上、永不退缩。</span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">其实我想说的是，我只是一个程序员，这就是我现在纯粹人生的全部。</span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">==================================================================================</span></div></div><div><br/></div><div><h1 style="margin: 0px; padding: 0px 0px 0px 5px; font-size: 18.2px; border-bottom: 1px solid rgb(153, 153, 153); float: left; width: 1263px; clear: both; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a href="http://www.cnblogs.com/xrq730/p/6757608.html" style="font-size: 18.2px; border-bottom: 1px solid rgb(153, 153, 153); width: 1263px; clear: both; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-family: Verdana, Arial, Helvetica, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 2em; color: rgb(255, 102, 0);">【Spring源码分析】AOP源码解析（下篇）</a></h1></div><div style="margin: 0px; padding: 0px; clear: both; color: rgb(0, 0, 0); font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"></div><div style="margin: 0px 0px 20px; padding: 0px; word-break: break-word;"><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">AspectJAwareAdvisorAutoProxyCreator及为Bean生成代理时机分析</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">上篇文章说了，org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator这个类是Spring提供给开发者的AOP的核心类，</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">就是AspectJAwareAdvisorAutoProxyCreator完成了【类/接口--&gt;代理】的转换过程</span><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">，首先我们看一下AspectJAwareAdvisorAutoProxyCreator的层次结构：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><img src="https://images2015.cnblogs.com/blog/801753/201704/801753-20170424165718865-1039245200.png" style="margin: 0px; padding: 0px; border: 0px; max-width: 900px;"></img></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">这里最值得注意的一点是最左下角的那个方框，我用几句话总结一下：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">AspectJAwareAdvisorAutoProxyCreator是BeanPostProcessor接口的实现类</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">postProcessBeforeInitialization方法与postProcessAfterInitialization方法实现在父类AbstractAutoProxyCreator</span><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">中</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">postProcessBeforeInitialization方法是一个空实现</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">逻辑代码在</span><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">postProcessAfterInitialization方法中</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 0); font-family: 宋体;">基于以上的分析，将Bean生成代理的时机已经一目了然了：</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">在每个Bean初始化之后，如果需要，调用AspectJAwareAdvisorAutoProxyCreator中的postProcessBeforeInitialization为Bean生成代理</span><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 0); font-family: 宋体;">。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold; line-height: 21.6px;">代理对象实例化----判断是否为&lt;bean&gt;生成代理</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体; line-height: 21.6px;">上文分析了Bean生成代理的时机是在每个Bean初始化之后，下面把代码定位到Bean初始化之后，先是AbstractAutowireCapableBeanFactory的initializeBean方法进行初始化：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object initializeBean(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">final</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">String beanName,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">final</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object bean, RootBeanDefinition mbd) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(System.getSecurityManager() !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AccessController.doPrivileged(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">PrivilegedAction&lt;Object&gt;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">() {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object run() {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">invokeAwareMethods(beanName, bean);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}, getAccessControlContext());</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">invokeAwareMethods(beanName, bean);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object wrappedBean =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(mbd ==</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">|| !</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">mbd.isSynthetic()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">wrappedBean =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">try</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">invokeInitMethods(beanName, wrappedBean, mbd);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">catch</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Throwable ex) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throw</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">BeanCreationException(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(mbd !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">? mbd.getResourceDescription() :</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">),</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">beanName, &quot;Invocation of init method failed&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">, ex);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">26</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">27</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">28</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(mbd ==</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">|| !</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">mbd.isSynthetic()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">29</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">wrappedBean =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">30</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">31</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">wrappedBean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">32</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">初始化之前是第16行的applyBeanPostProcessorsBeforeInitialization方法，初始化之后即29行的applyBeanPostProcessorsAfterInitialization方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throws</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">BeansException {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object result =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">existingBean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(BeanPostProcessor beanProcessor : getBeanPostProcessors()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">result =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanProcessor.postProcessAfterInitialization(result, beanName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(result ==</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">result;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">result;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; line-height: 1.5;">这里调用每个BeanPostProcessor的postProcessBeforeInitialization方法。按照之前的分析，看一下AbstractAutoProxyCreator的postProcessAfterInitialization方法实现：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object postProcessAfterInitialization(Object bean, String beanName)</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throws</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">BeansException {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(bean !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object cacheKey =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">getCacheKey(bean.getClass(), beanName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.earlyProxyReferences.contains(cacheKey)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">wrapIfNecessary(bean, beanName, cacheKey);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">跟一下第5行的方法wrapIfNecessary：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.targetSourcedBeans.contains(beanName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.nonAdvisedBeans.contains(cacheKey)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(isInfrastructureClass(bean.getClass()) ||</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">shouldSkip(bean.getClass(), beanName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.nonAdvisedBeans.add(cacheKey);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Create proxy if we have advice.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(specificInterceptors !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">DO_NOT_PROXY) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advisedBeans.add(cacheKey);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">SingletonTargetSource(bean));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.proxyTypes.put(cacheKey, proxy.getClass());</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">proxy;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.nonAdvisedBeans.add(cacheKey);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px;">第2行~第11行是一些不需要生成代理的场景判断，这里略过。</span><span style="text-indent: 0px; font-size: 13px;">首先我们要思考的第一个问题是：</span><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 255); font-weight: bold;">哪些目标对象需要生成代理</span><span style="text-indent: 0px; font-size: 13px; color: rgb(0, 0, 255); font-weight: bold;">？</span><span style="text-indent: 0px; font-size: 13px;">因为配置文件里面有很多Bean，肯定不能对每个Bean都生成代理，因此需要一套规则判断Bean是不是需要生成代理，这套规则就是第14行的代码getAdvicesAndAdvisorsForBean：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Advisor&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">findEligibleAdvisors(Class beanClass, String beanName) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Advisor&gt; candidateAdvisors =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">findCandidateAdvisors();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Advisor&gt; eligibleAdvisors =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">extendAdvisors(eligibleAdvisors);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">eligibleAdvisors.isEmpty()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">eligibleAdvisors =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">sortAdvisors(eligibleAdvisors);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">eligibleAdvisors;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">顾名思义，方法的意思是为指定class寻找合适的Advisor。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第2行代码，寻找候选Advisors，根据上文的配置文件，有两个候选Advisor，分别是&lt;aop:aspect&gt;节点下的&lt;aop:before&gt;和&lt;aop:after&gt;这两个，这两个在XML解析的时候已经被转换生成了RootBeanDefinition。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">跳过第3行的代码，先看下第4行的代码extendAdvisors方法，之后再重点看一下第3行的代码。第4行的代码extendAdvisors方法作用是</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">向候选Advisor链的开头（也就是List.get(0)的位置）添加一个org.springframework.aop.support.DefaultPointcutAdvisor</span><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第3行代码，根据候选Advisors，寻找可以使用的Advisor，跟一下方法实现：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">static</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">clazz) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(candidateAdvisors.isEmpty()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">candidateAdvisors;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Advisor&gt; eligibleAdvisors =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">LinkedList&lt;Advisor&gt;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Advisor candidate : candidateAdvisors) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(candidate</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">IntroductionAdvisor &amp;&amp;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">canApply(candidate, clazz)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">eligibleAdvisors.add(candidate);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">hasIntroductions = !</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">eligibleAdvisors.isEmpty();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Advisor candidate : candidateAdvisors) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(candidate</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">IntroductionAdvisor) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">already processed</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">continue</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(canApply(candidate, clazz, hasIntroductions)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">eligibleAdvisors.add(candidate);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">eligibleAdvisors;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">整个方法的主要判断都围绕canApply展开方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">static</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">canApply(Advisor advisor, Class&lt;?&gt; targetClass,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">hasIntroductions) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(advisor</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">IntroductionAdvisor) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(advisor</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">PointcutAdvisor) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">PointcutAdvisor pca =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(PointcutAdvisor) advisor;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">canApply(pca.getPointcut(), targetClass, hasIntroductions);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">It doesn't have a pointcut so we assume it applies.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第一个参数advisor的实际类型是AspectJPointcutAdvisor，它是PointcutAdvisor的子类，因此执行第7行的方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">static</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">canApply(Pointcut pc, Class&lt;?&gt; targetClass,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">hasIntroductions) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pc.getClassFilter().matches(targetClass)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">false</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">MethodMatcher methodMatcher =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">pc.getMethodMatcher();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">IntroductionAwareMethodMatcher introductionAwareMethodMatcher =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(methodMatcher</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">instanceof</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">IntroductionAwareMethodMatcher) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">introductionAwareMethodMatcher =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(IntroductionAwareMethodMatcher) methodMatcher;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Set&lt;Class&gt; classes =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">HashSet&lt;Class&gt;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(ClassUtils.getAllInterfacesForClassAsSet(targetClass));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">classes.add(targetClass);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(Class&lt;?&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">clazz : classes) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Method[] methods =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">clazz.getMethods();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Method method : methods) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">((introductionAwareMethodMatcher !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">&amp;&amp;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions)) ||</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">methodMatcher.matches(method, targetClass)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">false</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">这个方法其实就是拿当前Advisor对应的expression做了两层判断：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">目标类必须满足expression的匹配规则</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">目标类中的方法必须满足expression的匹配规则，当然这里方法不是全部需要满足expression的匹配规则，有一个方法满足即可</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">如果以上两条都满足，那么容器则会判断该&lt;bean&gt;满足条件，需要被生成代理对象，具体方式为返回一个数组对象，该数组对象中存储的是&lt;bean&gt;对应的Advisor。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">代理对象实例化----为&lt;bean&gt;生成代理代码上下文梳理</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">上文分析了为&lt;bean&gt;生成代理的条件，现在就正式看一下Spring上下文是如何为&lt;bean&gt;生成代理的。回到AbstractAutoProxyCreator的wrapIfNecessary方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.targetSourcedBeans.contains(beanName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.nonAdvisedBeans.contains(cacheKey)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(isInfrastructureClass(bean.getClass()) ||</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">shouldSkip(bean.getClass(), beanName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.nonAdvisedBeans.add(cacheKey);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Create proxy if we have advice.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(specificInterceptors !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">DO_NOT_PROXY) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advisedBeans.add(cacheKey);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">SingletonTargetSource(bean));</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.proxyTypes.put(cacheKey, proxy.getClass());</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">proxy;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.nonAdvisedBeans.add(cacheKey);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">bean;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第14行拿到&lt;bean&gt;对应的Advisor数组，第15行判断只要Advisor数组不为空，那么就会通过第17行的代码为&lt;bean&gt;创建代理：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object createProxy(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Class&lt;?&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">beanClass, String beanName, Object[] specificInterceptors, TargetSource targetSource) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">ProxyFactory proxyFactory =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">ProxyFactory();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Copy our properties (proxyTargetClass etc) inherited from ProxyConfig.</span> <span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">proxyFactory.copyFrom(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">shouldProxyTargetClass(beanClass, beanName)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Must allow for introductions; can't just set interfaces to</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">the target's interfaces only.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Class&lt;?&gt;[] targetInterfaces = ClassUtils.getAllInterfacesForClass(beanClass,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.proxyClassLoader);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(Class&lt;?&gt;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">targetInterface : targetInterfaces) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">proxyFactory.addInterface(targetInterface);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Advisor[] advisors =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">buildAdvisors(beanName, specificInterceptors);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">for</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(Advisor advisor : advisors) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">proxyFactory.addAdvisor(advisor);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">proxyFactory.setTargetSource(targetSource);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">customizeProxyFactory(proxyFactory);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">proxyFactory.setFrozen(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.freezeProxy);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">26</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(advisorsPreFiltered()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">27</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">proxyFactory.setPreFiltered(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">28</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">29</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">30</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">proxyFactory.getProxy(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.proxyClassLoader);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">31</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第4行~第6行new出了一个ProxyFactory，Proxy，顾名思义，代理工厂的意思，提供了简单的方式使用代码获取和配置AOP代理。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第8行的代码做了一个判断，判断的内容是</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">&lt;aop:config&gt;这个节点中proxy-target-class=&quot;false&quot;或者proxy-target-class不配置</span><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">，即不使用CGLIB生成代理。如果满足条件，进判断，获取当前Bean实现的所有接口，讲这些接口Class对象都添加到ProxyFactory中。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第17行~第28行的代码没什么看的必要，向ProxyFactory中添加一些参数而已。重点看第30行proxyFactory.getProxy(this.proxyClassLoader)这句：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object getProxy(ClassLoader classLoader) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">createAopProxy().getProxy(classLoader);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">实现代码就一行，但是却明确告诉我们做了两件事情：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">创建AopProxy接口实现类</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">通过AopProxy接口的实现类的getProxy方法获取&lt;bean&gt;对应的代理</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">就从这两个点出发，分两部分分析一下。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">代理对象实例化----创建AopProxy接口实现类</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">看一下createAopProxy()方法的实现，它位于DefaultAopProxyFactory类中：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">protected</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">final</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">synchronized</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AopProxy createAopProxy() {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.active) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">activate();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">getAopProxyFactory().createAopProxy(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">前面的部分没什么必要看，直接进入重点即createAopProxy方法：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AopProxy createAopProxy(AdvisedSupport config)</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throws</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AopConfigException {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(config.isOptimize() || config.isProxyTargetClass() ||</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">hasNoUserSuppliedProxyInterfaces(config)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Class targetClass =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">config.getTargetClass();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(targetClass ==</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throw</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AopConfigException(&quot;TargetSource cannot determine target class: &quot; +</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">&quot;Either an interface or a target is required for proxy creation.&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(targetClass.isInterface()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">JdkDynamicAopProxy(config);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">cglibAvailable) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throw</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AopConfigException(</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">&quot;Cannot proxy target class because CGLIB2 is not available. &quot; +</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">&quot;Add CGLIB to the class path or specify proxy interfaces.&quot;</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">CglibProxyFactory.createCglibProxy(config);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">JdkDynamicAopProxy(config);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">平时我们说AOP原理三句话就能概括：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">对类生成代理使用CGLIB</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">对接口生成代理使用JDK原生的Proxy</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">可以通过配置文件指定对接口使用CGLIB生成代理</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">这三句话的出处就是createAopProxy方法。看到默认是第19行的代码使用JDK自带的Proxy生成代理，碰到以下三种情况例外：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">ProxyConfig的isOptimize方法为true，这表示让Spring自己去优化而不是用户指定</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">ProxyConfig的isProxyTargetClass方法为true，这表示配置了proxy-target-class=&quot;true&quot;</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">ProxyConfig满足hasNoUserSuppliedProxyInterfaces方法执行结果为true，这表示&lt;bean&gt;对象没有实现任何接口</span><span style="font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">或者实现的接口是SpringProxy接口</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">在进入第2行的if判断之后再根据目标&lt;bean&gt;的类型决定返回哪种AopProxy。简单总结起来就是：</span></div><ol style="margin: 0px; padding: 0px 0px 0px 40px;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">proxy-target-class没有配置或者proxy-target-class=&quot;false&quot;，返回JdkDynamicAopProxy</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: decimal;"><span style="font-size: 13px; font-family: 宋体;">proxy-target-class=&quot;true&quot;或者&lt;bean&gt;对象没有实现任何接口或者只实现了SpringProxy接口，返回Cglib2AopProxy</span></li></ol><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">当然，不管是JdkDynamicAopProxy还是Cglib2AopProxy，AdvisedSupport都是作为构造函数参数传入的，里面存储了具体的Advisor。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">代理对象实例化----通过getProxy方法获取&lt;bean&gt;对应的代理</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">其实代码已经分析到了JdkDynamicAopProxy和Cglib2AopProxy，剩下的就没什么好讲的了，无非就是看对这两种方式生成代理的熟悉程度而已。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">Cglib2AopProxy生成代理的代码就不看了，对Cglib不熟悉的朋友可以看</span><a href="http://www.cnblogs.com/xrq730/p/6661692.html" style="text-indent: 0px; color: black; text-decoration: underline;">Cglib及其基本使用</a><span style="text-indent: 0px;">一文。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">JdkDynamicAopProxy生成代理的方式稍微看一下：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object getProxy(ClassLoader classLoader) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(logger.isDebugEnabled()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">logger.debug(&quot;Creating JDK dynamic proxy: target source is &quot; +</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advised.getTargetSource());</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Class[] proxiedInterfaces =</span> <a href="http://aopproxyutils.completeproxiedinterfaces/" style="font-family: &quot;Courier New&quot;; font-size: 12px;">AopProxyUtils.completeProxiedInterfaces</a><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advised);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Proxy.newProxyInstance(classLoader, proxiedInterfaces,</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">这边解释一下第5行和第6行的代码，第5行代码的作用是拿到所有要代理的接口，第6行代码的作用是尝试寻找这些接口方法里面有没有equals方法和hashCode方法，同时都有的话打个标记，寻找结束，equals方法和hashCode方法有特殊处理。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">最终通过第7行的Proxy.newProxyInstance方法获取接口/类对应的代理对象，Proxy是JDK原生支持的生成代理的方式。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 18px; font-family: &quot;Microsoft YaHei&quot;; font-weight: bold;">代理方法调用原理</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">前面已经详细分析了为接口/类生成代理的原理，生成代理之后就要调用方法了，这里看一下使用JdkDynamicAopProxy调用方法的原理。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">由于JdkDynamicAopProxy本身实现了InvocationHandler接口，因此具体代理前后处理的逻辑在invoke方法中：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-size: 12px !important;"><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">1</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">public</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object invoke(Object proxy, Method method, Object[] args)</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">throws</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Throwable {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">2</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">MethodInvocation invocation;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">3</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object oldProxy =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">4</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">boolean</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">setProxyContext =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">false</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">5</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">6</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">TargetSource targetSource =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advised.targetSource;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">7</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Class targetClass =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">8</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">Object target =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">9</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">10</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">try</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">11</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">.equalsDefined &amp;&amp;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AopUtils.isEqualsMethod(method)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">12</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">The target does not implement the equals(Object) method itself.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">13</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">equals(args[0</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">]);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">14</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">15</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">.hashCodeDefined &amp;&amp;</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AopUtils.isHashCodeMethod(method)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">16</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">The target does not implement the hashCode() method itself.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">17</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">hashCode();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">18</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">19</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(!</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">20</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">method.getDeclaringClass().isAssignableFrom(Advised.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">)) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">21</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Service invocations on ProxyConfig with the proxy config...</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">22</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">AopUtils.invokeJoinpointUsingReflection(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advised, method, args);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">23</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">24</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">25</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Object retVal;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">26</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">27</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advised.exposeProxy) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">28</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Make invocation available if necessary.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">29</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">oldProxy =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AopContext.setCurrentProxy(proxy);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">30</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">setProxyContext =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">true</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">31</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">32</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">33</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">May be null. Get as late as possible to minimize the time we &quot;own&quot; the target,</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">34</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">in case it comes from a pool.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">35</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">target =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">targetSource.getTarget();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">36</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(target !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">37</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">targetClass =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">target.getClass();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">38</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">39</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">40</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Get the interception chain for this method.</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">41</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">List&lt;Object&gt; chain =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">this</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">42</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">43</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Check whether we have any advice. If we don't, we can fallback on direct</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">44</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">reflective invocation of the target, and avoid creating a MethodInvocation.</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">45</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(chain.isEmpty()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">46</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">We can skip creating a MethodInvocation: just invoke the target directly</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">47</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Note that the final invoker must be an InvokerInterceptor so we know it does</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">48</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">49</span> <span style="font-family: &quot;Courier New&quot;;">retVal =</span> <span style="font-family: &quot;Courier New&quot;; line-height: 1.5;">AopUtils.invokeJoinpointUsingReflection(target, method, args);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">50</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">51</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">else</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">52</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">We need to create a method invocation...</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">53</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">invocation =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">new</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">54</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Proceed to the joinpoint through the interceptor chain.</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">55</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">retVal =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">invocation.proceed();</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">56</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">57</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">58</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Massage return value if necessary.</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">59</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(retVal !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">&amp;&amp; retVal == target &amp;&amp; method.getReturnType().isInstance(proxy) &amp;&amp;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">60</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">!RawTargetAccess.</span><span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">class</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">.isAssignableFrom(method.getDeclaringClass())) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">61</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Special case: it returned &quot;this&quot; and the return type of the method</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">62</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">is type-compatible. Note that we can't help if the target sets</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">63</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">a reference to itself in another returned object.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">64</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">retVal =</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">proxy;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">65</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">66</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">return</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">retVal;</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">67</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">68</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">finally</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">{</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">69</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">(target !=</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">null</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">&amp;&amp; !</span><span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">targetSource.isStatic()) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">70</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Must have come from TargetSource.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">71</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">targetSource.releaseTarget(target);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">72</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">73</span> <span style="font-size: 12px !important; color: rgb(0, 0, 255); font-family: &quot;Courier New&quot;; line-height: 1.5;">if</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">(setProxyContext) {</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">74</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">//</span> <span style="font-size: 12px !important; color: rgb(0, 128, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">Restore old proxy.</span><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">75</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">AopContext.setCurrentProxy(oldProxy);</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">76</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">77</span> <span style="font-size: 12px !important; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; line-height: 1.5;">}</span></div><div><span style="font-size: 12px !important; color: rgb(0, 128, 128); font-family: &quot;Courier New&quot;; line-height: 1.5;">78</span> <span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;">}</span></div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><span style="color: rgb(0, 0, 0); font-family: &quot;Courier New&quot;; font-size: 12px;"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 900px;"></img></span></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第11行~第18行的代码，表示</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">equals方法与hashCode方法即使满足expression规则，也不会为之产生代理内容，调用的是JdkDynamicAopProxy的equals方法与hashCode方法</span><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">。至于这两个方法是什么作用，可以自己查看一下源代码。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第19行~第23行的代码，表示方法所属的Class是一个接口并且方法所属的Class是AdvisedSupport的父类或者父接口，直接通过反射调用该方法。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第27行~第30行的代码，是用于判断是否将代理暴露出去的，由&lt;aop:config&gt;标签中的expose-proxy=&quot;true/false&quot;配置。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第41行的代码，获取AdvisedSupport中的所有拦截器和动态拦截器列表，用于拦截方法，具体到我们的实际代码，列表中有三个Object，分别是：</span></div><ul style="margin: 0px 0px 0px 30px; padding: 0px; word-break: break-all;"><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">chain.get(0)：ExposeInvocationInterceptor，这是一个默认的拦截器，对应的原Advisor为DefaultPointcutAdvisor</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">chain.get(1)：MethodBeforeAdviceInterceptor，用于在实际方法调用之前的拦截，对应的原Advisor为AspectJMethodBeforeAdvice</span></li><li style="margin: 0px 0px 1em; padding: 0px; list-style: disc;"><span style="font-size: 13px; font-family: 宋体;">chain.get(2)：AspectJAfterAdvice，用于在实际方法调用之后的处理</span></li></ul><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第45行~第50行的代码，如果拦截器列表为空，很正常，因为某个类/接口下的某个方法可能不满足expression的匹配规则，因此此时通过反射直接调用该方法。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">第51行~第56行的代码，如果拦截器列表不为空，按照注释的意思，需要一个ReflectiveMethodInvocation，并通过proceed方法对原方法进行拦截，proceed方法感兴趣的朋友可以去看一下，里面使用到了</span><span style="text-indent: 0px; font-size: 13px; color: rgb(255, 0, 0); font-family: 宋体; font-weight: bold;">递归</span><span style="text-indent: 0px; font-size: 13px; font-family: 宋体;">的思想对chain中的Object进行了层层的调用。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div></div><div style="margin: 0px; padding: 0px;"><div><span style="font-weight: bold;">==================================================================================</span><span style="font-weight: bold;"> </span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">我不能保证写的每个地方都是对的，但是至少能保证不复制、不黏贴，保证每一句话、每一行代码都经过了认真的推敲、仔细的斟酌。每一篇文章的背后，希望都能看到自己对于技术、对于生活的态度。</span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">我相信乔布斯说的，只有那些疯狂到认为自己可以改变世界的人才能真正地改变世界。面对压力，我可以挑灯夜战、不眠不休；面对困难，我愿意迎难而上、永不退缩。</span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">其实我想说的是，我只是一个程序员，这就是我现在纯粹人生的全部。</span></div><div><br style="margin: 0px; padding: 0px;"/></div><div><span style="font-weight: bold;">==================================================================================</span></div></div><div><br/></div></span>
</div></body></html> 