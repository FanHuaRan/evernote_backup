<html>
<head>
  <title>第十章 早期（编译期）优化</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1029"/>
<h1>第十章 早期（编译期）优化</h1>

<div>
<span><div><div><span style="min-height: 15pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>一.概述</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  Java的编译器种类繁多，前面几章讲解的大部分和解释执行相关，现在讲编译。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  Java的编译器有三种：</font></span></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">前端编译器：sun的javac、eclipse JDT中的增量式编译器（ECJ）</span><br/></font></li><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">JIT编译器：Hotspot VM的C1、C2编译器</span><br/></font></li><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">AOT编译器：GNU Compier for java（GCJ）、Excelsior JET</span><br/></font></li></ol><div style="margin-left: 4mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">前端编译器：输入是*.java文件，输出是*.class文件</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">   JIT编译器：输入是*.class文件，输出是本地代码</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">   AOT编译器：输入时*.java文件，输出是本地代码</font></span></div><div style="min-height: 15pt;"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"> </span> <span style="min-height: 15pt; color: rgb(255, 0, 0);">在java当中，即时编译器在运行期的优化过程对于程序运行来说很重要（运行优化），而前端编译器在编译期的优化过程对于程序编码来说关系更加密切（语法糖和新的语言特性）。</span></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(255, 0, 0);"><font style="font-size: 12pt;">Java开发团队主要把目光放在虚拟机运行时优化，也就是JIT编译器的优化，堆前端编译器的优化很少，基本只有解语法糖。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>二.javac编译器</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  Javac编译器本身就是由java写的（那javac又是怎么编译出来的呢，C/C++语言干的？）</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  Javac编译器的源码在openjdk目录/langtools/src/classes/com/sun/tools/javac当中，javac只依赖sun目录下面的java文件，所以可以把com目录复制到自己的项目当中来进行调试。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  Javac的核心类是/langtools/src/com/sun/tools/javac/main/JavaCompiler.java</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  核心方法：</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  public void compile(List&lt;JavaFileObject&gt; sourceFileObjects,</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                        List&lt;String&gt; classnames,</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                        Iterable&lt;? extends Processor&gt; processors)</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">    {</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        if (processors != null &amp;&amp; processors.iterator().hasNext())</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            explicitAnnotationProcessingRequested = true;</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        // as a JavaCompiler can only be used once, throw an exception if</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        // it has been used before.</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        if (hasBeenUsed)</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            throw new AssertionError(&quot;attempt to reuse JavaCompiler&quot;);</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        hasBeenUsed = true;</font></span></div><div style="min-height: 15pt;"></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        // forcibly set the equivalent of -Xlint:-options, so that no further</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        // warnings about command line options are generated from this point on</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        options.put(XLINT_CUSTOM + &quot;-&quot; + LintCategory.OPTIONS.option, &quot;true&quot;);</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        options.remove(XLINT_CUSTOM + LintCategory.OPTIONS.option);</font></span></div><div style="min-height: 15pt;"></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        start_msec = now();</font></span></div><div style="min-height: 15pt;"></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        try {</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            initProcessAnnotations(processors);</font></span></div><div style="min-height: 15pt;"></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            // These method calls must be chained to avoid memory leaks</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            delegateCompiler =</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                processAnnotations(</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                    enterTrees(stopIfError(CompileState.PARSE, parseFiles(sourceFileObjects))),</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                    classnames);</font></span></div><div style="min-height: 15pt;"></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><a href="http://delegatecompiler.compile2/">delegateCompiler.compile2</a>();</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            delegateCompiler.close();</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            elapsed_msec = delegateCompiler.elapsed_msec;</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        } catch (Abort ex) {</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            if (devVerbose)</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                ex.printStackTrace(System.err);</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        } finally {</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">            if (procEnvImpl != null)</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">                procEnvImpl.close();</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">        }</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">    }</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">Javac基本存在三个编译过程：</font></span></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 36pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">解析与填充符号表过程</span><br/></font></li><li style="margin-left: 36pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">插入式注解的注解处理过程</span><br/></font></li><li style="margin-left: 36pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">分析与字节码生成</span><br/></font></li></ol><div style="margin-left: 7mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 75pt;"><font style="font-size: 12pt;"><img src="第十章 早期（编译期）优化_files/Image.png" type="image/png" data-filename="Image.png" width="554"/></font></div><div style="margin-left: 7mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 229pt;"><font style="font-size: 12pt;"><img src="第十章 早期（编译期）优化_files/Image [1].png" type="image/png" data-filename="Image.png" width="547"/></font></div><div style="margin-left: 7mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">解析与填充符号表包括：词法、语法分析；填充符号表</font></span></div><div style="margin-left: 7mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">注解处理器：注解处理，这部分是程序员可以操控编译的唯一方法</font></span></div><div style="margin-left: 7mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">语义分析及字节码生成：标注检查、数据及控制流分析、解语法糖、字节码生成（由/langtools/src/com/sun/tools/javac/jvm/Gen.java完成）</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>三.java语法糖的味道</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  1.泛型与类型擦除</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  2.自动装箱、拆箱</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">  3.遍历循环</font></span></div><div style="min-height: 15pt;"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"> </span> <span style="min-height: 15pt; color: rgb(255, 0, 0);">4.lambda表达式算不算语法糖？</span></font></div><div style="min-height: 15pt;"></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>四.实战：插入式注解处理</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">知识点：</font></span></div><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">这儿是参与javac编译的第二个阶段：插入式注解的注解处理过程</span><br/></font></li><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">方法是写一个Processor类继承自javax.annotation.processing.AbstractProcessor，派生process方法，javac编译时指定参数-processor</span><br/></font></li></ol><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 72pt;"><font style="font-size: 12pt;"><img src="第十章 早期（编译期）优化_files/Image [2].png" type="image/png" data-filename="Image.png" width="548"/></font></div><ol start="3" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><span style="min-height: 15pt; color: rgb(1, 1, 1);">使用这组API的项目包括：Hiberante Validator Annotation Processor和Project Lombok</span></font><br/></li></ol></div></span>
</div></body></html> 