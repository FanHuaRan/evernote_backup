<html>
<head>
  <title>java直接内存的垃圾回收的总结和思考</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="892"/>
<h1>java直接内存的垃圾回收的总结和思考</h1>

<div>
<span><div><div>jvm的内存区域还包括一个直接内存，直接内存默认和堆内存一样大，垃圾收集器无法回收直接内存，那直接内存的垃圾回收工作如何做呢？需要像C语言一样由程序员回收吗？后面给出答案。</div><div><span style="font-size: 18pt; color: rgb(26, 144, 185); font-weight: bold;">一.直接内存的内存分配API和垃圾回收API</span></div><div>   jdk中的直接内存的内存分配的入口点：</div><div>  <span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;"> <span style="background-color: rgb(232, 242, 254); font-size: 14pt; font-family: Consolas; color: rgb(45, 79, 201); font-weight: bold;">U</span></span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254);"><span style="background-color: rgb(232, 242, 254); font-size: 14pt; color: rgb(45, 79, 201); font-family: Consolas; font-style: italic; font-weight: bold;">ns</span></span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(0, 0, 192); font-family: Consolas; font-style: italic; font-weight: bold;">afe</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">allocateMemory</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">)</span></div><div>   该方法类似于C语言中的malloc方法，将在直接内存中分配一段大小为size的内存并返回内存的起始地址，如果内存不够，将抛出OOM。</div><div>   jdk中的直接内存的内存释放方法时：</div><div>    <span style="color: rgb(45, 79, 201); font-weight: bold;">U</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(45, 79, 201); font-family: Consolas; font-style: italic; font-weight: bold;">nsafe</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">freeMemory</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(0, 0, 192); font-family: Consolas;">address</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">);</span></div><div>   该方法类似于C语言中的free方法，将回收起始地址为address的一段内存。</div><div>   通过allocateMemory方法分配的内存不受jvm管理，无法被垃圾收集器进行回收，因此必须要使用freeMemory方法进行回收，否则会造成直接内存的OOM，而且还无法打印dump,很难定位问题！</div><div>   就像C语言中的malloc和free是一对一样。哈哈！</div><div><br/></div><div><span style="font-size: 18pt; color: rgb(26, 144, 185); font-weight: bold;">二.DirectByteBufferByteBuffer.allocateDirect方法</span></div><div>   Unsafe类不通过修改编译器和反射调用，是无法直接使用的，也不推荐使用，所以我们往往接触的直接内存只有一种情况，那就是通过ByteBuffer.allocateDirect(size)方法得到的含有直接内存的DirectByteBuffer对象。</div><div>   看看DirectBuffer是怎么利用Uunsafe.allocateMemory方法和Unsafe.freeMeomory方法来分配和回收直接内存的。</div><div>   源码如下：</div><div>  <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;"> DirectByteBuffer(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">int</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {                  </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// package-private</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">super</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(-1, 0,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><div><br/></div></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">pa</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= VM.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">isDirectMemoryPageAligned</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">int</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">ps</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= Bits.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">pageSize</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">long</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= Math.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">max</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(1L, (</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">long</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">)</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">+ (</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">pa</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">?</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">ps</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">: 0));</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        Bits.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">reserveMemory</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">long</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= 0;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">try</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic; font-weight: bold;">unsafe</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(212, 212, 212); font-family: Consolas;">allocateMemory</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(OutOfMemoryError</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">x</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            Bits.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">unreserveMemory</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">throw</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">x</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic; font-weight: bold;">unsafe</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.setMemory(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">, (</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">byte</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) 0);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">if</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">pa</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">&amp;&amp; (</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">%</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">ps</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">!= 0)) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// Round up to page boundary</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">address</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">+</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">ps</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">- (</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">&amp; (</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">ps</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">- 1));</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">else</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">address</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">cleaner</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= Cleaner.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">create</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">new</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Deallocator(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">));</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">att</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">null</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div><br/></div><div>      从这儿可以看出Unsafe的确是显示调用unsafe.allocateMemory方法来直接分配内存的。</div><div>      那在哪儿进行内存回收的工作呢？</div><div>      如下：</div><div>      <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">cleaner</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= Cleaner.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">create</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">new</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Deallocator(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">base</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">cap</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">));</span></div><div>      <span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">final</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">Cleaner</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(0, 0, 192); font-family: Consolas;">cleaner</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">;</span></div><div>      <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;"> </span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">class</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Deallocator</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">implements</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Runnable</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    {</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">static</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Unsafe</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">unsafe</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= Unsafe.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">getUnsafe</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">();</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">long</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">address</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">long</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">int</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">capacity</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">private</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">Deallocator(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">long</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">address</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">long</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">int</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">capacity</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">assert</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">address</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">!= 0);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">address</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">address</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">size</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">this</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">capacity</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">=</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(106, 62, 62); font-family: Consolas;">capacity</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">       </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">public</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">void</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">run() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">if</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">address</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">== 0) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">               </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(63, 127, 95); font-family: Consolas;">// Paranoia</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">               </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(127, 0, 85); font-family: Consolas; font-weight: bold;">return</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas; font-style: italic;">unsafe</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">.freeMemory(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">address</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">           </span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">address</span> <span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">= 0;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">            Bits.</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas; font-style: italic;">unreserveMemory</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; color: rgb(0, 0, 192); font-family: Consolas;">capacity</span><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-size: 14pt; font-family: Consolas;">    }</span></div><div>   从这儿可以看出内存回收工作是由Dellocator和Cleaner来做的，Dellocator实现了Runable，里面直接调用了unsafe.freeMemory方法来回收DirectBuffer中的直接内存，而Dellocator的对象又被传递了给了Cleaner，Cleaner是一个Reference子类，当DirectBuffer只有Cleaner等非强引用可达时，GC标记后会由一个全局线程来调用Cleaner的Clean方法，而Clean方法又回调Dellocator来进行直接内存的释放工作。</div><div>至于JVM如何调用Cleaner，那是在垃圾收集时候，由GC标记后交给ReferenceHandler线程来处理的，GC标记需要参考jdk底层代码，后者可以在Reference类中找到调用逻辑。</div><div><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">Bits.</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas; font-style: italic;">unreserveMemory</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">(</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(0, 0, 192); font-family: Consolas;">size</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">,</span> <span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); color: rgb(0, 0, 192); font-family: Consolas;">capacity</span><span style="min-height: 16pt; font-size: 14pt; background: rgb(232, 242, 254); font-family: Consolas;">);</span>还有一些进一步的处理动作，这儿不做总结。</div><div><br/></div><h2 style="border: 0px; margin: -9px 0px 20px; padding: 0px; font-size: 24px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 24px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><span style="font-size: 24px; color: rgb(26, 144, 185); font-family: &quot;Microsoft YaHei&quot;, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-stretch: normal; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 36px;">三.直接内存一些总结</span></span></h2><h3 style="border: 0px; margin: -8px 0px 20px; padding: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-stretch: normal; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 30px;">使用堆外内存的原因</span></h3><ul style="border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; list-style: disc inside; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">对垃圾回收停顿的改善</span></li></ul><div style="border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">因为full gc 意味着彻底回收，彻底回收时，垃圾收集器会对所有分配的堆内内存进行完整的扫描，这意味着一个重要的事实——这样一次垃圾收集对Java应用造成的影响，跟堆的大小是成正比的。过大的堆会影响Java应用的性能。如果使用堆外内存的话，堆外内存是直接受操作系统管理( 而不是虚拟机 )。这样做的结果就是能保持一个较小的堆内内存，以减少垃圾收集对应用的影响。</span></div><ul style="border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; list-style: disc inside; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">在某些场景下可以提升程序I/O操纵的性能。少去了将数据从堆内内存拷贝到堆外内存的步骤。</span></li></ul><h3 style="border: 0px; margin: -8px 0px 20px; padding: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-stretch: normal; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 30px;">什么情况下使用堆外内存</span></h3><ul style="border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; list-style: disc inside; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">堆外内存适用于生命周期中等或较长的对象。( 如果是生命周期较短的对象，在YGC的时候就被回收了，就不存在大内存且生命周期较长的对象在FGC对应用造成的性能影响 )。</span></li><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">直接的文件拷贝操作，或者I/O操作。直接使用堆外内存就能少去内存从用户内存拷贝到系统内存的操作，因为I/O操作是系统内核内存和设备间的通信，而不是通过程序直接和外设通信的。</span></li><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">同时，还可以使用 池+堆外内存 的组合方式，来对生命周期较短，但涉及到I/O操作的对象进行堆外内存的再使用。( Netty中就使用了该方式 )</span></li></ul><h3 style="border: 0px; margin: -8px 0px 20px; padding: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-stretch: normal; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 30px;">堆外内存 VS 内存池</span></h3><ul style="border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; list-style: disc inside; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">内存池：主要用于两类对象：①生命周期较短，且结构简单的对象，在内存池中重复利用这些对象能增加CPU缓存的命中率，从而提高性能；②加载含有大量重复对象的大片数据，此时使用内存池能减少垃圾回收的时间。</span></li><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">堆外内存：它和内存池一样，也能缩短垃圾回收时间，但是它适用的对象和内存池完全相反。内存池往往适用于生命期较短的可变对象，而生命期中等或较长的对象，正是堆外内存要解决的。</span></li></ul><h3 style="border: 0px; margin: -8px 0px 20px; padding: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-stretch: normal; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 30px;">堆外内存的特点</span></h3><ul style="border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; list-style: disc inside; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">对于大内存有良好的伸缩性</span></li><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">对垃圾回收停顿的改善可以明显感觉到</span></li><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">在进程间可以共享，减少虚拟机间的复制</span></li></ul><h3 style="border: 0px; margin: -8px 0px 20px; padding: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="border: 0px; font-size: 20px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-stretch: normal; font-variant-caps: normal; font-variant-ligatures: normal; line-height: 30px;">堆外内存的一些问题</span></h3><ul style="border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; list-style: disc inside; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">堆外内存回收问题，以及堆外内存的泄漏问题。这个在上面的源码解析已经提到了</span></li><li style="border: 0px; margin: 0px; padding: 0px; font-size: 14px;"><span style="font-size: 14px; color: rgb(0, 0, 0); font-family: &quot;Microsoft YaHei&quot;, 宋体, &quot;Myriad Pro&quot;, Lato, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">堆外内存的数据结构问题：堆外内存最大的问题就是你的数据结构变得不那么直观，如果数据结构比较复杂，就要对它进行串行化（serialization），而串行化本身也会影响性能。另一个问题是由于你可以使用更大的内存，你可能开始担心虚拟内存（即硬盘）的速度对你的影响了。</span></li></ul></div><div><br/></div></span>
</div></body></html> 