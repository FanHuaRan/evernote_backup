<html>
<head>
  <title>IO多路复用之select总结</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1419"/>
<h1>IO多路复用之select总结</h1>

<div>
<span><div><h1 style="margin: 0px 0px 10px; padding: 0px 0px 0px 5px; font-size: 15.6px; font-weight: bold; border: 0px; width: 764.938px; clear: both; line-height: 1.5; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></h1><div>原文地址：</div><h1 style="margin: 0px 0px 10px; padding: 0px 0px 0px 5px; font-size: 15.6px; font-weight: bold; border: 0px; float: left; width: 764.938px; clear: both; line-height: 1.5; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a href="http://www.cnblogs.com/Anker/p/3258674.html" style="font-size: 15.6px; font-weight: bold; border: 0px; width: 764.938px; clear: both; line-height: 1.5; color: rgb(33, 117, 155); font-family: &quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); outline: none;">IO多路复用之select总结</a></h1><div style="margin: 0px; padding: 0px; clear: both; color: rgb(0, 0, 0); font-family: &quot;Helvetica Neue&quot;, Helvetica, Verdana, Arial, sans-serif; font-size: 12px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"></div><div style="margin: 0px 0px 20px; padding: 0px; word-break: break-word;"><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-weight: bold;">1、基本概念</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　IO多路复用是指内核一旦发现进程指定的一个或者多个IO条件准备读取，它就通知该进程。IO多路复用适用如下场合：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　（1）当客户处理多个描述字时（一般是交互式输入和网络套接口），必须使用I/O复用。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　（2）当一个客户同时处理多个套接口时，而这种情况是可能的，但很少出现。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　（3）如果一个TCP服务器既要处理监听套接口，又要处理已连接套接口，一般也要用到I/O复用。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　（4）如果一个服务器即要处理TCP，又要处理UDP，一般要使用I/O复用。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　（5）如果一个服务器要处理多个服务或多个协议，一般要使用I/O复用。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　与多进程和多线程技术相比，I/O多路复用技术的最大优势是系统开销小，系统不必创建进程/线程，也不必维护这些进程/线程，从而大大减小了系统的开销。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-weight: bold;">2、select函数</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　该函数准许进程指示内核等待多个事件中的任何一个发送，并只在有一个或多个事件发生或经历一段指定的时间后才唤醒。函数原型如下：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div>#include &lt;sys/<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">select</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">#include</span> &lt;sys/<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">time.h</span>&gt;</div><div><br/></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">select</span>(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> maxfdp1,fd_set *readset,fd_set *writeset,fd_set *exceptset,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">const</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> timeval *timeout)</div><div>返回值：就绪描述符的数目，超时返回0，出错返回-1</div></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">函数参数介绍如下：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">（1）</span><span style="text-indent: 0px;">第一个参数maxfdp1指定待测试的描述字个数，它的值是待测试的最大描述字加1（因此把该参数命名为maxfdp1），描述字0、1、2...maxfdp1-1均将被测试。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">因为文件描述符是从0开始的。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">（2）</span><span style="text-indent: 0px;">中间的三个参数readset、writeset和exceptset指定我们要让内核测试读、写和异常条件的描述字。如果对某一个的条件不感兴趣，就可以把它设为空指针。struct fd_set可以理解为一个集合，这个集合中存放的是文件描述符，可通过以下四个宏进行设置：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">          void FD_ZERO(fd_set *fdset);           //清空集合</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">          void FD_SET(int fd, fd_set *fdset);   //将一个给定的文件描述符加入集合之中</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">          void FD_CLR(int fd, fd_set *fdset);   //将一个给定的文件描述符从集合中删除</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">          int FD_ISSET(int fd, fd_set *fdset);   // 检查集合中指定的文件描述符是否可以读写 </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">（3）timeout告知内核等待所指定描述字中的任何一个就绪可花多少时间。其timeval结构用于指定这段时间的秒数和微秒数。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">         struct timeval{</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">                   long tv_sec;   //seconds</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">                   long tv_usec;  //microseconds</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">       };</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">这个参数有三种可能：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">（1）永远等待下去：仅在有一个描述字准备好I/O时才返回。为此，把该参数设置为空指针NULL。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">（2）等待一段固定时间：在有一个描述字准备好I/O时返回，但是不超过由该参数所指向的timeval结构中指定的秒数和微秒数。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">（3）根本不等待：检查描述字后立即返回，这称为轮询。为此，该参数必须指向一个timeval结构，而且其中的定时器值必须为0。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> 原理图：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><img src="https://images2015.cnblogs.com/blog/305504/201509/305504-20150918012828961-1176245587.png" style="margin: 0px; padding: 0px; border: 0px; max-width: 700px;"></img></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-weight: bold;">3、测试程序</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　写一个TCP回射程序，程序的功能是：客户端向服务器发送信息，服务器接收并原样发送给客户端，客户端显示出接收到的信息。</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">服务端程序如下：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 700px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> #include &lt;stdio.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> #include &lt;stdlib.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> #include &lt;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">string</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> #include &lt;errno.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> #include &lt;netinet/<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">in</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> #include &lt;sys/socket.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> #include &lt;sys/<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">select</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> #include &lt;sys/types.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> #include &lt;netinet/<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">in</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> #include &lt;arpa/inet.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span> #include &lt;unistd.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> #include &lt;assert.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> IPADDR &quot;127.0.0.1&quot;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> PORT 8787</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> MAXLINE 1024</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> LISTENQ 5</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> SIZE 10</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">19</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">20</span> typedef <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">server_context_st</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">21</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">22</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> cli_cnt; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">客户端个数</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">23</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> clifds[SIZE]; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">客户端的个数</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">24</span> fd_set allfds; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">句柄集合</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">25</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> maxfd; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">句柄最大值</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">26</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">} server_context_st;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">27</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> server_context_st *s_srv_ctx = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">NULL;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">28</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">===========================================================================</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">29</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">* ==========================================================================</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">30</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> create_server_proc(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">const</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">char</span>* ip,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">port)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">31</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">32</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">fd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">33</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sockaddr_in servaddr;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">34</span> fd = socket(AF_INET, SOCK_STREAM,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">35</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (fd == -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">36</span> fprintf(stderr, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">create socket fail,erron:%d,reason:%s\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">,</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">37</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">errno, strerror(errno));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">38</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">39</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">40</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">41</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">一个端口释放后会等待两分钟之后才能再被使用，SO_REUSEADDR是让端口释放后立即就可以被再次使用。</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">42</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> reuse = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">43</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span>(reuse)) == -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">44</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">45</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">46</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">47</span> bzero(&amp;servaddr,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(servaddr));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">48</span> servaddr.sin_family = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">AF_INET;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">49</span> inet_pton(AF_INET,ip,&amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">servaddr.sin_addr);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">50</span> servaddr.sin_port = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">htons(port);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">51</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">52</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (bind(fd,(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> sockaddr*)&amp;servaddr,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span>(servaddr)) == -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">53</span> perror(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">bind error:</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">54</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">55</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">56</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">57</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">listen(fd,LISTENQ);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">58</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">59</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">fd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">60</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">61</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">62</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> accept_client_proc(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">srvfd)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">63</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">64</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sockaddr_in cliaddr;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">65</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">socklen_t cliaddrlen;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">66</span> cliaddrlen = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(cliaddr);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">67</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> clifd = -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">68</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">69</span> printf(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">accpet clint proc is called.\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">70</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">71</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">ACCEPT:</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">72</span> clifd = accept(srvfd,(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> sockaddr*)&amp;cliaddr,&amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">cliaddrlen);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">73</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">74</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (clifd == -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">75</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (errno == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">EINTR) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">76</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">goto</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">ACCEPT;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">77</span> } <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">else</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">78</span> fprintf(stderr, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">accept fail,error:%s\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">, strerror(errno));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">79</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">80</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">81</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">82</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">83</span> fprintf(stdout, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">accept a new client: %s:%d\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">,</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">84</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">inet_ntoa(cliaddr.sin_addr),cliaddr.sin_port);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">85</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">86</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">将新的连接描述符添加到数组中</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">87</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> i = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">88</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> (i = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span>; i &lt; SIZE; i++<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">89</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (s_srv_ctx-&gt;clifds[i] &lt; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">90</span> s_srv_ctx-&gt;clifds[i] = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">clifd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">91</span> s_srv_ctx-&gt;cli_cnt++<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">92</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">break</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">93</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">94</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">95</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">96</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (i == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">SIZE) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">97</span> fprintf(stderr,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">too many clients.\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">98</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">99</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">100</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">101</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">102</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">103</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> handle_client_msg(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> fd, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">char</span> *<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">buf)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">104</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">105</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">assert(buf);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">106</span> printf(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">recv buf is :%s\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">, buf);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">107</span> write(fd, buf, strlen(buf) +<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">108</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">109</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">110</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">111</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> recv_client_msg(fd_set *<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">readfds)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">112</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">113</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> i = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span>, n = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">114</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">clifd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">115</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">char</span> buf[MAXLINE] = {<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">};</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">116</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> (i = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span>;i &lt;= s_srv_ctx-&gt;cli_cnt;i++<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">117</span> clifd = s_srv_ctx-&gt;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">clifds[i];</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">118</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (clifd &lt; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">119</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">continue</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">120</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">121</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">判断客户端套接字是否有数据</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">122</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(FD_ISSET(clifd, readfds)) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">123</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">//</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">接收客户端发送的信息</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">124</span> n = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">read(clifd, buf, MAXLINE);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">125</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (n &lt;= <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">126</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">n==0表示读取完成，客户都关闭套接字</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">127</span> FD_CLR(clifd, &amp;s_srv_ctx-&gt;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">allfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">128</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">close(clifd);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">129</span> s_srv_ctx-&gt;clifds[i] = -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">130</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">continue</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">131</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">132</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">handle_client_msg(clifd, buf);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">133</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">134</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">135</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">136</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> handle_client_proc(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">srvfd)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">137</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">138</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> clifd = -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">139</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> retval = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">140</span> fd_set *readfds = &amp;s_srv_ctx-&gt;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">allfds;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">141</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">timeval tv;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">142</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> i = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">143</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">144</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">while</span> (<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">145</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">每次调用select前都要重新设置文件描述符和时间，因为事件发生后，文件描述符和时间都被内核修改啦</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">146</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">FD_ZERO(readfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">147</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">添加监听套接字</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">148</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">FD_SET(srvfd, readfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">149</span> s_srv_ctx-&gt;maxfd = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">srvfd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">150</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">151</span> tv.tv_sec = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">30</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">152</span> tv.tv_usec = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">153</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">添加客户端套接字</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">154</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> (i = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span>; i &lt; s_srv_ctx-&gt;cli_cnt; i++<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">155</span> clifd = s_srv_ctx-&gt;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">clifds[i];</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">156</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">去除无效的客户端句柄</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">157</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (clifd != -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">158</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">FD_SET(clifd, readfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">159</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">160</span> s_srv_ctx-&gt;maxfd = (clifd &gt; s_srv_ctx-&gt;maxfd ? clifd : s_srv_ctx-&gt;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">maxfd);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">161</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">162</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">163</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">开始轮询接收处理服务端和客户端套接字</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">164</span> retval = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">select</span>(s_srv_ctx-&gt;maxfd + <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span>, readfds, NULL, NULL, &amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">tv);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">165</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (retval == -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">166</span> fprintf(stderr, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">select error:%s.\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">, strerror(errno));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">167</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">168</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">169</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (retval == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">170</span> fprintf(stdout, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">select is timeout.\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">171</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">continue</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">172</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">173</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(FD_ISSET(srvfd, readfds)) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">174</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">监听客户端请求</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">175</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">accept_client_proc(srvfd);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">176</span> } <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">else</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">177</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">接受处理客户端消息</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">178</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">recv_client_msg(readfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">179</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">180</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">181</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">182</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">183</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">server_uninit()</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">184</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">185</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(s_srv_ctx) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">186</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">free</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(s_srv_ctx);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">187</span> s_srv_ctx = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">NULL;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">188</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">189</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">190</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">191</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">server_init()</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">192</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">193</span> s_srv_ctx = (server_context_st *)<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">malloc</span>(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(server_context_st));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">194</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (s_srv_ctx == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">NULL) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">195</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">196</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">197</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">198</span> memset(s_srv_ctx, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span>, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(server_context_st));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">199</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">200</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> i = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">201</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">for</span> (;i &lt; SIZE; i++<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">202</span> s_srv_ctx-&gt;clifds[i] = -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">203</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">204</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">205</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">206</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">207</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">208</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> main(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> argc,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">char</span> *<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">argv[])</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">209</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">210</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">srvfd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">211</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">初始化服务端context</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">212</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (server_init() &lt; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">213</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">214</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">215</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">创建服务,开始监听客户端请求</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">216</span> srvfd = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">create_server_proc(IPADDR, PORT);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">217</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (srvfd &lt; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">218</span> fprintf(stderr, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">socket create or bind fail.\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">219</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">goto</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">err;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">220</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">221</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">/*</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">开始接收并处理客户端请求</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 0);">*/</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">222</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">handle_client_proc(srvfd);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">223</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">server_uninit();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">224</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">225</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">err:</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">226</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">server_uninit();</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">227</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">228</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 700px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">客户端程序如下：</span></div><div style="margin: 5px 0px; padding: 5px; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); overflow: auto; color: rgb(0, 0, 0); font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 700px;"></img></div><div style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; font-family: &quot;Courier New&quot; !important; font-size: 12px !important;"><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">1</span> #include &lt;netinet/<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">in</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">2</span> #include &lt;sys/socket.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">3</span> #include &lt;stdio.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">4</span> #include &lt;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">string</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">5</span> #include &lt;stdlib.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">6</span> #include &lt;sys/<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">select</span>.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">7</span> #include &lt;time.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">8</span> #include &lt;unistd.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">9</span> #include &lt;sys/types.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">10</span> #include &lt;errno.h&gt;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">11</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">12</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> MAXLINE 1024</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">13</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> IPADDRESS &quot;127.0.0.1&quot;</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">14</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> SERV_PORT 8787</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">15</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">16</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">#define</span> max(a,b) (a &gt; b) ? a : b</div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">17</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">18</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> handle_recv_msg(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> sockfd, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">char</span> *<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">buf)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">19</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">20</span> printf(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">client recv msg is:%s\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">, buf);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">21</span> sleep(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">5</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">22</span> write(sockfd, buf, strlen(buf) +<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">23</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">24</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">25</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">static</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">void</span> handle_connection(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sockfd)</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">26</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">27</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">char</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sendline[MAXLINE],recvline[MAXLINE];</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">28</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">maxfdp,stdineof;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">29</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">fd_set readfds;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">30</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">n;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">31</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">timeval tv;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">32</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> retval = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">33</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">34</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">while</span> (<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">35</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">36</span> FD_ZERO(&amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">readfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">37</span> FD_SET(sockfd,&amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">readfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">38</span> maxfdp = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sockfd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">39</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">40</span> tv.tv_sec = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">5</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">41</span> tv.tv_usec = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">42</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">43</span> retval = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">select</span>(maxfdp+<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span>,&amp;readfds,NULL,NULL,&amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">tv);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">44</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">45</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (retval == -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">46</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">47</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">48</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">49</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (retval == <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">50</span> printf(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">client timeout.\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">51</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">continue</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">52</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">53</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">54</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (FD_ISSET(sockfd, &amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">readfds)) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">55</span> n = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">read(sockfd,recvline,MAXLINE);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">56</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (n &lt;= <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">57</span> fprintf(stderr,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">client: server is closed.\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">58</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">close(sockfd);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">59</span> FD_CLR(sockfd,&amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">readfds);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">60</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">61</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">62</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">63</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">handle_recv_msg(sockfd, recvline);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">64</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">65</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">66</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">67</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">68</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> main(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> argc,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">char</span> *<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">argv[])</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">69</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">{</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">70</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sockfd;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">71</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">sockaddr_in servaddr;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">72</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">73</span> sockfd = socket(AF_INET,SOCK_STREAM,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">74</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">75</span> bzero(&amp;servaddr,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(servaddr));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">76</span> servaddr.sin_family = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">AF_INET;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">77</span> servaddr.sin_port = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">htons(SERV_PORT);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">78</span> inet_pton(AF_INET,IPADDRESS,&amp;<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">servaddr.sin_addr);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">79</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">80</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">int</span> retval = <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">81</span> retval = connect(sockfd,(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">struct</span> sockaddr*)&amp;servaddr,<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">sizeof</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">(servaddr));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">82</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">if</span> (retval &lt; <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">) {</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">83</span> fprintf(stderr, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">connect fail,error:%s\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">, strerror(errno));</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">84</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> -<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">1</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">85</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">}</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">86</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">87</span> printf(<span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">client send to server .\n</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">88</span> write(sockfd, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">hello server</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 0);">&quot;</span>, <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">32</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">89</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">90</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">handle_connection(sockfd);</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">91</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">92</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 255);">return</span> <span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(128, 0, 128);">0</span><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 0, 0);">;</span></div><div><span style="font-family: &quot;Courier New&quot; !important; font-size: 12px !important; line-height: 1.5 !important; color: rgb(0, 128, 128);">93</span> }</div></div><div style="margin: 5px 0px 0px; padding: 0px; background-color: rgb(245, 245, 245);"><img src="http://common.cnblogs.com/images/copycode.gif" style="margin: 0px; padding: 0px; border: none !important; background-color: rgb(245, 245, 245) !important; max-width: 700px;"></img></div></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;"> </span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px; font-weight: bold;">4、程序结果</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">　　启动服务程序，执行三个个客户程序进行测试，结果如下图所示：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><img src="https://images2015.cnblogs.com/blog/305504/201509/305504-20150918013817539-541219182.png" style="margin: 0px; padding: 0px; border: 0px; max-width: 700px;"></img></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">参考：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><a href="http://konglingchun.is-programmer.com/posts/12146.html" style="text-indent: 0px; outline: none; color: black; text-decoration: underline;">http://konglingchun.is-programmer.com/posts/12146.html</a></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><a href="http://blog.163.com/smileface100@126/blog/static/27720874200951024532966/" style="text-indent: 0px; outline: none; color: black; text-decoration: underline;">http://blog.163.com/smileface100@126/blog/static/27720874200951024532966/</a></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">备注：</span></div><div style="margin: 10px auto; padding: 0px; text-indent: 0px;"><span style="text-indent: 0px;">（1）2016-10-23修改服务端,添加注释，非法客户端的处理。</span></div></div><div><br/></div></div></span>
</div></body></html> 