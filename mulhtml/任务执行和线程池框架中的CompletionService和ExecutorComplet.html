<html>
<head>
  <title>任务执行和线程池框架中的CompletionService和ExecutorCompletionService</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1619"/>
<h1>任务执行和线程池框架中的CompletionService和ExecutorCompletionService</h1>

<div>
<span><div><div><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-weight: bold;"><font style="font-size: 18pt; color: rgb(20, 113, 145);">个人理解</font></span></div><div><span style="font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); font-weight: bold; color: rgb(192, 0, 0); font-size: 16px;">想想一个需求，现在有N多个任务需要执行，在这些任务执行每个完成时需要立即对其结果进行进一步处理，这个时候应该怎么做？仔细想想除非显示的去修改任务的代码，否则没有好的办法可以完成。这时CompetionService可以登场了！</span></div><div><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 16px;">CompletionService接口定义了一组带相同返回值的任务的管理接口,可以最快的获取这些批量任务的执行结果，ExecutorService.invokeAny就使用了这个技术！</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    源码如下：</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public interface CompletionService&lt;V&gt; {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-weight: bold;">   </span> <span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">//提交任务</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">    Future&lt;V&gt; submit(Callable&lt;V&gt; task);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //提交任务</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">    Future&lt;V&gt; submit(Runnable task, V result);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //获取一个执行结果（并移除） 阻塞</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">    Future&lt;V&gt; take() throws InterruptedException;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">    //获取一个执行结果（并移除） 不阻塞</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    Future&lt;V&gt; poll();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //获取一个执行结果（并移除） 带超时</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">    Future&lt;V&gt; poll(long timeout, TimeUnit unit) throws InterruptedException;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">     }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">ExecutorCompletionService类是CompletionService接口的实现</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">ExecutorCompletionService内部管理者一个已完成任务的阻塞队列，其引用了一个Executor用来执行任务，submit()方法最终会委托给内部的executor去执行任务，take/poll方法的工作都委托给内部的已完成任务阻塞队列</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    如果阻塞队列中有已完成的任务, take方法就返回任务的结果, 否则阻塞等待任务完成</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    源码如下：</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public class ExecutorCompletionService&lt;V&gt; implements CompletionService&lt;V&gt; {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            //被包装Executor</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    private final Executor executor;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //如果executor是AbstractExecutorService就为它</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    private final AbstractExecutorService aes;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //完成任务的阻塞队列</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    private final BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    /**</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     * 扩展FutureTask，重写了其done方法用于将完成任务放置在阻塞队列！！！</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     */</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    private class QueueingFuture extends FutureTask&lt;Void&gt; {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        QueueingFuture(RunnableFuture&lt;V&gt; task) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            super(task, null);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            this.task = task;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        protected void done() { completionQueue.add(task); }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        private final Future&lt;V&gt; task;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    private RunnableFuture&lt;V&gt; newTaskFor(Callable&lt;V&gt; task) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (aes == null)</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            return new FutureTask&lt;V&gt;(task);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        else</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            return aes.newTaskFor(task);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    private RunnableFuture&lt;V&gt; newTaskFor(Runnable task, V result) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (aes == null)</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            return new FutureTask&lt;V&gt;(task, result);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        else</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            return aes.newTaskFor(task, result);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    </span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public ExecutorCompletionService(Executor executor) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (executor == null)</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">            throw new NullPointerException();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">        this.executor = executor;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        this.aes = (executor instanceof AbstractExecutorService) ?</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            (AbstractExecutorService) executor : null;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a href="http://this.completionqueue/">this.completionQueue</a> = new LinkedBlockingQueue&lt;Future&lt;V&gt;&gt;();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">   </span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public ExecutorCompletionService(Executor executor,</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">                                     BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (executor == null || completionQueue == null)</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            throw new NullPointerException();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        this.executor = executor;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        this.aes = (executor instanceof AbstractExecutorService) ?</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            (AbstractExecutorService) executor : null;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><a href="http://this.completionqueue/">this.completionQueue</a> = completionQueue;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //提交任务</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public Future&lt;V&gt; submit(Callable&lt;V&gt; task) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (task == null) throw new NullPointerException();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        RunnableFuture&lt;V&gt; f = newTaskFor(task);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        executor.execute(new QueueingFuture(f));</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        return f;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //提交任务</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public Future&lt;V&gt; submit(Runnable task, V result) {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        if (task == null) throw new NullPointerException();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        RunnableFuture&lt;V&gt; f = newTaskFor(task, result);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        executor.execute(new QueueingFuture(f));</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        return f;</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //获取结果带阻塞</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public Future&lt;V&gt; take() throws InterruptedException {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        return completionQueue.take();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">     //获取结果</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public Future&lt;V&gt; poll() {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        return completionQueue.poll();</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    //获取结果 带超时</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    public Future&lt;V&gt; poll(long timeout, TimeUnit unit)</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">            throws InterruptedException {</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">        return completionQueue.poll(timeout, unit);</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">    }</span></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><div><br/></div></div><div style="margin: 0px; padding: 0px; color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 14px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">}</span></div><div><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">       ExecutorCompletionService主要用与管理一组带相同返回结果类型的异步任务 (有结果的任务, 任务完成后要处理结果)</span></div><div><span style="color: rgb(0, 0, 0); font-family: punctuation, 微软雅黑, Tohoma; font-size: 16px; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></span></div><div><font style="font-family: punctuation, 微软雅黑, Tohoma; color: rgb(20, 113, 145); font-size: 18pt;"><b>原文</b></font></div><div><font face="punctuation, 微软雅黑, Tohoma"><span style="font-size: 16px;">地址：</span></font></div><ol><li>CompletionService接口定义了一组任务管理接口:</li></ol><ul><li>submit() - 提交任务</li><li>take() - 获取任务结果</li><li>poll() - 获取任务结果</li></ul><ol start="2"><li>ExecutorCompletionService类是CompletionService接口的实现</li></ol><ul><li>ExecutorCompletionService内部管理者一个已完成任务的阻塞队列</li><li>ExecutorCompletionService引用了一个Executor, 用来执行任务</li><li>submit()方法最终会委托给内部的executor去执行任务</li><li>take/poll方法的工作都委托给内部的已完成任务阻塞队列</li><li>如果阻塞队列中有已完成的任务, take方法就返回任务的结果, 否则阻塞等待任务完成</li><li>poll与take方法不同, poll有两个版本:</li><ul><li>无参的poll方法 --- 如果完成队列中有数据就返回, 否则返回null</li><li>有参数的poll方法 --- 如果完成队列中有数据就直接返回, 否则等待指定的时间, 到时间后如果还是没有数据就返回null</li><li>ExecutorCompletionService主要用与管理异步任务 (有结果的任务, 任务完成后要处理结果)</li></ul></ul><ol start="3"><li>关于CompletionService和ExecutorCompletionService的类图如下:</li></ol><div style="max-width: 524px; max-height: 628px;"><div style="padding-bottom: 119.85%; font-family: punctuation; font-size: 12pt;"><img src="任务执行和线程池框架中的CompletionService和ExecutorComplet_files/Image.png" type="image/png" data-filename="Image.png" style="font-family: punctuation; font-size: 12pt;"/></div><div style="font-family: punctuation; font-size: 12pt;"><img style="cursor: zoom-in; font-family: punctuation; font-size: 12pt;"></img></div></div><div><span style="font-family: punctuation; font-size: 12pt;">CompletionService.png</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: punctuation; font-size: 12pt;-en-paragraph:true;">下面是简单的用法:</span></div><div><span style="font-family: punctuation; font-size: 12pt;">package com.example.concurrent;</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.ArrayList;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.List;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.Random;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.concurrent.Callable;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.concurrent.ExecutionException;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.concurrent.ExecutorCompletionService;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.concurrent.ExecutorService;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.concurrent.Executors;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">import java.util.concurrent.Future;</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">public class Main {</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">public static void main(String[] args) throws ExecutionException, InterruptedException {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">// case1();// case2();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">case3();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">/**</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* &lt;一&gt;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 1. 用List收集任务结果 (List记录每个submit返回的Future)</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 2. 循环查看结果, Future不一定完成, 如果没有完成, 那么调用get会租塞</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 3. 如果排在前面的任务没有完成, 那么就会阻塞, 这样后面已经完成的任务就没法获得结果了, 导致了不必要的等待时间.</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 更为严重的是: 第一个任务如果几个小时或永远完成不了, 而后面的任务几秒钟就完成了, 那么后面的任务的结果都将得不到处理</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 导致: 已完成的任务可能得不到及时处理</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*/</span></div><div><span style="font-family: punctuation; font-size: 12pt;">private static void case1() throws ExecutionException, InterruptedException {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">final Random random = new Random();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">ExecutorService service = Executors.newFixedThreadPool(10);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">List&lt;Future&lt;String&gt;&gt; taskResultHolder = new ArrayList&lt;&gt;();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">for(int i=0; i&lt;50; i++) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">//搜集任务结果</span></div><div><span style="font-family: punctuation; font-size: 12pt;">taskResultHolder.add(service.submit(new Callable&lt;String&gt;() {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">public String call() throws Exception {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Thread.sleep(random.nextInt(5000));</span></div><div><span style="font-family: punctuation; font-size: 12pt;">return Thread.currentThread().getName();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}));</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">// 处理任务结果</span></div><div><span style="font-family: punctuation; font-size: 12pt;">int count = 0;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(&quot;handle result begin&quot;);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">for(Future&lt;String&gt; future : taskResultHolder) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(future.get());</span></div><div><span style="font-family: punctuation; font-size: 12pt;">count++;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(&quot;handle result end&quot;);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(count + &quot; task done !&quot;);</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">//关闭线程池</span></div><div><span style="font-family: punctuation; font-size: 12pt;">service.shutdown();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">/**</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* &lt;二&gt; 只对第一种情况进行的改进</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 1. 查看任务是否完成, 如果完成, 就获取任务的结果, 让后重任务列表中删除任务.</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 2. 如果任务未完成, 就跳过此任务, 继续查看下一个任务结果.</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 3. 如果到了任务列表末端, 那么就从新回到任务列表开始, 然后继续从第一步开始执行</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 这样就可以及时处理已完成任务的结果了</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*/</span></div><div><span style="font-family: punctuation; font-size: 12pt;">private static void case2() throws ExecutionException, InterruptedException {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">final Random random = new Random();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">ExecutorService service = Executors.newFixedThreadPool(10);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">List&lt;Future&lt;String&gt;&gt; results = new ArrayList&lt;&gt;();</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">for(int i=0; i&lt;50; i++) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Callable&lt;String&gt; task = new Callable&lt;String&gt;() {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">public String call() throws Exception {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Thread.sleep(random.nextInt(5000)); //模拟耗时操作</span></div><div><span style="font-family: punctuation; font-size: 12pt;">return Thread.currentThread().getName();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">};</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Future&lt;String&gt; future = service.submit(task);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">results.add(future); // 搜集任务结果</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">int count = 0;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">//自旋, 获取结果</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(&quot;handle result begin&quot;);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">for(int i=0; i&lt;results.size(); i++) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Future&lt;String&gt; taskHolder = results.get(i);</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">if(taskHolder.isDone()) { //任务完成</span></div><div><span style="font-family: punctuation; font-size: 12pt;">String result = taskHolder.get(); //获取结果, 进行某些操作</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(&quot;result: &quot; + result);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">results.remove(taskHolder);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">i--;</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">count++; //完成的任务的计数器</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">//回到列表开头, 从新获取结果</span></div><div><span style="font-family: punctuation; font-size: 12pt;">if(i == results.size() - 1) i = -1;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(&quot;handle result end&quot;);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(count + &quot; task done !&quot;);</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">//线程池使用完必须关闭</span></div><div><span style="font-family: punctuation; font-size: 12pt;">service.shutdown();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">/**</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* &lt;三&gt; 使用ExecutorCompletionService管理异步任务</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 1. Java中的ExecutorCompletionService&lt;V&gt;本身有管理任务队列的功能</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* i. ExecutorCompletionService内部维护列一个队列, 用于管理已完成的任务</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* ii. 内部还维护列一个Executor, 可以执行任务</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 2. ExecutorCompletionService内部维护了一个BlockingQueue, 只有完成的任务才被加入到队列中</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 3. 任务一完成就加入到内置管理队列中, 如果队列中的数据为空时, 调用take()就会阻塞 (等待任务完成)</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* i. 关于完成任务是如何加入到完成队列中的, 请参考ExecutorCompletionService的内部类QueueingFuture的done()方法</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 4. ExecutorCompletionService的take/poll方法是对BlockingQueue对应的方法的封装, 关于BlockingQueue的take/poll方法:</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* i. take()方法, 如果队列中有数据, 就返回数据, 否则就一直阻塞;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* ii. poll()方法: 如果有值就返回, 否则返回null</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* iii. poll(long timeout, TimeUnit unit)方法: 如果有值就返回, 否则等待指定的时间; 如果时间到了如果有值, 就返回值, 否则返回null</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*</span></div><div><span style="font-family: punctuation; font-size: 12pt;">* 解决了已完成任务得不到及时处理的问题</span></div><div><span style="font-family: punctuation; font-size: 12pt;">*/</span></div><div><span style="font-family: punctuation; font-size: 12pt;">static void case3() throws InterruptedException, ExecutionException {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Random random = new Random();</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">ExecutorService service = Executors.newFixedThreadPool(10);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">ExecutorCompletionService&lt;String&gt; completionService = new ExecutorCompletionService&lt;String&gt;(service);</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">for(int i=0; i&lt;50; i++) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">completionService.submit(new Callable&lt;String&gt;() {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">@Override</span></div><div><span style="font-family: punctuation; font-size: 12pt;">public String call() throws Exception {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Thread.sleep(random.nextInt(5000));</span></div><div><span style="font-family: punctuation; font-size: 12pt;">return Thread.currentThread().getName();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">});</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">int completionTask = 0;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">while(completionTask &lt; 50) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">//如果完成队列中没有数据, 则阻塞; 否则返回队列中的数据</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Future&lt;String&gt; resultHolder = completionService.take();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(&quot;result: &quot; + resultHolder.get());</span></div><div><span style="font-family: punctuation; font-size: 12pt;">completionTask++;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">System.out.println(completionTask + &quot; task done !&quot;);</span></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">//ExecutorService使用完一定要关闭 (回收资源, 否则系统资源耗尽! .... 呵呵...)</span></div><div><span style="font-family: punctuation; font-size: 12pt;">service.shutdown();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: punctuation; font-size: 12pt;-en-paragraph:true;">那咩, ExecutorCompletionService是如何执行任务, 又是如何将任务的结果存储到完成队列中的呢?</span></div><ol><li>ExecutorCompletionService在submit任务时, 会创建一个QueueingFuture, 然后将创建的QueueingFuture丢给executor, 让executor完成任务的执行工作</li><li>QueueingFuture继承与FutureTask类, 而FutureTask实现了两个接口Runnable和Future.</li></ol><ul><li>Runnable一般表示要执行的任务的过程, 而Future则表述执行任务的 结果 (或者说是任务的一个句柄, 可获取结果, 取消任务等).</li><li>因此FutureTask就是一个有结果可期待的任务. FutureTask实现了run方法, 我们指定此方法一般是在在工作线程(不是submit线程) 执行的, 可以看看源码:</li></ul><div><span style="font-family: punctuation; font-size: 12pt;">public void run() {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">if (state != NEW ||</span></div><div><span style="font-family: punctuation; font-size: 12pt;">!</span><a href="http://unsafe.compareandswapobject/" style="font-family: punctuation; font-size: 12pt;">UNSAFE.compareAndSwapObject</a><span style="font-family: punctuation; font-size: 12pt;">(this, runnerOffset,</span></div><div><span style="font-family: punctuation; font-size: 12pt;">null, Thread.currentThread()))</span></div><div><span style="font-family: punctuation; font-size: 12pt;">return;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">try {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">Callable&lt;V&gt; c = callable;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">if (c != null &amp;&amp; state == NEW) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">V result;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">boolean ran;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">try {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">result = c.call();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">ran = true;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">} catch (Throwable ex) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">result = null;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">ran = false;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">setException(ex);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">if (ran)</span></div><div><span style="font-family: punctuation; font-size: 12pt;">set(result);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">} finally {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">// runner must be non-null until state is settled to</span></div><div><span style="font-family: punctuation; font-size: 12pt;">// prevent concurrent calls to run()</span></div><div><span style="font-family: punctuation; font-size: 12pt;">runner = null;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">// state must be re-read after nulling runner to prevent</span></div><div><span style="font-family: punctuation; font-size: 12pt;">// leaked interrupts</span></div><div><span style="font-family: punctuation; font-size: 12pt;">int s = state;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">if (s &gt;= INTERRUPTING)</span></div><div><span style="font-family: punctuation; font-size: 12pt;">handlePossibleCancellationInterrupt(s);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><ul><li>FutureTask构造的时候需要一个Callable&lt;V&gt;参数, Callable表示一个任务的执行过程, 在run方法中恰好调用了Callable.call(), 也就是任务工作在工作线程中执行.</li><li>那么任务执行完了会返回结果, 这个结果是要在submit线程(就是提交任务的线程)中使用的, 那么如何让submit线程可以反问到呢? 答案也是在FutureTask类中, 我们可以看到run方法中执行任务(Callable.call())获取结果后, 会掉用一个set()方法, set方法源码如下:</li></ul><div><span style="font-family: punctuation; font-size: 12pt;">protected void set(V v) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">if (</span><a href="http://unsafe.compareandswapint/" style="font-family: punctuation; font-size: 12pt;">UNSAFE.compareAndSwapInt</a><span style="font-family: punctuation; font-size: 12pt;">(this, stateOffset, NEW, COMPLETING)) {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">outcome = v;</span></div><div><span style="font-family: punctuation; font-size: 12pt;">UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state</span></div><div><span style="font-family: punctuation; font-size: 12pt;">finishCompletion();</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><ul><li><span style="-en-paragraph:true;">set() 将获取的结果存储到FuturnTask的一个outcome字段中, 这个过程是同步的, 所以其他线程稍后访问是可以读取到值的</span></li><li><span style="-en-paragraph:true;">ExecutorCompletionService中的完成队列中正好存储的是FuturnTask的子类, 当然可以调用FutureTask的get方法, FutureTask的get方法就是获取outcome值 (get()方法中调用了report()方法, report中返回了outcome字段).</span></li><li><span style="-en-paragraph:true;">FuturnTask中委托的任务执行完成后, 会掉一个done()方法, 这个方法是个空方法, 而其子类QueueingFuture重写了此方法, 如下:</span></li></ul><div><span style="font-family: punctuation; font-size: 12pt;">protected void done() {</span></div><div><span style="font-family: punctuation; font-size: 12pt;">completionQueue.add(task);</span></div><div><span style="font-family: punctuation; font-size: 12pt;">}</span></div><h5><span style="font-family: punctuation; font-size: 12pt;">正式在此方法中把执行完的任务放置到完成队列中的!!</span></h5><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: punctuation; font-size: 12pt;-en-paragraph:true;">然后我们就可以在submit线程中从完成队列中取出任务句柄, 获取任务结果了!!!</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: punctuation; font-size: 12pt;-en-paragraph:true;">至此, ExecutorCompletionService原理已经解析完毕 !!</span></div><div><span style="font-family: punctuation; font-size: 12pt;">欲知后事如何, 切听下回分解 !!</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: punctuation; font-size: 12pt;-en-paragraph:true;">==&gt;</span> <a href="https://www.jianshu.com/p/50c03b1226fe" style="font-family: punctuation; font-size: 12pt;-en-paragraph:true;">Future/FutureTask源码分析</a></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><br style="font-family: punctuation; font-size: 12pt;"/></div><div><span style="font-family: punctuation; font-size: 12pt;">作者：元亨利贞o</span></div><div><span style="font-family: punctuation; font-size: 12pt;">链接：</span><a href="https://www.jianshu.com/p/cfda708a3478" style="font-family: punctuation; font-size: 12pt;">https://www.jianshu.com/p/cfda708a3478</a></div><div><span style="font-family: punctuation; font-size: 12pt;">來源：简书</span></div><div><span style="font-family: punctuation; font-size: 12pt;">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</span></div></div></span>
</div></body></html> 