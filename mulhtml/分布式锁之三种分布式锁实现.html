<html>
<head>
  <title>分布式锁之三种分布式锁实现</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1704"/>
<h1>分布式锁之三种分布式锁实现</h1>

<div>
<span><div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">锁是开发过程中十分常见的工具，在处理高并发请求的时候和订单数据的时候往往需要锁来帮助我们保证数据的安全。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 18pt;"><span style="font-size: 18pt; color: rgb(20, 113, 145); font-weight: bold;">分布式锁的一些场景</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">场景1.前端点击太快，导致后端重复调用接口。两次调用一个接口，这样就会产生同一个请求执行了两次，而从用户的角度出发，他是因为太卡而点了两次，他的目标是执行一次请求。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">场景2.对于高并发场景，我们往往需要引入分布式缓存，来加快整个系统的响应速度。但是缓存是有失效机制的，如果某一时刻缓存失效，而此时有大量的请求过来，那么所有的请求会瞬间直接打到DB上，那么这么大的并发量，DB可能是扛不住的。那么这里需要引入一个保护机制。当发生“缓存击穿”的时候加锁，从而保护DB不被拖垮。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 16px;">场景3:数据存在则更新，不存在则插入的并发问题</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 18pt; color: rgb(20, 113, 145); font-weight: bold;">如何实现分布式锁</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">看完了上面的场景，其实分布式锁的场景一直在我们身边。说分布式锁之前，应该先说一下java提供的锁，比较能单机解决的并发问题，没必要引入分布式的解决方案。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">java提供了两种内置的锁的实现，一种是由JVM实现的synchronized和JDK提供的Lock，当你的应用是单机或者说单进程应用时，可以使用synchronized或Lock来实现锁。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">但是，当你的应用涉及到多机、多进程共同完成时，例如现在的互联网架构，一般都是分布式的RPC框架来支撑，那么这样你的Server有多个，由于负载均衡的路由规则随机，相同的请求可能会打到不同的Server上进行处理，那么这时候就需要一个全局锁来实现多个线程(不同的进程)之间的同步。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">实现全局的锁需要依赖一个第三方系统，此系统需要满足高可用、一致性比较强同时能应付高并发的请求。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">常见的处理办法有三种：数据库、缓存、分布式协调系统。数据库和缓存是比较常用的，但是分布式协调系统是不常用的。</span></div><h4><span style="font-size: 14pt; color: rgb(20, 113, 145);">数据库实现分布式锁####</span></h4><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">利用DB来实现分布式锁，有两种方案。两种方案各有好坏，但是总体效果都不是很好。但是实现还是比较简单的。</span></div><div><span style="font-size: 12pt; font-weight: bold;">1.利用主键唯一规则</span></div><div><span style="font-size: 12pt;">我们知道数据库是有唯一主键规则的，主键不能重复，对于重复的主键会抛出主键冲突异常。</span></div><div><span style="font-size: 12pt;">了解JDK reentrantlock的人都知道，reentrantlock是利用了OS的CAS特性实现的锁。主要是维护一个全局的状态，每次竞争锁都会CAS修改锁的状态，修改成功之后就占用了锁，失败的加入到同步队列中，等待唤醒。</span></div><div><span style="font-size: 12pt;">其实这和分布式锁实现方案基本是一致的，首先我们利用主键唯一规则，在争抢锁的时候向DB中写一条记录，这条记录主要包含锁的id、当前占用锁的线程名、重入的次数和创建时间等，如果插入成功表示当前线程获取到了锁，如果插入失败那么证明锁被其他人占用，等待一会儿继续争抢，直到争抢到或者超时为止。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">这里我主要写了一个简单的实现：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">package</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">com.fhr.concurrentdemo.distributedlock;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.sql.Connection;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.sql.PreparedStatement;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.sql.SQLException;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.util.concurrent.CountDownLatch;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.util.concurrent.TimeUnit;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">javax.sql.DataSource;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 利用MySQL行锁实现分布式锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@author</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">HuaRanFan</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">class</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">MysqlPrimaryLock {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">static</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">DataSource</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-style: italic;">dataSource</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">static</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              Class.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">forName</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;com.mysql.jdbc.Driver&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(ClassNotFoundException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">// String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt; text-decoration: underline;">url</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">= &quot;jdbc:mysql://10.0.0.212:3308/db<a href="http://www_lock/?user=lock_admin&amp;password=lock123">www_lock?user=lock_admin&amp;password=lock123</a>&quot;;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">//</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt; text-decoration: underline;">datasource</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">初始化逻辑</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">Connection getConnection()</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">throws</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">SQLException {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-style: italic;">dataSource</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.getConnection();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 加锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">lock(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          acquire(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 获取锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">acquire(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;insert into test_lock('id','count','thName','addtime') VALUES (?,?,?,?)&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">while</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   PreparedStatement</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= getConnection().prepareStatement(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setString(1,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setInt(2, 1);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setLong(1, System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">());</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.execute();</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">// 如果成功，那么就是获取到了锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(SQLException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   Thread.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">sleep</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(1000);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(InterruptedException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">continue</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 超时获取锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">timeOuts</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@throws</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">InterruptedException</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">acquire(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">throws</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">InterruptedException {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;insert into test_lock('id','count','thName','addtime') VALUES (?,?,?,?)&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">futureTime</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">() +</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= 500;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">while</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              CountDownLatch</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">latch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">CountDownLatch(1);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   PreparedStatement</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= getConnection().prepareStatement(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setString(1,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setInt(2, 1);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setLong(1, System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">());</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.execute();</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">// 如果成功，那么就是获取到了锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(SQLException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">latch</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.await(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">, TimeUnit.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">MILLISECONDS</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">futureTime</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">- System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">&lt;= 0)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">break</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">&lt;</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">continue</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">false</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 释放锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@throws</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">SQLException</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">unlock(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">throws</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">SQLException {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;DELETE from test_lock where id = ?&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          PreparedStatement</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= getConnection().prepareStatement(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setString(1,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.execute();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">false</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">}</span></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">这里是利用主键冲突规则，加入了id','count','thName','addtime'，count主要是为了重入计数，thName为了判断占用锁的线程，addtime是记录占用时间。上面代码没有实现重入的逻辑。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">重入主要实现思路是，在每次获取锁之前去取当前锁的信息，如果锁的线程是当前线程，那么更新锁的count+1，并且执行锁之后的逻辑。如果不是当前锁，那么进行重试。释放的时候也要进行count-1，最后减到0时，删除锁标识释放锁。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">优点：实现简单</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">缺点：没有超时保护机制，mysql存在单点，并发量大的时候请求量太大、没有线程唤醒机制，用异常去控制逻辑多少优点恶心。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">对于超时保护：如果可能，可以采用定时任务去扫描超过一定阈值的锁，并删除。但是也会存在，锁住的任务执行时间很长，删除锁会导致并发问题。所以需要对超时时间有一个很好的预估。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">对于单点问题：有条件可以搞一个主从，但是为了一个锁来搞一个主从是不是优点浪费？同时主从切换的时候系统不可用，这也是一个问题。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">并发量大的时候请求量太大：因为这种实现方式是没有锁的唤醒机制的，不像reentrantlock在同步队列中的节点，可以通过唤醒来避免多次的循环请求。但是分布式环境数据库这种锁的实现是不能做到唤醒的。所以只能将获取锁的时间间隔调高，避免死循环给系统和DB带来的巨大压力。这样也牺牲了系统的吞吐量，因为总会有一定的间隔锁是空闲的。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">用异常去控制逻辑多少优点恶心：就不说了，每次失败都抛异常.....</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt; font-weight: bold;">2.</span><span style="font-size: 12pt; font-weight: bold;">利用Mysql行锁的特性</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">Mysql是有表锁、页锁和行锁的机制的，可以利用这个机制来实现锁。这里尽量使用行锁，它的吞吐量是最高的。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">package</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">com.fhr.concurrentdemo.distributedlock;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.sql.Connection;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.sql.PreparedStatement;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.sql.SQLException;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.util.concurrent.CountDownLatch;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.util.concurrent.TimeUnit;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">javax.sql.DataSource;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 使用MySQL行锁来实现分布式锁 依靠了事务，所以如果想没有侵入性，需要使用ThreadLocal来构建全局变量。</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@author</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">HuaRanFan</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">class</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">MySQLRowLock {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">static</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">DataSource</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-style: italic;">dataSource</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">static</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              Class.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">forName</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;com.mysql.jdbc.Driver&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(ClassNotFoundException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">// String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt; text-decoration: underline;">url</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">=</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">// &quot;jdbc:mysql://10.0.0.212:3308/db<a href="http://www_lock/?user=lock_admin&amp;password=lock123">www_lock?user=lock_admin&amp;password=lock123</a>&quot;;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">//</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt; text-decoration: underline;">datasource</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">初始化逻辑</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">static</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">ThreadLocal&lt;Connection&gt;</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-style: italic;">threadLocalConnection</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">ThreadLocal&lt;Connection&gt;() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(100, 100, 100); font-size: 14pt;">@Override</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">protected</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">Connection initialValue() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-style: italic;">dataSource</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.getConnection();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(SQLException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">null</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     };</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">Connection getConnection()</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">throws</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">SQLException {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-style: italic;">threadLocalConnection</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.get();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 超时获取锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt; background: #d4d4d4;">timeOuts</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@throws</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">InterruptedException</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">acquireByUpdate(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt; background: #f0d8a8;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">throws</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">InterruptedException, SQLException {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;SELECT id from test_lock where id = ? for UPDATE &quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">futureTime</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">() +</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt; background: #d4d4d4;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt; background: #d4d4d4;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= 500;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          getConnection().setAutoCommit(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">false</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">while</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              CountDownLatch</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">latch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">CountDownLatch(1);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   PreparedStatement</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= getConnection().prepareStatement(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">sql</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setString(1,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setInt(2, 1);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setLong(1, System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">());</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">statement</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.execute();</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 127, 95); font-size: 14pt;">// 如果成功，那么就是获取到了锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ifsucess</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(SQLException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">latch</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.await(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">, TimeUnit.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">MILLISECONDS</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">futureTime</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">- System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">&lt;= 0)</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">break</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">&lt;</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timerange</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ranmain</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">continue</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">false</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 释放锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@throws</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">SQLException</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">unlockforUpdtate(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">throws</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">SQLException {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          getConnection().commit();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">}</span></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">利用for update加显式的行锁，这样就能利用这个行级的排他锁来实现分布式锁了，同时unlock的时候只要释放commit这个事务，就能达到释放锁的目的。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">优点：实现简单</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">缺点：连接池爆满和事务超时的问题单点的问题，单点问题，行锁升级为表锁的问题，并发量大的时候请求量太大、没有线程唤醒机制。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">连接池爆满和事务超时的问题单点的问题：利用事务进行加锁的时候，query需要占用数据库连接，在行锁的时候连接不释放，这就会导致连接池爆满。同时由于事务是有超时时间的，过了超时时间自动回滚，会导致锁的释放，这个超时时间要把控好。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">对于单点问题：同上。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">并发量大的时候请求量太大：同上。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">行锁升级为表锁的问题：Mysql行锁默认需要走索引，如果不走索引会导致锁表，如果可以，在sql中可以强制指定索引。</span></div><h4><span style="font-size: 14pt; color: rgb(26, 144, 185);">缓存分布式锁####</span></h4><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">缓存实现分布式锁还是比较常见的，因为缓存比较轻量，并且缓存的响应快、吞吐高。最重要的是还有自动失效的机制来保证锁一定能释放。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">缓存的分布式锁主要通过Redis实现，当然其他的缓存也是可以的。关于缓存有两种实现吧：</span></div><div><span style="font-size: 12pt; font-weight: bold;">基于SetNX实现</span></div><div><span style="font-size: 12pt;">setNX是Redis提供的一个原子操作，如果指定key存在，那么setNX失败，如果不存在会进行Set操作并返回成功。我们可以利用这个来实现一个分布式的锁，主要思路就是，set成功表示获取锁，set失败表示获取失败，失败后需要重试。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">具体看下代码：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">package</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">com.fhr.concurrentdemo.distributedlock;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.util.concurrent.CountDownLatch;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">java.util.concurrent.TimeUnit;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; background: #d4d4d4; color: rgb(51, 51, 51);">redis.clients.jedis.Jedis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 基于</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt; text-decoration: underline;">Redis</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">缓存实现的锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 核心是setNx方法，setNX是</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt; text-decoration: underline;">Redis</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">提供的一个原子操作，</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 如果指定key存在，那么setNX失败，如果不存在会进行Set操作并返回成功。</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 我们可以利用这个来实现一个分布式的锁，主要思路就是：</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * set成功表示获取锁，set失败表示获取失败，失败后需要重试。</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@author</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">HuaRanFan</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">class</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">RedisLock {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; background: #d4d4d4; color: rgb(51, 51, 51);">Jedis</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">jedisCli</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; background: #d4d4d4; color: rgb(51, 51, 51);">Jedis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;localhost&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">, 6381);</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">int</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">expireTime</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= 1;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 获取锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">lock(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">while</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">returnFlag</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">jedisCli</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setnx(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;1&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">returnFlag</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">== 1) {</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; get lock....&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; is trying lock....&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   Thread.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">sleep</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(2000);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(InterruptedException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">false</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      * 超时获取锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">lockID</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@param</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">timeOuts</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">      */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">boolean</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">lock(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">current</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= System.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentTimeMillis</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">future</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">current</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeOuts</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeStep</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= 500;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          CountDownLatch</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">latch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">CountDownLatch(1);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">while</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">future</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">&gt;</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">current</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">returnFlag</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">jedisCli</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.setnx(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;1&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">returnFlag</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">== 1) {</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; get lock....&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">jedisCli</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.expire(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockID</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">expireTime</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; is trying lock....&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">latch</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.await(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeStep</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">, TimeUnit.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">MILLISECONDS</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(InterruptedException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">current</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">current</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">timeStep</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">false</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">unlock(String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockId</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">long</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">flag</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">jedisCli</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.del(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">lockId</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">flag</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">&gt; 0) {</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; release lock....&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">else</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; release lock fail....&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">          }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">}</span></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">可以看到，几个线程很好的进行了同步。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">这种方式也是有优点和缺点：</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">优点：实现简单，吞吐量十分客观，对于高并发情况应付自如，自带超时保护，对于网络抖动的情况也可以利用超时删除策略保证不会阻塞所有流程。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">缺点：单点问题、没有线程唤醒机制、网络抖动可能会引起锁删除失败。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">对单点问题：因为redis一般都是单实例使用，那么对于单点问题，可以做一个主从。当然主从切换的时候也是不可用的，因为主从同步是异步的，可能会并发问题。如果对于主从还是不能保证可靠性的话，可以上Redis集群，对于Redis集群，因为使用了类一致性Hash算法，虽然不能避免节点下线的并发问题(当前的任务没有执行完，其他任务就开始执行)，但是能保证Redis是可用的。</span><span style="font-size: 12pt; font-weight: bold;-en-paragraph:true;">可用性的问题是出了问题之后的备选方案，如果我们系统天天都出问题还玩毛啊，对于突发情况牺牲一两个请求还是没问题的。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">对于线程唤醒机制：分布式锁大多都是这样轮训获取锁的，所以控制住你的重试频率，也不会导致负载特别高的。可能就是吞吐量低点而已。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">对于锁删除失败：分布式锁基本都有这个问题，可以对key设置失效时间。这个超时时间需要把控好，过大那么系统吞吐量低，很容易导致超时。如果过小那么会有并发问题，部分耗时时间比较长的任务就要遭殃了。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 16px;"><b>注意：setNx方法是原子方法，但如果随后手动设置过期时间，那就不是原子的，因此也存在并发问题，但Redis的set操作很多，有相应的原子操作合并了setNX和expire的两条操作的。</b></span></div><h4><span style="font-size: 14pt; color: rgb(20, 113, 145);">基于Zookeeper的分布式锁####</span></h4><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">Zookeeper是一个分布式一致性协调框架，主要可以实现选主、配置管理和分布式锁等常用功能，因为Zookeeper的写入都是顺序的，在一个节点创建之后，其他请求再次创建便会失败，同时可以对这个节点进行Watch，如果节点删除会通知其他节点抢占锁。</span></div><div><span style="font-size: 12pt;"><b>第一种实现（会产生惊群效应）</b></span></div><div><span style="font-size: 12pt;">可以利用Zookeeper不能重复创建一个节点的特性来实现一个分布式锁，这看起来和redis实现分布式锁很像。但是也是有差异的，后面会详细分析。</span></div><div><span style="font-size: 12pt;">主要流程图如下：</span></div><div><img src="分布式锁之三种分布式锁实现_files/Image.png" type="image/png" data-filename="Image.png" style="font-size: 12pt;"/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">上面的流程很简单：</font></span></div><ol><li><font style="font-size: 12pt;">查看目标Node是否已经创建，已经创建，那么等待锁。</font></li><li><font style="font-size: 12pt;">如果未创建，创建一个瞬时Node，表示已经占有锁。</font></li><li><font style="font-size: 12pt;">如果创建失败，那么证明锁已经被其他线程占有了，那么同样等待锁。</font></li><li><font style="font-size: 12pt;">当释放锁，或者当前Session超时的时候，节点被删除，唤醒之前等待锁的线程去争抢锁。</font></li></ol><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">上面是一个完整的流程，简单的代码实现如下：</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font face="Consolas" style="font-size: 14pt;"><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">import java.io.IOException;</span></font></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">import org.apache.zookeeper.CreateMode;</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">import org.apache.zookeeper.KeeperException;</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">import org.apache.zookeeper.WatchedEvent;</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">import org.apache.zookeeper.Watcher;</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">import org.apache.zookeeper.ZooDefs;</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">import org.apache.zookeeper.ZooKeeper;</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">/**</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">* 基于ZooKeeper实现的分布式锁 无顺序保证，有惊群效应</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">*</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">* @author HuaRanFan</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">* @since 2018年3月10日</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">*/</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">public class NoFairZooKeeperLock {</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    private String zkQurom = &quot;localhost:2181&quot;;</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    private String lockNameSpace = &quot;/mylock&quot;;</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    private String nodeString = lockNameSpace + &quot;/test1&quot;;</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    private ZooKeeper zk;</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    public NoFairZooKeeperLock() {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            zk = new ZooKeeper(zkQurom, 6000, new Watcher() {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                @Override</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                public void process(WatchedEvent watchedEvent) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    System.out.println(&quot;Receive event &quot; + watchedEvent);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    if (Event.KeeperState.SyncConnected == watchedEvent.getState())</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        System.out.println(&quot;connection is established...&quot;);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            });</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        } catch (IOException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    private void ensureRootPath() throws InterruptedException {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            if (zk.exists(lockNameSpace, true) == null) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                zk.create(lockNameSpace, &quot;&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        } catch (KeeperException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    private void watchNode(String nodeString, final Thread thread) throws InterruptedException {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            zk.exists(nodeString, new Watcher() {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                @Override</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                public void process(WatchedEvent watchedEvent) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    System.out.println(&quot;==&quot; + watchedEvent.toString());</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    if (watchedEvent.getType() == Event.EventType.NodeDeleted) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        System.out.println(&quot;Threre is a Thread released Lock==============&quot;);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        thread.interrupt();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        zk.exists(nodeString, new Watcher() {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                            @Override</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                            public void process(WatchedEvent watchedEvent) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                System.out.println(&quot;==&quot; + watchedEvent.toString());</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                if (watchedEvent.getType() == Event.EventType.NodeDeleted) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                    System.out.println(&quot;Threre is a Thread released Lock==============&quot;);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                    thread.interrupt();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                    zk.exists(nodeString, true);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                } catch (KeeperException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                    e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                } catch (InterruptedException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                    e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                                }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                            }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        });</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    } catch (KeeperException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    } catch (InterruptedException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            });</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        } catch (KeeperException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     * 获取锁</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     * @return</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     * @throws InterruptedException</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    public boolean lock() throws InterruptedException {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        @SuppressWarnings(&quot;unused&quot;)</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        String path = null;</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        ensureRootPath();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        watchNode(nodeString, Thread.currentThread());</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        while (true) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                path = zk.create(nodeString, &quot;&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            } catch (KeeperException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                System.out.println(Thread.currentThread().getName() + &quot;  getting Lock but can not get&quot;);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    Thread.sleep(5000);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                } catch (InterruptedException ex) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    System.out.println(&quot;thread is notify&quot;);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            System.out.println(Thread.currentThread().getName() + &quot;  get Lock...&quot;);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            return true;</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     * 释放锁</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    public void unlock() {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        try {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            zk.delete(nodeString, -1);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            System.out.println(&quot;Thread.currentThread().getName() +  release Lock...&quot;);</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        } catch (InterruptedException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        } catch (KeeperException e) {</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            e.printStackTrace();</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">}</span></div><div><font face="Consolas" style="font-size: 14pt;"><br/></font><br style="font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);"/></div></div><div><span style="font-size: 12pt;"><b><br/></b></span></div><div><span style="font-size: 12pt;">其实上面的实现有优点也有缺点：</span></div><div><span style="font-size: 12pt;">优点：</span></div><div><span style="font-size: 12pt;">实现比较简单，有通知机制，能提供较快的响应，有点类似reentrantlock的思想，对于节点删除失败的场景由Session超时保证节点能够删除掉。</span></div><div><span style="font-size: 12pt;">缺点：</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">重量级，同时在大量锁的情况下会有“惊群”的问题。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">“惊群”就是在一个节点删除的时候，大量对这个节点的删除动作有订阅Watcher的线程会进行回调，这对Zk集群是十分不利的。所以需要避免这种现象的发生。</span></div><div><b style="font-size: 16px;"><span style="font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: bold; font-size: 12pt;">解决“惊群”</span><span style="font-weight: bold; font-size: 12pt;"> （</span>第二种实现<span style="font-weight: bold; font-size: 12pt;">）</span>  </b><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">为了解决“惊群“问题，我们需要放弃订阅一个节点的策略，那么怎么做呢？</font></span></div><ol><li><font style="font-size: 12pt;">我们将锁抽象成目录，多个线程在此目录下创建瞬时的顺序节点，因为Zk会为我们保证节点的顺序性，所以可以利用节点的顺序进行锁的判断。</font></li><li><font style="font-size: 12pt;">首先创建顺序节点，然后获取当前目录下最小的节点，判断最小节点是不是当前节点，如果是那么获取锁成功，如果不是那么获取锁失败。</font></li><li><font style="font-size: 12pt;">获取锁失败的节点获取当前节点上一个顺序节点，对此节点注册监听，当节点删除的时候通知当前节点。</font></li><li><font style="font-size: 12pt;">当unlock的时候删除节点之后会通知下一个节点。</font></li></ol><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">上面的实现和reentrantlock的公平锁实现还是比较类似的，下面是简单的实现：</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font face="Consolas" style="font-size: 12pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">org.apache.zookeeper.CreateMode;</span></font></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">org.apache.zookeeper.KeeperException;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">org.apache.zookeeper.WatchedEvent;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">org.apache.zookeeper.Watcher;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">org.apache.zookeeper.ZooDefs;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">org.apache.zookeeper.ZooKeeper;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">import</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">org.apache.zookeeper.data.Stat;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 基于ZooKeeper实现的分布式锁 有顺序保证，</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> * 无惊群效应（依靠顺序队列）</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@author</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">HuaRanFan</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@since</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">  2018年3月10日</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;"> */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">class</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">FairZooKeeperLock {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">     </span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zkQurom</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;localhost:2181&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;/mylock&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockZnode</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">null</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">ZooKeeper</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">FairZooKeeperLock(){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">       </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">ZooKeeper(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zkQurom</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">, 6000,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">Watcher() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(100, 100, 100); font-size: 14pt;">@Override</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">process(WatchedEvent</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchedEvent</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    System.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;Receive event &quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchedEvent</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(Event.KeeperState.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">SyncConnected</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">==</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchedEvent</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.getState())</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        System.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;connection is established...&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            });</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(IOException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">private</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">ensureRootPath(){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">       </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.exists(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">)==</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">null</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.create(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.getBytes(), ZooDefs.Ids.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">OPEN_ACL_UNSAFE</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">, CreateMode.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">PERSISTENT</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(Exception</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">     * 获取锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">     *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@return</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">     *</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 159, 191); font-size: 14pt; font-weight: bold;">@throws</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">InterruptedException</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">lock(){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">path</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">null</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        ensureRootPath();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">path</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.create(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;/mylock_&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;&quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.getBytes(), ZooDefs.Ids.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">OPEN_ACL_UNSAFE</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">, CreateMode.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">EPHEMERAL_SEQUENTIAL</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockZnode</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">path</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                List&lt;String&gt;</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">minPath</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.getChildren(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">false</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                System.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">minPath</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                Collections.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">sort</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">minPath</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                System.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">minPath</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.get(0)+</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; and path &quot;</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">path</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNode</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">null</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">for</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">int</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">i</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">minPath</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.size()-1;</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">i</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">&gt;=0;</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">i</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">--){</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">minPath</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.get(</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">i</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">).compareTo(</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">path</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.substring(</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">path</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.lastIndexOf(</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;/&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) + 1))&lt;0){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                       </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNode</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">minPath</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.get(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">i</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                       </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">break</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNode</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">!=</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">null</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">final</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">String</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNodeTmp</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNode</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">final</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">Thread</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">thread</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">= Thread.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    Stat</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">stat</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.exists(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;/&quot;</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNodeTmp</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">new</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">Watcher() {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                       </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(100, 100, 100); font-size: 14pt;">@Override</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                       </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">process(WatchedEvent</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchedEvent</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchedEvent</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.getType() == Event.EventType.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">NodeDeleted</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">thread</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.interrupt();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.exists(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;/&quot;</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNodeTmp</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">true</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                            }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(KeeperException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                            }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(InterruptedException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    });</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">if</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">stat</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">!=</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">null</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                        System.</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;Thread &quot;</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+ Thread.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getId() +</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; waiting for &quot;</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockName</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;/&quot;</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">+</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">watchNode</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">               </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    Thread.</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">sleep</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(1000000000);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(InterruptedException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">ex</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">){</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot; notify&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                    System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() +</span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;  get Lock...&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">return</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">;</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">                }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(Exception</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">              </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">/**</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">     * 释放锁</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; color: rgb(63, 95, 191); font-size: 14pt;">     */</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">   </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">public</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">void</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">unlock(){</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">       </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">try</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">{</span></div><div style="min-height: 11pt;"><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">            System.</span><span style="min-height: 11pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt; font-weight: bold; font-style: italic;">out</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.println(Thread.</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; font-style: italic; color: rgb(51, 51, 51);">currentThread</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">().getName() + </span> <span style="min-height: 11pt; font-family: Consolas; color: rgb(42, 0, 255); font-size: 14pt;">&quot;release Lock...&quot;</span><span style="min-height: 11pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">zk</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.delete(</span><span style="min-height: 16pt; font-family: Consolas; color: rgb(0, 0, 192); font-size: 14pt;">lockZnode</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">,-1);</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(InterruptedException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(127, 0, 85); font-size: 14pt; font-weight: bold;">catch</span> <span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">(KeeperException</span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">) {</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">           </span> <span style="min-height: 16pt; font-family: Consolas; color: rgb(106, 62, 62); font-size: 14pt;">e</span><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">.printStackTrace();</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">        }</span></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">    }</span></div><div style="min-height: 16pt;"></div><div style="min-height: 16pt;"><span style="min-height: 16pt; font-family: Consolas; font-size: 14pt; color: rgb(51, 51, 51);">}</span></div><div><font face="Consolas" style="font-size: 12pt;"><br/></font></div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">其实上面的实现还是很复杂的，因为你需要反复的去关注Watcher，实现一个Demo可以，做一个生产环境可用的Lock并不容易。因为你的代码bug在生产环境上会引起很严重的bug。</font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">其实对于Zookeeper的一些常用功能是有一些成熟的包实现的，像Curator。Curator的确是足够牛逼，不仅封装了Zookeeper的常用API，也包装了很多常用Case的实现。但是它的编程风格其实还是吧比较难以接受的。</font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">可以用Curator轻易的实现一个分布式锁：</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">InterProcessMutex lock = new InterProcessMutex(client, lockPath);</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">if ( lock.acquire(maxWait, waitUnit) )</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">{</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">try</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">{</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">// do some work inside of the critical section here</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">}</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">finally</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">{</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">lock.release();</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">}</span></div><div><span style="font-size: 12pt; font-family: Monaco; color: rgb(51, 51, 51);">}</span></div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">是的就这么简单，一个直接拿过来可用的轮子。</font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;">基于Zookeeper的分布式锁就说完了。基于Zookeeper实现分布式锁，其实是不常用的。虽然它实现锁十分优雅，但编程复杂，同时还要单独维护一套Zookeeper集群，频繁的Watch对Zookeeper集群的压力还是蛮大的，如果不是原有的项目以来Zookeeper，同时锁的量级比较小的话，还是不用为妙</font>。</span></div><div><b><font style="font-size: 14pt; color: rgb(20, 113, 145);">三种分布锁对比：####</font></b></div><div><span style="font-size: 12pt;">Mysql实现比较简单，不需要引入第三个应用，但实现多少有些重，性能不是很好。</span></div><div><span style="font-size: 12pt;">Redis的话实现比较简单，同时性能很好，引入集群可以提高可用性。同时定期失效的机制可以解决因网络抖动锁删除失败的问题，所以我比较倾向Redis实现。</span></div><div><span style="font-size: 12pt;">Zookeeper实现是有些重的，同时我们还需要维护Zookeeper集群，实现起来还是比较复杂的，实现不好的话还会引起“羊群效应”。如果不是原有系统就依赖Zookeeper，同时压力不大的情况下。一般不使用Zookeeper实现分布式锁。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><div><br/></div><div><br/></div></div></div><div><br/></div></span>
</div></body></html> 