<html>
<head>
  <title>第六章 类文件结构</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="959"/>
<h1>第六章 类文件结构</h1>

<div>
<span><div><span style="min-height: 15pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>JVM的两大无关性</b></font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt;"><font style="font-size: 12pt;">语言无关性</font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt;"><font style="font-size: 12pt;">平台无关性</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>无关性基石</b></font></span></div><div style="min-height: 15pt;"><font style="font-size: 12pt;"><span style="min-height: 15pt;">   各种不同平台的虚拟机和所有平台都统一使用的程序存储格式——字节码（ByteCode）是构成平台无关性的基石，字节码的载体是</span><span style="min-height: 15pt;">”Class”</span><span style="min-height: 15pt;">文件。</span></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">   Java虚拟机不和包括java语言在内的任何一门语言绑定，它只与“Class文件”这种特定的二进制格式所关联，Class文件中包含了java虚拟机指令集和符号表以及若干其它辅助信息。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">任何语言只要借助相关的编译器，使其源码文件能被编译成符合虚拟机规范的字节码文件，那就能被java虚拟机执行。</font></span></div><div style="min-height: 236pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image.png" type="image/png" data-filename="Image.png" width="553"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">Java语言中的各种变量、关键字和运算符号的语义最终都是由多条字节码命令组成的，因此字节码命令所能提供的语义描述能力肯定会比Java语言本身更加强大。这为其它语言实现比java更高级的语言特性提供了基础。</font></span></div><div style="min-height: 15pt;"></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="color: rgb(26, 144, 185); font-size: 18pt;"><b>Class类文件的结构</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">     一个Class文件对应一个类或者接口的定义信息，但类或者接口的定义信息不一定在class文件中，class文件只是一个类或接口的字节码的载体。类加载器可以直接在网络或者内存中加载字节码，并不一定要加载class文件。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">     Class文件是一组以八位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑的排列在Class文件中，中间没有添加任何分隔符，这使得Class文件非常紧凑，存储内容几乎是运行时所有必需数据。当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割存放若干个8位字节来进行存储。（所以java的class文件的数字编码是大端，X86处理器是小端）</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">   Class文件中的数据结构只有两种类型：无符号数和表。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">   无符号数属于基本的数据类型，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">表是由多个无符号数或其它表作为数据项构成的复合数据类型，所有表都习惯以“_info”结尾。表用于描述有层次关系的复合结构的数据，整个Class文件本质上就是一张表。Class文件的格式如下：</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 248pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [1].png" type="image/png" data-filename="Image.png" width="550"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">   无论是无符号数还是表，当需要描述同一类型但数量不定的多个数据时，经常会使用一个前置的容量计数器加若干个连续的数据项的形式，这时称这一系列连续的某一类型的数据为某一类型的集合。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;"><b>1.魔数与class文件的版本</b></font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt;"><font style="font-size: 12pt;"> 前四个字节是魔数：0XCAFEBABE</font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt;"><font style="font-size: 12pt;"> 第五六个字节是版本号</font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 0mm; min-height: 15pt;"><font style="font-size: 12pt;"> 第七八个字节是主版本号</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;"><b>2.常量池</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">     常量池可以理解为class文件中的资源仓库，是class文件结构当中与其它项目关联最多的数据类型，也是占用class文件空间最大的数据项目之一，同时它还是在class文件中第一个出现的表类型数据项目。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">     常量池中主要存放两大类常量：</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 15mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 15mm; min-height: 15pt;"><font style="font-size: 12pt;">字面量：文本字符串、声明为final的常量值和数字这些值等</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 15mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 15mm; min-height: 15pt;"><font style="font-size: 12pt;">符号引用：属于编译原理方面的概念，包括三种：</font></span></div><div style="margin-left: 22mm; margin-right: 0mm; text-indent: 11mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 11mm; min-height: 15pt;"><font style="font-size: 12pt;">类和接口的全限定名</font></span></div><div style="margin-left: 22mm; margin-right: 0mm; text-indent: 11mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 11mm; min-height: 15pt;"><font style="font-size: 12pt;">字段的名称和描述符</font></span></div><div style="margin-left: 22mm; margin-right: 0mm; text-indent: 11mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 11mm; min-height: 15pt;"><font style="font-size: 12pt;">方法的名称和描述符</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 15mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 15mm; min-height: 15pt;"><font style="font-size: 12pt;">注意：字段和方法的名称好理解，描述符就是jni当中查询字段或者方法时用到的那种描述符，如int的字段就是“I”,无参void方法就是“()V”</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">     常量池中的每一个常量都是一个表，目前共有14种表，每个表开始的第一位都是u1类型的标志位，代表这个常量属于什么类型，14种常量类型如下：</font></span></div><div style="min-height: 15pt;"></div><div style="min-height: 222pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [2].png" type="image/png" data-filename="Image.png" width="546"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">常量池是最繁琐的数据结构，因为14种常量类型都有自己的结构，共同点是起始的一个字节都是常量类型的标志位。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">CONSTANT_Utf8_info是最常见的类型，其它的很多常量类型都有数据结构指向它，这个常量类型存放了编译出来的类名、方法名、字段名、方法描述符、字段描述符等等一系列的字符信息和字符串类型字面量等，使用UTF-8编码。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">14种常量类型结构如下：</font></span></div><div style="min-height: 426pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [3].png" type="image/png" data-filename="Image.png" width="552"/></font></div><div style="min-height: 262pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [4].png" type="image/png" data-filename="Image.png" width="549"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;"><b>3.访问标志</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">   两个字节代表访问标志，该标志用于识别类或者接口层次的访问信息，包括：这个Class是类还是接口；是否是public等等，标志位可以互相自由组合，如下：</font></span></div><div style="min-height: 196pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [5].png" type="image/png" data-filename="Image.png" width="549"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;"><b>4.类索引、父类索引和接口索引集合</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">  类索引和父类索引都是一个u2类型的数据，而接口索引集合是一组u2类型的数据的集合，Class文件中由这三项来确定类的继承关系。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">  每个索引的u2类型数据都是指向常量池中的一个CONSTANT_Class_info的类描述符常量的索引，而通过CONSTANT_Class_info又可以知道一个Constant_Utf8_info，从而便能找到类或者接口的全限定名。如下：</font></span></div><div style="min-height: 123pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [6].png" type="image/png" data-filename="Image.png" width="552"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">只有java.lang.Object的父类索引可以是0，其它都不能为0。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;"><b>5.字段表集合</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">  字段表用于描述接口或者类中声明的变量，包括类级变量和实例级变量，但不包括方法内部声明的局部变量。</font></span></div><div style="min-height: 15pt;"><font style="font-size: 12pt;"><span style="min-height: 15pt;"> </span> <img src="第六章 类文件结构_files/Image [7].png" type="image/png" data-filename="Image.png" width="547"/></font></div><div style="min-height: 160pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [8].png" type="image/png" data-filename="Image.png" width="546"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">Attribute_info表可能为空，这里面主要是针对常量字段而言。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;"><b>6.方法表集合</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">方法表集合的结构与字段表集合的结构几乎一致。</font></span></div><div style="min-height: 82pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [9].png" type="image/png" data-filename="Image.png" width="553"/></font></div><div style="min-height: 203pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [10].png" type="image/png" data-filename="Image.png" width="552"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">方法中的代码逻辑存放在属性表集合中一个名为Code的属性当中。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;"><b>7.属性表集合</b></font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">在Class文件、字段表、方法表中都可以携带自己的属性表集合，以用于描述某些场景专有的描述信息。</font></span></div><div style="min-height: 113pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [11].png" type="image/png" data-filename="Image.png" width="549"/></font></div><div style="min-height: 300pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [12].png" type="image/png" data-filename="Image.png" width="548"/></font></div><div style="min-height: 225pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [13].png" type="image/png" data-filename="Image.png" width="552"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">属性表的通用结构：</font></span></div><div style="min-height: 73pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [14].png" type="image/png" data-filename="Image.png" width="547"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">对于每个属性，它的名称需要从常量池中引用一个Constant_Utf8_info类型的常量来表示，而属性值的结构可以完全自定义，只需要通过一个u4的长度属性去说明属性值锁占位数。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">Eg:</font></span></div><div style="min-height: 171pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [15].png" type="image/png" data-filename="Image.png" width="545"/></font></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 18pt; color: rgb(26, 144, 185);"><b>字节码指令简介</b></font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">Java虚拟机的指令由一个字节长度的、代表着某种特定操作含义的数字（称为操作码，Opcode）以及跟随其后的零至多个代表此操作所需参数（称为操作数，Operands）而构成。</font></span></div><div style="min-height: 15pt;"><span style="min-height: 15pt;"><font style="font-size: 12pt;">由于java虚拟机采用面向操作数栈而不是寄存器的架构，所以大多数的指令都不含操作数，只有一个操作码。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">操作码的长度为一个字节，因此最多有256种操作码；又由于Class文件格式放弃了编译后代码的操作数长度对齐，这就意味着虚拟机处理那些超过一个字节的数据的时候，不得不在运行时重建出具体数据的结构。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">这种设计会造成解释执行字节码时损失一些性能。但优势也很明显：放弃操作数对齐，意味着可以省略很多填充和间隔符号；用一个字节来代表操作码，也能够获得短小精干的编译代码。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">不考虑异常处理，java虚拟机的解释器大概是下面的运行逻辑：</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">do{</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">       自动计算PC寄存器的值加1;</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">       根据PC寄存器的指示位置，从字节码流中取出操作码；</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">    If(字节码存在操作数) 从字节码流中读出操作数</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">    执行字节码定义的操作</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 15pt;"><span style="text-indent: 7mm; min-height: 15pt;"><font style="font-size: 12pt;">} while （字节流长度 &gt; 0）</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 81pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [16].png" type="image/png" data-filename="Image.png" width="549"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 300pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [17].png" type="image/png" data-filename="Image.png" width="554"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 72pt;"><font style="font-size: 12pt;"><img src="第六章 类文件结构_files/Image [18].png" type="image/png" data-filename="Image.png" width="552"/></font></div><div><br/></div></span>
</div></body></html> 